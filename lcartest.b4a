Build1=Default,com.omnicorp.lcarui.test
File1=01d.png
File10=10n.png
File100=borg.ttf
File101=br.gif
File102=bsod.png
File103=bttf.png
File104=card0.ogg
File105=card1.ogg
File106=card2.ogg
File107=card3.ogg
File108=card4.ogg
File109=card5.ogg
File11=10seconds.ogg
File110=card6.ogg
File111=cardassian.ttf
File112=cardassian0.ini
File113=cardassian1.ini
File114=cards.png
File115=chicago.ttf
File116=chron.png
File117=chronowerx.png
File118=click.ogg
File119=contact.ogg
File12=10secondsafm.ogg
File120=coo.ogg
File121=criticalstop.ogg
File122=cursor.png
File123=cylon.ttf
File124=data.png
File125=ding.ogg
File126=dna.png
File127=donotaddress.ogg
File128=dradis.ttf
File129=ds9.3d
File13=1-1.pon
File130=ed209s05.ogg
File131=ed209s15.ogg
File132=ed209s20.ogg
File133=eh1.ogg
File134=eh2.ogg
File135=eh3.ogg
File136=eh4.ogg
File137=eharmed.ogg
File138=elbow.gif
File139=elbow.png
File14=1-10.pon
File140=elbow2.gif
File141=elbow2.png
File142=elbow2s.gif
File143=elbow2s.png
File144=elbows.gif
File145=elbows.png
File146=elements.png
File147=english.ut
File148=ent.png
File149=ent2.png
File15=1-11.pon
File150=error.ogg
File151=error1.ogg
File152=evade.ogg
File153=eventhor.png
File154=excelsior.png
File155=false.gif
File156=federation.ttf
File157=ferengi.png
File158=ferengi.ttf
File159=fun.ogg
File16=1-12.pon
File160=fwars.ogg
File161=hailing.ogg
File162=hullbreak.ogg
File163=hum.ogg
File164=icons.png
File165=insignia.gif
File166=insigniabig.png
File167=insigniasmall.png
File168=insufficientdata.ogg
File169=intro.ogg
File17=1-13.pon
File170=khan.ogg
File171=kitt.ogg
File172=klingon.png
File173=klingon.ttf
File174=klingon0.ini
File175=klingonsmall.png
File176=l1.bal
File177=lcars.ttf
File178=makeityourself.ogg
File179=manytribbles.ogg
File18=1-14.pon
File180=mic.png
File181=missing.ogg
File182=mission.png
File183=ml.gif
File184=modem.ogg
File185=more.ogg
File186=motpicaler.ogg
File187=mr.gif
File188=mu.png
File189=n1.gif
File19=1-15.pon
File190=n2.gif
File191=n3.gif
File192=n4.gif
File193=nixie.png
File194=noaccess.ogg
File195=notaccepted.ogg
File196=notareplicator.ogg
File197=nx01.png
File198=onecredit.ogg
File199=overheat.ogg
File2=01n.png
File20=11d.png
File200=pcload.png
File201=phaser.ogg
File202=pixelmen.ttf
File203=precars.ttf
File204=pulaski.png
File205=q.png
File206=quark.png
File207=quarks.ogg
File208=redalert.ogg
File209=reliant.ogg
File21=1-2.pon
File210=reliant.png
File211=rom.ttf
File212=romulan.png
File213=scanner.ogg
File214=scream.ogg
File215=searchmode.ogg
File216=shrinky.ogg
File217=shuttlebays.png
File218=skull.png
File219=snap.ogg
File22=1-3.pon
File220=sovereign.png
File221=sprites.png
File222=starfleet.png
File223=starships.gif
File224=starships2.png
File225=starwars.ttf
File226=t0.png
File227=t1.png
File228=t2.png
File229=tactical.png
File23=13d.png
File230=tardis.3d
File231=tcars0.ini
File232=test1.gif
File233=test1.png
File234=test11.gif
File235=test11.png
File236=test110.gif
File237=test110.png
File238=test111.gif
File239=test111.png
File24=1-4.pon
File240=test112.gif
File241=test112.png
File242=test113.gif
File243=test113.png
File244=test114.gif
File245=test114.png
File246=test115.gif
File247=test115.png
File248=test12.gif
File249=test12.png
File25=1-5.pon
File250=test13.gif
File251=test13.png
File252=test14.gif
File253=test14.png
File254=test15.gif
File255=test15.png
File256=test16.gif
File257=test16.png
File258=test17.gif
File259=test17.png
File26=1-6.pon
File260=test18.gif
File261=test18.png
File262=test19.gif
File263=test19.png
File264=test2.gif
File265=test2.png
File266=test21.gif
File267=test21.png
File268=test210.gif
File269=test210.png
File27=1-7.pon
File270=test211.gif
File271=test211.png
File272=test212.gif
File273=test212.png
File274=test213.gif
File275=test213.png
File276=test214.gif
File277=test214.png
File278=test215.gif
File279=test215.png
File28=1-8.pon
File280=test22.gif
File281=test22.png
File282=test23.gif
File283=test23.png
File284=test24.gif
File285=test24.png
File286=test25.gif
File287=test25.png
File288=test26.gif
File289=test26.png
File29=1-9.pon
File290=test27.gif
File291=test27.png
File292=test28.gif
File293=test28.png
File294=test29.gif
File295=test29.png
File296=timesup.ogg
File297=tm.gif
File298=tmp.ini
File299=torpedo.ogg
File3=02d.png
File30=1minute.ogg
File300=tos.ogg
File301=tos.ttf
File302=tosred.ogg
File303=tostitle.ttf
File304=tr.gif
File305=transporter0.ogg
File306=transporter1.ogg
File307=transporter2.ogg
File308=transporter3.ogg
File309=transporter4.ogg
File31=1minuteafm.ogg
File310=transporter5.ogg
File311=tribbles.png
File312=tricorder.ogg
File313=tricorder.png
File314=troopers.png
File315=true.gif
File316=turret.ogg
File317=twokstandby.ogg
File318=twokwin.ogg
File319=ufp.3d
File32=2.cir
File320=ufp.png
File321=ufplogo.png
File322=veidt.png
File323=voyager.3d
File324=voyager.png
File325=warp.ogg
File326=warp2.ogg
File327=warpfield.ini
File328=weirdnoise.ogg
File329=woprchess.ogg
File33=2-1.pon
File330=woprgreetings.ogg
File331=woprshallwe.ogg
File332=woprside.ogg
File333=woprstrange.ogg
File334=working.ogg
File34=2-10.pon
File35=2-11.pon
File36=2-12.pon
File37=2-13.pon
File38=2-14.pon
File39=2-15.pon
File4=02n.png
File40=2-2.pon
File41=2-3.pon
File42=2-4.pon
File43=2-5.pon
File44=2-6.pon
File45=2-7.pon
File46=2-8.pon
File47=2-9.pon
File48=3.cir
File49=3-1.pon
File5=03d.png
File50=3-10.pon
File51=3-11.pon
File52=3-12.pon
File53=3-13.pon
File54=3-14.pon
File55=3-15.pon
File56=3-2.pon
File57=3-3.pon
File58=3-4.pon
File59=3-5.pon
File6=04d.png
File60=3-6.pon
File61=3-7.pon
File62=3-8.pon
File63=3-9.pon
File64=4.cir
File65=4-1.pon
File66=4-10.pon
File67=4-11.pon
File68=4-12.pon
File69=4-13.pon
File7=09d.png
File70=4-14.pon
File71=4-15.pon
File72=4-2.pon
File73=4-3.pon
File74=4-4.pon
File75=4-5.pon
File76=4-6.pon
File77=4-7.pon
File78=4-8.pon
File79=4-9.pon
File8=1.cir
File80=5.cir
File81=50d.png
File82=6.cir
File83=accessdenied.ogg
File84=alert.png
File85=armens.txt
File86=assimilate.ogg
File87=autodestructarmed.ogg
File88=beep1.ogg
File89=beep2.ogg
File9=10d.png
File90=beep3.ogg
File91=beep4.ogg
File92=beep5.ogg
File93=beep6.ogg
File94=beep7.ogg
File95=bl.gif
File96=bm.gif
File97=boom.ogg
File98=borg.gif
File99=borg.ogg
FileGroup1=Default Group
FileGroup10=Default Group
FileGroup100=Default Group
FileGroup101=Default Group
FileGroup102=Default Group
FileGroup103=Default Group
FileGroup104=Default Group
FileGroup105=Default Group
FileGroup106=Default Group
FileGroup107=Default Group
FileGroup108=Default Group
FileGroup109=Default Group
FileGroup11=Default Group
FileGroup110=Default Group
FileGroup111=Default Group
FileGroup112=Default Group
FileGroup113=Default Group
FileGroup114=Default Group
FileGroup115=Default Group
FileGroup116=Default Group
FileGroup117=Default Group
FileGroup118=Default Group
FileGroup119=Default Group
FileGroup12=Default Group
FileGroup120=Default Group
FileGroup121=Default Group
FileGroup122=Default Group
FileGroup123=Default Group
FileGroup124=Default Group
FileGroup125=Default Group
FileGroup126=Default Group
FileGroup127=Default Group
FileGroup128=Default Group
FileGroup129=Default Group
FileGroup13=Default Group
FileGroup130=Default Group
FileGroup131=Default Group
FileGroup132=Default Group
FileGroup133=Default Group
FileGroup134=Default Group
FileGroup135=Default Group
FileGroup136=Default Group
FileGroup137=Default Group
FileGroup138=Default Group
FileGroup139=Default Group
FileGroup14=Default Group
FileGroup140=Default Group
FileGroup141=Default Group
FileGroup142=Default Group
FileGroup143=Default Group
FileGroup144=Default Group
FileGroup145=Default Group
FileGroup146=Default Group
FileGroup147=Default Group
FileGroup148=Default Group
FileGroup149=Default Group
FileGroup15=Default Group
FileGroup150=Default Group
FileGroup151=Default Group
FileGroup152=Default Group
FileGroup153=Default Group
FileGroup154=Default Group
FileGroup155=Default Group
FileGroup156=Default Group
FileGroup157=Default Group
FileGroup158=Default Group
FileGroup159=Default Group
FileGroup16=Default Group
FileGroup160=Default Group
FileGroup161=Default Group
FileGroup162=Default Group
FileGroup163=Default Group
FileGroup164=Default Group
FileGroup165=Default Group
FileGroup166=Default Group
FileGroup167=Default Group
FileGroup168=Default Group
FileGroup169=Default Group
FileGroup17=Default Group
FileGroup170=Default Group
FileGroup171=Default Group
FileGroup172=Default Group
FileGroup173=Default Group
FileGroup174=Default Group
FileGroup175=Default Group
FileGroup176=Default Group
FileGroup177=Default Group
FileGroup178=Default Group
FileGroup179=Default Group
FileGroup18=Default Group
FileGroup180=Default Group
FileGroup181=Default Group
FileGroup182=Default Group
FileGroup183=Default Group
FileGroup184=Default Group
FileGroup185=Default Group
FileGroup186=Default Group
FileGroup187=Default Group
FileGroup188=Default Group
FileGroup189=Default Group
FileGroup19=Default Group
FileGroup190=Default Group
FileGroup191=Default Group
FileGroup192=Default Group
FileGroup193=Default Group
FileGroup194=Default Group
FileGroup195=Default Group
FileGroup196=Default Group
FileGroup197=Default Group
FileGroup198=Default Group
FileGroup199=Default Group
FileGroup2=Default Group
FileGroup20=Default Group
FileGroup200=Default Group
FileGroup201=Default Group
FileGroup202=Default Group
FileGroup203=Default Group
FileGroup204=Default Group
FileGroup205=Default Group
FileGroup206=Default Group
FileGroup207=Default Group
FileGroup208=Default Group
FileGroup209=Default Group
FileGroup21=Default Group
FileGroup210=Default Group
FileGroup211=Default Group
FileGroup212=Default Group
FileGroup213=Default Group
FileGroup214=Default Group
FileGroup215=Default Group
FileGroup216=Default Group
FileGroup217=Default Group
FileGroup218=Default Group
FileGroup219=Default Group
FileGroup22=Default Group
FileGroup220=Default Group
FileGroup221=Default Group
FileGroup222=Default Group
FileGroup223=Default Group
FileGroup224=Default Group
FileGroup225=Default Group
FileGroup226=Default Group
FileGroup227=Default Group
FileGroup228=Default Group
FileGroup229=Default Group
FileGroup23=Default Group
FileGroup230=Default Group
FileGroup231=Default Group
FileGroup232=Default Group
FileGroup233=Default Group
FileGroup234=Default Group
FileGroup235=Default Group
FileGroup236=Default Group
FileGroup237=Default Group
FileGroup238=Default Group
FileGroup239=Default Group
FileGroup24=Default Group
FileGroup240=Default Group
FileGroup241=Default Group
FileGroup242=Default Group
FileGroup243=Default Group
FileGroup244=Default Group
FileGroup245=Default Group
FileGroup246=Default Group
FileGroup247=Default Group
FileGroup248=Default Group
FileGroup249=Default Group
FileGroup25=Default Group
FileGroup250=Default Group
FileGroup251=Default Group
FileGroup252=Default Group
FileGroup253=Default Group
FileGroup254=Default Group
FileGroup255=Default Group
FileGroup256=Default Group
FileGroup257=Default Group
FileGroup258=Default Group
FileGroup259=Default Group
FileGroup26=Default Group
FileGroup260=Default Group
FileGroup261=Default Group
FileGroup262=Default Group
FileGroup263=Default Group
FileGroup264=Default Group
FileGroup265=Default Group
FileGroup266=Default Group
FileGroup267=Default Group
FileGroup268=Default Group
FileGroup269=Default Group
FileGroup27=Default Group
FileGroup270=Default Group
FileGroup271=Default Group
FileGroup272=Default Group
FileGroup273=Default Group
FileGroup274=Default Group
FileGroup275=Default Group
FileGroup276=Default Group
FileGroup277=Default Group
FileGroup278=Default Group
FileGroup279=Default Group
FileGroup28=Default Group
FileGroup280=Default Group
FileGroup281=Default Group
FileGroup282=Default Group
FileGroup283=Default Group
FileGroup284=Default Group
FileGroup285=Default Group
FileGroup286=Default Group
FileGroup287=Default Group
FileGroup288=Default Group
FileGroup289=Default Group
FileGroup29=Default Group
FileGroup290=Default Group
FileGroup291=Default Group
FileGroup292=Default Group
FileGroup293=Default Group
FileGroup294=Default Group
FileGroup295=Default Group
FileGroup296=Default Group
FileGroup297=Default Group
FileGroup298=Default Group
FileGroup299=Default Group
FileGroup3=Default Group
FileGroup30=Default Group
FileGroup300=Default Group
FileGroup301=Default Group
FileGroup302=Default Group
FileGroup303=Default Group
FileGroup304=Default Group
FileGroup305=Default Group
FileGroup306=Default Group
FileGroup307=Default Group
FileGroup308=Default Group
FileGroup309=Default Group
FileGroup31=Default Group
FileGroup310=Default Group
FileGroup311=Default Group
FileGroup312=Default Group
FileGroup313=Default Group
FileGroup314=Default Group
FileGroup315=Default Group
FileGroup316=Default Group
FileGroup317=Default Group
FileGroup318=Default Group
FileGroup319=Default Group
FileGroup32=Default Group
FileGroup320=Default Group
FileGroup321=Default Group
FileGroup322=Default Group
FileGroup323=Default Group
FileGroup324=Default Group
FileGroup325=Default Group
FileGroup326=Default Group
FileGroup327=Default Group
FileGroup328=Default Group
FileGroup329=Default Group
FileGroup33=Default Group
FileGroup330=Default Group
FileGroup331=Default Group
FileGroup332=Default Group
FileGroup333=Default Group
FileGroup334=Default Group
FileGroup34=Default Group
FileGroup35=Default Group
FileGroup36=Default Group
FileGroup37=Default Group
FileGroup38=Default Group
FileGroup39=Default Group
FileGroup4=Default Group
FileGroup40=Default Group
FileGroup41=Default Group
FileGroup42=Default Group
FileGroup43=Default Group
FileGroup44=Default Group
FileGroup45=Default Group
FileGroup46=Default Group
FileGroup47=Default Group
FileGroup48=Default Group
FileGroup49=Default Group
FileGroup5=Default Group
FileGroup50=Default Group
FileGroup51=Default Group
FileGroup52=Default Group
FileGroup53=Default Group
FileGroup54=Default Group
FileGroup55=Default Group
FileGroup56=Default Group
FileGroup57=Default Group
FileGroup58=Default Group
FileGroup59=Default Group
FileGroup6=Default Group
FileGroup60=Default Group
FileGroup61=Default Group
FileGroup62=Default Group
FileGroup63=Default Group
FileGroup64=Default Group
FileGroup65=Default Group
FileGroup66=Default Group
FileGroup67=Default Group
FileGroup68=Default Group
FileGroup69=Default Group
FileGroup7=Default Group
FileGroup70=Default Group
FileGroup71=Default Group
FileGroup72=Default Group
FileGroup73=Default Group
FileGroup74=Default Group
FileGroup75=Default Group
FileGroup76=Default Group
FileGroup77=Default Group
FileGroup78=Default Group
FileGroup79=Default Group
FileGroup8=Default Group
FileGroup80=Default Group
FileGroup81=Default Group
FileGroup82=Default Group
FileGroup83=Default Group
FileGroup84=Default Group
FileGroup85=Default Group
FileGroup86=Default Group
FileGroup87=Default Group
FileGroup88=Default Group
FileGroup89=Default Group
FileGroup9=Default Group
FileGroup90=Default Group
FileGroup91=Default Group
FileGroup92=Default Group
FileGroup93=Default Group
FileGroup94=Default Group
FileGroup95=Default Group
FileGroup96=Default Group
FileGroup97=Default Group
FileGroup98=Default Group
FileGroup99=Default Group
Group=Default Group
IconFile=
Library1=abextdrawing
Library10=camera
Library11=clipboard
Library12=core
Library13=daydream
Library14=encryption
Library15=fft
Library16=gestures
Library17=gps
Library18=http
Library19=javaobject
Library2=abwifi
Library20=json
Library21=livewallpaper
Library22=mediabrowser
Library23=mediacontroller
Library24=mimetype
Library25=notificationbuilder
Library26=oslibrary
Library27=phone
Library28=randomaccessfile
Library29=reflection
Library3=answercall
Library30=sensorextender
Library31=stringutils
Library32=threading
Library33=tts
Library34=webviewextras
Library35=sql
Library36=contentresolver
Library37=abftp
Library38=betterdialogs
Library39=okhttp
Library4=astro
Library40=nfc
Library41=nfcforeground
Library42=broadcastreceiver
Library43=network
Library5=audio
Library6=audiorecord
Library7=audiorecorder
Library8=byteconverter
Library9=calendar2
ManifestCode='This code will be applied to the manifest file during compilation.~\n~'You do not need to modify it in most cases.~\n~'See this link for for more information: http://www.basic4ppc.com/forum/showthread.php?p=78136~\n~' android:targetSdkVersion="10"~\n~AddManifestText(<uses-sdk android:minSdkVersion="4"/>~\n~<supports-screens ~\n~	android:xlargeScreens="true"~\n~	android:largeScreens="true" ~\n~    android:normalScreens="true" ~\n~    android:smallScreens="true" ~\n~    android:anyDensity="true"/>	)~\n~~\n~SetApplicationAttribute(android:icon, "@drawable/icon")~\n~SetApplicationAttribute(android:label, "$LABEL$")~\n~SetApplicationAttribute(android:theme, "@android:style/Theme.NoTitleBar")~\n~SetApplicationAttribute(android:hardwareAccelerated, "true") ~\n~~\n~AddApplicationText(<activity android:name=".main" android:label="LCARS UI">~\n~  <intent-filter>~\n~    <action android:name="android.intent.action.MAIN"/>~\n~    <category android:name="android.intent.category.LAUNCHER"/>~\n~    <category android:name="tv.ouya.intent.category.GAME"/>~\n~  </intent-filter>~\n~</activity>)~\n~~\n~AddApplicationText(<activity android:name=".main">~\n~    <intent-filter>~\n~        <action android:name="com.google.android.gms.actions.SEARCH_ACTION"/>~\n~        <category android:name="android.intent.category.DEFAULT"/>~\n~    </intent-filter>~\n~</activity>)~\n~AddActivityText(main,  <intent-filter>~\n~  <action android:name="com.google.android.gms.actions.CREATE_NOTE" />~\n~  <category android:name="android.intent.category.DEFAULT" />~\n~  <data android:mimeType="*/*" />~\n~</intent-filter>)~\n~~\n~AddApplicationText(<activity android:name=".main">~\n~    <intent-filter>~\n~        <action android:name="android.intent.action.SET_TIMER"/>~\n~        <category android:name="android.intent.category.DEFAULT"/>~\n~    </intent-filter>~\n~</activity>)~\n~~\n~AddApplicationText(<activity android:name=".main">~\n~    <intent-filter>~\n~        <action android:name="android.intent.action.SET_ALARM"/>~\n~		<action android:name="android.intent.action.SHOW_ALARMS"/>~\n~		<action android:name="android.intent.action.DISMISS_ALARM"/>~\n~        <category android:name="android.intent.category.DEFAULT"/>~\n~    </intent-filter>~\n~</activity>)~\n~~\n~AddApplicationText(<application>~\n~  <activity android:name="StartRunActivity" android:label="computer">~\n~      <intent-filter>~\n~          <action android:name="android.intent.action.MAIN" />~\n~          <category android:name="android.intent.category.LAUNCHER" />~\n~      </intent-filter>~\n~  </activity>~\n~</application>)~\n~~\n~AddReceiverText(stimer,~\n~    <intent-filter>~\n~        <action android:name="android.intent.action.SEND" />~\n~        <category android:name="com.google.android.voicesearch.SELF_NOTE" />~\n~    </intent-filter>)~\n~'AddReceiverText(stimer, <intent-filter>~\n~' <action android:name="android.bluetooth.device.action.ACL_CONNECTED"/>~\n~' <action android:name="android.bluetooth.device.action.ACL_DISCONNECTED"/>~\n~' </intent-filter>)~\n~~\n~AddApplicationText(<service~\n~        android:label="LCARS UI LWP" ~\n~        android:name="anywheresoftware.b4a.objects.WallpaperInternalService"~\n~        android:permission="android.permission.BIND_WALLPAPER">~\n~        <intent-filter>~\n~            <action android:name="android.service.wallpaper.WallpaperService" />~\n~        </intent-filter>~\n~        <meta-data android:name="android.service.wallpaper" android:resource="@xml/wallpaper" />~\n~</service>)~\n~AddApplicationText(<service~\n~            android:name="anywheresoftware.b4a.objects.DreamServiceWrapper"~\n~            android:exported="true"~\n~            android:label="LCARS UI DD">~\n~            <intent-filter>~\n~                <action android:name="android.service.dreams.DreamService" />~\n~                <category android:name="android.intent.category.DEFAULT" />~\n~            </intent-filter>~\n~			<meta-data android:name="android.service.dream" android:resource="@xml/my_dream" />~\n~           </service>)~\n~		   ~\n~		   ~\n~~\n~AddPermission(android.permission.MODIFY_AUDIO_SETTINGS)~\n~AddPermission(com.android.alarm.permission.SET_ALARM)~\n~'AddPermission(android.permission.BLUETOOTH)~\n~~\n~AddManifestText(<uses-feature android:name="android.hardware.location.gps" android:required="false"/>)~\n~AddManifestText(<uses-feature android:name="android.hardware.location" android:required="false"/>)~\n~AddManifestText(<uses-feature android:name="android.hardware.microphone" android:required="false"/>)~\n~AddManifestText(<uses-feature android:name="android.hardware.camera" android:required="false"/>)~\n~AddManifestText(<uses-feature android:name="android.hardware.location.NETWORK" android:required="false"/>)~\n~AddManifestText(<uses-feature android:name="android.hardware.touchscreen" android:required="false"/>)~\n~AddManifestText(<uses-feature android:name="android.hardware.location.gps" android:required="false"/>)~\n~~\n~AddReplacement(<uses-permission android:name="android.permission.READ_SMS"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.RECEIVE_SMS"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.WRITE_SMS"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.ACCESS_LOCATION_EXTRA_COMMANDS"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="jp.co.c_lis.permission.CHANGE_LOCALE"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/>, <!-- -->)~\n~~\n~AddReplacement(<uses-permission android:name="android.permission.CHANGE_NETWORK_STATE"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.READ_PHONE_STATE"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.ACCESS_COARSE_UPDATES"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/>, <!-- -->)~\n~~\n~AddReplacement(<uses-permission android:name="android.permission.REBOOT"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.DUMP"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.BATTERY_STATS"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.KILL_BACKGROUND_PROCESSES"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.GET_TASKS"/>, <!-- -->)~\n~~\n~AddReplacement(<uses-permission android:name="android.permission.WRITE_CALENDAR"/>, <!-- -->)~\n~~\n~AddActivityText(main,~\n~<intent-filter>~\n~  <action android:name="android.nfc.action.NDEF_DISCOVERED" />~\n~  <category android:name="android.intent.category.DEFAULT" />~\n~  <data android:mimeType="text/plain" />~\n~</intent-filter>)~\n~~\n~AddActivityText(main, <meta-data android:name="com.amazon.input.cursor" android:value="pointer"/>)~\n~~\n~AddReceiverText(stimer,~\n~    <intent-filter>~\n~		'voice recognition~\n~        <action android:name="android.intent.action.SET_ALARM"/>~\n~		<action android:name="android.intent.action.SET_TIMER" />~\n~		<action android:name="android.intent.action.SHOW_ALARMS" />~\n~		<action android:name="com.google.android.gms.actions.SEARCH_ACTION"/>~\n~        <category android:name="android.intent.category.DEFAULT"/>~\n~    </intent-filter>)~\n~AddReceiverText(stimer,~\n~    <intent-filter>~\n~		<action android:name="android.intent.action.SEND" />~\n~        <category android:name="com.google.android.voicesearch.SELF_NOTE" />~\n~    </intent-filter>)~\n~~\n~AddReceiverText(stimer, ~\n~<intent-filter>~\n~	'inter-app communications~\n~    <action android:name="com.omnicorp.lcarui" />~\n~		~\n~	'music players~\n~	<action android:name="com.android.music.metachanged" />'stock music player~\n~	<action android:name="com.miui.player.metachanged" />'MIUI music player~\n~ 	<action android:name="com.htc.music.metachanged" />'HTC music player~\n~ 	<action android:name="com.nullsoft.winamp.metachanged" />'WinAmp~\n~ 	<action android:name="com.real.IMP.metachanged" />'MyTouch4G~\n~	<action android:name="com.amazon.mp3.metachanged" />'Amazon~\n~    <action android:name="fm.last.android.metachanged"/>'last.fm~\n~    <action android:name="com.sec.android.app.music.metachanged"/>'~\n~    <action android:name="com.sonyericsson.music.metachanged"/>'Sony Ericsoon~\n~    <action android:name="com.rdio.android.metachanged"/>'rdio~\n~    <action android:name="com.samsung.sec.android.MusicPlayer.metachanged"/>'Samsung~\n~    <action android:name="com.andrew.apollo.metachanged"/>'~\n~</intent-filter>)'This code will be applied to the manifest file during compilation.~\n~'You do not need to modify it in most cases.~\n~'See this link for for more information: http://www.basic4ppc.com/forum/showthread.php?p=78136~\n~' android:targetSdkVersion="10"~\n~AddManifestText(<uses-sdk android:minSdkVersion="4"/>~\n~<supports-screens ~\n~	android:xlargeScreens="true"~\n~	android:largeScreens="true" ~\n~    android:normalScreens="true" ~\n~    android:smallScreens="true" ~\n~    android:anyDensity="true"/>	)~\n~~\n~SetApplicationAttribute(android:icon, "@drawable/icon")~\n~SetApplicationAttribute(android:label, "$LABEL$")~\n~SetApplicationAttribute(android:theme, "@android:style/Theme.NoTitleBar")~\n~SetApplicationAttribute(android:hardwareAccelerated, "true") ~\n~~\n~AddApplicationText(<activity android:name=".main" android:label="LCARS UI">~\n~  <intent-filter>~\n~    <action android:name="android.intent.action.MAIN"/>~\n~    <category android:name="android.intent.category.LAUNCHER"/>~\n~    <category android:name="tv.ouya.intent.category.GAME"/>~\n~  </intent-filter>~\n~</activity>)~\n~~\n~AddActivityText(main,  <intent-filter>~\n~  <action android:name="com.google.android.gms.actions.CREATE_NOTE" />~\n~  <action android:name="com.google.android.gms.actions.SEARCH_ACTION"/>~\n~  <action android:name="android.intent.action.SET_TIMER"/>~\n~  <action android:name="android.intent.action.SET_ALARM"/>~\n~  <category android:name="android.intent.category.DEFAULT" />~\n~  <data android:mimeType="*/*" />~\n~</intent-filter>)~\n~~\n~AddApplicationText(<application>~\n~  <activity android:name="StartRunActivity" android:label="computer">~\n~      <intent-filter>~\n~          <action android:name="android.intent.action.MAIN" />~\n~          <category android:name="android.intent.category.LAUNCHER" />~\n~      </intent-filter>~\n~  </activity>~\n~</application>)~\n~~\n~AddReceiverText(stimer,~\n~    <intent-filter>~\n~        <action android:name="android.intent.action.SEND" />~\n~        <category android:name="com.google.android.voicesearch.SELF_NOTE" />~\n~    </intent-filter>)~\n~	~\n~~\n~AddApplicationText(<service~\n~        android:label="LCARS UI LWP" ~\n~        android:name="anywheresoftware.b4a.objects.WallpaperInternalService"~\n~        android:permission="android.permission.BIND_WALLPAPER">~\n~        <intent-filter>~\n~            <action android:name="android.service.wallpaper.WallpaperService" />~\n~        </intent-filter>~\n~        <meta-data android:name="android.service.wallpaper" android:resource="@xml/wallpaper" />~\n~</service>)~\n~AddApplicationText(<service~\n~            android:name="anywheresoftware.b4a.objects.DreamServiceWrapper"~\n~            android:exported="true"~\n~            android:label="LCARS UI DD">~\n~            <intent-filter>~\n~                <action android:name="android.service.dreams.DreamService" />~\n~                <category android:name="android.intent.category.DEFAULT" />~\n~            </intent-filter>~\n~           </service>)~\n~		   ~\n~		   ~\n~AddPermission(android.permission.MODIFY_AUDIO_SETTINGS)~\n~'AddPermission(com.android.alarm.permission.SET_ALARM)~\n~~\n~AddManifestText(<uses-feature android:name="android.hardware.location.gps" android:required="false"/>)~\n~AddManifestText(<uses-feature android:name="android.hardware.location" android:required="false"/>)~\n~AddManifestText(<uses-feature android:name="android.hardware.microphone" android:required="false"/>)~\n~AddManifestText(<uses-feature android:name="android.hardware.camera" android:required="false"/>)~\n~AddManifestText(<uses-feature android:name="android.hardware.location.NETWORK" android:required="false"/>)~\n~AddManifestText(<uses-feature android:name="android.hardware.touchscreen" android:required="false"/>)~\n~~\n~AddReplacement(<uses-permission android:name="android.permission.READ_SMS"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.RECEIVE_SMS"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.WRITE_SMS"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.ACCESS_LOCATION_EXTRA_COMMANDS"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="jp.co.c_lis.permission.CHANGE_LOCALE"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/>, <!-- -->)~\n~~\n~AddReplacement(<uses-permission android:name="android.permission.CHANGE_NETWORK_STATE"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.READ_PHONE_STATE"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.ACCESS_COARSE_UPDATES"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/>, <!-- -->)~\n~~\n~AddReplacement(<uses-permission android:name="android.permission.REBOOT"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.DUMP"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.BATTERY_STATS"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.KILL_BACKGROUND_PROCESSES"/>, <!-- -->)~\n~AddReplacement(<uses-permission android:name="android.permission.GET_TASKS"/>, <!-- -->)~\n~~\n~AddReplacement(<uses-permission android:name="android.permission.WRITE_CALENDAR"/>, <!-- -->)~\n~~\n~AddActivityText(main,~\n~<intent-filter>~\n~  <action android:name="android.nfc.action.NDEF_DISCOVERED" />~\n~  <category android:name="android.intent.category.DEFAULT" />~\n~  <data android:mimeType="text/plain" />~\n~</intent-filter>)~\n~~\n~AddReceiverText(stimer,~\n~    <intent-filter>~\n~		'voice recognition~\n~        <action android:name="android.intent.action.SET_ALARM"/>~\n~		<action android:name="android.intent.action.SET_TIMER" />~\n~		<action android:name="android.intent.action.SHOW_ALARMS" />~\n~		<action android:name="com.google.android.gms.actions.SEARCH_ACTION"/>~\n~        <category android:name="android.intent.category.DEFAULT"/>~\n~    </intent-filter>)~\n~AddReceiverText(stimer,~\n~    <intent-filter>~\n~		<action android:name="android.intent.action.SEND" />~\n~        <category android:name="com.google.android.voicesearch.SELF_NOTE" />~\n~    </intent-filter>)~\n~~\n~AddReceiverText(stimer, ~\n~<intent-filter>~\n~	'inter-app communications~\n~    <action android:name="com.omnicorp.lcarui" />~\n~		~\n~	'music players~\n~	<action android:name="com.android.music.metachanged" />'stock music player~\n~	<action android:name="com.miui.player.metachanged" />'MIUI music player~\n~ 	<action android:name="com.htc.music.metachanged" />'HTC music player~\n~ 	<action android:name="com.nullsoft.winamp.metachanged" />'WinAmp~\n~ 	<action android:name="com.real.IMP.metachanged" />'MyTouch4G~\n~	<action android:name="com.amazon.mp3.metachanged" />'Amazon~\n~    <action android:name="fm.last.android.metachanged"/>'last.fm~\n~    <action android:name="com.sec.android.app.music.metachanged"/>'~\n~    <action android:name="com.sonyericsson.music.metachanged"/>'Sony Ericsoon~\n~    <action android:name="com.rdio.android.metachanged"/>'rdio~\n~    <action android:name="com.samsung.sec.android.MusicPlayer.metachanged"/>'Samsung~\n~    <action android:name="com.andrew.apollo.metachanged"/>'~\n~</intent-filter>)
Module1=LCAR
Module10=STimer
Module11=LCARSeffects6
Module12=Weather
Module13=Eval
Module14=LCARSeffects4
Module15=Widgets
Module16=CameraExClass
Module17=LCARSeffects2
Module18=Trig
Module19=LCARSeffects7
Module2=Tropes
Module20=LCARSeffects
Module21=LCARSeffects5
Module22=What3Words
Module23=btimer
Module24=HttpJob
Module25=BING
Module26=HttpUtils2Service
Module27=cPDF2Text
Module3=DreamService
Module4=Games
Module5=Wireframe
Module6=LCARSeffects3
Module7=GPlus
Module8=API
Module9=WallpaperService
NumberOfFiles=334
NumberOfLibraries=43
NumberOfModules=27
Version=9
@EndOfDesignText@
#Region Module Attributes
	#FullScreen: True
	#IncludeTitle: False
	#ApplicationLabel: LCARS
	#VersionCode: 340
	#VersionName: 2.3.40
	#SupportedOrientations: unspecified
	#CanInstallToExternalStorage: True
	#additionaljar: com.android.support:support-v4
#End Region

'https://developer.android.com/guide/components/intents-common.html#AdbIntents

'shields, beep 7, beep 4

'https://www.youtube.com/watch?v=y7wj3bB6OU4

'Remove a permission
'AddManifestText(<uses-feature android:name="android.hardware.location.gps" android:required="false"/>
                '<uses-feature android:name="android.hardware.camera.autofocus" android:required="false"/>)

'To-do list:
'	TACTICAL consoles
'	Sickbay
'	Games: Tongo, Warpath/Booby Trap
'	video recording
'	more widgets (personal log)
'	http://www.starbase-10.de/vld/
'	Activity log
'	events widget issue
'	bottom left elbow issue

'Bugs:
'	keyboard cancel button doesn't work

'fonts http://www.starfleet.4mg.com/fonts/
Sub Process_Globals
	'These global variables will be declared once when the application starts.
	'These variables can be accessed from all modules. 
	
	Type Sensor(Device As PhoneSensors, Name As String, SensorType As Int, ThreeValues As Boolean, IsPresent As Boolean,X As Int, Y As Int, Z As Int,  MaxValue As Float )
	Dim SensorList As List, SensorEnabled As Boolean , Pi As Double,SelectedSetting As Double,LastURL As String ,LCARSpeed As Int,ServerIP As IPaddress ,InsuranceRemaining As Int
	Dim A As AudioRecorder, myWifi As ABWifi,waitingforwifi As Boolean,turnedwifion As Boolean ,CurrSensor As Int,GPSitems As Int,StarshipID As String ,SettingIndex As Int  'virtual sensors
	Dim ExDraw As ABExtDrawing, NoDecimals As Boolean ,CurrentSensor2 As Int ,rACC(3) As Float, TMF As Int, FFTMode As Byte, ListColors(6) As Int 
	Dim Hotspots As List ,WifiIsOn As Boolean,LoadingWifi As Boolean,WifiSearching As Boolean,WifiSearchCycles As Int,WifiSuccess As Int  ,TechnisMAC As String ,DOSITEM As Int, MenuSection As Int
	Type Hotspot(Name As String,Mac As String, Checked As Boolean , isCurrent As Boolean)' ,  Data As ABWifiInfo)
	
	Dim Settings As Map, MicEnabled As Boolean ,micrunning As Boolean ,BackToQuit As Boolean ,cTimer As Int ,TimerCount As Int,needsreloading As Boolean ,AprilFools As Boolean ,AcceptOnlyNumbers As Boolean 
    Dim Server As ServerSocket,SelectedSection As Int ,CurrentSection As Int,UMRsection As Int'-3=stardate, -2=settings, -1=mode select
	Dim Socket1 As Socket, AStreams As AsyncStreams, GPS1 As GPS, GPSenabled As Boolean ,SocketConnected As Boolean ,Keytones As Boolean ,KeyToneIndex As Int, UMRURL As String ,UMRDOWNLOADING As Boolean ,HasShown As Boolean 
	Dim MagicURL As String, MyURL As String , VR As VoiceRecognition,VRisInitialized As Boolean,IsVoiceCommand As Boolean ,IsLoading As Boolean, doCRLF As Boolean    ', TTS1 As TTS
	Dim BorgPic As Int = -1, BorgSound As Int = -1, BorgMode As Int, BorgFontSize As Int = 24,needsborgswap As Boolean ,BorgElement As Int 'rgb 0,120,0
	Dim OkudaMode As Int, MouseStage As Int ,DefaultPort As Int,Screenshots As Boolean ,MultiCore As Boolean ,SkipIntro As Byte  ,UID As String  ,Starshipname As String ,DOS As Int
	Dim Password As String, CMD() As String, RepeatMode As Boolean ,RAWmode As Boolean , LastVersion As String , WarpCoreRumble As Boolean ,IsAsking As Int , IsAskingID As Int
	
	Dim GameMode As Boolean, Buttons(15) As Byte , ButtonsChanged As Boolean ,CurrentSensor As Int,PlusID As String ,PageToken As String ,WebMode As Int,MaxSearchCycles As Int ,CurrentSettingsSection As Int 
	
	Dim AR As AudioRecord, BufferSize As Int, SampleRate As Int, ChannelConfig As Int, AudioFormat As Int, AudioSource As Int, NoChnls As Int,BitsPerSample As Int,DataSize As Long,  StartTime As Long, PasswordLocked As Boolean ,AudioFile As String ,Subtitles As StringBuilder , IsRecording As Boolean 
	Dim FREQSuccess As Boolean,FREQGotData As Boolean
	
	Dim VRQuestionID As Int, theSMSMessages As List ,LastContact As String ,LastUMRsection As Int,WasWebviewVisible As Boolean ,LastExecuted As Long ,YourName As String,MenuEnabled As Boolean  ',QuestionAsked As Boolean
	Dim TTSisReady As Boolean ,SpeakText As String , Telnet As APIKeyboard ,DoSectionToast As Boolean ,ButtonMenu As Int=-1,IsServer As Boolean ,Shutdowntime As Long ,ModeSelect As Boolean ,CurrentSound As Int =-1,LogSound As Int = -1
	
	Dim Translator As BING ,ContactDelays As List, ContactStage As Int  ,doshuffle As Boolean ,HeadsetAction As Int ,ScreenOrientation As Int ,CurrentScreenOrientation As Int =-1
	
	Dim TwitterJob As HttpJob, TrekJob As HttpJob ,LastFrame As Long, FrameDelay As Int = DateTime.TicksPerSecond / 5
	Dim Lightpackmode As Boolean ,  LightpackCMD As String, GPSStarted As Long    ', lightproxyURL As String 
	
	Dim SysVRini As Map, AwaitingAnswer As Boolean, AllowVRecOffline As Boolean, WasAVREC As Boolean, Educational As Map, WorkingDate As Long, LastBack As Long, SuppressFile As String ', BackPressed As Boolean
	
	Dim Chooser As ContentChooser, OnMyMark As String, BigOptions As Boolean, SectionLocked As Boolean, TTSIsSpeaking As Boolean, BDmode As Byte, Obfuscated As Boolean, WasMenuOpen As Boolean, ShowSubBridges As Boolean 
	
	Dim Ph As Phone, SDKversion As Int = Ph.SdkVersion, VRCMD As String, CurrentDir As String, FTP As ABFTP, StoredIntent As Intent, TimerMain As Timer, MP2 As MediaPlayer, TimerSec As Timer ', FTP As FTP '(needs NET library)
End Sub
Sub Globals
	'These global variables will be redeclared each time the activity is created.
	'These variables can only be accessed from this module.
	Dim BG As Canvas, TimerBlink As Long,G As Gestures,NeedsShowFrame As Boolean,Record As Thread, Phone1 As PhoneEvents
	Dim TTS1 As TTS', TTS1 As ICOSTextToSpeech
	'Dim myWIFI_Test As ToggleWifiData:myWIFI_Test.Initialize 
	
	Dim webview1 As WebView, MyWebViewExtras As WebViewExtras, ACLpanel As Panel, camEx As CameraExClass, BD As BetterDialogs, FileScroller As ScrollView ' ACL As AdvancedCamera
	If webview1.IsInitialized  =False Then webview1.Initialize("webview1")
	Phone1.Initialize("Phone")
	'InitTTS(True)
	If SDKversion >= 10 Then 
		Dim NfcF As NfcForeground, NFC1 As NFC
		NFC_EnableForeground
	End If
End Sub
Sub DelayedPlay
	If TimerSec.IsInitialized Then 
		TimerSec.Interval = API.BluetoothDelay
	Else 
		TimerSec.Initialize("TimerSec", API.BluetoothDelay)
		MP2.Initialize
	End If
	MP2.Load(File.DirAssets, "hum.ogg")
	MP2.SetVolume(1,1)
	MP2.Play
	TimerSec.Enabled=True 
End Sub
Sub TimerSec_Tick
	MP2.Stop
	TimerSec.Enabled=False
	LCAR.MP.Play
End Sub

Sub ActivityFinish(Why As String)
	LogColor("Finish: " & Why, Colors.Red)
	Activity.Finish 
End Sub

Sub JobDone (Job As HttpJob)
	Dim HTML As String, Bypass As Boolean 
	Select Case Job.JobName
		Case "BING.AUTH", "BING.TRANS", "umrserver", "WebPage": Bypass = True 
	End Select
	API.CurrentJob = Job 
	If Job.Success Or Bypass Then
		If Job.Success Then HTML = Job.GetString
	 	Select Case Job.JobName
			Case "filelist"
				If CurrentSection = 71 Then 
					ShowSettingsSection(-36)
					API.HandleFiles(3, Job.URL, Job.GetString)
				End If 
			Case "Twitter":		GPlus.GetTwitterAccessToken(Job.GetString)
			Case "w3w": 		What3Words.ProcessWords(Job.GetString)
				
			Case "tropes"
				Tropes.JobDone(Job.URL, HTML)
				
			Case "BING.AUTH", "BING.TRANS"
				If Job.Success Then
					Translator.JobDone(Job.JobName, HTML)
				Else
					Translator.Failed(True, Job.ErrorMessage)
				End If
				
			Case "System"
				If ParseHTML( API.GetBetween(HTML, "[" & StarshipID & "]", "[END]")) Then
					ParseHTML( API.GetBetween(HTML, "[ALL]", "[END]"))
				Else
					ParseHTML( API.GetBetween(HTML, "[ELSE]", "[END]"))
				End If
			
			Case "plusreplies"
				If GPlus.ParseReplies("", GPlus.CwActivity, GPlus.CwReply, True) And CurrentSection=15 Then
					BrowseWeb(DebugActivity,1)
					LCAR.LCAR_SetElementText(66, LCARSeffects2.RandomENT, API.GetString("back")) 
				End If	
			
			Case "Facebook":	GPlus.GetFacebookAccessToken(HTML)
			Case "Twitter":		GPlus.GetTwitterAccessToken(HTML)
			Case "soho":		If CurrentSection=39 Then LCARSeffects3.HandleJobDone(Job.URL, 97)
			
					
			Case "plus"
				If  CurrentSection=15  Then
					API.Move(webview1,  Activity, 0,50,0,0)
					webview1.Visible=True'
					If Not(Job.Success) Then
						'LCARSeffects.ShowPrompt(BG, 12, "ERROR",  "PAGE FAILED TO DOWNLOAD. IS WIFI TURNED OFF?" , -1, "I PROMISE", "")
						HTML = API.MakeErrrorPage(LastURL,Job.ErrorMessage)
						HTML=API.MakeHTML(HTML)
						webview1.loadurl(HTML)
					Else
						'webview1.LoadHtml("<FONT COLOR=WHITE>" & DebugActivity(GPlus.ParseActivityFeed( HttpUtils.GetString( GPlus.PostsURL(PlusID,PageToken) ))) )
						'webview1.LoadHtml( LCARSeffects2.PreCARSFrame("blue", "TEST<BR>TEST<BR>TEST","https://lh6.googleusercontent.com/-pelflrfhuKQ/AAAAAAAAAAI/AAAAAAAAAAA/dv5mpuqaMWA/s48-c-k/photo.jpg" ) &  LCARSeffects2.PreCARSFrame("red", DebugActivity(GPlus.ParseActivityFeed( HttpUtils.GetString( GPlus.PostsURL(PlusID,PageToken) ))), "https://lh6.googleusercontent.com/-pelflrfhuKQ/AAAAAAAAAAI/AAAAAAAAAAA/dv5mpuqaMWA/s48-c-k/photo.jpg") )
						
						'webview1.LoadHtml( LCARSeffects2.PreCARSFrame("red", DebugActivity(GPlus.ParseActivityFeed( HttpUtils.GetString( GPlus.PostsURL(PlusID,PageToken) )),0), "https://lh6.googleusercontent.com/-pelflrfhuKQ/AAAAAAAAAAI/AAAAAAAAAAA/dv5mpuqaMWA/s48-c-k/photo.jpg") )
						'webview1.LoadUrl ( DebugActivity )
						BrowseWeb(DebugActivity,1)
						GPlus.GetReplies(GPlus.CwActivity) 
						If GPlus.isGplus=0 Then  LCAR.LCAR_SetElementText(66, LCARSeffects2.RandomENT, "BACK")'replies
					End If
				End If
			Case "umrserver"', "lightproxy"
				If Job.Success Then
					HTML =  "UMR.ZIP"
					Job.SaveFile(File.DirRootExternal , HTML)
					LCAR.LCAR_SetElementText( 40, API.GetStringVars("umrserver_success", Array As String(File.DirRootExternal.ToUpperCase & "/" & HTML)), "")
				Else
					LCAR.LCAR_SetElementText( 40, API.GetString("umrserver_failure"), "")
				End If
			Case "WebPage"
				If CurrentSection<> 999 Then
					If Not(Job.Success) Then
						SetElement18Text(API.GetString("webpage_failure"))
						HTML = API.MakeErrrorPage(LastURL,Job.ErrorMessage)
					Else
						'HTML = HttpUtils.GetString(HttpUtils.SuccessfulUrls.GetKeyAt(0))
						HTML = API.ParseHTML(HTML , API.durl)
						SetElement18Text(API.Title.Replace(" - ", CRLF))
						Settings.Put("Title", API.Title)
					End If
					If LCAR.CurrentStyle = LCAR.LCAR_ENT Then
						HTML=API.MakeHTMLFile(HTML)
					Else
						ShowFrame(True,True)
						HTML=API.MakeHTML(HTML)
					End If
					webview1.loadurl(HTML & API.aHREF )
					AddHistoryItem(HTML, API.Title, 16    , "History", API.BaseHref)
					ShowBrowser
				End If
			Case "MSDS"
				SetElement18Text(API.GetString("msds_success"))
				EnumMSDs(HTML)
			Case "MSDS2"
				EnumMSDs2(HTML)
			Case "MSD"
				HTML = SetMSD(Job.URL)
				'HTML = API.GetSide(HTML, "/", False, False)
				'HTML = API.GetSide(HTML, "?", True, False)
				'HTML = HTML.Replace("%5B", "[").Replace("%5D", "]")
				'LCAR.ToastMessage(BG, HTML.ToUpperCase & " DOWNLOADED", 3)
				'Msgbox("MSD NAME = '" & HTML & "'" & CRLF & "URL = '" & HttpUtils.SuccessfulUrls.GetKeyAt(0) & "'", "THESE SHOULD NOT BE BLANK")
				
				If Job.SaveFile(LCAR.DirDefaultExternal, HTML) Then
					Games.ImagePackDone(HTML)
				Else
					LCAR.ToastMessage(BG, API.GetStringVars("msds_failure", Array As String(HTML)), 3)
				End If
				
				IsLoading=False

			Case "ogg"'april fools conversation recordings
				HTML = Job.URL
				Job.SaveFile(LCAR.DirDefaultExternal, MSDname(HTML))
				If API.IsTimerRunning(4) =-2 Then 'make sure it waited 2 seconds
					LCAR.PlaySoundfile("", MSDname(HTML), False)
					ToastSound(SpeakText)
				End If

			Case "ini"'download april fools conversations ini'If API.IsConnected Then HttpUtils.Download("ini", "http://sites.google.com/site/programalpha11/home/lcars/sysvr.ini?attredirects=0&d=1")
				HTML = Job.URL
				Job.SaveFile(LCAR.DirDefaultExternal, "sysvr.ini")
				LoadSysVRini
			
			Case "file"
				HTML = Job.URL
				Job.SaveFile(LCAR.DirDefaultExternal, MSDname(HTML))
				LCAR.ToastMessage(BG, API.GetStringVars("file_success", Array As String(MSDname(HTML))), 2)
				
			
			Case Else:			Log(Job & ": " & HTML)
		End Select
	Else
		Log("FAILED: " & Job.ErrorMessage)
	End If
	Job.release
End Sub


Sub SetupVariables
	LCARSpeed=10
	MenuSection=-1
	Pi = 3.14159265358979
	SensorEnabled=False'if = true then randomizes sensor data
	MyURL="http://sites.google.com/site/neotechni/Home/"
	MagicURL=MyURL & "lcars/magic"
	UMRURL=MyURL & "programs/UltraMobileRemote.zip?attredirects=0&d=1"
	DefaultPort= 8080
	TechnisMAC="20:13:e0:5c:4c:f2"
	CurrentSensor=-1
	SelectedSection=-999
	PlusID="113296486298236709829"
	MaxSearchCycles=50
	ServerIP=API.ParseIP("192.168.0.1:8080")
	ServerIP.SelectedOctet=1
	
	GPlus.APIkey = ""
	GPlus.FacebookClientID = ""  
	GPlus.FacebookClientSecret = ""
	GPlus.TwitterThumb = MyURL & "lcars/icon.jpg?attredirects=0"
	GPlus.EncodeTwitterConsumerKeyAndSecret("","")
	
	AprilFools=IsAprilFools
	LCAR.VolInc = 250
	'LoadSettings (False)
	GPS1.Initialize("GPS")
End Sub

Sub HandleSetting(VariableName As String, CurrentValue As Object , DefaultValue As Object, Save As Boolean )As Object
	Return API.HandleSetting(VariableName,CurrentValue,DefaultValue,Save)
End Sub

Sub GetVersion As String 
	Dim PM As PackageManager 
	Return PM.GetVersionName(API.MyPackage) 
End Sub

Sub VRQuestion(QuestionID As Int) As Boolean
	If QuestionID>0 Then
		VRQuestionID=QuestionID
		Return VRListen
	End If
End Sub
Sub VRListen As Boolean 
	If Not(VRisInitialized) Then 
		VR.Initialize("VR")
		VRisInitialized=True
	End If
	VR.Prompt = API.GetString("vr_prompt")
	Select Case VRQuestionID
		Case 1,2: VR.Prompt = API.GetString("vr_password")
	End Select
	If VR.IsSupported And (API.IsConnected Or AllowVRecOffline) Then 'or allow voice rec. when offline
		LCAR.DontHide = True
		VR.Listen
		Return True
	Else
		LCAR.ToastMessage(BG, API.GetString("vr_notavailable"), 3)
	End If
	Return False
End Sub

Sub SetupAprilFoolsMode(Mode As Boolean)
	AprilFools = Mode
	LCAR.GetElement(27).ElementType = API.IIF(AprilFools, LCAR.SBALLS_Plaid, LCAR.LCAR_Navigation)'forward navigation scan
	LCAR.GetElement(57).ElementType = API.IIF(AprilFools, LCAR.DRD_Matrix, LCAR.LCAR_Matrix) 'federation database
	LCAR.GetElement(64).ElementType = API.IIF(AprilFools, LCAR.BTTF_Flux, LCAR.LCAR_Engineering)'warp core status
	LCAR.GetElement(70).Text = API.IIF(AprilFools, "π", "Ω"):LCARSeffects2.OmegaNeedsInit=True'omega
	LCAR.GetElement(77).ElementType = API.IIF(AprilFools, LCAR.LCAR_LSOD, LCAR.LCAR_Static) 'disconnected
	LCAR.GetElement(83).RWidth = API.IIF(AprilFools,1,0)
	LCAR.GetElement(86).RWidth = API.IIF(AprilFools,1,0)'environmental
	LCAR.GetElement(108).SideText = API.IIF(AprilFools, API.IIF(API.debugMode,"ufp", "tardis"), "voyager") & ".3d"
	
	LCARSeffects2.ForcedNumber = API.IIF(AprilFools,3,-1)
	
	LCAR.AddSound("1 MIN", API.IIF(AprilFools, "1minuteafm.ogg" , "1minute.ogg"), File.DirAssets)'sound 3 (1 minute remaining)
	LCAR.AddSound("10 SEC",API.IIF(AprilFools, "10secondsafm.ogg" , "10seconds.ogg"), File.DirAssets)'sound 4(10 seconds remaining)
	LCAR.AddSound("EMERGENCY", API.IIF(AprilFools, "shrinky.ogg", "timesup.ogg"), File.DirAssets)'sound 5(0 seconds remaining)
	LCAR.AddSound("DENIED", API.IIF(AprilFools, "noaccess.ogg", "accessdenied.ogg"), File.DirAssets)'sound 32 (access denied)
	
	LCAR.AddSound("REPLICATE", API.IIF(AprilFools, "makeityourself.ogg" , "notareplicator.ogg"), File.DirAssets)'sound 26 (not a replicator)
	LCAR.AddSound("BE POLITE",API.IIF(AprilFools, "onecredit.ogg" , "donotaddress.ogg"), File.DirAssets)'sound 27 (do not address this unit in that manner)
		
	LCAR.AddSound("TOSTRANS", API.IIF(AprilFools, "transporter3.ogg" , "transporter0.ogg"), File.DirAssets)' sound 34 (TOS transporter)
	LCAR.AddSound("TNGTRANS", API.IIF(AprilFools, "transporter4.ogg" , "transporter1.ogg"), File.DirAssets)' sound 35 (TNG transporter)
	LCAR.AddSound("VOYTRANS", API.IIF(AprilFools, "transporter5.ogg" , "transporter2.ogg"), File.DirAssets)' sound 36 (VOY transporter)

	If API.IsConnected And Mode Then API.Download("ini", "http://sites.google.com/site/emhbackupmodule/home/lcars") Else LoadSysVRini
End Sub
Sub PlayError
	LCAR.PlaySound(8, False)
End Sub
Sub VR_Handle(Text As String)As Boolean 
	Dim DidCommand As Boolean, temp As Int, DontShow As Boolean
	Text = Text.Trim.ToLowerCase
	If Text.Length = 0 Then Return False 
	Log("VR: " & Text)
	If RAWmode Then
		If Text= "stop" Then
			RAWmode=False
			RepeatMode=False
			LCAR.ToastMessage(BG, API.getstring("umr_disabled"), 3)
		Else
			SendText("umr "  & Text)
			If Text="disconnect" Then 
				DisconnectUMR
				Return False 
			End If
		End If
	Else If VRQuestionID <> 0 Then
		Select Case VRQuestionID
'			Case -1'Computer
'				CMD=Regex.Split(" ", Text)
'				Select Case CMD(0).ToLowerCase 
'					Case "call"
'						Text=API.right(Text, Text.Length - 5)
'						'If Not(API.SendCall( GetPhoneNickname( "", Text))) Then LCAR.ToastMessage(BG, "'" & Text & "' NOT RECOGNIZED", 2)
'					Case "text"
'						CMD(1)=API.right(Text, Text.Length - 5).ToUpperCase 
'						'CMD(0) = GetPhoneNickname( "", CMD(1))
'						If CMD(0).Length =0 Then
'							LCAR.ToastMessage(BG, "'" & CMD(0) & "' NOT RECOGNIZED", 2)
'						Else	
'							VRQuestion(2)
'							Return
'						End If
'					
'					Case Else
'						LCAR.ToastMessage(BG, "'" & Text.ToUpperCase & "' NOT RECOGNIZED", 2)
'				End Select
'			
'			Case 1'assign nickname to phone number
'				'GetPhoneNickname(LCAR.LCAR_GetListItem(3, LCAR.LCAR_SelectedItem).Text, Text)
'				LCAR.LCAR_GetListItem(3, LCAR.LCAR_SelectedItem).Side = Text.ToUpperCase 
'			Case 2'send text message
'				 API.SendTextMessage(CMD(0), Text)
'				'LCAR.ToastMessage(BG, API.IIF(	Text.ToUpperCase & , " WAS",  " WAS NOT" ) &  " SENT TO " & CMD(1), 3)
			Case 1'setpassword
				If API.TempPass.Length=0 Then
					API.TempPass = Text
					Return VRListen 
				Else
					LCAR.HideToast'("VR_Handle")
					If Text.EqualsIgnoreCase(API.TempPass) Then
						API.DeadmanPass=Text 
						LCAR.toastmessage(BG, "PASSWORD SET TO " & Text.ToUpperCase,3)
					Else
						LCAR.toastmessage(BG, "PASSWORD MISMATCH",3)
					End If
				End If
			Case 2'ask password
				Return HandlePassword(Text)
				
			Case Else
				Msgbox("UNHANDLED QUESTION ID: " & VRQuestionID & CRLF & "CONTACT THE DEVELOPER PLEASE", Text)
		End Select
		VRQuestionID=0
	Else
		DidCommand=True
		If Text.EndsWith("on my mark") Or Text.EndsWith("in my mark") Or Text.StartsWith("prepare to") Or Text.StartsWith("prepare 2") Then
			OnMyMark = API.RemoveWord(False, API.RemoveWord(False, Text, "on my mark"), "in my mark")
			OnMyMark = API.RemoveWord(True, API.RemoveWord(True, OnMyMark, "prepare to"), "prepare 2")
			LCAR.ToastMessage(BG,  "THE SYSTEM WILL '" & OnMyMark & "' ON YOUR MARK", 3)
			Return True
		End If 
		Select Case Text
			Case "access secure data file omega 1", "access secured data file omega 1"
				If DOS < 0 Then DOS = 9999
				ShowSection(-2,False)
			Case "light", "lights"
				Log("LET THERE BE LIGHT!")
				LCARSeffects4.CameraAction(2, "VR_Handle")
			Case "mark"
				If OnMyMark.Length>0 Then VR_Handle(OnMyMark) Else PlayError
			Case "download all files"
				DownloadAllVRECs
			Case "computer"
				VRQuestionID=-1
				VRListen
			Case "end program", "and program"
				ActivityFinish("VR: End program")
			Case "april fools mode", "april fools", "april fool", "refresh", "april fool's mode"
				SetupAprilFoolsMode(API.IIF(Text="refresh", True, Not(AprilFools)))
				LCAR.ToastMessage(BG, "APRIL FOOLS MODE WAS " & BoolToText(AprilFools), 3)
			Case "tea earl grey hot", "coffee black"
				DownloadAndPlay(LCAR.GetSound(26).Filename, 2) 'LCAR.PlaySound(26,False)
			Case "you suck", "fuck you", "screw you", "f*** you", "s***", "shit", "damn", "ass", "fuck", "f***", "bastard", "bitch", "cunt", "c***", "mother f*****", "mother fucker", "son of a bitch", "w****", "whore"
				DownloadAndPlay(LCAR.GetSound(27).Filename, 2) 'LCAR.PlaySound(27,False)
				If AprilFools Then Games.CARD_AddCash(-2)
			Case "jokes", "triggers", "phrases", "trigger phrases", "phrasing", "easter eggs"
				If Not(AprilFools) Then SetupAprilFoolsMode(True)
				BrowseMySite("triggers")
			Case "alarm", "alarms"
				ShowSection(37,False)
			Case "activate alarm"
				If AprilFools Then DownloadAndPlay("vrnotrec", 2) Else DidCommand=False
			Case "party time", "it's party time", "party mode", "come on guys it's party time"
				If Not(AprilFools) Then SetupAprilFoolsMode(True)
				LCAR.PartyTime = Not(LCAR.PartyTime)'Speak("alert status condition, party mode")
			Case "vrec", "listen", "v.rec"
				VRListen
			Case "menu", "menu button"
				If Not(WasMenuOpen) Then Activity_KeyPress(82)
				WasMenuOpen = False 

			Case Else
				If LCAR.IsKeyboardVisible(Null,-1,False) Then
					LCAR.SelectText(Text)
					LCAR.HideKeyboard(BG,10)
					LCAR.PushEvent(LCAR.LCAR_OK, LCAR.KBCancelID+5,0,0,0,0,0,0)
				Else If LCAR.IsNumboardVisible Then
					LCAR.ToastMessage(BG, FilterIP(Text) , 4)
				Else If LCARSeffects.IsPromptVisible(Null) Then
					If Text.EqualsIgnoreCase( LCAR.GetElement(LCARSeffects.PromptID+5).Text)  Then
						LCAR.PushEvent(LCAR.LCAR_Button, LCARSeffects.PromptID+5, 0,0,0,0,0,LCAR.Event_Down)
					Else If Text.EqualsIgnoreCase( LCAR.GetElement(LCARSeffects.PromptID+6).Text)  Then
						LCAR.PushEvent(LCAR.LCAR_Button, LCARSeffects.PromptID+6, 0,0,0,0,0,LCAR.Event_Down)
					Else If CurrentSection = 22 Then'personal log
						Subtitles.Append( API.IIF( Subtitles.Length=0 ,"", CRLF) & (DateTime.Now-StartTime) & "=" & Text)
						LCAR.ToastMessage(BG, Text,2)
					End If
				else if Text.StartsWith("start ") Or Text.StartsWith("stark ") Then 
					If Text.Contains("white") And Text.Contains("noise") Then 
						StartNardiAutomatic(Text)
						DidCommand = True 
					End If 
				Else
					Select Case Text
						Case "raw", "ultra mobile remote"
							RAWmode=True
							RepeatMode=True
						Case "mute", "on mute", "un mute"
							LCAR.mute= Not(LCAR.Mute)
						Case "disconnect"
							SendText("disconnect")
							DisconnectUMR
						Case "exit"
							ActivityFinish("VR: Exit")
						Case "back", "show mode select", "modi select", "mode select", "home", "go home"
							ShowModeSelect(0)
						Case "settings"
							ShowSettings(True,False)
						Case "screenshot", "screen shot", "print screen", "photo", "take screen shot", "take screenshot"
							TakeScreenshot
						Case "red alert", "condition red", "condition: red", "blue alert", "condition blue", "condition: blue"
							If Text.Contains("red") Then Text = "red" Else Text = "blue"
							Select Case CurrentSection
								Case 0,12,13,3,5,7,15,16,17,36,40,49,53
									LCAR.Toastmessage(BG, Text.ToUpperCase & " ALERT NOT SUPPORTED", 3)
								Case 10'alert condition status
									SwapMode(51,API.IIF(Text="red", -3, -4))
								Case Else
									LCAR.SetRedAlert(True, "VR " & Text & " alert")
									If Text = "blue" Then LCAR.RedAlertMode = LCAR.Classic_Blue
							End Select
						Case "green alert", "stand down", "stand down from red alert", "condition green", "condition: green"
							If CurrentSection=10 Then
								LCAR.Stop("Swapmode")
								SwapMode(51,-1)
							Else
								'Log("223")
								LCAR.SetRedAlert(False, "VR Alert condition status")
							End If
						Case "search"
							Activity_KeyPress(84)
						Case "help"
							If CurrentSection = 12 Then
								LCARSeffects2.HelpMode = Not(LCARSeffects2.HelpMode): LCAR.ClearScreen(Null)
							Else
								ShowSection(CurrentSection, True)
							End If
						Case "voice help"
							BrowseMySite("voice")
						Case "belay alarm", "cancel alarm", "delay alarm"
							API.BelayCurrentAlarm(True)
						Case "unbelay alarm", "uncancel alarm", "undelay alarm", "resume alarm"
							API.BelayCurrentAlarm(False)
						Case "belay timer", "cancel timer", "delay timer", "cancel auto destruct", "cancel self destruct", "delay auto destruct", "delay self destruct"
							API.BelayTimer(0)
							
						Case Else
							DidCommand=False
							CMD=Regex.Split(" ", Text)
							If API.Containsword(CMD, "alarm") Or API.Containsword(CMD, "alarms") Then
								DidCommand=	HandleAlarm(CMD, Text)
							Else If API.Containsword(CMD, "reminder") Or API.Containsword(CMD, "reminders") Or API.Containsword(CMD, "remind") Then
								DidCommand= HandleReminder(Text)
							Else If ContainsTime(Text) Then
								ProcessTime
								DidCommand=True		
							Else
								Select Case CurrentSection
									Case 0'intro
										Select Case Text
											Case "stop", "cancel", "abort", "ok"
												DidCommand=True
												ShowModeSelect(1)
										End Select
									
									Case 1,6,13, 14   'WIFI CHART, FORWARD NAVIGATION SCAN, ANALYSIS, WARP CORE STATUS
										LCAR.Toastmessage(BG, "VOICE CONTROL NOT SUPPORTED", 3)
										DidCommand=True
										
									Case -1 ' mode select
										SeedSectionList(0, "VREC", False)
										temp = LCAR.LCAR_FindListItem(0, Text, 0,False,-1)
										If temp=-1 Then
											DidCommand=True
											Text = Text.replace("navigation scam", "navigation scan")
											Select Case Text
												Case "wifi card", "why fight shark": Text = "wifi chart"
												Case "alert", "alerts condition", "alert conditions", "alerts confitions" : Text= "alert condition status"
												Case "sense or meters", "answer meters", "centermeters", "centimeters", "center meters" : Text= "sensor meters"
												Case "ford navigation scan", "navigation scan", "or work navigation scan", "forwarded navigation scan", "forwarded navigation scan": Text = "forward navigation scan"
												Case "what score status", "what course status", "work or stay here" , "work or status" : Text = "warp core status"
												Case "web browser": Text = "memory alpha browser"
												Case "an animation", "can animation", "dan animation", "damn animation" : Text = "scan animation"
												Case "autodestruct timer", "timer", "self destruct", "author distort", "author distort timer", "ir to distract timer", "art and destruct timer", "destruct timer": Text = "auto destruct timer"
												Case "ocu did graham generator", "ocu to grams generator", "ok food o gram", "ok cupid graham generator", "ok who did graham generator" : Text = "okudagram generator"
												Case "omega directed", "degrees of separation", "dos", "omega": Text= "omega directive"
												Case "three quincy": Text = "frequency"
												Case "personal lock", "personal blog": Text = "personal log"
												Case Else: DidCommand = False
											End Select
											If DidCommand Then temp = LCAR.LCAR_FindListItem(0, Text, 0,False,-1)
										End If
										If temp =-1 Then
											DidCommand=True
											Select Case API.Left(Text,3)
												Case "all": SeedSectionList(0, "ALL", True)
												Case "sen": SeedSectionList(1, "SEN", True)
												Case "fun": SeedSectionList(2, "FUN", True)
												Case "gam": SeedSectionList(3, "GAM", True )
												Case "nov", "oth": SeedSectionList(4, "OTH", True)
												Case "sys": SeedSectionList(5, "SYS", True)
												Case Else: DidCommand=False
											End Select
										Else
											If temp=7 Then
												LCAR.ToastMessage(BG, "UMR IS ALREADY RUNNING", 3)
											Else
												ShowSection(TranslateSection(temp), False)
											End If
											DidCommand=True
										End If
									
									Case 2  'SCAN ANIMATION
										DidCommand=True
										Select Case API.Left(Text, 3)
											Case "ran": ShowSensorScan(0)
											Case "acc": ShowSensorScan(1)
											Case "mag": ShowSensorScan(2)
											Case "ori": ShowSensorScan(3)
											Case "gyr": ShowSensorScan(4)
											Case Else: DidCommand=False
										End Select
									
									Case 3  'Sensor METERS
										DidCommand=True
										Select Case API.Left(Text, 3)
											Case "all": HandleSidebar(0)
											Case "mul": HandleSidebar(1)
											Case "men": HandleSidebar(2)
											Case Else: DidCommand=False
										End Select
									
									Case 4'timers NATIVE
										DidCommand=True
										If UMRsection<2 Then
											If ContainsTime(Text) Then
												ProcessTime
											Else
												Select Case Text
													Case "reset":					TimerAction(0)
													Case "start":					TimerAction(1)
													Case "save":					TimerAction(2)
													Case "delete":					TimerAction(3)
													Case "stardate", "star date":	TimerAction(4)
													Case Else
														Select Case CMD(0)
															Case "lock"
																PasswordLocked = True
																Text= "AUTO-DESTRUCT PASSWORD LOCKED"
															Case "unlock"
																PasswordLocked = False
																Text=  "AUTO-DESTRUCT PASSWORD UNLOCKED"
															Case "clear", "delete"
																If PasswordLocked Then 
																	Text= "AUTO-DESTRUCT PASSWORD LOCKED"
																Else
																	Password = ""
																	Text=  "AUTO-DESTRUCT PASSWORD ERASED"
																End If
															Case Else
																If Not(PasswordLocked) Then Password = Text
																Text=  "PASSWORD SET TO: " & Password.ToUpperCase
																SetElement18Text(Password.ToUpperCase)
														End Select
														LCAR.ToastMessage(BG, Text, 3)
												End Select
											End If
										Else'in timer
											If Password.EqualsIgnoreCase(Text) Then BelayTimer Else LCAR.ToastMessage(BG, "'" & Text.ToUpperCase & "' NOT RECOGNIZED" , 3)
										End If
										
									Case 5, 15  'MEMORY ALPHA BROWSER,CAPTAINS LOG
										DidCommand=True
										Select Case Text
											Case "top": MyWebViewExtras.pageup(webview1, True)
											Case "bottom":  MyWebViewExtras.pageDown(webview1, True)
											Case "page down", "who's down", "h down", "h town": MyWebViewExtras.pageDown(webview1, False)
											Case "page up", "who's up", "h up":MyWebViewExtras.pageup(webview1, False)
											Case "zoom in": MyWebViewExtras.zoomIn(webview1)
											Case "zoom out": MyWebViewExtras.zoomOut(webview1)
											Case "scroll down": MyWebViewExtras.flingScroll(webview1, 10, 0)
											Case "scroll down slow": MyWebViewExtras.flingScroll(webview1, 1, 0)
											Case "scroll up": MyWebViewExtras.flingScroll(webview1, -10, 0)
											Case "scroll up slow": MyWebViewExtras.flingScroll(webview1, -1, 0)
											Case Else
												If CurrentSection=15 Then
													Select Case CMD(0)
														Case "l", "elkhart", "my", "change", "log":									LoadGPlusFeed(0)
														Case "michael", "okuda", "scenic", "art", "supervisor", "super":			LoadGPlusFeed(1)
														Case "ronald", "moore", "more", "writer", "producer":						LoadGPlusFeed(2)
														Case "william", "bill", "shatner", "captain", "james", "kirk", "rocket":	LoadGPlusFeed(4)
														Case "wil", "wheaton", "will", "wesley", "crusher":							LoadGPlusFeed(16)
														Case "reload", "refresh", "back":											Activity_KeyPress(84)
														Case "list", "others", "lists", "other":									webview1.Visible = Not(webview1.Visible)
														Case Else: DidCommand=False
													End Select
												Else
													Select Case CMD(0)
														Case "clear"
															HistoryList(0)
														Case "load", "item", "open"
															temp = API.KillAllExceptNumbers(Text)
															If temp>0 Then	HistoryList(temp)
														Case "history"
															HistoryList(-1)
														Case "search"
															Text = Text.replace(" for " , " ").replace(" 4 " , " ")
															Text = API.Right(Text, Text.length -7 )
															Searchfor(Text)
														Case Else
															DidCommand=False
													End Select
												End If
										End Select
			
									Case 7  'UMR NATIVE
										IsVoiceCommand=True
										DidCommand=True
										If Not(UMRCommand(Text)) Then ShowUMRMenu(UMRsection) 
										
									Case 8  'TACTICAL
										DidCommand=True
										Select Case CMD(0)
											Case "listen", "connect"
												LCAR.ToastMessage(BG, "YOU ARE ALREADY CONNECTED", 3)
											Case "deploy"
												AddGPScoordinate(LCARSeffects.GetGPScoordinate(0))
											Case "probe"
												If IsNumber(CMD(1)) Then ' probe 1 = item 2
													CollectProbe( CMD(1)+1)
												Else
													DidCommand=False
												End If
											Case Else:DidCommand=False
										End Select
									
									Case 9  'Okudagram GENERATOR
										Select Case CMD(0)
											Case "toggle": 	OkudaDpad(-2)
											Case "center", "middle", "ok", "place", "click": OkudaDpad(-1)
											Case "up":		OkudaDpad(0)
											Case "right":	OkudaDpad(1)
											Case "down":	OkudaDpad(2)
											Case "left": 	OkudaDpad(3)
											
											'tools: get, set, auto
											'mode: blank, circle, square, slice, lines, bar
											'color: color1, color2, blink, 
										End Select
									
									Case 10 'ALERT CONDITION
										If Text.Contains("yellow") Then
											SwapMode(51,-2)
											DidCommand=True
										End If
									
									Case 11'Federation Database
										LCARSeffects2.LE_SeedText(Text.ToUpperCase)
									
									Case 12 'CLOCK
										DidCommand=True
										Select Case Text
											Case "refresh":			LCARSeffects2.StarshipsClean =False
											Case "clear":			LCAR.ClearScreen(Null)
											Case "path", "paths", "pass", "pack not" , "pat not", "ha not", "pats", "pants", "pat", "ha":	LCARSeffects2.DoPaths = Not(LCARSeffects2.DoPaths)
											Case Else:DidCommand=False
										End Select
									
									Case 16 'ANGRY TRIBBLES
									Case 17 'MEMORY ALLOCATION
									
									Case 22'Captains log 
										DidCommand=True
										Select Case Text
											Case "record": Activity_KeyPress(84)
											Case "play": HandleSidebar(0)
											Case "edit": HandleSidebar(1)
											Case "delete", "erase": HandleSidebar(2)
											Case Else:DidCommand=False
										End Select
									
									Case 24'calculator
									Case 42'translator
									Case 50'solar system
									
								End Select
							End If
					End Select
				End If
		End Select
	End If
	
	If Not(DidCommand) Then
		DidCommand=True
		Select Case CMD(0)
			Case "download"
				If Text.Contains(" dot ") Then 							
					Text = API.Right(Text, Text.Length - 9).Replace(" dot ", ".").ToLowerCase.Replace(" ", "")
					DownloadFile(1, Text, True, False)
				Else
					DidCommand=False
				End If
			Case "say", "speak": Speak( API.Right(Text, Text.Length-(CMD(0).Length+1) ))

			Case Else: DidCommand=False
		End Select
	End If
	
	If Not(DidCommand) And AprilFools And SysVRini.IsInitialized Then
		Select Case Text'remember, everything is lower case!
			Case "holy shit", "holy s***": SpeakText = "noshit"
			Case Else
				SpeakText = SysVRini.GetDefault(Text, "")
				If SpeakText.Length = 0 Then SpeakText = SysVRini.GetDefault(Eval.VReplace(Text, True), "")
		End Select
		
		
		Log("Play: " & Text & " - " & SpeakText)
		If SpeakText.Length>0 Then 
			DownloadAndPlay(SpeakText, 2)
			
			
			'If Not(SpeakText.Contains(".")) Then SpeakText=SpeakText & ".ogg"
			'If File.Exists(File.DirAssets,SpeakText) OR File.Exists(LCAR.DirDefaultExternal, SpeakText) Then
			'	API.NewTimer("Sound", 4, 2)
			'Else If API.IsConnected Then
			'	HttpUtils.Download("ogg", "http://sites.google.com/site/programalpha11/home/lcars/" & SpeakText & "?attredirects=0&d=1")
			'End If 
			DidCommand=True
			DontShow = True 
		End If
	End If
	
	If RepeatMode Then VRListen
	
	If Not(DidCommand) Then
		CMD=Regex.Split(" ", Text)
		If CMD.Length>2 Then
			If CMD(1) = "equals" And Not(IsNumber(CMD(0))) And Eval.CharType(CMD(0)) = Eval.ch_routine Then
				CMD=Regex.Split(" ", Text)
				Text = API.Right(Text, Text.Length - (8+CMD(0).Length))'   " equals "
				Eval.SetVariable(CMD(0), 0, True, 0, Text,False)
				LCAR.ToastMessage(BG, CMD(0) & " WAS SET TO " & Text, 3)
				Speak(CMD(0) & " WAS SET TO " & Text)
				DidCommand=True
			End If
		End If
	End If
	
	If Not(DidCommand) Then
		If Eval.IsAnEquation(Text) Then
			If Text.StartsWith("what is ") Then Text = API.right(Text, Text.Length - 8)
			If Text.StartsWith("what's ") Then Text = API.right(Text, Text.Length - 7)
			Text = Text.Replace(" x ", "*")
			SpeakText = Text 
			Eval.DoVoice=True
			Text =Eval.val(Text)'10-2=8
			Eval.DoVoice=False
			If Text.Length =0 Or Eval.EvalError.Length>0 Then 
				LCAR.ToastMessage(BG, SpeakText & " RESULTED IN AN ERROR", 3)
				If Eval.EvalError.Length>0 Then Speak(Eval.EvalError)
			Else
				LCAR.ToastMessage(BG, SpeakText & "=" & Text, 3)
				
				SpeakText = SpeakText.Replace("=", " equals ")	
				SpeakText = SpeakText.Replace("-", " minus ")			
				SpeakText = SpeakText.Replace("+", " plus ")
				SpeakText = SpeakText.Replace("*", " times ")
				SpeakText = SpeakText.Replace("/", " divided by ")
				SpeakText = SpeakText.Replace("^", " to the power of ")
				
				Speak(SpeakText & " is " & Text)
			End If
		Else If Text.StartsWith("computer ") Then
			DidCommand = VR_Handle(API.Right(Text, Text.Length - 9))
		Else If API.IsPackageInstalled("com.omnicorp.lcarui.launcher") Then
			API.BroadcastToLauncher("vrec", Text)
		Else
			LCAR.ToastMessage(BG, "'" & Text & "' WAS NOT RECOGNIZED", 3)
		End If
	End If
	If API.debugMode And Not(DontShow) Then LCAR.ToastMessage(BG, API.IIF(DidCommand, "", "NOT ") & "Recognized: " & Text, 4)
	WasAVREC=False
	Return DidCommand
End Sub

Sub DownloadAllVRECs
	Dim temp As Int, Files As List, tempstr As String = API.GetString("vr_internet_required")
	If Not(AprilFools) Then
		SetupAprilFoolsMode(True)
		tempstr= API.GetString("vr_restate_command")
	Else If SysVRini.IsInitialized And API.IsConnected Then
		Files.Initialize 
		For temp = 0 To SysVRini.Size - 1 
			tempstr = SysVRini.GetValueAt(temp)
			If Files.IndexOf(tempstr)=-1 And Not(tempstr.Contains(".")) Then 
				Files.Add(tempstr)
				DownloadAndPlay(tempstr, -1)
			End If
		Next
		tempstr=API.GetString("vr_download_all")
	End If
	LCAR.ToastMessage(BG, tempstr, 3)
End Sub

Sub HandleReminder(Text As String) As Boolean 
	Dim CMD() As String
	Text = Text.Replace("reminder to", "").Replace("reminder", "").Replace("reminders", "").Replace("reminder", "").replace("   ", " ").Replace("  ", " ")
	Log("REM: " & Text)
	CMD=Regex.Split(" ", Text)
	Select Case CMD(0)
		Case "add", "me", "and", "make", "create"
			Text = Text.Trim.ToUpperCase  
			Text = API.Right(Text, Text.Length - (CMD(0).Length + 1))
			Text = API.RemoveWord(True, Text, "A ")
			Text = API.RemoveWord(True, Text, "TO ")
			LCAR.ToastMessage(BG, "REMINDER ADDED: " & Text , 3)
			If CurrentSection = 62 Then SeedSetting(Text,Text,"")
			Return API.ReminderAction(0,Text)
		Case "delete", "erase", "clear", "remove", "finish", "complete"
			Text = API.KillAllExceptNumbers(Eval.VReplace(Text, True)) ' .Replace("to", "2")))
			If API.Containsword(CMD, "all") Or API.Containsword(CMD, "every") Then
				LCAR.ToastMessage(BG, "ALL REMINDERS DELETED", 3)
				Return API.ReminderAction(1, -1)
			Else If IsNumber(Text) And Text<> "0" Then
				LCAR.ToastMessage(BG, "REMINDER " & Text & " DELETED", 3)
				Return API.ReminderAction(1, Text-1) 
			Else
				Log(Text)
			End If
	End Select
End Sub

Sub HandleAlarm(Command() As String, Text As String) As Boolean 
	Dim Temp As Int=-1, temp2 As Int, tempstr As String = "STARTINGINTENT", DidIt As List 
	If Not(Text = tempstr) Then  
		Log("Alarm command processor: '" & Text & "'")
		If API.Containsword(Command, "delete") Or API.Containsword(Command, "remove") Then Temp = 0
		If API.Containsword(Command, "enable") Or API.Containsword(Command, "activate") Then Temp = 1
		If API.Containsword(Command, "disable") Or API.Containsword(Command, "deactivate") Then Temp = 2
		If API.Containsword(Command, "toggle") Or API.Containsword(Command, "reverse") Or API.Containsword(Command, "flip") Then Temp = 3
		If API.Containsword(Command, "turn") Or API.Containsword(Command, "switch") Then
			If API.Containsword(Command, "on") Then Temp = 1
			If API.Containsword(Command, "off") Then Temp = 2
			If Temp= -1 Then Temp = 3
		End If
		If Temp>-1 Then
			Text=API.IIFIndex(Temp, API.getstrings("alarm_action", 0))
			DidIt.Initialize 
			temp2=Temp
			For Temp = 0 To Command.Length-1 
				tempstr = Command(Temp)
				If tempstr.EqualsIgnoreCase("to") Then tempstr = "2"
				If IsNumber(tempstr) Then 
					If API.QuickAlarmAction(Settings, tempstr, temp2) Then DidIt.Add(tempstr)
				Else If tempstr.EqualsIgnoreCase("all") Then
					If API.QuickAlarmAction(Settings, -1, temp2) Then 
						DidIt.Add(tempstr)
					Else
						LCAR.ToastMessage(BG, API.getstring("alarm_none"), 3)
						Return True
					End If
				End If
			Next
			If DidIt.Size>0 Then 
				API.LoadSettings(True, BG)
				API.HandleAlarm(False)
				If CurrentSection = 37 Then ShowSection(37,False)'refresh
				If DidIt.Size= 1 Then
					If DidIt.Get(0) = "all" Then
						LCAR.ToastMessage(BG, API.GetStringVars("alarm_allwere", Array As String(Text)), 3)
					Else 
						LCAR.ToastMessage(BG,  API.GetStringVars("alarm_onewas", Array As String(DidIt.Get(0), Text)), 3)
					End If
				Else
					tempstr = DidIt.Get(0)
					For Temp = 1 To DidIt.Size-1
						tempstr = tempstr & API.IIF(Temp = DidIt.Size-1, " " & API.GetString("alarm_lastdel") & " ", API.GetString("alarm_manydel") & " ") & DidIt.Get(Temp)
					Next
					LCAR.ToastMessage(BG, API.GetStringVars("alarm_onewas", Array As String(tempstr, Text)), 3)
				End If
				Return True
			End If
		Else If API.Containsword(Command, "when") And API.Containsword(Command, "next") Then
			If STimer.AlarmTime>0 Then
				Text = API.GetStringVars("alarm_next", Array As String(API.GetDateVerbose(STimer.AlarmTime, False, False), API.GetTimeIn(STimer.AlarmTime - DateTime.Now, "WEEKS", "DAYS", "HOURS", "MINUTES", "SECONDS", "", " ")))
			Else
				Text = API.getstring("alarm_noneset")
			End If
			Speak(Text)
			LCAR.ToastMessage(BG, Text, 4)
			Return True
		End If
	End If 
	
	'initialize
	API.CWA.Initialize 
	API.AlarmIndex=-1
	API.CWA.Initialize 
	API.CWA.Repeats.Initialize 		
	For Temp = 1 To 7
		API.CWA.Repeats.Add(False)
	Next
	API.CWA.Enabled=True'Not(API.Containsword(Command, "disable")) AND Not(API.Containsword(Command,"disabled")) AND Not(API.Containsword(Command,"off"))
	API.CWA.SoundEnabled=True
	API.CWA.SoundID=38
	API.CWA.Hour = -1
	API.CWA.Minute= -1

	If Text = tempstr Then 
		'LogColor("GOOGLE ALARM: [" & API.Implode("][", Command) & "]", Colors.Magenta)'[3][0][2,3,4,5,6,7,1]
		API.CWA.Hour = Command(0)
		API.CWA.Minute = Command(1)
		If Command(2).Length>0 Then 
			Command = Regex.Split(",", Command(2))
			For Temp = 0 To Command.Length - 1
				API.CWA.Repeats.Set( Command(Temp)-1 , True)			
			Next
		End If 
	Else 
		'repeating
		If API.Containsword(Command, "tomorrow") Then API.CWA.Repeats.Set(DateTime.GetDayOfWeek(DateTime.Now) Mod 7, True)'automatically adds 1 day 
		If API.Containsword(Command, "after") And API.Containsword(Command, "tomorrow") Then API.CWA.Repeats.Set((DateTime.GetDayOfWeek(DateTime.Now)+1) Mod 7, True)
		If API.Containsword(Command, "sun") Or API.Containsword(Command, "son") Or API.Containsword(Command, "sunday") Then API.CWA.Repeats.Set(0, True)
		If API.Containsword(Command, "man") Or API.Containsword(Command, "mon") Or API.Containsword(Command, "monday") Then API.CWA.Repeats.Set(1, True)
		If API.Containsword(Command, "tues") Or API.Containsword(Command, "tuesday") Then API.CWA.Repeats.Set(2, True)
		If API.Containsword(Command, "wed") Or API.Containsword(Command, "wednesday") Then API.CWA.Repeats.Set(3, True)
		If API.Containsword(Command, "thurs") Or API.Containsword(Command, "thursday") Then API.CWA.Repeats.Set(4, True)
		If API.Containsword(Command, "fry") Or API.Containsword(Command, "fri") Or API.Containsword(Command, "friday") Then API.CWA.Repeats.Set(5, True)
		If API.Containsword(Command, "sat") Or API.Containsword(Command, "saturday") Then API.CWA.Repeats.Set(6, True)
		
		If API.Containsword(Command, "in") Or API.Containsword(Command, "from") Or API.Containsword(Command, "relative") Then'relative to now
			'days
			tempstr = GetWordRelative(Command, "days", 0, True, GetWordRelative(Command, "day", 0, True, ""))
			If IsNumber(tempstr) Then 
				Temp = DateTime.GetDayOfWeek(DateTime.Now) + tempstr
				If Temp > 7 Then Temp = Temp-7
				API.CWA.Repeats.Set(Temp, True)
				API.CWA.Hour = DateTime.GetHour(DateTime.Now)
				API.CWA.Minute = DateTime.GetMinute(DateTime.Now)
			End If
			'hours
			tempstr = GetWordRelative(Command, "hours", 0, True, GetWordRelative(Command, "hour", 0, True, ""))
			If IsNumber(tempstr) Then 
				API.CWA.Hour = (DateTime.GetHour(DateTime.Now) + tempstr) Mod 24
				API.CWA.Minute = DateTime.GetMinute(DateTime.Now)
			End If
			'minutes
			tempstr = GetWordRelative(Command, "minutes", 0, True, GetWordRelative(Command, "minute", 0, True, ""))
			If IsNumber(tempstr) Then 
				If API.CWA.Hour = -1 Then API.CWA.Hour = DateTime.GetHour(DateTime.Now)
				API.CWA.Minute = (DateTime.GetMinute(DateTime.Now) + tempstr)
				If API.CWA.Minute>60 Then
					API.CWA.Hour = API.CWA.Hour + Floor(API.CWA.Minute / 60)
					API.CWA.Minute = API.CWA.Minute Mod 60
				End If
			End If
		Else'absolute time
			For Temp = 0 To Command.Length-1 
				tempstr = Command(Temp)
				If Temp < Command.Length-1 Then'combine 00 into this
					If Command(Temp+1) = "00" And IsNumber(tempstr) Then
						tempstr = tempstr & ":00"
						Command(Temp+1) = ""
					End If
				End If
				If tempstr.Contains(":") And IsNumber(tempstr.Replace(":", "")) Then'a.m. / p.m. (a.m. is assumed)
					API.CWA.Hour = API.GetSide(tempstr, ":", True, False)
					API.CWA.Minute = API.GetSide(tempstr, ":", False, False)
					If API.Containsword(Command, "p.m.") Then API.CWA.Hour = API.CWA.Hour + 12
				Else If IsNumber(tempstr) Then'24 hour/military time
					If API.Containsword(Command, "p.m.") Then
						API.CWA.Hour = tempstr + 12
						API.CWA.Minute = 0
					Else If API.Containsword(Command, "a.m.")  Then
						API.CWA.Hour = tempstr
						API.CWA.Minute = 0
					Else If Text.Contains("o'clock") Then
						API.CWA.Hour = tempstr
						API.CWA.Minute = 0
						If DateTime.GetHour(DateTime.Now) >= 12 Then API.CWA.Hour = API.CWA.Hour + 12
					Else
						API.CWA.Hour = Floor(tempstr / 100)
						API.CWA.Minute = tempstr Mod 100
					End If
				Else
					Select Case tempstr
						Case "midnight"
							API.CWA.Hour = 0
							API.CWA.Minute = 0
						Case "noon"
							API.CWA.Hour = 12
							API.CWA.Minute = 0
					End Select
				End If
			Next
		End If
	End If 
	
	'final error checking
	API.CWA.Hour = API.CWA.Hour Mod 24
	API.CWA.Minute = API.CWA.Minute Mod 60
	Log("MAKE ALARM: " & API.CWA)
	
	'save data, show results
	If API.CWA.Hour>-1 And API.CWA.Minute>-1 Then 
		API.SaveAlarm(Settings)
		API.LoadSettings(True, BG)
		STimer.CurrentAlarm = -1 
		STimer.AlarmTime =0
		API.HandleAlarm(False)
		If CurrentSection = 37 Then ShowSection(37,False)'refresh
		LCAR.ToastMessage(BG, API.GetStringVars("alarm_new", Array As String(API.PadtoLength(API.CWA.Hour,True,2,"0"), API.PadtoLength(API.CWA.Minute,True,2,"0"), API.DaysOfWeek(API.CWA,True), API.IIF(API.CWA.enabled, "", " (" & API.GetString("alarm_action2") & ")"))) , 4)
		Return True
	Else
		LCAR.ToastMessage(BG, API.GetString("vr_alarm_insufficient"), 3)
		'LCAR.ToastMessage(BG, "'" & Text & "'", 3)
		LCAR.SystemEvent(3, 7)
	End If
End Sub
Sub GetWordRelative(Text() As String, Word As String, Start As Int, LeftSide As Boolean, Default As String) As String 
	Return API.GetWordRelative(Text,Word,Start,LeftSide,Default)
End Sub

'SiteIndex: 0=emhbackupmodule, 1=programalpha11, 2=vkwidgetskins
Sub DownloadFile(SiteIndex As Int, Filename As String, Overwrite As Boolean, Suppress As Boolean) As Boolean 
	Dim Site As String 
	If API.IsConnected And File.ExternalWritable Then 
		If File.Exists(LCAR.DirDefaultExternal, Filename) And Not(Overwrite) Then Return False
		Site = API.IIFIndex(SiteIndex, Array As String("emhbackupmodule", "programalpha11", "vkwidgetskins"))
		API.Download("file", "http://sites.google.com/site/" & Site & "/home/lcars/" & Filename & "?attredirects=0&d=1")
		If Suppress Then SuppressFile = Filename Else SuppressFile = ""
		Return True
	End If
End Sub

Sub ToastSound(Sound As String)
	Dim temp As Int = LCAR.LCAR_TNG, Length As Int = Ceil(LCAR.MP.Duration / 1000), Text As String =  " "
	If Not(SysVRini.IsInitialized) Then Return
	Select Case CurrentSection '= -1 	'whitelist: -1, -2,-3, 23, 36, 35, 32, 38, 41, 47, 51, 52, 1, 2, 3, 6, 8, 18, 
		Case 39,48,12,59,60,40,49,16,25,27,28,45,54,64'blacklist		
		Case Else
			Sound = SysVRini.GetDefault(Sound, "")
			If Sound.Length>0 Then 
				If Sound.Contains(":") Then
					Text = API.GetSide(Sound, ":", True, False)
					Sound = API.GetSide(Sound, ":", False, False)
				End If
				If Sound.EndsWith(".png") Then
					LCAR.ToastImage(BG, Sound, Length)
				Else
					Select Case Sound.ToUpperCase.Replace(" ", "")
						Case "ENTERPRISE":				temp=LCAR.LCAR_ENT
						Case "TOS": 					temp=LCAR.LCAR_TOS
						Case "TMP": 					temp=LCAR.LCAR_TMP
						Case "KLINGON": 				temp=LCAR.Klingon
						Case "FERENGI": 				temp=LCAR.Ferengi
						Case "STARWARS": 				temp=LCAR.StarWars
						Case "CHRONOWERX": 				temp=LCAR.ChronowerX 
						Case "BATTLESTAR","GALACTICA": 	temp=LCAR.Battlestar
						Case "EVENTHORIZON":			temp=LCAR.EVENT_Horizon 
						Case "STARSHIPTROOPERS": 		temp=LCAR.StarshipTroopers
						Case "FREEDOMWARS": 			temp=LCAR.FreedomWars 
						Case "KNIGHTRIDER":				temp=LCAR.KnightRider
					End Select
					LCAR.CurrentStyle = temp
					LCAR.ToastMessage(BG, Text, Length)
				End If
			End If
	End Select
End Sub

Sub DownloadAndPlay(Sound As String, Delay As Int)
	Dim FileExists As Boolean, Site As String = "programalpha11" , Image As String 
	If Sound.Contains("-") Then
		Site = API.GetSide(Sound, "-", True, False)
		Sound = API.GetSide(Sound, "-", False, False)
	End If
	SpeakText=Sound
	If Not(SpeakText.Contains(".")) Then SpeakText=SpeakText & ".ogg"
	'image
	If SysVRini.IsInitialized Then
		Image = SysVRini.GetDefault(SpeakText, "")
		If Image.EndsWith(".png") And Image.Length>0 And Not(File.Exists(LCAR.DirDefaultExternal, Image)) Then DownloadFile(0, Image, False, True)
	End If
	'sound
	FileExists = File.Exists(File.DirAssets,SpeakText) Or File.Exists(LCAR.DirDefaultExternal, SpeakText)
	API.StopTimer(4)
	If Delay=0 And FileExists Then
		LCAR.PlaySoundfile("", SpeakText, False)
		ToastSound(SpeakText)
	Else If Delay>0 Then
		If (FileExists Or API.IsConnected) And Delay>0 Then API.NewTimer("Sound", 4, Delay)
		If Not(FileExists) And API.IsConnected Then 
			API.Download("ogg", "http://sites.google.com/site/" & Site & "/home/lcars/" & SpeakText & "?attredirects=0&d=1")
		End If
	End If 
	Log("DownloadAndPlay: " & SpeakText & " - " & Site & " - " & Sound & " - " & Delay & " - " & FileExists)
End Sub

Sub LoadSysVRini
	Dim tempstr() As String, temp As Int, Phrase As String , Filename As String , tempstr2() As String, temp2 As Int 
	If File.Exists(LCAR.DirDefaultExternal, "sysvr.ini") Then
		SysVRini.Initialize 
		tempstr = Regex.Split(CRLF, API.GetBetween(File.ReadString(LCAR.DirDefaultExternal, "sysvr.ini"), "<div dir=""ltr"">", "[END]").Replace("<br />", CRLF).Replace("</div>", "").Replace("<div>", ""))
		For temp = 0 To tempstr.Length - 1
			If Not(tempstr(temp).StartsWith("#")) And tempstr(temp).Length>0 Then
				If tempstr(temp).Contains("=") Then
					Phrase = API.GetSide(tempstr(temp), "=", True, False)
					Filename = API.GetSide(tempstr(temp), "=", False, False).Trim
				Else
					Phrase = tempstr(temp)
				End If
				If Phrase.Contains(",") Then
					tempstr2 = Regex.Split(",", Phrase)
					For temp2 = 0 To tempstr2.Length-1
						SysVRini.Put(tempstr2(temp2).Trim,Filename)
					Next
				Else
					SysVRini.Put(Phrase.Trim,Filename)
				End If
			End If
		Next
	End If
End Sub

Sub ContainsWords(Text As String, Words As List) As Boolean 
	Dim temp As Int 
	For temp = 0 To Words.Size - 1 
		If Text.Contains(Words.get(temp)) Then Return True 
	Next
End Sub
Sub ContainsTime(Text As String) As Boolean 
	Dim temp As Int
	If ContainsWords(Text, Array As String("minute", "second", "hour", "day", "plus", "minus", "timer", "destruct")) Then
		Return True
	Else
		For temp = 0 To CMD.Length -1
			If API.IsTime( CMD(temp) ) Then Return True
		Next
	End If
End Sub

Sub ProcessTime()'use cmd
	Dim RelativeMode As Int , CacheNumber As Float, Multiplier As Int, temp As Int, total As Int , Start As Int
	Start=1
	Select Case CMD(0)
		Case "add", "plus": RelativeMode= 1
		Case "minus", "subtract": RelativeMode=-1
		Case Else: Start=0
	End Select
	For temp = Start To CMD.Length-1
		Multiplier=0
		Select Case CMD(temp)
			Case "to": CMD(temp) = "2"
			Case "for": CMD(temp) = "4"
			Case "while": CMD(temp) = "12"		
			Case "half": CacheNumber = CacheNumber + 0.5	
			Case "quarter": CacheNumber = CacheNumber + 0.25	
			Case "third": CacheNumber = CacheNumber + 0.33	
		End Select
		If IsNumber(CMD(temp)) Then 
			CacheNumber = CMD(temp)
		Else If API.IsTime(CMD(temp)) Then
			total = API.ParseTime(CMD(temp))' * 60
		Else
			Select Case CMD(temp)
				Case "day", "days":						Multiplier = 86400
				Case "hour", "hours": 					Multiplier = 3600
				Case "min", "minute", "minutes":        Multiplier = 60
				Case "sex", "sec", "second", "seconds": Multiplier = 1
				Case "silent", "audio", "warning": 		LCAR.Volume(0, True)
			End Select
			If Multiplier>0 And CacheNumber>0 Then
				total = total + CacheNumber*Multiplier
			End If
		End If
	Next
	
	Select Case RelativeMode
		Case -1: cTimer = Max(0,  cTimer-total)'minus
		Case 0: 
			cTimer = total
			TimerAction(1)'set it
		Case 1: cTimer = cTimer+ total'add
	End Select
	
	If CurrentSection = 4 Then 
		SetElement18Text(API.GetTime(cTimer))
	Else 
		'ShowTimer(True)
		ShowSection(4, False)
	End If
End Sub


Sub VR_Result (Success As Boolean, Texts As List)
	Shutdowntime=DateTime.Now 
	VRCMD=""
	If API.ListSize(Texts) = 0 Then Success = False 
    If Success Then	VRCMD = API.lCase(Texts.Get(0))''VR_Handle(API.lCase(Texts.Get(0)))
	LCAR.ClearScreen(Null)
End Sub
Sub FilterIP(Text As String) As String 
	Dim temp As IPaddress ,temp2 As Long , tempstr() As String, Valid As Boolean  
	If Text.Contains("load") Then
		temp2=API.KillAllExceptNumbers(Text)-1
		If temp2>-1 Then
			temp= LCAR.LoadIP(BG, temp2 , Settings, ServerIP.Port)
			If temp.Octets(0) = 0 Then
				Return API.getstringvars("ip_notsaved", Array As String(temp))
			Else
				ServerIP=temp
				Return "IP: " & API.GetIP(ServerIP,True)
			End If
		Else
			Return API.getstringvars("ip_notsaved", Array As String(temp))
		End If
	Else If API.Left(Text,4) = "port" Or API.Left(Text,5) = "porch" Then
		ServerIP.Port = API.KillAllExceptNumbers(Text)
		LCAR.ResizeNumboard(BG, ServerIP, 4,True)
		Return "IP: " & API.GetIP(ServerIP,True)
	Else
		Select Case Text
			'Case "local host": Text = "127.0.0.1"
			Case "clear", "start", "start over", "first", "first octet", "home", "back": LCAR.HandleNumboard(BG,"FIRST", ServerIP, Settings): Return "FIRST"'first octet
			Case "help":				BrowseMySite("ip"): Return "HELP"
			Case "backspace":			LCAR.HandleNumboard(BG, KeyCodes.KEYCODE_DEL, ServerIP, Settings): Return "BKSP" 'backspace
			'Case "delete":				LCAR.HandleNumboard(BG, KeyCodes.KEYCODE_UNKNOWN, serverIP, Settings): Return "DEL"'Delete
			Case "prev", "previous": 	LCAR.HandleNumboard(BG,"PREV", ServerIP, Settings): Return "PREV"'Prev octet
			Case "next":				LCAR.HandleNumboard(BG,"NEXT", ServerIP, Settings): Return "NEXT"'Next octet
			Case "save", "safe":		If LCAR.SaveIP( ServerIP , Settings) Then Return API.getstring("ip_saved") Else Return API.getstring("ip_savedalready")
			Case "delete":				If LCAR.DeleteIP( LCAR.GetSavedIP(API.GetIP(ServerIP,False), Settings)  ,Settings) Then Return API.getstring("ip_deleted") Else Return API.getstring("ip_cantdelete")
		End Select
	End If
	temp = API.ParseIP(Text.Replace(" ", "").Replace("port", ":").Replace("period", ".").replace("mark", ".").Replace("dash", ".") )
	If temp.Octets(0) =0 Then
		'If IsNumber(Text) Then
		'	temp = API.SetOctet(serverIP, serverIP.SelectedOctet, Text)
		'	serverIP= LCAR.ResizeNumboard(BG, temp, serverIP.SelectedOctet +1,True) 
		'	Return "Was a number"
		'Else
			tempstr = Regex.Split("\.", Text)
			If tempstr.Length>0 Then
				temp = API.ParseIP( API.Getip( ServerIP,True) )
				For temp2 = 0 To tempstr.Length-1
					If IsNumber(tempstr(temp2)) Then
						Valid=True
						temp = API.SetOctet(temp, ServerIP.SelectedOctet, tempstr(temp2))
						ServerIP.SelectedOctet=Min(4 , ServerIP.SelectedOctet+1)
					End If
				Next
				If Valid Then
					ServerIP= LCAR.ResizeNumboard(BG, temp, ServerIP.SelectedOctet,True) 
					Return "IP: " & API.GetIP(ServerIP,True)
				End If
			End If
		'End If
	Else
		If temp.Port = 0 Then temp.Port = ServerIP.Port
		ServerIP= LCAR.ResizeNumboard(BG, temp, 4,True) 
		Return "IP: " & API.GetIP(ServerIP,True)
	End If
	Return API.getstringvars("ip_notrecognized", Array As String(Text))
End Sub
Sub UMRCommand(Text As String )As Boolean 
	Dim number As Int, temp As Int ,CommandID As Int, X As Int, Y As Int ,WasX As Boolean ,WasNeg As Boolean 
	If API.left(Text, 5) = "mouse" And Text.Length>6 Then Text = API.Right(Text, Text.Length-6)
	CMD = Regex.Split(" ", Text)
	number = API.KillAllExceptNumbers(Text)
	If GameMode Then
		Select Case CMD(0) 
			Case "disconnect", "quit", "exit": GameMode=False 
			
		End Select
	Else
		'ToastMessageShow(Text, True)
		Select Case CMD(0) 
			'system
			Case "help": BrowseMySite(7):CommandID=-1
			Case "type": SendText("sendtext " & API.Right(Text, Text.Length-5))
			Case "disconnect", "quit", "exit": DisconnectUMR:CommandID=-1:Return True
			Case "game": GameMode=True
			Case "stop": RepeatMode=False
			Case "repeat", "continuous", "infinite", "loop": RepeatMode = True
			
			'task switcher
			Case "switch"
				If CMD.Length>1 Then	
					Text = Text.Replace(" to ", " ")
					Text = API.Right(Text, Text.Length -7)
					CMD = Regex.Split(" ", Text)
					CommandID=6
				End If
			
			'mouse
			Case "left":   			CommandID=1	
			Case "middle","center": CommandID=2
			Case "right":  			CommandID=3
			Case "click"
				Select Case GetIndex(CMD, 1, "left")
					Case "left":   			CommandID=1
					Case "middle","center": CommandID=2
					Case "right":  			CommandID=3
				End Select
			Case "scroll"
				Select Case GetIndex(CMD, 1, "up")
					Case "up":     			CommandID=4
					Case "down":   			CommandID=5
				End Select
			Case "move"		
				CommandID=7
				For temp = 1 To CMD.Length -1
					number=10
					Select Case CMD(temp)
						Case "up", "north":   WasX=False: WasNeg=True
						Case "left", "west":  WasX=True: WasNeg=True
						Case "right", "east": WasX=True: WasNeg=False
						Case "down", "south": WasX=False: WasNeg=False	
						Case Else:		      If IsNumber(CMD(temp)) Then number = CMD(temp)
					End Select
					If WasX Then
						X= GetWasNegValue(WasNeg, number)
					Else
						Y= GetWasNegValue(WasNeg, number)
					End If
				Next

		End Select
		
		Select Case CommandID'buttons go in list 10
			Case -1'GNDN
			Case 0: 
				number = LCAR.LCAR_FindListItem(10, Text, 0,False,-1)
				If number=-1 Then
					LCAR.ToastMessage(BG, API.getstringvars("ip_notrecognized", Array As String(Text.ToUpperCase)), 4)
				Else
					SendText("exe " &  Text)
				End If 
			Case 1: SendText("mouse left")
			Case 2: SendText("mouse middle")
			Case 3: SendText("mouse right")
			Case 4: SendText("mouse scroll " & Max(1, number))'up
			Case 5: SendText("mouse scroll -" & Max(1,number))'down
			Case 6: SendText("task")
			Case 7: SendText("mouse " & X & " " & Y)
			Case 8: If ButtonsChanged Then SendText("g " & GetKeyState)'GameMode
		End Select
	End If
End Sub
Sub GetWasNegValue(WasNeg As Boolean, Value As Int )As Int
	Return API.IIF(WasNeg, -Value,Value)
End Sub
Sub GetIndex(Command() As String , Index As Int, Default As String) As String 
	If Index< Command.Length Then
		Return Command(Index)
	Else
		Return Default
	End If
End Sub
Sub TextContainsCommand(Windowtitle As String) As Boolean 
	Dim temp As Int 
	Windowtitle = Windowtitle.ToLowerCase 
	For temp = 0 To CMD.Length -1
		If CMD(temp).Length>0 Then
			Log(CMD(temp) & " | " & Windowtitle)
			If Not(Windowtitle.Contains(CMD(temp))) Then Return False
		End If
	Next
	Return True
End Sub


'Sub EnableMultiCore
	'Dim temp As Thread 
	'temp.Initialise("Thread")
	'temp.Start("MultiCoreDrawing")
	
	'Dim Params(0) As Object
	'temp.RunOnGuiThread("MultiCoreDrawing", Params)
	'temp.Sleep(10)
'End Sub
'Sub MultiCoreDrawing
'	DrawScreen(TimerMain.Interval)
'End Sub

Sub HideWebview
	Log("HIDE WEBVIEW")
	webview1.StopLoading 
	WasWebviewVisible=False
	webview1.Visible=False
	needsreloading=False
End Sub

Sub ResizeScreen
	Dim temp As Int,temp2 As Int ', Element As LCARelement 'Landscape As Boolean 
	'Landscape=Activity.Width>Activity.Height 
	If LCARSeffects.ispromptvisible(Null) Then
		If LCAR.IsKeyboardVisible(Null,0,False) Then temp=-999'LCARSeffects.PromptQID=-LCARSeffects.PromptQID

		LCARSeffects.ShowPrompt(BG, temp, "", "", LCARSeffects.PromptQID, "", "")
	Else
		If webview1.Visible Then MoveWebview
		'Msgbox(CurrentSection,"CurrentSection")
		If LCAR.IsNumboardVisible Then LCAR.ShowNumBoard(BG, ServerIP)
		Select Case CurrentSection
			Case -2,23,32,35,37, 38'Settings, resize the lists
				ResizeSetting(4)
			Case -1'main menu
				CurrentSection=-999
				ShowModeSelect(2)
				
			Case 0'intro, move the textbox
				LCAR.ForceElementData(3,  0, 50%y+40, 0,0, 100%x , LCAR.Fontsize,0,0,255,255,True,False)
			
			Case 5 'web browser
				needsreloading=True
			Case 7'UMR
				ResizeMouseStuff
			Case 9'Okudagram
				'move element 49
				temp =  200 * LCAR.GetScalemode '  API.IIF(LCAR.SmallScreen, 100,200) ', LCAR.TextWidth(BG, "COLOR DARK ORANGE"))
				LCAR.ResizeElement(49, 0,-temp,temp,temp,-temp,LCAR.ListItemsHeight(1),temp,temp)'button
				
				temp=Max(203, LCAR.TextWidth(BG, "COLOR  DARK ORANGE"))
				LCAR.ResizeElement(48, 0,0, temp-3,LCAR.ItemHeight, 0,0,temp-3,LCAR.ItemHeight)'TOGGLE UI button
				LCAR.ResizeList(14, temp, LCAR.ListItemsHeight(6), LCAR.TextWidth(BG, "DARK ORANGE"),0,0,False)
				HandleOkuda(-1)
				
				'listid 14.5
			Case 15,36' google plus
				'If WasWebviewVisible Then
					temp=API.IIF(CurrentSection=15,4,2)
					temp2= Floor((Activity.Width- temp*2) / temp)'width
					temp = 50 * Max(1, GetScalemodeFlt)'height
					MoveWebview 
					LCAR.MoveList(22,0, temp+2)
					
					LCAR.ResizeElement(65,      	0,0,    		temp2,temp,     0,0,   			temp2,temp)'EXIT
					If CurrentSection = 15 Then 'captains log
						LCAR.ResizeElement(66,     temp2+2,0,	 	temp2,temp,		temp2+2,0,		temp2,temp)'BACK
						LCAR.ResizeElement(67,     temp2*2+4,0,		temp2,temp,     temp2*2+4,0,	temp2,temp)'PRT SCR
						LCAR.ResizeElement(75,     temp2*3+6,0,		temp2,temp,		temp2*3+6,0,	temp2,temp)'FEEDS list
					Else
						LCAR.ResizeElement(92,     temp2+2,0,     	temp2,temp,     temp2+2,0,    	temp2,temp)'LWP Preview
					End If					
					needsreloading=True
				'	webview1.Visible=True
				'End If
			Case 16'Angry tribbles
				If Not(LCAR.Landscape) Then temp= LCAR.ScaleWidth * (LCAR.ScaleWidth /LCAR.ScaleHeight)
				LCAR.ResizeElement(69, 0,0,-1,-1,0,0,-1, temp)
			Case 17'PdP
				ResizeSetting(0)
				HideSideBar
			
			Case 40'battle of the mutara nebula
				Games.BMN_EnterSystem(BG,False)
				
			'Case 48'tricorder
				'If LCARSeffects4.TRI_Section = 0 Then SetupCamera
				
				
			Case 999'alarm
				ShowUFPLogo
		End Select
	End If
	LCAR.IsToastVisible(BG,True)
End Sub
Sub SmallScreenMode
	Dim Left As Int=100, Height As Int=130, Top As Int =115 ,Mode As Float =1, temp As Int, temp2 As Int ', Element As LCARelement
	If LCAR.SmallScreen Then
		Mode=0.5
		Left=50
		Height=65
		Top=102
	Else If LCAR.CrazyRez>0 Then
		Mode=LCAR.CrazyRez
		Left= 100 * Mode
		Top = LCAR.GetScaledPosition(3,False)' 182*Mode - LCAR.ListitemWhiteSpace 
		Height=Height*Mode '(165-17)*Factor - LCAR.ListitemWhiteSpace 
	End If
	LCAR.SmallScreenMode(-1)
	
	'Bottom, 0,0,       OneThird, 88*Factor
	'move a bunch of lists and elements
	LCAR.MoveList( 1,  0, LCAR.GetScaledPosition(4,False)) '(Top + 71*Mode) - LCAR.ChartEdgeHeight +  LCAR.ChartSpace)' 133)'wifi meters   0,257
	LCAR.MoveList( 2, Left+3, LCAR.GetScaledPosition(3,False))'sensor meters
	'LCAR.MoveList( 5, 53, 100)'timer stuff
	
	temp= API.iif(LCAR.CrazyRez=0, 132, 253*Mode + LCAR.ListitemWhiteSpace)
	LCAR.MoveList( 9,  0, temp)'tactical stuff

	'LCAR.MoveList(10, 53, 100)'UMR actions
	'LCAR.MoveList(11, 53, 100)'UMR tasks
	'LCAR.MoveList(12, 53, 100)'UMR main feature list
	'LCAR.MoveList(13, 53, 100)'UMR files
	
	'LCAR.MoveList(16, 53, 100)'history
	LCAR.MoveList(17,  0, 132)'sensor list
	'LCAR.MoveList(18, 53, 100)'analysis
	'LCAR.MoveList(20, 53, 100)'axis list
	
	'LCAR.MoveList(23, 53, 100)'personal logs
	'LCAR.MoveList(24, 53, 100)'calculator numpad
	'LCAR.MoveList(25, 53, 100)'calculator answers
	'LCAR.MoveList(26, 53, 100)'calculator questions
	
	'LCAR.MoveList(27, 53, 100)'comms	
	LCAR.GetElement(18).Align=69'text box
	
	ResizeGPS(GPSitems)
	LCAR.MoveLCAR(LCAR.KBCancelID+5, Left*2+5,0,0,0,0,True,False,False)'text box
	LCAR.MoveLCAR( 5,   Left+6, Top,   0,   0, 0, True, False, False)'sensor animation
	LCAR.MoveLCAR(19,  Left+6, Top,  -1,  Height-5, 0, True, True,  False)'big text (timer)
	LCAR.MoveLCAR(27,   Left+6, Top,   0,   0, 0, True, False, False)'FWD NAV SCAN
	LCAR.MoveLCAR(39,   Left+6, Top,   0,   0, 0, True, False, False)'tactical
	
	temp2=LCAR.ItemHeight
	temp=Min( Min(Activity.Width,Activity.Height)/4, 240*Mode)
	LCAR.MoveLCAR(58,    0, -temp2, temp,  temp2, 0, True, True,  False)'clock refresh (bottom left)
	LCAR.MoveLCAR(59, -temp, -temp2, temp,  temp2, 0, True, True,  False)'clock clear (bottom right)
	LCAR.MoveLCAR(60, -temp,   0, temp,  temp2, 0, True, True,  False)'clock paths (top right)
	LCAR.MoveLCAR(61,    0, 0, temp,  temp2, 0,False, True,  False)'clock help (top left)
	
	LCAR.MoveLCAR(63,   Left+3,   2,  -1,  Height, 0, True, True,  False)'sensor graph 
	LCAR.MoveLCAR(68,   Left+3,   2,  -1,  Height, 0, True, True,  False)'sensor sweep 
	LCAR.MoveLCAR(71,   Left+6, Top,   0,   0, 0, True, False, False)'multispectral
	LCAR.MoveLCAR(73,   Left+5,   2, Height,  Height, 0, True, True,  False)'shield status
	LCAR.MoveLCAR(74,   Left+6, Top,   0,   0, 0, True, False, False)'PdP
	'LCAR.MoveLCAR(77,   API.IIF(AprilFools,0, Left), API.IIF(AprilFools,0, Top),    0,0, 0, True, False, False)'Static
	LCAR.MoveLCAR(79,   0, LCAR.GetScaledPosition(4,False),   0,   0, 0, True, False, False)'microphone/frequency
	LCAR.MoveLCAR(82,   Left+3,   0,  -1,  Height, 0, True, True,  False)'random number block
	LCAR.MoveLCAR(84,   Left+6, Top,   0,   0, 0, True, False, False)'calculator graph
	LCAR.MoveLCAR(89,   Left+6,   0,   0,  LCAR.GetScaledPosition(0,False)+LCAR.LCARCornerElbow2.Height, 0, True, True,  False)'SCIENCE I
	LCAR.MoveLCAR(90,   Left+6,  Top ,   0,   0, 0, True, False, False)'SCIENCE II
	LCAR.MoveLCAR(97,   Left+6, Top,   0,   0, 0, True, False, False)'metaphasic shields
	LCAR.MoveLCAR(99, -150,-150, 150, 150, 0, True, False, False)'dpad in widget resizer
	LCAR.MoveLCAR(107, Left+6, Top,   0,   0, 0, True, False, False)'sensor animation
	LCAR.MoveLCAR(110, Left+6, Top,   0,   0, 0, True, False, False)'cards 
	LCAR.MoveLCAR(111, Left+6, 0,   -1,   Height, 0, True, True, False)'cards 2
	LCAR.MoveLCAR(112, Left+3, Top,   -1,  -1, 0, True, True, False)'plasma
	LCAR.MoveLCAR(113, Left+3, Top,   -1,  -1, 0, True, True, False)'pulaski
	AlignLists
End Sub

Sub AlignLists
	Dim temp As Int, Lists() As Int , Element As LCARelement 
	Lists = Array As Int(5,10,11,12,13,16,18,20,23,24,25,26,27 ) 
	LCAR.ClearScreen(BG)
	For temp = 0 To Lists.Length -1
		'If Not(LCARSeffects.MoveListY(Lists(temp) )) Then Return
		LCARSeffects.MoveListY(Lists(temp) )
	Next
	'Log("REALIGNED LISTS")
	
	'resize textboxes
	Lists = Array As Int(18) 
	For temp = 0 To Lists.Length -1
		If LCAR.LCARelements.Size>Lists(temp) Then
			Element= LCAR.LCARelements.Get(Lists(temp) )
			Element.Size.currY = LCAR.Fontsize 'LCAR.Fontfactor*0.01*LCAR.ItemHeight 
		End If
	Next
End Sub 

Sub ResizeMouseStuff
	Dim X As Int, Y As Int,W As Int, H As Int, Element As LCARelement 
	X= LCAR.GetScaledPosition(3,True)' API.IIF(LCAR.SmallScreen, 56,115)
	Y= LCAR.GetScaledPosition(3,False) 'API.IIF(LCAR.SmallScreen, 102,200)
	H= 100 * LCAR.GetScalemode '  API.IIF(LCAR.SmallScreen, 50,100)
	W=((Activity.width- H)/3)-3
	
	LCAR.ForceElementData(52, X, Y,0,0, -LCAR.ItemHeight, -(H+3),0,0,255,255,True,False)
	LCAR.ForceElementData(53, -LCAR.ItemHeight, Y,0,0, LCAR.ItemHeight, -(H+3),0,0,255,255,True,False)
	
	LCAR.ForceElementData(54, H+3, -H,0,0, W,H ,0,0,255,255,True,False)
	LCAR.ForceElementData(55, H+6+W, -H,0,0, W,H ,0,0,255,255,True,False)
	LCAR.ForceElementData(56, H+9+(W*2), -H,0,0, W,H ,0,0,255,255,True,False)
	
	X=(LCAR.ScaleWidth-2)/2
	Y= -LCAR.ItemHeight
	LCAR.ResizeElement(40, 0, Y, X, LCAR.ItemHeight, 0, Y,  -1, LCAR.ItemHeight)
	LCAR.ResizeElement(78, X+3, Y, X, LCAR.ItemHeight, 0, Y+Y-3, -1, LCAR.ItemHeight)
	Element= LCAR.GetElement(78)
	Element.LWidth = API.IIF(LCAR.Landscape, 0, LCAR.leftside)
	Element.RWidth = API.IIF(LCAR.Landscape, LCAR.leftside,0)

	'LCAR.MoveLCAR(40, 0,-LCAR.ItemHeight,X-1,LCAR.ItemHeight ,255, True,True,False)
	'LCAR.MoveLCAR(78, X+ 1,-LCAR.ItemHeight, X-1,LCAR.ItemHeight ,255, True,True,False)
End Sub


Sub SaveLWPsetting(SettingName As String, Value As Object, Get As Boolean) As Object 
	Return API.SaveLWPsetting(SettingName,Value,Get)
End Sub

Sub SelectedLWP(Mode As String) As String 
	Dim temp As Int
	temp = SaveLWPsetting(Mode, -1,True)
	If temp=-1 Then
		Return API.GetString("lwp_none")
	Else
		Return LWPLIST.Get(temp)
	End If
End Sub


Sub LoadSettings(Save As Boolean ) 
	If API.LoadSettings(Save, BG) Then
		AlignLists
	End If
End Sub









Sub StartWifiOver
	 Hotspots.Clear 
End Sub
Sub TurnWifiOn
	If waitingforwifi Then
		'If myWIFI_Test.isWIFI_enabled Then InitHotspots
		If API.isWIFI_enabled Then InitHotspots'ABLoadWifi
	Else If LoadingWifi Or WifiSearching Then 
		If CheckHotspots Then 
			If WifiSearching Then InitHotspots
		End If
	End If
End Sub

Sub StopWifi
	waitingforwifi=False
	WifiIsOn=False
	LoadingWifi=False
	WifiSearching=False
	'WifiSearchCycles=0
	'If turnedwifion Then
	'	myWIFI_Test.toggleWIFI
	'	Log("Wifi shut down")
	'Else
		'Log ("Stopping wifi enumeration")
	'End If
End Sub
Sub InitHotspots

	waitingforwifi=False
	'If Not(myWIFI_Test.isWIFI_enabled) Then
		'myWIFI_Test.toggleWIFI
		'SetElement18Text("ACTIVATING WIFI" & CRLF & "PLEASE STAND BY")
		'waitingforwifi=True
		'turnedwifion=True
	If Not( API.isWIFI_enabled) Then
		'SetElement18Text("PLEASE ACTIVATE WIFI")
		ShowNotConnected(API.GetString("no_wifi"))
		turnedwifion=False
		WifiSearching=False
		LoadingWifi=False
		Return
	Else If Not(Hotspots.IsInitialized ) Then 
		Hotspots.Initialize 
		'SetElement18Text("SCANNING..." & CRLF & "PLEASE STAND BY")
		WifiIsOn= myWifi.ABLoadWifi()
		WifiSearchCycles=0
		waitingforwifi= False
	Else
		WifiIsOn=myWifi.ABLoadWifi()
		'SetElement18Text("SCANNING...")
		WifiSearchCycles=0
	End If
	WifiSearching = True
	LoadingWifi=True
End Sub

Sub MakeAprilFoolsHotSpot(HotSpotCount As Int) As Int 
	Dim Data As ABWifiInfo 
	If AprilFools Then
		Data.SSID = API.GetString("ssid_31")
		Data.BSSID = API.GetString("bssid_31")
		Data.MacAddress = Data.BSSID
		Data.Level = Rnd(-95,-70)
		SetWifiData(Data)
		HotSpotCount=HotSpotCount+1
	End If
	Return HotSpotCount
End Sub

Sub CheckHotspots As Boolean 
	Dim temp As Int, Wifi As Hotspot ,HotSpotCount As Int , temp As Int ,temp2 As Int , ItemHeight As Int
	If WifiIsOn Then
		HotSpotCount=myWifi.ABNumberOfAvailableWifiNetworks
		If HotSpotCount>0 Then 'OR hotspots.Size = 0 Then
			LoadingWifi=False
			If WifiSuccess< WifiSearchCycles Then WifiSuccess = WifiSearchCycles
			'Log("SCAN START")
			For temp = 0 To Hotspots.Size-1
				Wifi = Hotspots.Get(temp)
				Wifi.Checked = False
				Hotspots.Set(temp,Wifi)
			Next
			For temp = 0 To HotSpotCount - 1
				If SetWifiData(myWifi.ABGetWifiNetwork(temp)) Then Return
			Next
			
			HotSpotCount=MakeAprilFoolsHotSpot(HotSpotCount)	
			
			For temp = Hotspots.Size-1 To 0 Step -1
				Wifi = Hotspots.Get(temp)
				If Not(Wifi.Checked) Then
					'Log(Wifi.Name & " was removed")
					LCAR.LCAR_FindListItem(1, Wifi.Name ,0,True,-1)
					Hotspots.RemoveAt(temp)
				End If
			Next
			
			'Lists=lcar.LCARlists.Get(2)
			'Y=256 + (lists.LastMint * (lcar.ChartHeight + lcar.ChartSpace))  
			ItemHeight=(LCAR.ChartHeight + LCAR.ChartSpace)
			temp=Hotspots.Size   '  115,200,  -1 ,-1,
			temp2=Activity.Height-201
			temp2=(temp2 - (LCAR.ChartEdgeHeight + LCAR.ChartSpace)*2) / ItemHeight' (activity.Height - 201) / ItemHeight
			If temp2<temp Then temp=temp2
			
			
'			If LCAR.SmallScreen Then 
'				W = 50
'				Y=132 + (temp * ItemHeight) 
'			Else
'				Y=256 + (temp * ItemHeight)  
'				W=100
'			End If

			'LCAR.ForceElementData(17, 0,Y, 0,0, W,-1,0,-(LCAR.ScaleHeight-Y),0,255,True,  False) 
			'LCARSeffects.FrameOffset = HotSpotCount*ItemHeight
			'LCARSeffects.NeedsRedrawFrame=True
			'ShowFrame(False,True)
			
			LCAR.RandomizeColors(1)
			Return True
		Else
			WifiSearchCycles=WifiSearchCycles+1
			If WifiSuccess>0  Then
				If WifiSearchCycles>= WifiSuccess+10 Then  restartWifi
			Else If  WifiSearchCycles>=MaxSearchCycles Then
				restartWifi
			End If
			'SetElement18Text(WifiSearchCycles & " FAILED SEARCH CYCLES")
			LCAR.SetSensorXY(68,WifiSearchCycles,WifiSuccess,False)
			Return False
		End If
	End If
End Sub
Sub restartWifi 
	myWifi.ABLoadWifi()
	WifiSearchCycles=0
	LCAR.SetSensorXY(68,WifiSearchCycles,WifiSuccess,False)
End Sub

Sub FindHotSpot(Mac As String,IsConnected As Boolean,Check As Boolean) As Int 
	Dim temp As Int, Wifi As Hotspot
	For temp = 0 To Hotspots.Size-1
		Wifi = Hotspots.Get(temp)
		If Wifi.Mac =  Mac Then 
			If Check Then Wifi.Checked = True
			Wifi.isCurrent = IsConnected
			Hotspots.Set(temp,Wifi)
			Return temp
		End If
	Next
	Return -1
End Sub
Sub SetWifiData(Data As ABWifiInfo)As Boolean 
	Dim temp As Int, Wifi As Hotspot
	'Log("DATA: " & Data.BSSID & ", " & Data.MacAddress & ", " & Data.NetworkId & ", " & Data.SSID & ", " & Data.HiddenSSID)
	temp=FindHotSpot(Data.BSSID, Data.IsConnected ,True )
	If temp=-1 Then
		Wifi.Initialize 
		Wifi.Checked =True
		Wifi.Name= Data.SSID 
		Wifi.Mac = Data.BSSID 
		'wifi.Data = data
		Hotspots.Add(Wifi)
		temp= dBmToWifiSignalStrength(Data.Level)
		'Log(Wifi.Name & " created at : " &  temp)
'		Log ("NAME: " &  Data.SSID  )
'		Log ("MAC: " &  Data.MacAddress  )
'		Log ("BSSID: " &  Data.BSSID  )
'		Log ("STRING: " &  Data.FullString  )
'		Log ("ID: " &  Data.NetworkId  )
		LCAR.AddChartItem(1,LCAR.LCAR_RandomTheme, temp,-1, Data.SSID.ToUpperCase , Data.BSSID   )
		
		If Data.BSSID.EqualsIgnoreCase(TechnisMAC) Then
			DOS=1	
			ShowSection(-2,False)
			Return True
		End If
	Else
		Wifi = Hotspots.Get(temp)
		temp= dBmToWifiSignalStrength(Data.Level)
		'Log(Wifi.Name & " changed to : " & temp)
		LCAR.LCAR_FindListItem(1, Data.MacAddress ,2,False,temp)
	End If	
End Sub

Sub dBmToWifiSignalStrength(dBm As Int) As Int
	Dim temp As Int , temp2 As Double :temp2=1.666666666666667
	temp=(dBm+95) * temp2'(100/60)
	If temp<0 Then temp=0
	If temp>100 Then temp=100
	Return temp
End Sub










Sub StartRecording As Boolean 
	Dim Error As Boolean = FREQGotData And Not(FREQSuccess), args(0) As Object
	FREQGotData=False
	If Not(MicEnabled) Then Return False
	If Not(Record.IsInitialized) Or Error Then Record.Initialise("Rec")
	If Error Then StopRecording
	'PurgeBuffer
	AudioSource=AR.A_Src_Mic
	SampleRate=22050 '44100,22050,16000,11025,8000
	ChannelConfig=AR.Ch_Conf_Mono
	NoChnls=1
	AudioFormat=AR.Af_PCM_16
	BitsPerSample=16
	BufferSize=AR.GetMinBufferSize(SampleRate,ChannelConfig,AudioFormat)
	'BufferSize = Max(BufferSize, N * 2)
	If BufferSize < 0 Then Return False
	Try
		IsRecording=True
		AR.Initialize(AudioSource,SampleRate,ChannelConfig,AudioFormat,BufferSize)
		AR.StartRecording
		StartTime=DateTime.Now
		'Log("Start recording")
		'Record.Start("Recording",Null)
		Record.Start(Null, "Recording", args)
		Return True
	Catch
		PurgeBuffer
		StopRecording
		Return False
	End Try
End Sub
Sub Recording
	DataSize=0
	', RecData() As Byte
	FREQSuccess=False
	FREQGotData=True
	Do While IsRecording
		
		'Dim RecData() As Byte =AR.ReadBytes(0,BufferSize)
		'LCARSeffects2.AddPoints(1, RecData)
		Dim Sound() As Short = AR.ReadShort(0,  BufferSize)
		'Log("SAMPLE RECEIVED " & Sound.Length & " bytes. First data point: " & Sound(0) & " " & IsRecording )
		
		Select Case CurrentSection 
			Case 18: LCARSeffects2.AddPoints2(1, Sound)'SNSR\frequency
			Case 48: LCARSeffects4.ProcessRecData(SampleRate,Sound) 'tricorder
		End Select
		 
		 'AND FFTMode>0 Then 'graphid = 1
		'	LCARSeffects2.FFTPoints(1, 3,FFTMode=1)
		'End If
'		OutFile.WriteBytes(RecData,0,RecData.Length,44+DataSize)
		DataSize=DataSize+Sound.Length ' RecData.Length
		
		If DateTime.Now > StartTime+"10000" Or Not(IsRecording) Then Exit'Check if recording time is up
	Loop
	FREQSuccess=True
End Sub

Sub PurgeBuffer()
	Try
		AR.Stop
		AR.release
	Catch
		Log(LastException.Message)
	End Try
End Sub
Sub Rec_Ended(endedOK As Boolean,Error As String)
	PurgeBuffer
	If IsRecording Then StartRecording
End Sub
Sub StopRecording
	'Log("stop recording")
	IsRecording=False
	If Record.IsInitialized Then
		PurgeBuffer
		If Record.Running Then Record.Interrupt
	End If
End Sub








Sub Phone_BatteryChanged (Level As Int, Scale As Int, Plugged As Boolean, Intent As Intent)
	Dim temp As Int
	temp=LCAR.HandleBattery(Level,Scale,Plugged,Intent)
	LCAR.PushEvent(LCAR.LCAR_SensorChanged, 9, 0, temp, API.IIF(Plugged, 1,0),0, 0,0)
	If temp <> LCAR.OldBattery And LCAR.OldBattery>0 Then 
		If LCAR.OldBattery < 100 And temp = 100 Then 
			LCAR.ToastMessage(BG, API.GetString("charged_alert"), 4)
			SwapMode(51, -1)
		else If LCAR.OldBattery>=50 And temp< 50 Then
			LCAR.ToastMessage(BG, API.GetString("yellow_alert") & ": " & API.GetStringVars("percent_alert", Array As String("50")), 4)
			SwapMode(51, -2)
		Else If LCAR.OldBattery>=25 And  temp< 25 Then
			LCAR.SetRedAlert(True, "Phone_BatteryChanged")
			LCAR.ToastMessage(BG, API.GetString("red_alert") & ": " & API.GetStringVars("percent_alert", Array As String("25")), 4)
			SwapMode(51, -3)
		Else If LCAR.OldBattery<50 And temp>=50 Then
			LCAR.ToastMessage(BG, API.GetString("green_alert") & ": " & API.GetStringVars("charging_alert", Array As String("50")), 4)
			SwapMode(51, -1)
		Else If LCAR.OldBattery<25 And temp>=25 Then
			LCAR.ToastMessage(BG, API.GetString("yellow_alert") & ": " & API.GetStringVars("charging_alert", Array As String("25")), 4)
			'Log("1270")
			LCAR.SetRedAlert(False, "Phone_BatteryChanged")
			SwapMode(51, -2)
		End If
	End If
	
	If AprilFools Then
		If InsuranceRemaining=0 Then InsuranceRemaining = Rnd(0,101)
		InsuranceRemaining=InsuranceRemaining-1
		LCAR.PushEvent(LCAR.LCAR_SensorChanged, 10, 0, InsuranceRemaining, 0,0, 0,0)
	End If
End Sub


Sub webview1_PageFinished (Url As String) 
	'webview1.Visible = False: webview1.Visible = True 
End Sub

Sub MSDname(URL As String)As String 
	If URL.Contains("sites.google.com") Then 
		If Not(URL.Contains("?")) Then URL = URL & "?"
		URL = URL.Replace("%5B", "[").Replace("%5D", "]")
		Return API.GetBetween(URL, API.IIF(URL.Contains("lcars/"), "lcars/", "pictures/"), "?")
	End If 
	Return API.GetFile(URL)
End Sub
Sub HasMSD(URL As String) As Boolean 
	Return File.Exists(LCAR.DirDefaultExternal,MSDname(URL))
End Sub

Sub webview1_OverrideUrl (Url As String) As Boolean
	Dim tempstr As String 
	Select Case WebMode
		Case 1000'educational mode
			Log("stopped loading: " & Url)
			'webview1.StopLoading 
			HideWebview
			HandleEducationalURL(Url)
			'webview1.LoadUrl(LastURL)
		Case 2'ENTERPRISE mode
			If HasMSD(Url) And Not(Url.Contains("sys")) Then
				SetMSD(Url)
			Else
				Url=Url.Replace("https://", "http://")
				API.Download("MSD", Url)
				LCAR.Toastmessage(BG, API.GetStringVars("msds_downloading", Array As String(MSDname(Url))), 2)
			End If
			webview1.StopLoading 
		Case 3'TROPES
			tempstr=Tropes.URLclicked(Url)
			Select Case tempstr
				Case "-1":Return False
				
				Case Else
					Log("webview1_OverrideUrl " & tempstr & " isnt handled")
			End Select
			webview1.StopLoading 
		Case Else
			tempstr=Url.ToLowerCase 
			If tempstr.StartsWith("http://") Or tempstr.StartsWith("https://") Then
				If Not( tempstr.EndsWith("png") Or tempstr.EndsWith("gif") Or tempstr.EndsWith("jpg") Or tempstr.EndsWith("jpeg")) Then
					webview1.StopLoading
					If Url.Contains("NEOTECHNI/HOME/") Then 
						Url=Url.ToLowerCase.Replace("/home/", "/Home/").Replace("https://", "http://")
					Else If Url.Contains("PROGRAMALPHA11") Then
						Url=Url.ToLowerCase.Replace("https://", "http://")
					End If
					API.DownloadURL(Url)
				End If
				'HttpUtils.Download("WebPage", URL)
				'ShowFrame(True,True)
				'webview1.loadurl(api.MakeHTML(html))
				'webview1.Visible = True
				'lcar.forceshow(18,True)
				'lcar.LCAR_SetElementText( 18,api.Title, "")
			Else If tempstr.StartsWith("file://") And Not( Url.EqualsIgnoreCase(API.ScrollTo(-1)))  Then
			
				If tempstr.Contains("#") Then
					Return False 'Msgbox(tempstr, API.ScrollTo(-1))
				End If
				
				webview1.StopLoading 
				Url=API.right( Url,  Url.Length - 7 )
				
				If API.BaseHref.Length=0 Then API.BaseHref = "http://en.memory-alpha.org/"
				If API.left(Url,1) = "/" Then
					Url= API.GetBaseURL(API.basehref) & Url
				Else If API.Left(Url,4 ).EqualsIgnoreCase( "www.") Then
					Url = "http://" & Url
				Else If Not( API.Left(Url,7 ).EqualsIgnoreCase( "http://"))  Then
					Url=API.basehref & Url
				End If

				'"http://en.memory-alpha.org/"
				'Msgbox(url & CRLF & api.basehref, "URL")
				'url= api.BaseHref  & api.right( url,  url.Length - 8 )
				API.DownloadURL(Url )
			End If
			LastURL=Url
	End Select
End Sub






Sub AddAxis(ListID As Int)'RND", "ACC", "MAG", "ORI", "GYR", "MIC", "LIT", "PRS", "TMP", "PRX"
	LCARSeffects2.SetupAxis(ListID)
End Sub

Sub InitSensors
	If Not( SensorList.IsInitialized ) Then
		SensorList.Initialize 
		
		AddSensor(0, "", False,True)				'																																	MICROPHONE
		
		AddSensor(1, "", True,False) 				'All values are in SI units (m/s^2), Acceleration minus Gx on the x-axis 															ACCELEROMETER
		AddSensor(2, "", True,True)					'All values are in micro-Tesla (uT) and measure the ambient magnetic field in the X, Y and Z axis. 									MAGNETIC
		AddSensor(3, "", True,False)				'All values are angles in degrees. Azimuth(0=North, 90=East, 180=South, 270=West), 													ORIENTATION
													'Pitch(rotation around x-axis (-180 To 180), with positive values when the z-axis moves toward the y-axis), 
													'Roll (rotation around y-axis (-90 To 90), with positive values when the x-axis moves toward the z-axis. )
		AddSensor(4, "", True,False)				'All values are in radians/second and measure the rate of rotation around the X, Y and Z axis, 										GYROSCOPE
													'Rotation Is positive in the counter-clockwise/negative in clockwise direction
		AddSensor(5, "", False,True)				'Ambient light level in SI lux units 																								LIGHT
		AddSensor(6, "", False, True)				'NOT SUPPORTED																														PRESSURE
		AddSensor(7, "", False,True)				'NOT SUPPORTED																														TEMPERATURE
		AddSensor(8, "", False,True)				'Proximity sensor distance measured in centimeters Note: Some proximity sensors only support a binary near or far measurement. 		PROXIMITY
													'In this Case, the Sensor should report its maximum range value in the far state AND a lesser value in the near state. 
		'9=gravity									'A three dimensional vector indicating the direction and magnitude of gravity. Units are m/s^2. The coordinate system is the same 
													'As Is used by the acceleration Sensor. Note: When the device Is at rest, the output of the Gravity Sensor should be identical To that of the accelerometer.
		'10=linear acceleration						'A three dimensional vector indicating acceleration along each device axis, not including gravity. All values have units of m/s^2.  
		'11=TYPE_ROTATION_VECTOR 					'The rotation vector represents the orientation of the device as a combination of an angle and an axis, in which the device has 
													'rotated through an angle θ around an axis <x, y, z>. <x*sin(θ/2), y*sin(θ/2), z*sin(θ/2)>
		'acceleration = gravity + linear_acceleration
		
		'AddSensor(-1, "PRESSURE", False, True)
	End If
End Sub
Sub AddSensor(SensorType As Int, Name As String, ThreeValues As Boolean,SelfCalibrate As Boolean) As Int
	Dim temp As Sensor 
	Name = API.GetString("sensor" & SensorType)
	temp.Initialize
	Select Case SensorType
		Case 0'microphone
			'If MicEnabled Then ActivateMic
		Case Else
			Try
				If SensorType = -1 Then
					temp.Device.Initialize2(Name,2)
				Else
					temp.Device.Initialize(SensorType)
				End If
			Catch
				temp.IsInitialized=False
			End Try
	End Select
	temp.SensorType = SensorType
	temp.Name=Name
	If Not (SelfCalibrate) Then temp.MaxValue = temp.Device.MaxValue 
	temp.ThreeValues=ThreeValues
	SensorList.Add(temp)
	If CurrentSensor=-1 Then RandomizeGraph(0)
	Return SensorList.Size-1
End Sub
Sub GetSensors As List 
	Dim templist As List,temp As Int ,tempsensor As Sensor 
	templist.Initialize 
	For temp = 0 To SensorList.Size-1
		tempsensor = SensorList.Get(temp)
		templist.Add( tempsensor.Name )
	Next
	Return templist
End Sub
Sub ActivateMic(Dir As String, Filename As String) As Boolean 
	A.Initialize 
	AudioFile=""
	Log("Activate mic")
	If Not( A.IsRecording) Then' a.stop 
		Try
			Subtitles.Initialize 
			A.AudioSource=A.AS_MIC 'a.AS_VOICE_RECOGNITION 
			If Filename.length = 0 Then 
				Filename = "/dev/null"
				A.OutputFormat=A.OF_THREE_GPP
			Else
				A.AudioChannels=1
				'A.AudioEncodingBitRate=64
				'A.AudioSamplingRate=44000
				A.OutputFormat=A.OF_MPEG_4 
			End If
			A.AudioEncoder=A.AE_AMR_NB
			AudioFile = File.Combine(Dir,Filename)
			A.setOutputFile(Dir,Filename)
			A.prepare
			A.Start
			'Log("Mic Started")
		Catch
			micrunning=False
			'Log("MIC failed to init")
			Return False
		End Try
		StartTime=DateTime.Now
	End If
	micrunning=True
	Return True
End Sub
Sub DeactivateMic(CombineFilename As Boolean) As String
	Try 
		If micrunning Then
			A.Stop 
			micrunning=False
		End If
	Catch
		Return ""
	End Try
	If CombineFilename Then
		Return AudioFile
	Else
		Return API.getSide(AudioFile, "/", False,False)
	End If
End Sub
Sub Listen(DoListen As Boolean)
	SensorEnabled=True
	WasAVREC=True
	Dim temp As Int , tempS As Sensor 
	For temp=0 To SensorList.Size-1
		tempS= SensorList.Get(temp)
		Try
			If tempS.SensorType=0 Then
				If MicEnabled Then
					If DoListen Then
						ActivateMic("","")
					Else
						DeactivateMic(False)
						'Log ("MIC Stopped")
						'If micrunning Then A.Stop 
						'micrunning=False
					End If
				End If
			Else
				If DoListen Then
					tempS.IsPresent= tempS.Device.StartListening("Sensor")'temps.Name)
				Else
					tempS.Device.StopListening 
				End If
			End If
		Catch
			tempS.IsInitialized=False
		End Try
	Next
End Sub

Sub ListenServer()As Boolean 
	Try 
		Server.Initialize(DefaultPort, "Server")
		Server.Listen
		Return True
	Catch
		Return False
	End Try
End Sub
Sub ServerIPport As String 
	Return Server.GetMyIP & ":" & DefaultPort
End Sub
Sub ServerListen
	If Not(Server.IsInitialized) Then 'Server.Initialize(DefaultPort, "Server")
		Do Until ListenServer
			DefaultPort=DefaultPort+1
		Loop
	End If
	Dim tempstr As String = API.GetStringVars("ip_listening", Array As String(Server.GetMyIP, DefaultPort))
	LCAR.ToastMessage(BG, tempstr, 4)
	If CurrentSection = 49 Then SetElement18Text(tempstr)
	LCARSeffects.NewShip
End Sub






Sub HandleOrientation(Index As Int,device As Sensor , Values() As Float)
	Dim se As SensorExtender,R(16) As Float,I(16) As Float,ORi(3) As Float
	'se=device.device
	If False Then 'device.ThreeValues Then
		se.Initialize(device.SensorType)
		If Index = 1 Then'TYPE_ACCELEROMETER
		'se.HighPassFilter 
			rACC = se.LowPassFilter(Values,rACC,se.FILTERING_FACTOR_Recommended )
			Log(" ACC FILTER: " & rACC(0) & "  " & rACC(1) & "  " & rACC(2))
		Else
			If se.GetRotationMatrix(R,I,Values,rACC) Then
				ORi = se.GetOrientation(R)
				Log( "Orientation in radians:" & CRLF & NumberFormat(ORi(0),0,2) & ", " & NumberFormat(ORi(1),0,2) & ", " & NumberFormat(ORi(2),0,2) )
			Else 
				Log("FREEFALLING!")
			End If
		End If
	End If
End Sub

Sub TotalMagneticField(X As Float, Y As Float, Z As Float) As Float
	Return Sqrt((X*X) + (Y*Y) + (Z*Z))
End Sub

'1) ACCELEROMETER: 			All values are in SI units (m/s^2), Acceleration minus Gx on the x-axis 
'2) MAGNETIC:				All values are in micro-Tesla (uT) and measure the ambient magnetic field in the X, Y and Z axis. 
'3) ORIENTATION:			All values are angles in degrees. Azimuth(0=North, 90=East, 180=South, 270=West),
'							Pitch(rotation around x-axis (-180 To 180), with positive values when the z-axis moves toward the y-axis), 
'							Roll (rotation around y-axis (-90 To 90), with positive values when the x-axis moves toward the z-axis. )
'4) GYROSCOPE:				All values are in radians/second and measure the rate of rotation around the X, Y and Z axis, Rotation Is positive in the counter-clockwise/negative in clockwise direction
'5) LIGHT: 					Ambient light level in SI lux units
'6) PRESSURE 				Not Supported
'7) TEMPERATURE				Not Supported
'8) PROXIMITY				distance measured in centimeters Note: Some proximity sensors only support a binary near or far measurement
'9) GRAVITY					A three dimensional vector indicating the direction and magnitude of gravity. Units are m/s^2. The coordinate system is the same as is used by the acceleration Sensor
'10) linear acceleration	A three dimensional vector indicating acceleration along each device axis, not including gravity. All values have units of m/s^2.  
'11) TYPE_ROTATION_VECTOR	The rotation vector represents the orientation of the device as a combination of an angle and an axis, in which the device has rotated through an angle θ around an axis <x, y, z>. <x*sin(θ/2), y*sin(θ/2), z*sin(θ/2)>

'CurrentOrientation: 0=up, 1=right, 2=down, 3=left
Sub ms2(Value As Float) As Int 
	Return Value * 10
End Sub
Sub ChangeSensor(Index As Int, device As Sensor, Values0 As Float,Values1 As Float, Values2 As Float )
	Dim X As Float, Y As Float
	If Index = 1 Then'ACCELEROMETER
		Select Case API.CurrentOrientation
			Case 0'up
				X = Values0
				Y = Values1
			Case 1'right
				X = Values1*-1
				Y = Values0
			Case 2'down
				X = Values0*-1
				Y = Values1*-1
			Case 3'left
				X = Values1
				Y = Values0*-1
		End Select
		LCAR.CurrentRotationX = ms2(X*-1)	'-100 (leftside-down) to +100 (leftside-up)
		LCAR.CurrentRotationY = ms2(Y)		'+100 (topside-up)    to -100 (topside-down)
		'Log("Orientation: " & API.CurrentOrientation & " Rotation: " & LCAR.CurrentRotationX & ", " & LCAR.CurrentRotationY)
	End If
	Select Case CurrentSection
		Case 3'sensor data
			If Index = CurrentSensor2 And UMRsection=3 Then'raw subsection
				'Log(Values0 & ", " & Values1 & ", " & Values2)
				LCAR.LCAR_SetListitemText(3, 1, LCAR.LCAR_IGNORE, Round2(Values0,3))
				LCAR.LCAR_SetListitemText(3, 2, LCAR.LCAR_IGNORE, Round2(Values1,3))
				LCAR.LCAR_SetListitemText(3, 3, LCAR.LCAR_IGNORE, Round2(Values2,3))
				If device.ThreeValues Then
					HandleOrientation(Index,device,Array As Float(Values0,Values1,Values2))
					LCAR.LCAR_SetListitemText(3, 5, LCAR.LCAR_IGNORE,  Trig.GetCorrectAngle(0,0,Values0*100,Values1*100) )
					LCAR.LCAR_SetListitemText(3, 6, LCAR.LCAR_IGNORE,  Trig.GetCorrectAngle(0,0,100,Values2*100) )
					LCAR.LCAR_SetListitemText(3, 7, LCAR.LCAR_IGNORE, Round2(TotalMagneticField(Values0,Values1,Values2),3))
				End If
			End If
		Case 85'Dr. Pulaski
			Games.DrP_HandleMouse(113, LCAR.CurrentRotationX, LCAR.CurrentRotationY, LCAR.LCAR_SensorChanged, 0,0)
	End Select
	
	If Abs(Values0)> device.MaxValue Then device.MaxValue= Abs(Values0)
	If Abs(Values1)> device.MaxValue Then device.MaxValue= Abs(Values1)
	If Abs(Values2)> device.MaxValue Then device.MaxValue= Abs(Values2)
	device.X= toPercent(Values0,device.MaxValue)' 50+ (values(0)/source.MaxValue)
	If device.ThreeValues Then
		device.Y = toPercent(Values1,device.MaxValue)'50+ (values(1)/source.MaxValue)
		device.Z = toPercent(Values2,device.MaxValue)'50+ (values(2)/source.MaxValue)
	End If
	LCAR.PushEvent(LCAR.LCAR_SensorChanged, device.SensorType, 0, device.X,device.Y,device.Z, Values0,0)
	SensorList.Set(Index,device)
End Sub
Sub Sensor_SensorChanged (Values() As Float) As Boolean 
	Dim device As Sensor, temp As Int', source As PhoneSensors
	'source=Sender
	For temp = 0 To SensorList.Size -1
		device=SensorList.Get(temp)
		If Sender = device.device Then 
			ChangeSensor(temp,device, Values(0), Values(1), Values(2))
			Return False
		End If
	Next
End Sub
Sub toPercent(Value As Float, MaxValue As Float) As Int
	'Return 50+ ((value/MaxValue)*50)
	Return (Value/MaxValue)*100
End Sub

Sub findXY(X As Int, Y As Int, Distance As Int, Angle As Int, IsX As Boolean) As Int
    	'180=north
	'270=west	90=east
		'0=south
	Return Trig.findXYAngle(X,Y,Distance,Angle,IsX)
	'If IsX Then 
	'	Return X + Sin(DegToRad(Angle)) * Distance 
	'Else 
	'	Return Y + Cos(DegToRad(Angle)) * Distance
	'End If
End Sub

Sub SetSensorData(Name As String, Value As Int)As Boolean 
	Dim Index As Int 
	If CurrentSection=3 Then'lcar.SetGraphPercent(2, Array As Int( 4, event.X) )
		Index=LCAR.LCAR_FindListItem(2, Name ,0,False,Value)
		If Index =-1 And Value>0 Then	
			LCAR.AddChartItem(2,LCAR.LCAR_RandomTheme,Value,-1, Name,"" )'listitem 0
		Else If Index>-1 Then
			LCAR.SetGraphPercent(2, Array As Int(Index, Value) )
		End If
		If CurrentSensor = Index Then LCARSeffects2.AddPoint(0,Value)
		Return True
	End If
End Sub
Sub SetSensorData2(Index As String, X As Int, Y As Int,Z As Int, NegAlign As Boolean ) As Boolean 
	If CurrentSection=2 And Index=CurrSensor Then
		LCAR.SetSensorXY(5, X,Y,True)
	End If
	Return CurrentSection=2
End Sub










Sub Phone_TextToSpeechFinish (Intent As Intent)
	'Log("Phone_TextToSpeechFinish: " & Intent)
	TTSIsSpeaking = False
	If SpeakText.Length>0 Then Speak(SpeakText)
End Sub

Sub ShowFrame(DoAnimation As Boolean, LeftBar As Boolean ) 
	LCARSeffects.ShowFrame(BG, DoAnimation, LeftBar, 3)
End Sub

Sub RedoIntro(Index As Int, Why As String)
	Log("Play Intro " & Index & ": " & Why)
	LCAR.DrawFPS=True
	Select Case Index 
		Case 1
			LCAR.LCAR_HideAll(BG, False)
			LCAR.Stage=0 
			LCAR.HideGroup(0, True,True)
			LCAR.PlaySound(1, False)
			LCAR.ForceElementData(0,   LCAR.MAXDIM+50, LCAR.MAXDIM+50, 0,0, 0,0, 0,0 ,0,255,False, True)
			LCAR.ForceElementData(1,  10, 50%y - LCAR.ItemHeight-1, 0,0, -20, LCAR.ItemHeight,0,0,0,255,True,True)
			LCAR.ForceElementData(2,   10, 50%y  + 1, 0,0, -20, LCAR.ItemHeight,0,0,0,255,True,True)
			LCAR.ForceElementData(3,  0, 50%y+40,  0,0, LCAR.ScaleWidth,LCAR.Fontsize,0, 0,0,255,False,True)
			LCAR.LCAR_SetElementText(3, "", API.GetString("welcome"))
			CurrentSection=0
		Case 2
			PreviewLWP(44)'PreviewLWPname("UFP LOGO")
			LCAR.PlaySound(1, False)
			LCAR.DontCancel = True 
	End Select 
	If Index = 0 Then LCAR.stop("Intro0")
End Sub


Sub DebugActivity( ) As String 
	'Dim temp As Int ,tempstr As StringBuilder
	'tempstr.Initialize 
	'tempstr.Append( "<HR><CENTER>[" & tempINI.name & "] (" &  Level & ")</CENTER>")
	'For temp = 0 To tempINI.Keys.Size-1
	'	tempstr.Append(tempINI.Keys.get(temp) & " = " & tempINI.Values.get(temp) & "<BR>")
	'Next
	'For temp = 0 To tempINI.Sections.Size-1
	'	tempstr.Append(DebugActivity(tempINI.Sections.Get(temp), Level+1) )
	'Next
	'Return tempstr.ToString 
	Dim templus As PlusActivity ,tempstr As String  ,temp As Int, IO As TextWriter ,HasDoneOne As Boolean 
	If GPlus.NeedsParsing Then' Not(GPlus.CwActivity.IsInitialized)  Then
		tempstr=GPlus.PostsURL(PlusID,PageToken)
		tempstr=API.CurrentJob.GetString' HttpUtils.GetString( HttpUtils.SuccessfulUrls.GetKeyAt(0) )
		
		GPlus.CwActivity = GPlus.ParseSocialMediaFeed(tempstr)
		'INI=GPlus.ParseActivityFeed(tempstr)
		'GPlus.CwActivity = GPlus.EnumActivities(INI)
	End If
	'File.Delete(File.DirInternalCache, "gplus.html")
	IO.Initialize( File.OpenOutput(File.DirInternalCache, "gplus.html", False) )
	'IO.Write( "<html><head><style Type='text/css'>" & LCARSeffects2.PreCARSStyle("") & CRLF & "@font-face { font-family: 'Corporate Condensed';	src: url('file:///android_asset/precars.ttf')" & CRLF & "; }" )
	'IO.Write("<meta http-equiv='Content-Type' content='text/html; charset=utf-8' /><body></style></head>")
	
	IO.Write( LCARSeffects2.PreCARSStyle("") )
	
	
	For temp=0 To GPlus.CwActivity.Size-1
		templus=GPlus.CwActivity.Get(temp)
		IO.Write( ParseActivity(templus) )
		HasDoneOne=True
	Next
	
	If Not(HasDoneOne) Then
		IO.Write( LCARSeffects2.PreCARSFrame("red", API.GetString("gplus_none") , GPlus.ErrorAsset, "ERROR",100) )
	End If
	
	'For temp = 0 To INI.Sections.Size-1
	'	templus.Initialize 
	'	tempstr2.Append ( ParseActivityFeed(INI.Sections.Get(temp), templus) )
	'Next
	
	IO.Write("</TABLE></BODY></HTML>")
	IO.Close 
	'Return tempstr2.ToString & "</BODY></HTML>"
	'Return File.ReadString(File.DirInternalCache, "gplus.html" )
	API.FileLoaded="file://" & File.Combine(File.DirInternalCache, "gplus.html")'File.OpenOutput(File.DirInternalCache, "gplus.html", False) )
	Return API.FileLoaded
End Sub

Sub ParseActivity(Plus As PlusActivity) As String 
	Dim tempstr As StringBuilder, temp As Int, Attachment As PlusAttachment  ,tempstr2 As String ,Reply As PlusReply 
	tempstr.Initialize 
	tempstr.Append(Plus.updated.Replace("T", " ").Replace("Z", " ") & "<BR>" & Plus.Content.Replace("\ufeff", "") & "<BR><CENTER>")
	
	If Plus.Attachments.Size>0 Then
		'tempstr.Append("<TR><TD COLSPAN=3>")
		For temp = 0 To Plus.Attachments.Size-1
			Attachment = Plus.Attachments.Get(temp)
			tempstr2="<A Href='" & Attachment.Image.URL & "'><IMG SRC='" & Attachment.Thumbnail.URL & "' style='max-width: 100%;'></A>"'  & Min(webview1.Width,webview1.Height) & "%;'></A>"
			tempstr.Append( tempstr2)
			If Attachment.objectType.EqualsIgnoreCase("article") Then
				tempstr.Append("<br>" &  Attachment.content)' & "</FONT></TD></TR></TABLE>")
			End If
		Next
		'tempstr.Append("</TD></TR>")
	End If
	tempstr.Append("<BR><TABLE WIDTH=100%><TR><TD width=50% align=center>" & LCARSeffects2.PreCARSButton("blue", Plus.Replies , "grey", "REPLIES", Plus.Replies>0) & "</TD>")
	tempstr.Append("<TD align=center>" & LCARSeffects2.PreCARSButton("red", Plus.PlusOners , "grey", "+1", Plus.PlusOners>0) & "</TD></TR></TABLE>")
	'tempstr.Append("<TD>" & LCARSeffects2.PreCARSButton("yellow", Plus.Resharers , "grey", "RESHARERS", Plus.Resharers>0) & "</TD></TR></TABLE>")
	
	tempstr2=LCARSeffects2.PreCARSFrame("red", tempstr.ToString,  Plus.Actor.ImageURL, Plus.Actor.displayName,100)
	
	If Plus.ReplyList.Size=0 Then
		Return tempstr2
	Else
		tempstr.Initialize 
		For temp = 0 To Plus.ReplyList.Size-1
			Reply= Plus.ReplyList.Get(temp)
			tempstr.Append("<P align=right>" & LCARSeffects2.PreCARSFrame("blue",  Reply.Content, Reply.Actor.ImageURL, Reply.Actor.displayName, 80) )
		Next
		Return tempstr2 & tempstr.ToString 
	End If
End Sub

Sub ParseHTML(HTML As String ) As Boolean 
	Dim tempstr() As String ,temp As Int , Key As String, Value As String ,NeedsSaving As Boolean
	tempstr=Regex.Split("<br />", HTML)
	For temp = 0 To tempstr.Length-1
		If tempstr(temp).Trim.Length>0 Then
			Key = API.getSide( tempstr(temp).Trim, "=", True, False)
			Value= API.getSide( tempstr(temp).Trim, "=", False, False)
			Select Case Key.ToLowerCase 
				Case "toast"
					LCAR.ToastMessage(BG, Value,4)
				Case "msgbox"
					LCARSeffects.ShowPrompt(BG, 12, API.GetString("alert"), Value,  -1,"OK", "")
			
				Case Else
					Settings.Put(Key,Value)
					NeedsSaving=True
			End Select
		End If
	Next
	If NeedsSaving Then
		File.WriteMap(File.DirInternal, "settings.ini", Settings)
		LoadSettings(False)
	End If
	Return HTML.Length>0
End Sub

'Sub Response(Job As String, Data As HttpResponse)
'	Select Case Job
'		Case "BING.AUTH", "BING.TRANS"
'			Translator.Response(Job,Data)
'	End Select
'End Sub


Sub ShowBrowser
	If CurrentSection<>999 Then
		MoveWebview
		webview1.Visible = True
		MyWebViewExtras.addJavascriptInterface(webview1, "B4A")
		MyWebViewExtras.addWebChromeClient(webview1, "")
	End If
End Sub
Sub Javascript(Text As String)
	LogColor("javascript: " & Text, Colors.Cyan)
End Sub

Sub EnumMSDs(HTML As String )
	Dim URLS As List ,tempstr As String , temp As Int ,TAG As String ,Start As String , Finish As String ,Q As String =GPlus.vbQuote
	Start="<div xmlns=" & Q  & "http://www.w3.org/1999/xhtml" & Q & " id=" & Q & "sites-attachments" & Q & ">"
	Finish="<a xmlns=" & Q  & "http://www.w3.org/1999/xhtml" & Q & " name=" & Q & "page-comments" & Q & ">"
	temp=API.Instr(HTML, Start,0)
	HTML = API.GetBetween(HTML , Start ,Finish )
	If HTML.Length>0 Then
		URLS= API.EnumAHREFs(HTML)
		WallpaperService.MSDList.Initialize 
		For temp = 0 To URLS.Size-1
			TAG= URLS.Get(temp)
			If API.GetTag(TAG, "title") = "Download" Then
				tempstr="http://sites.google.com" & API.GetTag(TAG, "href")
				WallpaperService.MSDList.Add(API.Left(tempstr,tempstr.Length - 8) )' remove &amp;d=1
			End If
		Next
		ShowMSDs(4,True)
	End If
End Sub
Sub EnumMSDs2(HTML As String)
	Dim tempstr() As String ,temp As Int ,Image As String,Name As String,iType As String , IO As TextWriter,tempstr2() As String  ,temp2 As Int,Quality As String, Color As String ,URL As String
	HTML=API.GetBetween(HTML, "[START]", "[END]")
	Name=API.GetBetween(HTML, "[MOTD]", "[/MOTD]")
	HTML=API.GetBetween(HTML,"<tbody>","</tbody>")
	tempstr=Regex.Split("</tr>", HTML) 
	IO.Initialize( File.OpenOutput(File.DirInternalCache, "msds.html", False) )
	IO.Write( LCARSeffects2.PreCARSStyle("") )
	IO.Write( LCARSeffects2.PreCARSFrame("blue", Name, "file:///android_asset/mission.png", "NOTE", 100))
	For temp = 0 To tempstr.Length -1
		'Msgbox(tempstr(temp),temp)
		If tempstr(temp).Trim.Length>0 Then
			Image  	=	API.GetBetween(tempstr(temp), "src=" & Eval.vbQuote, Eval.vbquote)
			Name	=	API.GetBetween(tempstr(temp), "<br />", ":")
			If Name.Trim.Length=0 Then Name	=	API.GetBetween(tempstr(temp), "</div>", ":")
			Name=Name.replace(CRLF,"")
			
			iType	=	API.GetBetween(tempstr(temp), Name & ":", "<a href").Trim 
			HTML	=	API.GetBetween(tempstr(temp), iType,"<br />").Trim 
			If HTML.Length=0 Then HTML	=	API.GetBetween(tempstr(temp), iType,"</td>").Trim 
			tempstr2= Regex.Split("</a>", HTML)
			HTML="<TABLE width=100%><TR>"
			For temp2=0 To tempstr2.Length-1
				URL		=	API.GetBetween(tempstr2(temp2), "<a href=" & Eval.vbQuote, Eval.vbQuote)
				'If Not(HasMSD(URL)) Then
					Quality = 	API.GetBetween(tempstr2(temp2) & "<", ">", "<").Trim.ToUpperCase 
					Select Case Quality
						Case "LOW", "LO":					Color=API.IIF(HasMSD(URL), "lightblue", "green")
						Case "MED", "MEDIUM", "NO BLOOD":	Color=API.IIF(HasMSD(URL), "blue", "yellow")
						Case "HI", "HIGH", "BLOODY":		Color=API.IIF(HasMSD(URL), "darkblue", "red")
					End Select
					HTML = HTML & "<TD align=center>" & LCARSeffects2.PreCARSButton(Color, "<A href=" & URL & ">" & Quality & "</a>", "grey", "QUALITY",  HasMSD(URL)) & "</TD>"
					'CanGetAny=True
				'End If
			Next
			'If CanGetAny Then 
			IO.Write( LCARSeffects2.PreCARSFrame("red", "<CENTER>" & Name & "<BR><img src=" & Image & "></CENTER><BR>" & HTML & "</TR></TABLE>", "file:///android_asset/mission.png", iType, 100))
		End If
	Next
	IO.Write("</BODY></HTML>")
	IO.Close 
	
	SetElement18Text("")
	API.FileLoaded="file://" & File.Combine(File.DirInternalCache, "msds.html")
	BrowseWeb(API.FileLoaded,2)
	
	LCAR.ForceShow(65,True)
	LCAR.ForceShow(92,True)
	LCAR.HideToast'("EnumMSDs2")
End Sub
Sub SetMSD(URL As String)As String 
	Dim LWP As String ,DoSetMSD As Boolean = True
	URL= MSDname(URL)
	If URL.ToLowerCase.StartsWith("sys") Then
		If LCAR.IsElementVisible(105) And URL.ToLowerCase.Contains("syseventhor") Then	
			LCARSeffects4.ResetEventHorizon(BG, 105)
		Else
			LCAR.Toastmessage(BG, API.GetStringvars("file_success", Array As String(URL)), 2)
		End If
	Else If URL.ToLowerCase.StartsWith("warpcore") Then
		LWP=API.GetString("lwp_15")
		DoSetMSD=False
		LCAR.Toastmessage(BG, API.GetStringVars("lwp_success", Array As String(LWP)), 2)
	Else If URL.Contains("[") And URL.Contains("]") Then
		LWP= API.GetString("lwp_18")
	Else
		Select Case URL
			Case "twokhi.png", "twoklo.png", "twoklo.jpg", "twokwinhi.jpg", "twoklosehi.jpg", 	"twokloselo.jpg": Return URL', "bridge.ogg"
		End Select
		If URL.EndsWith(".ogg") Or URL.StartsWith("sys") Then Return URL
		LWP=API.getstring("lwp_11")
	End If
	SaveLWPsetting("SCR", LWPLIST.IndexOf(LWP),False)
	If DoSetMSD Then 
		SaveLWPsetting("MSD", URL,False)
		LCAR.Toastmessage(BG, LWP & ": " & URL, 2)
	End If
	Select Case CurrentSection
		Case 36'msd downloader
			LCAR.LCAR_SetElementText(92,LWP, "PREVIEW")
		Case 23'live wallpaper settings 
			LCAR.LCAR_SetListitemText(3,1,"SCREENS", LWP)
			If DoSetMSD Then LCAR.LCAR_SetListitemText(3,3,"SELECT MSD", URL)
	End Select
	Return URL
End Sub
Sub ShowMSDs(ListID As Int, NotDownloadedYet As Boolean )
	Dim temp As Int ,URL As String ,Title As String,EXT As String  ,temp2 As Int , Files As List ,OnlyShowPNGs As Boolean 
	URL="http://sites.google.com/site/programalpha11/home/lcars"
	Title= API.GetString("msd_downloading")
	If ListID=-2 Then
		LCAR.ToastMessage(BG,Title,3)
		API.Download("MSDS2", URL)
		LCAR.LCAR_SetElementText(92,SelectedLWP("SCR"), "PREVIEW")
	Else If ListID=-1 Then
		LCAR.LCAR_ClearList(4 ,0)
		SetElement18Text(Title)
		API.Download("MSDS", URL)
	Else
		LCAR.LCAR_ClearList(ListID ,0)
		If NotDownloadedYet  Then'download/parse msd page
			LCAR.LCAR_AddListItem(ListID, API.GetString("msd_redownload"), LCAR.LCAR_Random, -1, "", False, "", 0, False,-1)
			For temp = 0 To WallpaperService.MSDList.Size -1
				URL = WallpaperService.MSDList.Get(temp)
				Title = API.GetSide(URL, "/", False,False)
				Title=API.GetSide(Title, "?", True,False)
				Title=Title.Replace("%5B", "[").Replace("%5D", "]")
				If Not(File.Exists(LCAR.DirDefaultExternal, Title)) Then
					EXT = API.GetSide(Title, ".",False,False).ToLowerCase 
					Title=API.GetSide(Title, ".", True,False).Replace("[]", "")
					If Title.Contains("[") Then Title = API.GetSide(Title, "[", True, False)
					Select Case EXT.ToLowerCase
						Case "jpg", "gif", "png", "bmp", "jpeg"
							LCAR.LCAR_AddListItem(ListID, Title.ToUpperCase, LCAR.LCAR_Random, -1, URL, False, "", 0, False,-1)
					End Select
				End If
			Next
		Else'show downloaded msds
			temp2=SaveLWPsetting("SCR", -1,True)
			If temp2 = 18 Then OnlyShowPNGs=True

			Files = File.ListFiles(LCAR.DirDefaultExternal)
			Files.SortCaseInsensitive(True)
			
			If OnlyShowPNGs Then
				LCAR.LCAR_AddListItem(ListID, API.GetString("msd_outwards"), LCAR.LCAR_Random, -1, "[]", False, "", 0, False,-1)
				LCAR.LCAR_AddListItem(ListID, API.GetString("msd_inwards"), LCAR.LCAR_Random, -1, "[d360]", False, "", 0, False,-1)
				LCAR.LCAR_AddListItem(ListID, API.GetString("msd_left"), LCAR.LCAR_Random, -1, "[d270]", False, "", 0, False,-1)
				LCAR.LCAR_AddListItem(ListID, API.GetString("msd_right"), LCAR.LCAR_Random, -1, "[d90]", False, "", 0, False,-1)
			End If
			For temp = 0 To Files.Size-1
				URL = Files.Get(temp)
				If Not(URL.StartsWith("sys")) Then
					EXT = API.GetSide(URL, ".",False,False)
					Select Case EXT.ToLowerCase
						Case "jpg", "gif", "png", "bmp", "jpeg"
							Title=API.GetSide(URL, ".", True ,False)
							Select Case Title.ToLowerCase  
								Case "warpcorehi","warpcorelo", "twoklo", "twokhi" 'filter from results
								Case Else
									If LCARSeffects3.IsPNG(Title, EXT) = OnlyShowPNGs Then
										If OnlyShowPNGs Then Title = API.GetSide(URL, "[", True ,False) 'Title.Replace("[" & API.GetBetween(Title,"[", "]") & "]", "")
										LCAR.LCAR_AddListItem(ListID, Title.ToUpperCase, LCAR.LCAR_Random, -1, URL, False, "", 0, False,-1)
									End If
							End Select
					End Select
				End If
			Next
		End If
		ShowSideList(1)
	End If
End Sub


Sub AddHistoryItem(URL As String, Title As String, ListID As Int, ListName As String, BaseHref As String )
	Dim Count As Int 'listid=16
	Count = Settings.Getdefault(ListName & "Count", "0") +1
	Settings.put(ListName & "Count", Count)
	Settings.put(ListName & Count & "URL", URL)
	Settings.put(ListName & Count & "Title", Title)
	Settings.put(ListName & Count & "BaseHREF", BaseHref)
	AddHistoryToList(URL, Title, ListID, -1)
End Sub
Sub AddHistoryToList(URL As String , Title As String, ListID As Int, Index As Int)
	Dim Index2 As Int 
	If URL.Length=0 Then
		Index2=-1
	Else
		If Index>-1 Then 'Index2 = LCAR.GetListItemCount(ListID) Else Index2=Index
			Index2=Index
			Index=LCAR.GetListItemCount(ListID)
		Else
			Index2=LCAR.GetListItemCount(ListID)
			Index=1
		End If
		
	End If
	LCAR.LCAR_AddListItem(ListID, Title.ToUpperCase, LCAR.LCAR_Random, Index2, URL, False, "", 0 , False, Index)'-1
End Sub
Sub LoadHistory(ListID As Int, ListName As String, FirstItem As String  )
	Dim temp As Int, Count As Int 
	LCAR.LCAR_ClearList(ListID,0)
	AddHistoryToList("", FirstItem, ListID, -1)'If FirstItem.Length>0 Then 
	Count = Settings.Getdefault(ListName & "Count", "0")
	For temp = Count To 1 Step -1
		AddHistoryToList(Settings.Get(ListName & temp & "URL"), Settings.Get(ListName & temp & "Title"), ListID, temp)' temp)
	Next
End Sub
Sub ClearHistory(ListID As Int, ListName As String, FirstItem As String)
	Dim temp As Int, Count As Int ,Filename As String ,templist As List 
	Count = Settings.Getdefault(ListName & "Count", "0")
	For temp = 1 To Count
		Filename=Settings.Get(ListName & temp & "URL")'"file://"
		Filename=API.Right(Filename, Filename.Length - 7)
		If Not( Filename.EqualsIgnoreCase(API.FileLoaded)) Then	File.Delete(API.GetDir(Filename), API.GetFile(Filename))
		Settings.Remove(ListName & temp & "URL")
		Settings.Remove(ListName & temp & "Title")
		Settings.Remove(ListName & temp & "BaseHREF")
	Next
	Settings.put(ListName & "Count", "0")
	LCAR.LCAR_ClearList(ListID, 0)
	If FirstItem.Length>0 Then AddHistoryToList("", FirstItem, ListID, -1)
	
	Filename=File.Combine(LCAR.DirDefaultExternal, "HTML")
	'Log("Clear HTML from: " & Filename)
	templist = File.ListFiles( Filename)
	For temp = 0 To templist.Size-1
		'Log("Deleting: " & File.Combine(Filename, templist.Get(temp)))
		File.Delete(Filename, templist.Get(temp))
	Next
End Sub
Sub GetBaseHREF(ListName As String, Index As Int) As String 
	Return Settings.Get(ListName & Index & "BaseHREF")
End Sub





Sub Searchfor(Text As String)
	If Text.Length=0 Then
		LCAR.PlaySound(7, False)
	Else
		If Text.Contains(".") Then
			LastURL = "http://" & Text.Replace(" ","")
		Else
			LastURL=API.Searchfor( Text)
		End If
		API.DownloadURL( LastURL)
		'HttpUtils.Download("WebPage", api.Searchfor( Text))
	End If
End Sub

Sub BeepModes As List 
	Dim temp As Int, templ As List
	templ.Initialize 
	templ.Add(API.GetString("disabled"))
	templ.Add(API.GetString("random"))
	For temp = 1 To LCAR.LCAR_Beeps
		templ.Add(API.GetStringVars("keytone", Array As String(temp)))
	Next
	Return templ
End Sub
Sub PlayRandomBeep
	Dim temp As Int 
	If Keytones And LCAR.cVol>0 Then ' LCAR.PlaySoundAnyway(API.IIF(KeyToneIndex=1, Rnd(9,12),KeyToneIndex+7))
		temp=KeyToneIndex'0=disabled, 1=random, 2=beep 1, 3=beep 2, 4=beep 3, 5=beep 4, 6=beep 5, 7=beep 6
		If KeyToneIndex =1 Then temp = Rnd(2,LCAR.LCAR_Beeps+2)
		LCAR.PlaySound(LCAR.FindSound("BEEP " & (temp-1)),False)
		'LCAR.PlaySoundAnyway( LCAR.FindSound("BEEP " & (temp-1)) )
	End If
	LCAR.Rumble(1)
End Sub

Sub Activity_LongClick
	ShowModeSelect(3)
End Sub


'Sub IsNotDropdown As Boolean 
'	If ShowSubBridges Then
'		Dim Item As LCARlistitem  = LCAR.LCAR_GetListItem(0,LCAR.LCAR_SelectedItem)
'		If Item.Tag = Item.Number Then
'			Select Case Item.Tag
'				Case 67, 76, 81, 64, 66, 89: Return False 'Tactical 2, Operations Center, DNA analysis, TOS, NX-01, ENT-B bridges
'			End Select
'		End If
'	End If 
'	Return True 
'End Sub
Sub TranslateSection(Index As Int) As Int 
	Dim Item As LCARlistitem, Items As List, temp As Int 
	If Index>-1 And Index< LCAR.GetListItemCount(0) Then 
		Item = LCAR.LCAR_GetListItem(0,Index)
		Index = Item.Tag 
		'Select Case Index 
			'Case 67, 76, 81, 64, 66, 89'Tactical 2, Operations Center, DNA analysis, TOS, NX-01, ENT-B bridges
				If Index = Item.Number Then 
					Select Case Index 
						Case 67, 76, 81'Tactical 2, Operations Center, DNA
							Items = API.GetStrings("sec_" & Index & "_", 0)
						Case 64, 66, 89'TOS, NX-01, ENT-B bridges 
							If ShowSubBridges Then Items = API.GetStrings("sec_" & Index & "_", 0)
					End Select
					If Items.IsInitialized Then 
						For temp = 0 To Items.Size - 1 
							AddSubItem(0, Index, temp+1, Items.Get(temp))
						Next
						Return -999
					End If 
				Else 'is sub section shortcut
					WallpaperService.SubScreenIndex = Item.Number - 1
				End If 
		'End Select
		Return Index 
	End If
	Return -999
End Sub
Sub AddSubItem(ListID As Int, MasterIndex As Int, SubIndex As Int, Title As String)'use listid 0
	Dim Index As Int = SubItemExists(ListID, MasterIndex, SubIndex)
	If Index = -1 Then 
		Index = SubItemExists(ListID, MasterIndex,MasterIndex) + SubIndex - 1
		LCAR.LCAR_AddListItem(ListID, Title.ToUpperCase, LCAR.LCAR_RandomColor, SubIndex, MasterIndex, False, "", 20 * LCAR.ScaleFactor, False, Index+1)
	Else 
		LCAR.LCAR_RemoveListitem(ListID,Index)
	End If
End Sub
Sub SubItemExists(ListID As Int, MasterIndex As Int, SubIndex As Int) As Int 
	Dim tList As LCARlist = LCAR.GetList(0), temp As Int, Item As LCARlistitem
	For temp = 0 To tList.ListItems.Size - 1
		Item = tList.ListItems.Get(temp)
		If Item.Tag = MasterIndex And Item.Number = SubIndex Then Return temp 
	Next
	Return -1
End Sub








Sub SetupBing
	'API.Trace("SetupBing", True)
	Translator.Initialize(Me, "BING", "NKV1uq4Bxb4T1H0IubabH/jOm02GkD3kaI4gerYXVTM", "LCARS_UI")
	Translator.MaxChars=100
	Translator.MustBeKlingon=True
	Translator.Dest = Translator.KlingonLanguage(False)
	CallSub(Translator, "AddKlingonTest")
	'API.Trace("SetupBing", False)
End Sub

Sub RestartTheApp
	AprilFools=False
	LCARSeffects2.IsSetup=False
	LCAR.SmallScreen=False
	LCAR.CrazyRez=0
	API.LoadSettings(True,BG)
	LCAR.ChartHeight =62
	LCAR.MeterWidth = 60
	ButtonMenu=0
	LCARSeffects.FrameElement=0
	LCAR.lcarElements.Initialize 
	LCAR.SoundList.Initialize 
	LCAR.LCARlists.Initialize 
	LCAR.LCARGroups.Initialize 
	Activity_Create(False)
End Sub

Sub SetupCamera 
	Dim Width As Int = 160, Height As Int = 120
	Log("Turning camera on")
	If Not(ACLpanel.IsInitialized) Then
		ACLpanel.Initialize("aclpanel")
		'If LCARSeffects4.TRI_CameraOrientation  = 0 OR LCARSeffects4.TRI_CameraOrientation  = 180 Then
			Activity.AddView(ACLpanel,API.IIF(API.debugMode,0, -Width),0,Width,Height)
		'Else
		'	Activity.AddView(ACLpanel,-Width,0,Height,Width)
		'End If
		ACLpanel.Visible=True
	End If
	camEx.Initialize(ACLpanel, LCARSeffects4.TRI_FrontCamera, Me, "camera")
	camEx.CameraOrientation  = LCARSeffects4.TRI_CameraOrientation 
	LCARSeffects4.TRI_FrontCamera=camEx.Front 
	'ACL.Initialize(ACLpanel, "camera")
	'ACL.PictureSize(ACLpanel.Width,ACLpanel.Height)
	'ACL.StartPreview 
End Sub
Sub StopCamera 
	'Log("Turning camera off")
	If camEx.IsInitialized Then'LCARSeffects4.CameraIsOn AND 
		Try
			camEx.Release 
		Catch
			Log(LastException.Message)
		End Try
		LCARSeffects4.CameraIsOn=False
		LCARSeffects4.CameraToggled=False
	End If
	'If CameraIsOn Then ACL.Release 
End Sub
Sub camera_Ready (Success As Boolean)
	Log("CAMERA IS " & API.IIF(Success, "READY", "NOT READY") & API.IIF(LCARSeffects4.FlashIsOn, ", NEEDS FLASH", ""))
	LCARSeffects4.CameraIsOn=Success
	If Success Then 
		camEx.StartPreview
		'If LCARSeffects4.TRI_FrontCamera Then ACL.CameraFront Else ACL.CameraBack 
		'ACL.StartPreview 
		If LCARSeffects4.FlashIsOn Then camEx.ToggleFlash
	End If
End Sub
Sub camera_preview(Data() As Byte)
	If LCARSeffects4.CameraIsOn And DateTime.Now >= LastFrame + FrameDelay And LCARSeffects4.TRI_Section=LCARSeffects4.TRI_MET Then
		LastFrame=DateTime.Now
		'LCARSeffects4.TRI_CameraUpdate2( camEx.BytesToBmp(Data))
		LCARSeffects4.TRI_CameraUpdate2( camEx.PreviewImageToBMP(Data,90, ACLpanel.Width ,ACLpanel.Height,True) )
	End If
End Sub



Sub Activity_Create(FirstTime As Boolean)
	Dim temp As Int,temp2 As Int ,tempstr As String' , Landscape As Boolean
	'If FirstTime Then 'API.Trace("", True)
	If API.FullscreenMode Then
		Dim jo As JavaObject = Activity, e As Object = jo.CreateEvent("android.view.View.OnSystemUiVisibilityChangeListener", "VisibilityChanged", Null)
	    jo.RunMethod("setOnSystemUiVisibilityChangeListener", Array As Object(e))
	End If
	'API.Trace("Activity_Create", True)
	LCAR.OvalHeight = 20 * LCAR.GetScalemode
	LCAR.MultiTouchEnabled=False
	LCAR.BGisInit=False
	TimerBlink=-1
	INITBG
	'If API.isstolen Then
	'	Msgbox("此方案尚未購買" & CRLF & "PIRACY SOFTWARE WAS DETECTED" & CRLF & "UNINSTALL BAIDU", "小偷模式啟動")
	'	ActivityFinish("Theif mode")
	'End If
		
	'If  LCAR.MultiTouchEnabled  Then G.SetOnTouchListener(Activity, "Activity_GesturesTouch")
	'Landscape=activity.Width>activity.Height 
	'Msgbox ( 50%x, activity.Width)
	If Not(LCAR.lcarElements.IsInitialized) Then LCAR.lcarElements.Initialize 
	If LCAR.lcarElements.Size=0 Then 
		SetupBing
		
		'API.Trace("SetupTheVariables", True)
		LCAR.SetupTheVariables 
		SetupVariables
		LCAR.SetupLCARcolors(Activity) 
		LoadSettings (False)
		'API.Trace("SetupTheVariables", False)
		
		If API.debugMode Then Log("Manufacturer: " & API.Model(0) & CRLF & "Model: " & API.Model(1) & CRLF & "Product: " & API.Model(2) & CRLF & "Size: " & API.GetDevicePhysicalSize & CRLF & "API: " & API.APIlevel & CRLF & "SDK: " & API.SDKversion)
		
		'HttpUtils.CallbackActivity="Main"
		'HttpUtils.CallbackJobDoneSub = "JobDone1"
		'HttpUtils.CallbackUrlDoneSub = "UrlDone"
		'HttpUtils.CallbackResponseSub = "Response"
	
		'API.Trace("InitSensors", True)
		InitSensors
		'API.Trace("InitSensors", False)
		
		'API.Trace("AddSounds", True)
		LCAR.AddSound("KLAXON", "criticalstop.ogg", File.DirAssets)'sound 0 (red alert toggle)
		LCAR.AddSound("INTRO",  "intro.ogg", File.DirAssets)'sound 1 (computer intro)
		LCAR.AddSound("AUTODESTRUCT", "autodestructarmed.ogg", File.DirAssets)'sound 2 (auto destruct sequence armed)
		LCAR.AddSound("1 MIN", "1minute.ogg", File.DirAssets)'sound 3 (1 minute remaining)
		LCAR.AddSound("10 SEC", "10seconds.ogg", File.DirAssets)'sound 4(10 seconds remaining)
		LCAR.AddSound("EMERGENCY", "timesup.ogg", File.DirAssets)'sound 5(0 seconds remaining)
		LCAR.AddSound("SEARCH MODE", "searchmode.ogg", File.DirAssets)'sound 6(search mode activated)
		LCAR.AddSound("INSUFFICIENT", "insufficientdata.ogg", File.DirAssets)'sound 7(insufficient data provided)
		LCAR.AddSound("ERROR", "error1.ogg", File.DirAssets)'sound 8 (error)
		LCAR.AddSound("BEEP 1", "beep1.ogg", File.DirAssets)'sound 9 (beep 1)
		LCAR.AddSound("BEEP 2", "beep2.ogg", File.DirAssets)'sound 10 (beep 2)
		LCAR.AddSound("BEEP 3", "beep3.ogg", File.DirAssets)'sound 11 (beep 3)
		LCAR.AddSound("ERROR2", "error.ogg", File.DirAssets)'sound 12 (error 2)
		LCAR.AddSound("RED ALERT", "redalert.ogg", File.DirAssets)'sound 13 (red alert)
		LCAR.SetSoundLength(LCAR.AddSound("WARP", "warp.ogg", File.DirAssets),1610)' LCAR.SetSoundPool(LCAR.AddSound("WARP", "warp.wav", File.DirAssets), 1000)'sound 14 (warp core) uses soundpool
		
		Games.TribbleSound = LCAR.AddSound("TRB YELL",  "scream.ogg", File.DirAssets)'sound 15 (tribble death scream)
		LCAR.AddSound("TRB SNAP",  "snap.ogg", File.DirAssets)'sound 16 (tribble pregnate pop)
		LCAR.AddSound("TRB BOMB",  "boom.ogg", File.DirAssets)'sound 17 (tribble explosion)
		LCAR.AddSound("TRB SLOW",  "weirdnoise.ogg", File.DirAssets)'sound 18 (tribble slow)
		LCAR.AddSound("TRB SICK",  "scanner.ogg", File.DirAssets)'sound 19 (tribble sick)
		LCAR.AddSound("TRB NORM",  "coo.ogg", File.DirAssets)'sound 20 (tribble normal coo/spawn)
		LCAR.AddSound("TRB FIRE",  "turret.ogg", File.DirAssets)'sound 21 (tribble fire turret)
		LCAR.AddSound("TRB MANY",  "manytribbles.ogg", File.DirAssets)'sound 22 (many tribbles)
		LCAR.AddSound("TRB HEAT",  "overheat.ogg", File.DirAssets)'sound 23 (over heat)	
		
		LCAR.AddSound("RED WARP", "warp2.ogg", File.DirAssets)'sound 24 (at warp, and red alert)
		LCAR.AddSound("HAILING", "hailing.ogg", File.DirAssets)'sound 25 (hailing freq. open)
		
		LCAR.AddSound("REPLICATE", "notareplicator.ogg", File.DirAssets)'sound 26 (not a replicator)
		LCAR.AddSound("BE POLITE", "donotaddress.ogg", File.DirAssets)'sound 27 (do not address this unit in that manner)
		
		LCAR.AddSound("TOS BRIDGE", "tos.ogg", File.DirAssets)'sound 28 (TOS Bridge)
		LCAR.AddSound("TOS KLAXON", "tosred.ogg", File.DirAssets)'sound 29 (TOS red alert)
		
		LCAR.AddSound("WORKING", "working.ogg", File.DirAssets)'sound 30 (ENT Working)
		LCAR.AddSound("INVALID", "notaccepted.ogg", File.DirAssets)'sound 31 (Not Working)
		
		LCAR.AddSound("DENIED", "accessdenied.ogg", File.DirAssets)'sound 32 (access denied)
		LCAR.AddSound("OLDALERT", "motpicaler.ogg", File.DirAssets)'sound 33 (emergency alert from motion picture)
		
		LCAR.AddSound("TOSTRANS", "transporter0.ogg", File.DirAssets)' sound 34 (TOS transporter)
		LCAR.AddSound("TNGTRANS", "transporter1.ogg", File.DirAssets)' sound 35 (TNG transporter)
		LCAR.AddSound("VOYTRANS", "transporter2.ogg", File.DirAssets)' sound 36 (VOY transporter)
		
		LCAR.AddSound("BEEP 4", "beep4.ogg", File.DirAssets)'sound 37 (beep 4)
		LCAR.AddSound("WAKE UP","assimilate.ogg","")'sound 38 (wake up and assimilate the day)
		LCAR.AddSound("CONTACT","contact.ogg","")'sound 39 (contact sound)
		
		LCAR.AddSound("BEEP 5", "beep5.ogg", File.DirAssets)'sound 40 (beep 5)
		LCAR.AddSound("BEEP 6", "beep6.ogg", File.DirAssets)'sound 41 (beep 6)
		LCAR.AddSound("BEEP 7", "beep7.ogg", File.DirAssets)'sound 42 (beep 7)
	
		LCAR.AddSound("MISSINGDATA", "missing.ogg", File.DirAssets)'sound 43 (error 404)
	
		Games.LoadTMPsounds 
		LCARSeffects4.TRI_Click = LCAR.AddSound("RATCHET", "click.ogg", File.DirAssets)
		LCAR.AddSound("TRICORDER", "tricorder.ogg", File.DirAssets)
		BorgSound = LCAR.AddSound("BORG", "borg.ogg", File.DirAssets)
		'API.Trace("AddSounds", False)
		
		LCAR.LoadPicture("insignia.gif", File.DirAssets)
		
		'API.Trace("AddLCARS", True)
		LCAR.LCAR_AddLCAR("Insignia", 0, LCAR.MAXDIM+50, LCAR.MAXDIM+50,  0,0, 0 ,0,0, LCAR.LCAR_Picture, "","","", 0,True, 0,True,5,  0)'element 0
		LCAR.LCAR_AddLCAR("Intro1", 0, 10, 50%y - LCAR.ItemHeight-1, -20, LCAR.ItemHeight, LCAR.leftside,LCAR.leftside, LCAR.LCAR_Orange, LCAR.LCAR_Button, "", "", "", 0, True, 4, True, 0, 0)'element 1
		LCAR.LCAR_AddLCAR("Intro2", 0, 10, 50%y + 1, -20, LCAR.ItemHeight, LCAR.leftside,LCAR.leftside, LCAR.LCAR_Orange, LCAR.LCAR_Button, "", "", "", 0, True, 4, True, 0, 0)'element 2
		LCAR.LCAR_AddLCAR("IntroText", 0, 0, 50%y+40, LCAR.ScaleWidth , LCAR.Fontsize , 0,0,LCAR.lcar_orange, LCAR.LCAR_Textbox , "", "", "", 0, True,  5,True, 0,0)'element 3 (side was [welcome])
		LCAR.MoveLCAR(1, 0,0,0,0,255 ,False,False,True)
		LCAR.MoveLCAR(2, 0,0,0,0,255,False,False,True)
		
		LCAR.SmallScreenMode(LCAR.LCAR_AddList("ModeSelect", 0,1,2,100,40,-1,-(Activity.Height -20), False, 3, LCAR.leftside,0,False,True,False,0))'list 0
		
		LCAR.LCAR_AddLCAR("ModeOK", 0, 0,-40, -1,71,97,17, LCAR.LCAR_Orange, LCAR.LCAR_Elbow , "","","",1,  False, 2, True, 2,255)'element 4 (text was API.getstring("help"))
		
		LCAR.LCAR_AddList("WIFI", 0, 1,2, 0,257,-1,-20,  False,  3,LCAR.leftside,  0, True,SensorEnabled,False ,LCAR.lcar_chart)'list 1

		LCAR.LCAR_AddList("Meters", 0, 1,2,  115,200,  -1 ,-1,  False,  3,LCAR.leftside,  0, True,SensorEnabled,False ,LCAR.LCAR_Meter )'list 2
		
		LCAR.LCAR_AddLCAR("SensorGrid", 0, 115,200,  -1 ,-1,  55,95, LCAR.LCAR_DarkBlue , LCAR.LCAR_SensorGrid, "",  "", "0", 2,    False,4,  True ,20,0)'element 5
	
		LCARSeffects.MakeFrame(3,5)	'elements 6-17, (group 3 and 5)	
		
		LCAR.LCAR_AddLCAR("TopText", 0, 100, 0,  -1 , 20 ,  0,0,LCAR.lcar_orange, LCAR.LCAR_Textbox , "", "", "",   4, False,  3, True, 143,0)'element 18 (group 4)
		LCAR.LCAR_AddLCAR("BigText", 0,  100, 200,  -1 , 100 ,  0,0,LCAR.lcar_orange, LCAR.LCAR_Textbox , "", "", "",   6 , False,  12, True, 0,0)'element 19 (group 6)
		LCAR.LCAR_AddLCAR("Belay", 0,  100+LCAR.ChartSpace, -LCAR.ItemHeight,-1,LCAR.ItemHeight,LCAR.leftside,0, LCAR.LCAR_Orange, LCAR.LCAR_Button, "","","", 7,  False, 5,True, 0,255)'element 20 (group 7) (text was API.getstring("cancel"))
		
		LCAR.SmallScreenMode(LCAR.LCAR_AddList("Settings", 0, 1,1,  100 + LCAR.ChartSpace,200,  100 ,-1,  False,  3,LCAR.leftside,  0,  False,True,False ,0 ))'list 3 changed shownumber to true
			
		LCAR.LCAR_Addlist("Options", 0, 1,1, 104, 200, 100,-1, False,3,0,0,False,False,False,0)'list 4
		
		LCAR.SmallScreenMode(LCAR.LCAR_AddList("Timer", 0, 2 ,3,  100 + LCAR.ChartSpace,200, -1 ,-1,  False,  3,LCAR.leftside,  0,   False,True,False ,0 ))'list 5	
		
		LCAR.MakeKeyboard (0, 8) 'list 6, group 8, elements 21,22,23,24,25,26
		
		LCAR.LCAR_AddLCAR("Navigation", 0, 115,200,  -1 ,-1, 0,-45,LCAR.lcar_orange, LCAR.LCAR_Navigation, "", "", "",   9, False,  0,True,  0,255)'element 27 (group 9)
		
		LCAR.MakeNumboard(0,10, Settings)' lists 7 and 8, elements 28,29,30,31, 32,33,34,35, 36,37,38 (group 10)
		
		LCAR.LCAR_AddLCAR("Tactical", 0, 115,200,   -1 ,-1, 1,1,LCAR.lcar_orange, LCAR.LCAR_Tactical, "", "", "",   11, False,  0,True,  0,255)'element 39 (group 11)
		LCAR.LCAR_AddList("Tactical", 0, 1 ,1, 0, 256,103, -1,  False,  3, 0,  0,  False,False,False ,0 )'list 9
		
		LCAR.SmallScreenMode(LCAR.LCAR_AddList("UMRactions", 0, 2 ,3,  100 + LCAR.ChartSpace,200, -1 ,-1,  False,  3,LCAR.leftside,  0,  False,True,False ,0 ))'list 10
		LCAR.LCAR_AddList("UMRtasks", 0, 1 ,1,  100 + LCAR.ChartSpace,200, -1 ,-1,  False,  3,LCAR.leftside,  0,  False,True,False ,0 )'list 11
		LCAR.SmallScreenMode(LCAR.LCAR_AddList("UMRmain", 0, 2 ,3,  100 + LCAR.ChartSpace,200, -1 ,-1,  False,  3,LCAR.leftside,  0,  False,True,False ,0 ))'list 12
		LCAR.LCAR_AddList("UMRfiles", 0, 1 ,1,  100 + LCAR.ChartSpace,200, -1 ,-1,  False,   3,LCAR.leftside,  50,  False,True,False ,0 )'list 13
		LCAR.LCAR_AddLCAR("DownloadUMR", 0, 10,-40,-20,LCAR.ItemHeight,LCAR.leftside,0, LCAR.LCAR_Orange, LCAR.LCAR_Button, "","","",12 ,  False, 5,True, 0,255)'element 40 (group 12) text=API.getstring("umr_download")
		
		LCARSeffects.MakePrompt(0, 13)'Elements 41,42,43,44,45,46,47 (group 13)
		
		temp = Min(Activity.Width, Activity.Height)
		LCAR.LCAR_AddLCAR("OkudaToggleHUD",  0,0,0,200, LCAR.ItemHeight, 0,0, LCAR.LCAR_Orange, LCAR.LCAR_Button, "", "", "", 14, False, 4,True, 0,255)' element 48 (group 14) text=API.getstring("okuda_toggle")
		LCAR.LCAR_AddLCAR("OkudaDpad", 0,-200,30,200,200,0,0,LCAR.LCAR_Orange, LCAR.LCAR_Dpad, "","","", 14 ,True, 0,True, 0,0)' element 49 (group 14)
		LCAR.LCAR_AddLCAR("Okudagram", 0,-temp,-temp,temp,temp,0,0,LCAR.LCAR_Orange, LCAR.LCAR_Okuda, "","","", 14 ,True, 0,True, 0,0)' element 50 (group 14)
		LCAR.LCAR_AddList("OkudaUI", 0,1,1,0,LCAR.ItemHeight+3, 203, LCAR.listitemsheight(6), False,3,0 ,140,False,False,False,0)'list 14
		LCAR.LCAR_AddList("OkudaUI2", 0, 1,1,0,LCAR.ItemHeight+3, 203, -1, False,0,0 ,0,False,False,False,0)'list 15

		LCAR.LCAR_AddLCAR("AlertStatus", 0, 0,0,-1,-1, LCAR.Classic_Green, 0,  LCAR.Classic_Green, LCAR.LCAR_Alert, "", "","", 15,False,0,True,0,255)'element 51 (group 15)
		
		LoadHistory(LCAR.LCAR_AddList("History", 0, 1 ,1,  100 + LCAR.ChartSpace,200, -1 ,-1,  False,  3,LCAR.leftside,  0,  False,True,False ,0 ), "History", API.GetString("web_clear_hist"))'list 16 
		
		LCAR.LockListStart(LCAR.LCAR_AddList("Sensors", 0,1,1, 0, 256,103,   LCAR.ListItemsHeight(5)   , False, 0,0,0,False,False,False,0),True)'list 17

		LCAR.RespondToAll(LCAR.LCAR_AddLCAR("MouseGrid", 0, 115,200,  -LCAR.ItemHeight -3 ,-100,  55,95, LCAR.LCAR_DarkBlue , LCAR.LCAR_SensorGrid, "",  "", "0", 16,  False,4 ,  True ,0,0))'element 52 (group 16)
		LCAR.LCAR_AddLCAR("MouseScroll", 0,  -LCAR.ItemHeight,200, LCAR.ItemHeight ,-100,  55,95, LCAR.LCAR_DarkBlue , LCAR.LCAR_Slider, "",  "", "", 16, True,4 ,  True ,0,0)'element 53 (group 16)
		LCAR.LCAR_AddLCAR("MouseLeft", 0, 115,-100,100,100,0,0, LCAR.LCAR_Orange, LCAR.LCAR_Button, "","","", 16,  False, 5,True, 0,255)'element 54 text=API.getstring("umr_left")
		LCAR.LCAR_AddLCAR("MouseMid", 0, 218,-100,100,100,0,0, LCAR.LCAR_Orange, LCAR.LCAR_Button, "","","", 16,  False, 5,True, 0,255)'element 55 text=API.getstring("umr_middle")
		LCAR.LCAR_AddLCAR("MouseRight", 0, 321,-100,100,100,0,0, LCAR.LCAR_Orange, LCAR.LCAR_Button, "","","", 16,  False, 5,True, 0,255)'element 56 text=API.getstring("umr_right")
		
		LCAR.LCAR_AddLCAR("TheMatrix", 0, 0,0,  -1 ,-1,  55,95, LCAR.LCAR_DarkBlue , LCAR.LCAR_Matrix, "",  "", "", 17,  False,4 ,  True ,0,0)'element 57 (group 17)

		LCAR.LCAR_AddLCAR("Refresh", 0,  0,-50,180,50, 0, 0,  LCAR.Classic_Blue, LCAR.Legacy_Button , "", "","", 18,False,0,True,9,255)'element 58 (group 18) text= API.getstring("clock_refresh")
		LCAR.LCAR_AddLCAR("CLS", 0,  -180,-50,180,50, 0, 0,  LCAR.Classic_Green, LCAR.Legacy_Button , "", "","", 18,False,0,True,9,255)'element 59 (group 18) text=API.getstring("clock_clear")
		LCAR.LCAR_AddLCAR("PATH", 0,  -180,0,180,50, 0, 0,  LCAR.Classic_Blue, LCAR.Legacy_Button , "", "","", 18,False,0,True,9,255)'element 60 (group 18) text=API.GetString("clock_paths")
		LCAR.LCAR_AddLCAR("Help", 0,  0,0,180,50, 0, 0,  LCAR.Classic_Green, LCAR.Legacy_Button , "", "","", 18,False,0,True,9,255)'element 61 (group 18) text=API.getstring("help")
		LCAR.LCAR_AddLCAR("Starbase", 0, 0,0,-1,-1, 0, 0,  LCAR.Classic_Green, LCAR.LCAR_StarBase, "", "","", 18,False,0, False,0,255)'element 62 (group 18)
		
		LCAR.LCAR_AddList("Analysis", 0, 0 ,0,  100 + LCAR.ChartSpace,200 , -1 ,-1,  False,  3,LCAR.leftside,  0,  False,True,False , LCAR.LCAR_Analysis )'list 18
		
		LCARSeffects2.AddGraph(0, 25, False)'graph 0, element 63
		LCAR.LCAR_AddLCAR("Graph", 0, 115,2, -1,130, 3,4, LCAR.LCAR_Orange , LCAR.LCAR_Graph, "",  "", "",  19,   False,0 ,   True ,0,0)'element 63 (group 19)
		
		LCAR.LCAR_AddLCAR("WARPCORE", 0, 0,0, -1,-1,  0,0, LCAR.LCAR_Orange , LCAR.LCAR_Engineering, "",  "", "",  20,  False,0 ,   True ,0,0)'element 64 (group 20)
		
		temp = (Min(Activity.Width, Activity.height)-15) / 4
		LCAR.LCAR_AddLCAR("EXIT", 0,0,0, temp,50,0,0, LCAR.LCAR_Red, LCAR.ENT_Button ,  LCARSeffects2.RandomENT, "", "", 21,False, 0, True, 0,0)' element 65 (group 21) side=API.getstring("exit")
		LCAR.LCAR_AddLCAR("BACK", 0,temp+5,0, temp,50,0,0, LCAR.LCAR_Yellow, LCAR.ENT_Button ,  LCARSeffects2.RandomENT, "", "", 21,False, 0, True, 0,0)' element 66 (group 21) side=API.getstring("back")
		LCAR.LCAR_AddLCAR("PRTSCR", 0,(temp+5)*2,0, temp,50,0,0, LCAR.LCAR_Yellow, LCAR.ENT_Button ,  LCARSeffects2.RandomENT, "", "", 21,False, 0, True, 0,0)' element 67 (group 21) side=API.GetString("printscreen")
		
		LCAR.LCAR_AddLCAR("Sweep", 0, 115,2, -1,130, 3,4, LCAR.LCAR_Orange , LCAR.LCAR_SensorSweep, "",  "", "",  22,   False,0 ,   True ,0,0)'element 68 (group 22)
		
		LCAR.LCAR_AddList("SetSections", 0,1,1, 0, 256,103,   LCAR.ListItemsHeight(4)   , False, 0,0,0,False,False,False,0)'list 19
		
		LCAR.RespondToAll(LCAR.LCAR_AddLCAR("KLINGON", 0, 0,0, -1,-1,   0,-1, LCAR.LCAR_Orange , LCAR.Klingon_Frame, "",  "", "",  23,  False,0 ,   True ,0,0))'element 69 (group 23) 
		
		LCAR.LCAR_AddLCAR("OMEGA", 0,0,0,-1,-1,0,0,LCAR.Classic_Blue, LCAR.LCAR_Omega, "Ω","","", 24,False,0,True,0,0)'element 70 (group 24)
		
		AddAxis(LCAR.LCAR_AddList("AxisList", 0, 2,3,  100 + LCAR.ChartSpace,200,  -1 ,-1,  False,  3,LCAR.leftside,  20,   False,False,False ,0 ))'list 20
		LCAR.LCAR_AddList("SAxisList", 0, 2,3,  100 + LCAR.ChartSpace,0,  -1 ,130,  False,  3,LCAR.leftside,  20,   False,False,False ,0 )'List 21
		LCAR.LCAR_AddLCAR("MultiSpectral", 0, 115,200,  -1 ,-1, 0,-45,LCAR.lcar_orange, LCAR.LCAR_MultiSpectral, "", "", "",   25, False,  0,True,  0,0)'element 71 (group 25) text=API.GetString("no_axis")
		LCAR.LCAR_AddLCAR("Ruler", 0, 0,0,   -1 ,10, 0,10,LCAR.lcar_orange, LCAR.LCAR_Ruler , "", "", "",   25, False, 2,True,  2,0)'element 72 
		
		LCAR.LCAR_AddLCAR("Shields", 0, 105,2, 210 ,140, 1,1,LCAR.lcar_orange, LCAR.LCAR_ShieldStatus, "", "", "",   11, False,  -1,True,  0,255)'element 73 (group 11)
		
		LCAR.RespondToAll(LCAR.LCAR_AddLCAR("PdP", 0,115,200,-1,-1,  0,13, LCAR.LCAR_Orange , LCAR.lcar_pdp, "",  "", "",  26,  False,0 ,   True ,0,0))'element 74 (group 26)
		'LCAR.LCAR_AddLCAR("PdP", 0,115,200,-1,-1,  5,50, LCAR.LCAR_Orange , LCAR.PCAR_Frame, "PLAYER 1",  "", "",  25,  False,3 ,    True ,5, 0)'element 74 (group 26)
		
		LCAR.LCAR_AddLCAR("Feeds", 0,(temp+5)*3,0, temp,50,0,0, LCAR.LCAR_Yellow, LCAR.ENT_Button ,  "", "", "", 21,False, 0, True, 0,0)' element 75 (group 21), text=API.GetString("app"), API.getstring("gplus_list")
		LCAR.LCAR_AddList("PlusFeeds",0 , 2,2, 0, 53,-1,-1,False,3 ,0 ,0,False,False,False,  LCAR.ENT_Button )'List 22
		AddSocialMediaFeeds(22,0)

		LCAR.LCAR_AddLCAR("PdPCS", 0, 115,2, -1,130, 0,0, LCAR.LCAR_Orange , LCAR.LCAR_PdPSelector, "",  "", "",  27,   False,0 ,   True ,0,0)'element 76 (group 17)
			
		LCAR.LCAR_AddLCAR("Static", 0, 115,200,   -1 ,-1, 1,1,LCAR.lcar_orange, LCAR.LCAR_Static, "", "", "",   27, False,  0,True,  0,255)'element 77 (group 27)	
			
		LCAR.LCAR_AddLCAR("ServerUMR", 0, 10,-40,-20,LCAR.ItemHeight,0,LCAR.leftside, LCAR.LCAR_Orange, LCAR.LCAR_Button,"","","",12 ,  False, 5,True, 0,255)'element 78 (group 12) text= API.getstring("umr_server")
		
		LCARSeffects2.AddGraph(1, 0, False)'graph 1, element 79
		LCAR.LCAR_AddLCAR("Microphone", 0, 0,256,  -1 ,-1,  14,3, LCAR.LCAR_Orange , LCAR.LCAR_Graph, "",  "", "",  28,   False,1,   True ,4,0)'element 79 (group 28)
		
		LCAR.LCAR_AddLCAR("Moire", 0, 0,0,   -1 ,-1,  0,0,LCAR.lcar_orange, LCAR.TOS_Moires, "", "", "",   29, False,  0 ,True,  0,255)'element 80 (group 29)	
		LCAR.LCAR_AddLCAR("Sonar", 0, 0,0,   -1 ,-1,  0,0,LCAR.Classic_Blue, LCAR.Legacy_Sonar, "", "", "",   30, False,  0 ,True,  0,255)'element 81 (group 30)	 text=API.getstring("photic") & " "
		
		LCAR.LCAR_AddLCAR("RNDnum", 0, 115,0, -1,145,0,0, LCAR.LCAR_Orange , LCAR.LCAR_RndNumbers, "",  "", "",  31,   False,0 ,   True ,0,0)'element 82 (group 31)
	
		LCAR.RespondToAll(LCAR.LCAR_AddLCAR("PToE", 0,0,0,-1,-1,0,0,LCAR.LCAR_Orange, LCAR.LCAR_PToE, "", "", "", 32,False, 0,True, 0,0))'element 83 (group 32) text=API.getstring("sec_21"), API.GetString("lsod_0")
		
		LCAR.LCAR_AddList("Logs", 0, 1 ,1,  100 + LCAR.ChartSpace,200, -1 ,-1,  False,  3, LCAR.leftside,  200,  False,False,False ,0 )'list 23
		
		LCAR.LCAR_AddList("CALC1", 0,5, 5, 100 + LCAR.ChartSpace,200 ,-1, -1, False, 0,0,0,False,False,False,0)'list 24 	numpad	
		LCAR.LCAR_AddList("CALC2", 0,1, 1, 100 + LCAR.ChartSpace,200 ,-1, -1, False, 3,LCAR.leftside,-40, False ,True,False,0)'list 25   answers
		LCAR.LCAR_AddList("CALC3", 0,1, 1, 100 + LCAR.ChartSpace,200 ,-1, -1, False, 3,LCAR.leftside,-40, False ,False,False,0)'list 26   questions
				
		LCARSeffects2.AddGraph(2, 1,  True)'graph 2, element 84
		LCAR.LCAR_AddLCAR("Graph2", 0, 100 + LCAR.ChartSpace,200 ,-1, -1, 3,4, LCAR.LCAR_Orange , LCAR.LCAR_Graph, "",  "", "",  33,    False,2 , True ,1,0)'element 84 (group 33)
		
		LCARSeffects2.AddGraph(3,0,False)'graph 3
		
		LCAR.RespondToAll(LCAR.LCAR_AddLCAR("LWP", 0, 0,0, -1,-1, -1, 0, LCAR.LCAR_Orange , LCAR.LCAR_LWP, "",  "", "",  34,  False,0 ,   True ,0,0))'element 85 (group 34) 
		
		LCAR.LCAR_AddLCAR("SQ2", 0, 0,0, -1,-1, -1, 0, LCAR.LCAR_Orange , LCAR.LCAR_ASquare, "",  "", "",  35,  False,0 ,   True ,0,0)'element 86 (group 35) 
		
		LCAR.LCAR_AddLCAR("ModeOK2", 0, 0,0,-1,71,97,17, LCAR.LCAR_Orange, LCAR.LCAR_Elbow , "","","",1,  False, 2, True, 0,255)'element 87 (group 2) 
		LCAR.LCAR_AddLCAR("ModeOK3", 0, 100,-40,-1,LCAR.ItemHeight,LCAR.leftside,75, LCAR.LCAR_Orange, LCAR.LCAR_Button, "", "","",1,  False, 5, True, 0,255)'element 88 text=API.GetString("kb_ok"),API.GetString("help")
		
		LCAR.LockListStart(LCAR.LCAR_AddList("COMMS", 0,5, 5, 100 + LCAR.ChartSpace,200 ,-1, -1, False, 0,0,0,False,False,False,0) ,True)'list 27 	
		
		LCAR.LCAR_AddLCAR("SCI1", 0, 115,0, -1,145,        LCAR.LCAR_LightPurple,0, LCAR.LCAR_Orange , LCAR.LCAR_Science, "",  "", "",  36,   False,0 ,   True ,0,0)'element 89 (group 36)'72 in SSM
		LCAR.LCAR_AddLCAR("SCI2", 0, 115,181, -1,-1,       LCAR.LCAR_LightPurple,0, LCAR.LCAR_Orange , LCAR.LCAR_Science, "",  "", "",  36,   False,0 ,   True ,1,0)'element 90 (group 36)
		
		LCAR.LCAR_AddLCAR("SWARS", 0, 0,0,   -1 ,-1,      0,     100,LCAR.lcar_orange, LCAR.SWARS_Targeting, "", "", "",   37, False,   0 ,True, 999,255)'element 91 (group 37)
		
		LCAR.LCAR_AddLCAR("PREVIEW", 0,temp+5,0, temp,50,0,0, LCAR.LCAR_Yellow, LCAR.ENT_Button ,  "", "", "", 38,False, 0, True, 0,0)' element 92 (group 38) sidetext = API.GetString("preview")
		
		LCAR.LCAR_AddLCAR("ATOP", 0,0 ,0, -1, LCAR.itemheight,  LCAR.LCAR_LightBlue, LCAR.LCAR_Orange, LCAR.LCAR_Orange, LCAR.LCAR_TextButton, "", "", "",  39, False, 0,True, LCAR.LCAR_LightBlue, 255)'element 93 (group 39) text=API.GetString("alarm_online")
		LCAR.LCAR_AddLCAR("AUFP", 0, LCAR.ItemHeight*2, LCAR.ItemHeight*2,  100,100, -1 ,1,1, LCAR.LCAR_Picture, "","","",  39,True, 0,True,0,  0)'element 94 (group 39)
		LCAR.LCAR_AddLCAR("ABigText", 0,  100, 200,  -1 , 100 ,  0,0,LCAR.lcar_orange, LCAR.LCAR_Textbox , "", "", "",   39 , False,  12, True, 0,0)'element 95 (group 39)
		LCAR.LCAR_AddLCAR("AAnswer", 0,0, -LCAR.itemheight, -1,LCAR.ItemHeight,0,0, LCAR.Classic_Green, LCAR.LCAR_Answer, "", "","", 39, False, LCAR.LCAR_Red,True, 1,255)'element 96 (group 39)
		
		LCAR.LCAR_AddLCAR("META", 0, 115,200,   -1 ,-1, 0,0, 0, 				LCAR.LCAR_Metaphasic, "", "", "",   40, False,  0,True, -1,255)'element 97 (group 40)	
		
		LCAR.LCAR_AddLCAR("WIDGET", 0,0,0,320,320,-1,0,LCAR.LCAR_Orange,		LCAR.LCAR_Widget,"","","", 41, False, 0,False,0,255)'element 98 (group 41)
		LCAR.LCAR_AddLCAR("WIDPAD", 0, -300,-300,300,300, 0,0,LCAR.LCAR_Orange, LCAR.LCAR_Dpad, "", "", "", 41, False, 0, True, 0,255)' element 99 (group (41)

		LCAR.LCAR_AddLCAR("CHXLOGO", 0, 0,0,-1,-1, 0, 0,  LCAR.Classic_Green, 	LCAR.CHX_Logo, "", "","", 42,False,0,  True,0,255)'element 100 (group 42)
		LCAR.LCAR_AddLCAR("DRADIS", 0,   0,0,-1,-1,     0,0,0,        			LCAR.DRD_Timer, "", "", "", 43, False, 0,True, 0,255)'element 101 (group 43)
		LCAR.LCAR_AddLCAR("ENDGAME", 0,   0,0,-1,-1,     0,180,0,     			LCAR.VOY_Tricorder, "", "", "", 44, False, 0,True, 0,255)'element 102 (group 44)
		LCAR.RespondToAll(LCAR.LCAR_AddLCAR("3Dgames", 0,   0,0,-1,-1,     0,0, LCAR.LCAR_Yellow,  LCAR.LCAR_ThreeDGame, "", "", "", 45, False, 0,True, 0,255))'element 103 (group 45)
		LCAR.RespondToAll(LCAR.LCAR_AddLCAR("SOLAR", 0,   0,0,-1,-1,    0,0,0,  LCAR.ENT_Planets,  "", "", "", 46, False, 0,True, 0,255))'element 104 (group 46)
		LCAR.LCAR_AddLCAR("EVENTHOR", 0,   0,0,-1,-1,     0,0,0,        		LCAR.EVENT_Horizon, "", "", "", 47, False, 0,True, 0,255)'element 105 (group 47)
		'API.Trace("AddLCARS", False)
		
		LCAR.LCAR_AddLCAR("DS9", 0,   0,0,-1,-1,     0,0,0,        		LCAR.CRD_Shatter, "", "", "", 48, False, 0,True,  1,255)'element 106 (group 48) align=1
		LCAR.LCAR_AddLCAR("VOY", 0,   115,200,-1,-1, 1,1,LCAR.lcar_orange, LCAR.LCAR_ShieldStatus, "", "", "",   49, False,  0,True,  1,255)'element 107 (group 49)
		
		'lwidth=angle, align=angle increment, rwidth=radiusY (75%), TextAlign=Z scaling (25%), colorid=stroke (1), text=dir, sidetext=filename, 
		LCAR.RespondToAll(LCAR.LCAR_AddLCAR("VOY3D", 0,          0,0,         -1,-1,            0,        35,       2,        LCAR.LCAR_3Dmodel, "", "voyager.3d", "", 50, False, 35,True, 1,255))'element 108 (group 50)
		LCAR.LCAR_AddLCAR("WAVE", 0,          0,0,         -1,-1,            0,        25,       LCAR.Classic_Blue,        LCAR.TMP_3Dwave, "", "", "", 51, False, 3,True, LCAR.LCAR_DarkBlue ,255)'element 109 (group 51)
		
		Games.CARD_ElementID = LCAR.LCAR_AddLCAR("CARD", 0, 100 + LCAR.ChartSpace,200 ,-1, -1, 0,0, LCAR.LCAR_Orange , LCAR.LCAR_Cards, "",  "", "",  52, False,         0 , True ,0,      255)'element 110 (group 52)
		LCAR.LCAR_AddLCAR("CARD2", 0, 100 + LCAR.ChartSpace,0 ,-1, 130, 1,1, LCAR.LCAR_Orange , LCAR.LCAR_Cards, "",  "", "",  52, False,         0 , False ,0,      255)'element 111 (group 52)
	
		LCAR.LCAR_AddLCAR("Plasma", 0, 115,200,  -1 ,-1,  55,95, LCAR.LCAR_White , LCAR.LCAR_Plasma, "",  "", "",  53, False, 0, True, 0,0)'element 112 (group 53)
		LCAR.RespondToAll(LCAR.LCAR_AddLCAR("PULASKI", 0, 115,200,  -1 ,-1,  0,0, LCAR.Classic_Blue , LCAR.DrP_Board, "",  "", "", 54, False, 0, True, 0,0))'element 113 (group 54)
		
		LoadTranslation
		'API.Trace("Startup", True)
		MakeMenu(False)
		If AprilFools Then 
			SetupAprilFoolsMode(True)
			LCAR.PlaySoundAnyway(1)
		Else If SkipIntro > 0 Then
			RedoIntro(SkipIntro, "First Time")
		End If	
		'API.Trace("Startup", False)
		
		'API.Trace("Startup2", True)
		tempstr = Settings.GetDefault("SmallScreen", "")
		If tempstr.EqualsIgnoreCase("true") Or LCAR.CrazyRez>0 Then SmallScreenMode
		If SkipIntro = 0 And ( Not(AprilFools) Or API.debugMode ) Then ShowModeSelect(4)
		What3Words.InitHTTP(Me)
		'API.Trace("Startup2", False)
	Else
		'API.Trace("Startup warm", True)
		LCAR.SetupLCARcolors(Activity) 
		If LCAR.GroupVisible(3) Then 
			NeedsShowFrame = True
			LCARSeffects.NeedsRedrawFrame = True
			'ShowFrame(False, lcar.LCAR_GetElement(17).Visible )
		End If
		
		LCARSeffects.IsPromptVisible(Null)
		ResizeScreen
		'API.Trace("Startup warm", False)
		'lcar.IsKeyboardVisible(BG,10,False )
	End If
	
	If LCAR.SmallScreen Then
		temp=50 + LCAR.ChartSpace
		temp2=100
	Else
		temp=100 * LCAR.CrazyRez + LCAR.ChartSpace
		temp2=LCAR.GetScaledPosition(3,False)
	End If
	
	Try	
		Activity.AddView(webview1,  temp,temp2, Activity.Width-temp,Activity.Height-temp2)
	Catch
		Log(LastException.Message)
	End Try
	
	'MoveWebview
	SetShowWhenLocked(True)
	webview1.Visible = False
	webview1.Color=Colors.Black 
	webview1.ZoomEnabled =False
	'API.Trace("InitTTS", True)
	'InitTTS(True)
	'API.Trace("InitTTS", False)
	'Log("LastVersion: " & LastVersion & " GetVersion: " & GetVersion & " IsConnected: " & API.IsConnected & " SkipUpdate: " & STimer.SkipUpdate)
	If Not( LastVersion.EqualsIgnoreCase(GetVersion)) And LastVersion.Length>0 And API.IsConnected  And Not(STimer.SkipUpdate) And Not(AprilFools) Then
		'API.Trace("GetVersion", True)
		If Not(API.isSmallScreenDevice) Then
			LCAR.Stop("Browser")
			BrowseMySite("changes")
		End If
		LastVersion=GetVersion
		'API.Trace("GetVersion", False)
	Else If  LastVersion.Length=0 And API.IsConnected Then
		LastVersion=GetVersion
	End If
	
	STimer.SkipUpdate=True
	WallpaperService.SettingsLoaded=False
	'API.Trace("start3", True)
	AlignLists
	LCARSeffects2.ClearRandomNumbers
	If LCARSeffects3.TMPisVisible Then LCARSeffects3.ShowTMPPrompt(BG,"","", Array As String(""),-1)
	API.StartPhoneEvents
	'API.Trace("start3", false)
	
	TimerMain.Initialize("Timermain", 10 )
	TimerMain.Enabled=True
	'SendFolderContents("M:\Music\Artists")
	'API.RunTests 
	
	'LCARSeffects3.DrawTextWidget(BG,0,0,0,0, Widgets.StardateMode)
	'API.Trace("Activity_Create", False)
	'API.Trace("", False)
	
	If FirstTime And API.debugMode Then API.SendPebble(API.GetString("app"), "THE PROGRAM HAS STARTED")
End Sub

Sub LoadTranslation
	If API.TransNew Then 
		API.TransNew = False 
		LoadTransElement(3, 	"", 								API.getstring("welcome"), 						"")
		LoadTransElement(4, 	API.getstring("help"), 				"", 											"")
		LoadTransElement(20, 	API.getstring("cancel"), 			"", 											"")
		LoadTransElement(40, 	API.getstring("umr_download"), 		"", 											"")
		LoadTransElement(48, 	API.getstring("okuda_toggle"), 		"", 											"")
		LoadTransElement(54, 	API.getstring("umr_left"), 			"", 											"")
		LoadTransElement(55, 	API.getstring("umr_middle"), 		"", 											"")
		LoadTransElement(56, 	API.getstring("umr_right"), 		"", 											"")
		LoadTransElement(58, 	API.getstring("clock_refresh"), 	"", 											"")
		LoadTransElement(59, 	API.getstring("clock_clear"), 		"", 											"")
		LoadTransElement(60, 	API.getstring("clock_paths"), 		"", 											"")
		LoadTransElement(61, 	API.getstring("help"), 				"", 											"")
		LoadTransElement(65, 	LCARSeffects2.RandomENT, 			API.GetString("exit"), 							"")
		LoadTransElement(66, 	LCARSeffects2.RandomENT, 			API.GetString("back"), 							"")
		LoadTransElement(67, 	LCARSeffects2.RandomENT, 			API.GetString("printscreen"), 					"")
		LoadTransElement(71, 	API.getstring("no_axis"), 			"", 											"")
		LoadTransElement(75, 	API.getstring("app"),				API.getstring("gplus_list"), 					"")
		LoadTransElement(78, 	API.GetString("umr_server"), 		"", 											"")
		LoadTransElement(81, 	API.getstring("photic") & " ", 		"", 											"")
		LoadTransElement(83, 	API.getstring("sec_21"),			API.getstring("lsod_0"), 						"")
		LoadTransElement(88, 	API.GetString("kb_ok"),				API.GetString("help"), 							"")
		LoadTransElement(92, 	LCARSeffects2.RandomENT, 			API.GetString("preview"), 						"")
		LoadTransElement(93, 	API.GetString("alarm_online"), 		"", 											"")
		LoadTransElement(95, 	API.getstring("alarm_text"), 		"", 											"")
		LoadTransElement(96, 	API.getstring("alarm_wake"),		API.getstring("alarm_snooze"), 					"")
		LoadTransElement(102, 	API.GetString("tricorder0"), 		API.GetString("tricorder1"), 					"")
		LoadTransElement(103, 	API.GetString("msd_left"), 			API.getstring("msd_right"), 					"")
		
		ClearLists(Array As Int(9, 12, 14, 17, 24, 25, 26))
		LCAR.LCAR_AddListItems(9, LCAR.LCAR_Random, 0, API.GetStrings("tactical", 0))
		GPSitems = LCARSeffects.LoadGPScoordinates(Settings,9) + 3
		LCAR.ResizeList(9, 103, LCAR.ListItemsHeight(GPSitems),-1,0,0,False)
		LCAR.LCAR_AddListItems(12, LCAR.LCAR_Random,0, API.GetStrings("umr", 0))
		LCAR.LCAR_AddListItems(14, LCAR.LCAR_Random,0, API.getstrings("okuda_tools", 0))', "MOUSE",
		LCAR.LCAR_AddListItems(17, LCAR.LCAR_Random,0, API.GetStrings("sens",0))
		LCAR.LCAR_AddListItems(24, LCAR.LCAR_Random, 0, Array As String("^", "7", "4", "1", "0", "<ı",	 "/", "8", "5", "2", ".", API.getstring("kb_backspace"), 	"*", "9", "6", "3", "(", API.getstring("kb_clr"),		 "-", "+", "=", "<", ")", API.getstring("kb_delete"),	"&", "|", "!", ">", API.getstring("kb_ok"), "ı>"))'list 24
		LCAR.LCAR_AddListItem(25, API.getstring("calc_clear"), LCAR.LCAR_Random, -1,  "" , False, "", 0 , False, -1)
		LCAR.LCAR_AddListItem(26, API.getstring("calc_formula_for_y"), LCAR.lcar_random, -1, "", False, "", 0, False, -1)
		LCAR.LCAR_AddListItem(26, API.getstring("calc_inc"), LCAR.lcar_random, -1, "", False, "1", 0, False, -1)
		LCAR.LCAR_AddListItem(26, API.getstring("calc_start_x"), LCAR.lcar_random, -1, "", False, "0", 0, False, -1)
		LCAR.LCAR_AddListItem(26, API.getstring("calc_end_x"), LCAR.lcar_random, -1, "", False, "10", 0, False, -1)
		LCAR.LCAR_AddListItem(26, API.getstring("calc_shape"), LCAR.lcar_random, -1, "0", False, API.getstring("calc_shapes0"), 0, False, -1)
		LCAR.LCAR_AddListItem(26, API.getstring("calc_view"), LCAR.lcar_random, -1, API.getstring("calc_view"), False, "", 0, False, -1)
		If LCAR.IsListVisible(3) Then ShowSettingsNoClear(False)
	End If 
End Sub
Sub LoadTransElement(ID As Int, Text As String, SideText As String, Tag As String)
	Dim Element As LCARelement = LCAR.LCARelements.Get(ID)
	If Not(Text.EqualsIgnoreCase(LCAR.LCAR_IGNORE)) Then Element.Text = Text 
	If Not(SideText.EqualsIgnoreCase(LCAR.LCAR_IGNORE)) Then Element.SideText = SideText
	If Not(Tag.EqualsIgnoreCase(LCAR.LCAR_IGNORE)) Then Element.Tag = Tag
End Sub
Sub ClearLists(Lists() As Int)
	Dim temp As Int 
	For temp = 0 To Lists.Length - 1 
		LCAR.LCAR_ClearList(Lists(temp), 0)
	Next
End Sub


Sub MoveWebview
	Dim temp As Int
'	If Not(webview1.IsInitialized) Then webview1.Initialize("webview1")
'	Try
		If CurrentSection=15 Or CurrentSection=36 Then
			API.Move(webview1,  Activity, 0,50*GetScalemodeFlt+2,0,0)
		Else If LCAR.SmallScreen Then
			temp=50 + 2
			API.Move(webview1, Activity, temp,100, 0,0)
		Else
			temp= (100 * GetScalemodeFlt)  + 2
			API.Move(webview1, Activity, temp,LCAR.GetScaledPosition(3,False), 0,0)
		End If
		If CurrentSection=5 Then 
			LCAR.LCAR_HideElement(BG,19,True,True,False)
			LCAR.RemoveAnimation(19,True)
		End If
'	Catch
'	
'		Activity.AddView(webview1,  temp,100, Activity.Width-temp,Activity.Height-100)
'		MoveWebview
'	End Try
End Sub 

Sub AddSocialMediaFeeds(ListID As Int, Index As Int)
	LCAR.LCAR_ClearList(ListID,0)
	LCAR.LCAR_AddListItem(ListID, API.GetString("app"),		LCAR.LCAR_Orange, -1,  PlusID, False, "MY CHANGELOG", 0 , False, -1)
	LCAR.LCAR_AddListItem(ListID, "Back to the Main List", 	LCAR.LCAR_Orange, -1,  "0", False, "BCK", 0 , False, -1)
	Select Case Index 
		Case 0'main list
			AddFeed(ListID, API.GetString("log_behind"),	LCAR.LCAR_Orange, 	"1", 										"",						"STF")
			AddFeed(ListID, API.GetString("log_tos"),		LCAR.Classic_Blue,  "2", 										"",						"TOS")
			AddFeed(ListID, API.GetString("log_tng"), 		LCAR.LCAR_Purple,  	"3", 										"",						"TNG")
			AddFeed(ListID, API.GetString("log_ds9"), 		LCAR.Classic_Turq,  "4", 										"",						"DS9")
			AddFeed(ListID, API.GetString("log_voy"), 		LCAR.LCAR_LightBlue,"5", 										"",						"VOY")
			AddFeed(ListID, API.GetString("log_ent"), 		LCAR.LCAR_Yellow,  	"6", 										"",						"ENT")
			AddFeed(ListID, API.GetString("log_jja"), 		LCAR.Classic_Green, "7", 										"",						"JJA")
			AddFeed(ListID, API.GetString("log_std"),		LCAR.LCAR_DarkPurple,"8", 										"",						"DIS")
			AddFeed(ListID, API.GetString("log_etc"), 		LCAR.LCAR_Red,  	"9", 										"",						"ETC")
			
		Case 1'Not actors MISSING: Jeri Taylor, Denise Okuda (deniseokuda,105051974579225680212)
			AddFeed(ListID, "Andrew Probert", 				LCAR.LCAR_Orange,  	"f419107208142956", 						"",						"ARTIST")
			AddFeed(ListID, "Bjo Trimble", 					LCAR.LCAR_Orange,  	"bjo.trimble", 								"",						"WRITER")
			AddFeed(ListID, "Brannon Braga", 				LCAR.LCAR_Orange,  	"@BrannonBraga", 							"",						"WRITER/PRODUCER")
			AddFeed(ListID, "Bridge Restoration",			LCAR.LCAR_Orange,  	"EnterpriseRestoration", 					"",						"FAN FEED")			
			AddFeed(ListID, "Doug Drexler", 				LCAR.LCAR_Orange,  	"doug.drexler.7", 							"",						"VISUAL EFFECTS ARTIST")
			AddFeed(ListID, "Ira Steven Behr", 				LCAR.LCAR_Orange,  	"@IraStevenBehr", 							"",						"EXECUTIVE PRODUCER")
			AddFeed(ListID, "John Eaves", 					LCAR.LCAR_Orange,  	"john.eaves.526", 							"",						"DESIGNER ILLUSTRATOR")
			AddFeed(ListID, "Larry Nemecek", 				LCAR.LCAR_Orange,  	"@larrynemecek", 							"",						"AUTHOR")
			AddFeed(ListID, "Michael Okuda", 				LCAR.LCAR_Orange,  	"116479448730228244903", 	 				"LCARS INVENTOR",		"SCENIC ART SUPERVISOR")
			AddFeed(ListID, "Michael Okuda", 				LCAR.LCAR_Orange, 	"@MikeOkuda", 			 					"LCARS INVENTOR",		"SCENIC ART SUPERVISOR")
			AddFeed(ListID, "Michael Okuda", 				LCAR.LCAR_Orange,  	"michael.okuda", 							"LCARS INVENTOR",		"SCENIC ART SUPERVISOR")
			AddFeed(ListID, "Michael and Denise Okuda", 	LCAR.LCAR_Orange,  	"Michael.Denise.Okuda", 					"",						"SUPERVISORS")
			AddFeed(ListID, "Michael Westmore", 			LCAR.LCAR_Orange,  	"mgwestmore", 								"",						"MAKEUP SUPERVISOR")
			AddFeed(ListID, "Rick Berman", 					LCAR.LCAR_Orange,  	"@berman_rick", 							"",						"EXECUTIVE PRODUCER")
			AddFeed(ListID, "Rick Sternbach", 				LCAR.LCAR_Orange,  	"@ricksternbach", 							"",						"ILLUSTRATOR")
			AddFeed(ListID, "Rick Sternbach", 				LCAR.LCAR_Orange,  	"rick.sternbach", 							"",						"ILLUSTRATOR")'
			AddFeed(ListID, "Roddenberry", 					LCAR.LCAR_Orange,  	"101859955600091641663", 					"",						"OFFICIAL FEED")
			AddFeed(ListID, "Ronald Moore",					LCAR.LCAR_Orange,  	"105638383965929661183", 					"",						"WRITER/PRODUCER")
			AddFeed(ListID, "Ronald Moore",					LCAR.LCAR_Orange,  	"@RonDMoore", 								"BSG DIRECTOR",			"WRITER/PRODUCER")
			AddFeed(ListID, "Ronald Moore",					LCAR.LCAR_Orange,  	"RonBMoore", 								"BSG DIRECTOR",			"WRITER/PRODUCER")
			AddFeed(ListID, "Season 5 Campaign", 			LCAR.LCAR_Orange,  	"StarTrekEnterpriseSeason5NetflixCampaign", "",						"OFFICIAL FEED")			
			AddFeed(ListID, "StarTrek.com", 				LCAR.LCAR_Orange,  	"@StarTrek", 								"",						"OFFICIAL FEED")			
			AddFeed(ListID, "Star Trek: Community", 		LCAR.LCAR_Orange,  	"107015932809170182561", 					"",						"THEIR FEED")	
			AddFeed(ListID, "Star Trek: Renegades", 		LCAR.LCAR_Orange,  	"106583485062613077068", 					"",						"THEIR FEED")			
			AddFeed(ListID, "Star Trek: Renegades", 		LCAR.LCAR_Orange,  	"@TrekRenegades", 							"",						"THEIR FEED")			
			
		Case 2'TOS
			AddFeed(ListID, "George Takei", 				LCAR.Classic_Blue,	"104234302931579992973", 	 				"KAITO NAKAMURA", 		"HIKARU SULU")
			AddFeed(ListID, "George Takei", 				LCAR.Classic_Blue, 	"@GeorgeTakei", 			 				"KAITO NAKAMURA", 		"HIKARU SULU")
			AddFeed(ListID, "George Takei", 				LCAR.Classic_Blue, 	"georgehtakei", 			 				"KAITO NAKAMURA", 		"HIKARU SULU")
			'AddFeed(ListID, "Leonard Nimoy", 				LCAR.Classic_Blue, 	"@TheRealNimoy",		 	 				"DR. WILLIAM BELL", 	"SPOCK")'DECEASED
			'AddFeed(ListID, "Leonard Nimoy", 				LCAR.Classic_Blue, 	"Leonard-Nimoy", 			 				"DR. WILLIAM BELL", 	"SPOCK")'DECEASED
			AddFeed(ListID, "Nichelle Nichols", 			LCAR.Classic_Blue, 	"@NichelleIsUhura", 			 			"DIANE MAZA", 			"NYOTA UHURA")
			'AddFeed(ListID, "Nichelle Nichols", 			LCAR.Classic_Blue, 	"Nichelle-Nichols-Communications-Page",  	"DIANE MAZA", 			"NYOTA UHURA")
			AddFeed(ListID, "Walter Koenig", 				LCAR.Classic_Blue, 	"@GineokwKoenig", 		 					"ALFRED BESTER", 		"PAVEL CHEKOV")
			AddFeed(ListID, "Walter Koenig", 				LCAR.Classic_Blue, 	"waltermkoenig", 							"ALFRED BESTER", 		"PAVEL CHEKOV")'
			AddFeed(ListID, "William Shatner", 				LCAR.Classic_Blue, 	"112859244767729828637", 					"THE BIG GIANT HEAD", 	"JAMES T. KIRK")
			AddFeed(ListID, "William Shatner", 				LCAR.Classic_Blue, 	"@WilliamShatner", 		 					"THE BIG GIANT HEAD", 	"JAMES T. KIRK")
			AddFeed(ListID, "William Shatner", 				LCAR.Classic_Blue, 	"williamshatner", 		 					"THE BIG GIANT HEAD", 	"JAMES T. KIRK")
			
		Case 3 'TNG	MISSING: Diana Muldaur (Pulaski), Dwight Schultz
			AddFeed(ListID, "Patrick Stewart", 				LCAR.LCAR_Purple,  	"@SirPatStew", 			 					"DIRECTOR BULLOCK", 	"JEAN-LUC PICARD")
			AddFeed(ListID, "Patrick Stewart", 				LCAR.LCAR_Purple,  	"PatrickStewart", 		 					"DIRECTOR BULLOCK", 	"JEAN-LUC PICARD")
			AddFeed(ListID, "Jonathan Frakes", 				LCAR.LCAR_Purple,  	"@jonathansfrakes", 						"XANATOS", 				"WILLIAM T. RIKER")
			AddFeed(ListID, "Brent Spiner", 				LCAR.LCAR_Purple, 	"@BrentSpiner", 							"PUCK", 				"DATA")'
			AddFeed(ListID, "Brent Spiner", 				LCAR.LCAR_Purple,  	"brent.spiner.9", 		 					"PUCK", 				"DATA")
			AddFeed(ListID, "Levar Burton", 				LCAR.LCAR_Purple,  	"@levarburton", 							"ANANSI", 				"GEORDI LAFORGE")
			AddFeed(ListID, "Levar Burton", 				LCAR.LCAR_Purple,  	"levardisb", 								"ANANSI", 				"GEORDI LAFORGE")
			AddFeed(ListID, "Marina Sirtis", 				LCAR.LCAR_Purple,  	"@Marina_Sirtis", 		 					"DEMONA", 				"DEANNA TROI")
			AddFeed(ListID, "Marina Sirtis", 				LCAR.LCAR_Purple,  	"marina.sirtis.52", 						"DEMONA", 				"DEANNA TROI")'
			AddFeed(ListID, "Michael Dorn", 				LCAR.LCAR_Purple,  	"@akaWorf", 								"COLDSTONE", 			"WORF")
			AddFeed(ListID, "Michael Dorn", 				LCAR.LCAR_Purple,  	"MichaelDornOfficial", 						"TAURUS", 				"WORF")
			AddFeed(ListID, "Gates McFadden", 				LCAR.LCAR_Purple,  	"@gates_mcfadden", 		 					"ALLISON ROURKE", 		"DR. BEVERLY CRUSHER")
			AddFeed(ListID, "Gates McFadden", 				LCAR.LCAR_Purple,  	"cheryl.g.mcfadden", 						"ALLISON ROURKE", 		"DR. BEVERLY CRUSHER")
			AddFeed(ListID, "Denise Crosby", 				LCAR.LCAR_Purple,  	"@TheDeniseCrosby", 						"DR. GRETCHEN KELLY",	"TASHA YAR")
			AddFeed(ListID, "Denise Crosby", 				LCAR.LCAR_Purple,  	"denise.crosby.756", 						"DR. GRETCHEN KELLY",	"TASHA YAR")
			AddFeed(ListID, "John de Lancie", 				LCAR.LCAR_Purple,  	"@johndelancie", 							"DISCORD", 				"Q")
			AddFeed(ListID, "John de Lancie",				LCAR.LCAR_Purple,  	"john.delancie", 							"DISCORD", 				"Q")
			'AddFeed(ListID, "Wil Wheaton", 				LCAR.LCAR_Purple,  	"113296486298236709829", 					"JOSEPH 'JOEY' TROTTA", "WESLEY CRUSHER")
			'AddFeed(ListID, "Wil Wheaton", 				LCAR.LCAR_Purple,  	"@wilw", 									"JOSEPH 'JOEY' TROTTA", "WESLEY CRUSHER")
			'AddFeed(ListID, "Wil Wheaton", 				LCAR.LCAR_Purple,  	"itswilwheaton", 							"BOY", 					"WESLEY CRUSHER")
			AddFeed(ListID, "Tony Todd", 					LCAR.LCAR_Purple,  	"@TonyTodd54",								"JAKE SISKO",			"KURN")
			AddFeed(ListID, "Whoopi Goldberg", 				LCAR.LCAR_Purple,  	"@WhoopiGoldberg", 		 					"ODA MAE BROWN", 		"GUINAN")
	
		Case 4 'DS9	MISSING: Avery Brooks (Sisko), Alexander Siddig (Alexander-Siddig), Colm Meaney, Cirroc Lofton (Jake), Andrew J. Robinson (Garek)
			AddFeed(ListID, "Armin Shimerman", 				LCAR.Classic_Turq,	"@ShimermanArmin", 		 					"THE TERROR", 			"QUARK")
			AddFeed(ListID, "Aron Eisenberg", 				LCAR.Classic_Turq,	"@aroneisenberg", 		 					"KAR", 					"NOG")
			AddFeed(ListID, "Chase Masterson", 				LCAR.Classic_Turq, 	"@ChaseMasterson", 		 					"VIENNA SALVATORI", 	"LEETA")
			AddFeed(ListID, "Jeffrey Combs", 				LCAR.Classic_Turq, 	"@jeffreycombs",							"THE QUESTION",			"WEYOUN")
			AddFeed(ListID, "Nana Visitor",					LCAR.Classic_Turq, 	"@NanaVisitor",								"PAMELA VOORHEES",		"KIRA NERYS")
			AddFeed(ListID, "Nicole de Boer",				LCAR.Classic_Turq, 	"@Nikki_deboer",							"TARA JAMES",			"EZRI DAX")
			AddFeed(ListID, "Penny Johnson Jerald", 		LCAR.LCAR_Purple, 	"@btwprod", 								"CLAIRE FINN", 				"KASSIDY YATES")
			AddFeed(ListID, "Rene Auberjonois", 			LCAR.Classic_Turq, 	"@reneauberjonois", 						"CHEF LOUIS", 			"ODO")
			AddFeed(ListID, "Terry Farrell",				LCAR.Classic_Turq, 	"@4TerryFarrell",							"CAT",					"JADZIA DAX")
			AddFeed(ListID, "Terry Farrell",				LCAR.Classic_Turq, 	"terry.farrell",							"CAT",					"JADZIA DAX")

		Case 5'VOY	MISSING: Ethan Phillips, Jennifer Lien
			AddFeed(ListID, "Garrett Wang", 				LCAR.LCAR_LightBlue, "@GarrettRWang", 		 					"GARAN", 				"HARRY KIM")'
			AddFeed(ListID, "Garrett Wang", 				LCAR.LCAR_LightBlue, "garrett.wang.1", 							"GARAN", 				"HARRY KIM")
			AddFeed(ListID, "Jeri Ryan", 					LCAR.LCAR_LightBlue, "101765416973555767821", 					"LAUREN SANDERS", 		"SEVEN OF NINE")
			AddFeed(ListID, "Jeri Ryan", 					LCAR.LCAR_LightBlue, "@JeriLRyan", 			 					"LAUREN SANDERS", 		"SEVEN OF NINE")
			AddFeed(ListID, "Jeri Ryan", 					LCAR.LCAR_LightBlue, "f299784370224796",	 					"LAUREN SANDERS", 		"SEVEN OF NINE")
			AddFeed(ListID, "Kate Mulgrew",					LCAR.LCAR_LightBlue, "@totallykate", 		 					"TITANIA", 				"KATHRYN JANEWAY")
			AddFeed(ListID, "Roxann Dawson",				LCAR.LCAR_LightBlue, "@roxdaws",								"DREADNAUGHT",			"ROXANN DAWSON")
			AddFeed(ListID, "Robert Beltran", 				LCAR.LCAR_LightBlue, "@robertbeltran74",						"FUENTES",				"CHAKOTAY")
			AddFeed(ListID, "Robert Duncan McNeill", 		LCAR.LCAR_LightBlue, "@RobertDMcNeill", 						"NICHOLAS LOCARNO", 	"TOM PARIS")
			AddFeed(ListID, "Robert Picardo", 				LCAR.LCAR_LightBlue, "@RobertPicardo", 		 					"JOHNNY CAB", 			"THE DOCTOR")
			AddFeed(ListID, "Robert Picardo", 				LCAR.LCAR_LightBlue, "rpicardo1", 			 					"JOHNNY CAB", 			"THE DOCTOR")'
			AddFeed(ListID, "Tim Russ",						LCAR.LCAR_LightBlue, "@timruss2", 			 					"DEVOR", 				"TUVOK")
			AddFeed(ListID, "Tim Russ", 					LCAR.LCAR_LightBlue, "tim.russ.522", 		 					"DEVOR", 				"TUVOK")'
			
		Case 6'ENT
			AddFeed(ListID, "Anthony Montgomery", 			LCAR.LCAR_Yellow,  	"@MrAMontgomery", 		 					"JAMES CARLTON", 		"TRAVIS MAYWEATHER")'MrAMontgomery
			AddFeed(ListID, "Anthony Montgomery", 			LCAR.LCAR_Yellow,  	"MrAMontgomery", 		 					"JAMES CARLTON", 		"TRAVIS MAYWEATHER" )'MrAMontgomery
			AddFeed(ListID, "Connor Trinneer", 				LCAR.LCAR_Yellow,  	"@ConnorTrinneer", 		 					"MICHAEL KENMORE", 		"CHARLES 'TRIP' TUCKER III")
			'AddFeed(ListID, "Connor Trinneer", 			LCAR.LCAR_Yellow,  	"connor.trinneer.offical", 		 			"MICHAEL KENMORE", 		"CHARLES 'TRIP' TUCKER III")
			AddFeed(ListID, "Dominic Keating", 				LCAR.LCAR_Yellow,  	"@idomknow", 		 						"WILL",			 		"MALCOLM REED")
			AddFeed(ListID, "Gary Graham", 					LCAR.LCAR_Yellow, 	"@actorGaryGraham", 		 				"MATTHEW SIKES", 		"SOVAL")'
			AddFeed(ListID, "John Billingsley ", 			LCAR.LCAR_Yellow,  	"@JBillingsley60", 		 					"DR. EDWARD HARKNESS",	"DR. PHLOX")
			AddFeed(ListID, "Jolene Blalock", 				LCAR.LCAR_Yellow,  	"@JoleneBlalock", 		 					"LEXA",					"T'POL")
			AddFeed(ListID, "Linda Park", 					LCAR.LCAR_Yellow,  	"@realLindaPark", 		 					"DR. WENDY LEE", 		"HOSHI SATO")
			AddFeed(ListID, "Scott Bakula", 				LCAR.LCAR_Yellow,  	"@scottsbakula", 		 					"DR. SAM BECKETT", 		"JONATHON ARCHER")
		
		Case 7'JJ Abrams
			'AddFeed(ListID, "Anton Yelchin", 				LCAR.Classic_Green, "@TheAntonYelchin", 						"KYLE REESE", 			"PAVEL CHEKOV")'DECEASED
			AddFeed(ListID, "Bruce Greenwood", 				LCAR.Classic_Green, "@GreenwoodBruce", 		 					"BRUCE WAYNE", 			"CHRISTOPHER PIKE")
			AddFeed(ListID, "Chris Pine", 					LCAR.Classic_Green, "@TheChrisPine", 		 					"JACK FROST", 			"JAMES T. KIRK")
			AddFeed(ListID, "John Cho", 					LCAR.Classic_Green, "@JohnTheCho", 			 					"VINCE CHUNG", 			"HIKARU SULU")
			AddFeed(ListID, "Karl Urban", 					LCAR.Classic_Green, "@RealKarlUrban", 							"JUDGE DREDD", 			"LEONARD MCCOY")
			AddFeed(ListID, "Simon Pegg", 					LCAR.Classic_Green, "@simonpegg", 			 					"JOHN LANDIS", 			"MONTGOMERY SCOTT")
			AddFeed(ListID, "Simon Pegg", 					LCAR.Classic_Green, "f126319964084222", 						"JOHN LANDIS", 			"MONTGOMERY SCOTT")
			AddFeed(ListID, "Zachary Quinto", 				LCAR.Classic_Green, "@ZacharyQuinto", 		 					"SYLAR", 				"SPOCK")
			AddFeed(ListID, "Zachary Quinto", 				LCAR.Classic_Green, "zacharyquintoofficial",					"SYLAR", 				"SPOCK")
			AddFeed(ListID, "Zoe Saldana", 					LCAR.Classic_Green, "@zoesaldana", 			 					"NEYTIRI", 				"NYOTA UHURA")
			AddFeed(ListID, "Zoe Saldana", 					LCAR.Classic_Green, "ZoeSaldana", 			 					"NEYTIRI", 				"NYOTA UHURA")
		
		Case 8'DISCOVERY	MISSING: Michelle Yeoh (Captain Georgiou), Sam Vartholomeos (Ensign Connor), Clare McConnell (Dennas)
			AddFeed(ListID, "Anthony Rapp", 				LCAR.LCAR_DarkPurple, "@albinokid", 							"JEFF GLASER", 			"LT. STAMETS")
			AddFeed(ListID, "Damon Runyan", 				LCAR.LCAR_DarkPurple, "@damonrunyan", 							"JACKSON", 				"UJILLI")
			AddFeed(ListID, "Doug Jones", 					LCAR.LCAR_DarkPurple, "@actordougjones", 						"DOR NEVEN", 			"LT. SARU")
			AddFeed(ListID, "James Frain", 					LCAR.LCAR_DarkPurple, "@britjfrain", 							"MR. KOHL", 			"SAREK")
			AddFeed(ListID, "Jason Isaacs", 				LCAR.LCAR_DarkPurple, "@jasonsfolly", 							"LUCIUS MALFOY", 		"CAPT. LORCA")
			AddFeed(ListID, "Kenneth Mitchell", 			LCAR.LCAR_DarkPurple, "@MrKenMitchell", 						"ERIC GREEN", 				"KOL")
			AddFeed(ListID, "Maulik Pancholy", 				LCAR.LCAR_DarkPurple, "@maulikpancholy",						"RAOUL",	 			"DR. NAMBUE")
			AddFeed(ListID, "Rainn Wilson", 				LCAR.LCAR_DarkPurple, "@rainnwilson", 							"DWIGHT SCHRUTE",		"HARRY MUDD")
			AddFeed(ListID, "Rekha Sharma", 				LCAR.LCAR_DarkPurple, "@TheRekhaSharma", 						"TORY FOSTER", 			"CMDR. LANDRY")
			AddFeed(ListID, "Shazad Latif", 				LCAR.LCAR_DarkPurple, "@heyshazad", 							"DR. JEKYLL",			"LT. TYLER")
			AddFeed(ListID, "Sonequa Martin-Green", 		LCAR.LCAR_DarkPurple, "@SonequaMG", 							"PVT. LANG", 			"MICHAEL BURNHAM")
			AddFeed(ListID, "Terry Serpico", 				LCAR.LCAR_DarkPurple, "@terryserpico", 							"PULASKI", 				"ADMR. ANDERSON")			
			
		Case 9 'ELSE
			'AddFeed(ListID, "Bill Nye", 					LCAR.LCAR_Red,  	"@TheScienceGuy", 							"THE SCIENCE GUY", 		"SCIENTIST")
			'AddFeed(ListID, "Bill Nye", 					LCAR.LCAR_Red,  	"f48947135361", 							"THE SCIENCE GUY", 		"SCIENTIST")
			AddFeed(ListID, "NASA", 						LCAR.LCAR_Red,  	"@NASA", 									"UESPA", 				"NASA")
			AddFeed(ListID, "Neil deGrasse Tyson", 			LCAR.LCAR_Red,  	"@neiltyson", 								"AWESOME VEST GUY", 	"ASTROPHYSICIST")
			AddFeed(ListID, "Neil deGrasse Tyson", 			LCAR.LCAR_Red,  	"neiltyson", 								"AWESOME VEST GUY", 	"ASTROPHYSICIST")
			'AddFeed(ListID, "Techni Myoko", 				LCAR.LCAR_Red,	 	"113123467649333114413",					"SOME CRAZY FAN", 		"ME")
			AddFeed(ListID, "Troi Tweets", 					LCAR.LCAR_Red,	 	"@TroiTweets",								"TROI TWEETS",			"TROI TWEETS")
	End Select
End Sub
Sub AddFeed(ListID As Int, Name As String, ColorID As Int, FeedID As String, AprilFoolsDescription As String, Description As String)
	Dim T As String = " (" & API.getstring("log_twitter") & ")", F As String = " (" & API.GetString("log_facebook") & ")", FeedType As Int'0=gplus, 1=facebook, 2=twitter'
	If AprilFools And AprilFoolsDescription.Length>-0 Then Description=AprilFoolsDescription
	If Not(IsNumber(FeedID)) Then
		FeedType=1'facebook
		If API.Left(FeedID,1)="@" Then 
			FeedType=2'twitter
			If T.Length>0 Then
				Description=Description & T
			Else
				Return
			End If
		Else If F.Length>0 Then
			Description=Description & F
		Else
			Return
		End If
	End If
	LCAR.LCAR_AddListItem(ListID, Name, ColorID, -1,  FeedID, False, 		Description, 0 , False, -1)
End Sub

Sub HandleTimer(Index As Int) As String 
	Dim ListElement As LCARlistitem', tempstr As String 
	ListElement=LCAR.LCAR_GetListItem(5, Index)
	If ListElement.Number =-1 Then
		LCAR.StarDateMode=0
		Select Case ListElement.Tag 
			Case -1:	TimerAction(0)		'reset
			Case -2	'start
				Select Case CurrentSection
					Case 4: TimerAction(1)	'auto destruct
					Case Else: ShowSection(CurrentSection, False)
				End Select 
			Case -3:	SaveTimer(cTimer)	'save timer
			Case -4:	DeleteTimer(cTimer)	'delete timer
			Case -5:	TimerAction(4)		'Stardate
			Case -6:	VRListen			'password
			Case -7'old Stardate
				LCAR.StarDateMode=1
				TimerAction(4)
			Case -8'delete digit
				'cTimer = InsertSecond(cTimer, -1)
				'SetElement18Text(API.GetTime(cTimer))
				Return SetElement18Text( InsertSecond2(-1) )
		End Select
	Else
		Index = ListElement.Tag  'LCAR.LCAR_GetListitemText(5,Index,2)
		If UMRsection=0 Then' Index< 16 Then
			If Obfuscated Then 
				cTimer=Max(cTimer+Index,0)
			Else'cTimer is in seconds 
				Return SetElement18Text( InsertSecond2(Index) )
				'cTimer = API.GetTimeReverse( SetElement18Text( InsertSecond2(Index) ) )
			End If 
		Else
			cTimer=Index 
		End If
		SetElement18Text(API.GetTime(cTimer))
	End If
End Sub

Sub InsertSecond2(Second As Int) As String
	Dim Time As String = LCAR.LCAR_GetElement(18).Text.Replace(":", "") 
	If Second = -1 Then 
		Time = "0" & Time
		Time = API.left(Time, Time.Length-1)
	Else 
		Time = Time & Second
		Time = API.right(Time, Time.Length-1)
	End If	

	Time = InjectColons(Time)	
	cTimer = API.GetTimeReverse(Time)
	Return Time
End Sub
Sub InjectColons(Time As String) As String
	Dim tempstr As String 
	Time = Time.Replace(":", "")
	Do Until Time.Length = 0 
		tempstr = API.right(Time,2) & API.IIF(tempstr.Length = 0, "", ":") & tempstr
		Time = API.Left(Time, Max(0, Time.Length-2))
	Loop
	Return tempstr 
End Sub
Sub InsertSecond(Seconds As Int, Second As Int) As Int 
	Dim Time() As Int = SplitTime(Seconds), tempstr As String, Hours As Int = Time(0), MinutesTen As Int = Time(1), MinutesOne As Int = Time(2), SecondsTen As Int = Time(3), SecondsOne As Int  = Time(4)
	'Log(API.GetTime(cTimer) & " SPLITS TO " & Hours & ":" & MinutesTen & MinutesOne & ":" & SecondsTen & SecondsOne)
	If Second = -1 Then
		Seconds = SecondsTen + MinutesOne*10 + MinutesTen*60 + Hours*600'delete
		tempstr = Hours & MinutesTen & ":" & MinutesOne & SecondsTen
	Else 
		Seconds = (Second + (SecondsOne*10) + (SecondsTen*60) + (MinutesOne*600) + (MinutesTen*3600) ) ' + Hours*36000 chop 10 hours off
		tempstr = Hours & MinutesTen & ":" & Min(MinutesOne,5) & SecondsTen & ":" & Min(SecondsOne,5) & Second
	End If
	Second = API.GetTimeReverse(tempstr)
	'Log("TESTING 23:45:67 - " & API.gettime(85567))
	'Log(Seconds & " SHOULD BE: " & tempstr  & " ACTUAL: " & API.GetTime(Seconds) & " PHYSICAL: " & API.GetTime(Second))
	Return Seconds
End Sub

Sub SplitTime(Seconds As Int) As Int()
	Dim Hours As Int, MinutesTen As Int, MinutesOne As Int, SecondsTen As Int, SecondsOne As Int 
	SecondsOne = Seconds Mod 36000'chop at ten hours
	Hours  = Floor(SecondsOne / 3600)
	SecondsOne = SecondsOne - (Hours*3600)
	MinutesTen = Floor(SecondsOne / 600)
	SecondsOne = SecondsOne - (MinutesTen*600)
	MinutesOne = Floor(SecondsOne / 60)
	SecondsOne = SecondsOne - (MinutesOne*60)
	SecondsTen = Floor(SecondsOne / 10)
	SecondsOne = SecondsOne - (SecondsTen*10)
	Return Array As Int(Hours, MinutesTen, MinutesOne, SecondsTen, SecondsOne)
End Sub

Sub LoadTimers(SubSection As Int)
	Dim temp As Int,temp2 As Int
	If SubSection < 2 Then 
		LCAR.LCAR_ClearList(5,0)
		UMRsection=SubSection
	End If
	Select Case SubSection
		Case 0
			SetElement18Text(API.GetTime(cTimer))
			If Obfuscated Then 
				LCAR.LCAR_AddListItem(5, "+5 HRS", LCAR.LCAR_Random, 184,  "18000", False, "" ,0,False,-1)'listitem 0
				LCAR.LCAR_AddListItem(5, "+1 HOUR", LCAR.LCAR_Random, 363,  "3600", False, "" ,0,False,-1)'listitem 1
				LCAR.LCAR_AddListItem(5, "-1 HOUR", LCAR.LCAR_Random, 363,  "-3600", False, "" ,0,False,-1)'listitem 2
				LCAR.LCAR_AddListItem(5, "-5 HRS", LCAR.LCAR_Random, 184,  "-18000", False, "" ,0,False,-1)'listitem 3
				
				LCAR.LCAR_AddListItem(5, "+15 MIN", LCAR.LCAR_Random, 902,  "900", False, "" ,0,False,-1)'listitem 4
				LCAR.LCAR_AddListItem(5, "+5 MIN", LCAR.LCAR_Random, 302,  "300", False, "" ,0,False,-1)'listitem 5
				LCAR.LCAR_AddListItem(5, "+1 MIN", LCAR.LCAR_Random, 601,  "60", False, "" ,0,False,-1)'listitem 6
				LCAR.LCAR_AddListItem(5, "-1 MIN", LCAR.LCAR_Random, 601,  "-60", False, "" ,0,False,-1)'listitem 7
				LCAR.LCAR_AddListItem(5, "-5 MIN", LCAR.LCAR_Random, 302,  "-300", False, "" ,0,False,-1)'listitem 8
				LCAR.LCAR_AddListItem(5, "-15 MIN", LCAR.LCAR_Random, 902,  "-900", False, "" ,0,False,-1)'listitem 9
				
				LCAR.LCAR_AddListItem(5, "+15 SEC", LCAR.LCAR_Random, 151,  "15", False, "" ,0,False,-1)'listitem 10
				LCAR.LCAR_AddListItem(5, "+5 SEC", LCAR.LCAR_Random, 500,  "5", False, "" ,0,False,-1)'listitem 11
				LCAR.LCAR_AddListItem(5, "+1 SEC", LCAR.LCAR_Random, 100,  "1", False, "" ,0,False,-1)'listitem 12
				LCAR.LCAR_AddListItem(5, "-1 SEC", LCAR.LCAR_Random, 100,  "-1", False, "" ,0,False,-1)'listitem 13
				LCAR.LCAR_AddListItem(5, "-5 SEC", LCAR.LCAR_Random, 500,  "-5", False, "" ,0,False,-1)'listitem 14
				LCAR.LCAR_AddListItem(5, "-15 SEC", LCAR.LCAR_Random, 151,  "-15", False, "" ,0,False,-1)'listitem 15
			Else 
				For temp = 0 To 9
					LCAR.LCAR_AddListItem(5,API.IIF(LCAR.SmallScreen, temp,""), LCAR.LCAR_Random, temp, temp, False, "",0,False,-1)'listitem 10
				Next 
				LCAR.LCAR_AddListItem(5, API.GetString("auto_delete"), LCAR.LCAR_Random, -1,  "-8", False, "" ,0,False,-1)'listitem 19
			End If 
			
			LCAR.LCAR_AddListItem(5, API.GetString("auto_reset"), LCAR.LCAR_Random, -1,  "-1", False, "" ,0,False,-1)'listitem 16
			LCAR.LCAR_AddListItem(5, API.GetString("auto_save"), LCAR.LCAR_Random, -1,  "-3", False, "" ,0,False,-1)'listitem 18
			
			LoadTimers(2)
		Case 1
			LCAR.LCAR_AddListItem(5, API.GetString("auto_delete"), LCAR.LCAR_Random, -1,  "-4", False, "" ,0,False,-1)'listitem 19
			
			LoadTimers(2)
			
			TimerCount= Settings.GetDefault("SavedTimers", 0)
			For temp=1 To TimerCount
				temp2 = Settings.Get("Timer" & temp)
				LCAR.LCAR_AddListItem(5, API.GetTime(temp2), LCAR.LCAR_Random, LCAR.ScientificNotation(temp2), temp2, False, "" ,0,False,-1)
			Next
			If AprilFools Then
				AddFakeTimer(30)
				AddFakeTimer(600)
				AddFakeTimer(1980)
			End If
		Case 2
			LCAR.LCAR_AddListItem(5, API.GetString("auto_start"), LCAR.LCAR_Random, -1,  "-2", False, "" ,0,False,-1)'listitem 17
			If CurrentSection = 4 Then 
				LCAR.LCAR_AddListItem(5, API.GetString("widget_0"), LCAR.LCAR_Random, -1,  "-5", False, "" ,0,False,-1)'listitem 20
				LCAR.LCAR_AddListItem(5, API.GetString("auto_sto"), LCAR.LCAR_Random, -1,  "-7", False, "" ,0,False,-1)'listitem 21
				LCAR.LCAR_AddListItem(5, API.GetString("auto_code"), LCAR.LCAR_Random, -1,  "-6", False, "" ,0,False,-1)'listitem 22
			End If 
	End Select
	
End Sub
Sub AddFakeTimer(Duration As Int) As Int
	If FindTimer(Duration) = -1 Then LCAR.LCAR_AddListItem(5, API.GetTime(Duration), LCAR.LCAR_Random, LCAR.ScientificNotation(Duration), Duration, False, "" ,0,False,-1)
End Sub
Sub FindTimer(Duration As Int) As Int
	Dim temp As Int,temp2 As Int
	If Duration>0 Then
		For temp=1 To TimerCount
			temp2 = Settings.Get("Timer" & temp)
			If temp2=Duration Then Return temp
		Next
	End If
	Return -1
End Sub
Sub SaveTimer(Duration As Int)
	Dim TimerID As Int = FindTimer(Duration)
	If TimerID = -1 And Duration>0 Then
		TimerCount=TimerCount+1
		Settings.Put("SavedTimers",TimerCount)
		Settings.put("Timer" & TimerCount, Duration)
		'LCAR.LCAR_AddListItem(5, API.GetTime(Duration), LCAR.LCAR_Random, LCAR.ScientificNotation(Duration), Duration, False, "" ,0,False,-1)
		LCAR.ToastMessage(BG, API.GetStringVars("auto_saved", Array As String(API.GetTime(Duration))), 3)
	Else if Duration = 0 Then 
		LCAR.ToastMessage(BG, API.GetString("auto_none"), 3)
	Else 
		LCAR.ToastMessage(BG, API.GetString("auto_already"), 3)
		LogColor(Duration & " IS TIMER " & TimerID, Colors.red)
	End If
End Sub
Sub DeleteTimer(Duration As Int)
	Dim temp As Int, tempstr As String = "auto_notfound"
	temp=FindTimer(Duration)
	If temp>0 Then
		If temp < TimerCount Then Settings.put("Timer" & temp, Settings.Get("Timer" & TimerCount))
		Settings.Remove("Timer" & TimerCount)
		TimerCount=TimerCount-1
		Settings.Put("SavedTimers",TimerCount)
		
		LCAR.LCAR_FindListItem(5, API.GetTime(Duration),0, True,-1)
		tempstr = "auto_deleted"
	End If
	LCAR.ToastMessage(BG, API.GetStringVars(tempstr, Array As String(API.GetTime(Duration))), 3)
End Sub





Sub BoolToBool(Value As Boolean) As String 
	Return API.GetString(API.IIF(Value, "on","off"))
End Sub

Sub BoolToText(Value As Boolean ) As String
	Return API.BoolToText(Value)' If Value Then Return "ENABLED" Else Return "DISABLED"
End Sub
Sub uCase(Text As String) As String 
	Return Text.ToUpperCase 
End Sub

Sub Activity_Pause(UserClosed As Boolean ) 
	'Log("Activity_Pause(UserClosed=" & UserClosed & ")")
	'InitTTS(False)
	If Not(STimer.AllowServices) Then
		StopService(STimer)
		StopService(btimer)
		StopService(Widgets)
	End If
	
	LCAR.BGisInit=False
	API.ResetBrightness
	StopCamera 
	If API.IsSpeakerPhone Then API.SetSpeakerPhone(False)
	'If WallpaperService.DDisrunning Then ShowModeSelect(5)'causing issues
	LCARSeffects2.LockUniBMP=False
	
	LCAR.IsClean=False
	LCAR.ClearScreen(BG)
	WasWebviewVisible=False
	If Not(webview1=Null) Then WasWebviewVisible = webview1.Visible 
	
	If UserClosed = True Then GotoSleep

	TimerMain.Enabled=False
	LCAR.ScreenIsOn = False
	'If turnedwifion AND myWIFI_Test.isWIFI_enabled Then myWIFI_Test.toggleWIFI
	If SensorEnabled Then Listen(False)
	Games.Paused=True
	'If Not(UserClosed) Then
    '    If Socket1.Connected Then 
	'		Socket1.Close
	'		If AStreams.IsInitialized Then AStreams.Close
	'	End If
    'End If
	
	StopGPS(False)
	
	LoadSettings(True)
	If Not(LCAR.DontCancel) Then 
		Select Case CurrentSection
			Case 14,22,78,999'warp core, personal log, alarm
			Case Else
				Select Case LCAR.WasPlaying	
					Case 5,32'time's up
					Case Else:LCAR.Stop2("PAUSE")
				End Select
		End Select
	End If
	LCAR.DontCancel=False
	
	'If CurrentSection<>14 Then LCAR.Stop 'LCAR.Looping>-1  
		'STimer.Increment=10
		'StartService(STimer)
	'Else
	'	LCAR.Stop 
	'End If
	Phone1.StopListening 
	'If VRQuestionID=0 Then LCAR.HideToast' 
	WallpaperService.PreviewMode=False
	
	Shutdowntime=DateTime.Now 
	
	If CurrentSection = 999 And AwaitingAnswer Then 	
		CurrentSection=-1
		API.UserEscapedAlarm
		Log("Activity pause called it " & AwaitingAnswer)
'		If Not(API.CWA.IsInitialized) Then
'			API.UserEscapedAlarm
'		Else If API.CWA.Snooze=0 Then 
'			API.UserEscapedAlarm
'		End If
	End If
	If ButtonMenu > 0 Then WasMenuOpen = LCAR.IsListVisible(ButtonMenu)
End Sub



Sub Activity_Resume
	If btimer.NotificationWidget>-1 Then API.AutoUpdateNoti 
	If DateTime.Now-Shutdowntime> DateTime.TicksPerSecond*2 Then 
		API.Locked=True
		Select Case CurrentSection
			Case 32,37,38:
				Log(CurrentSection & " & relocking")
				ShowModeSelect(6)
		End Select
	End If
	If (DateTime.GetMonth(DateTime.Now) = 4 And DateTime.GetDayOfMonth (DateTime.Now) = 1) And (DateTime.GetMonth(Shutdowntime) <> 4 And DateTime.GetDayOfMonth(Shutdowntime) <> 1) Then SetupAprilFoolsMode(True)
	LCAR.CheckResumeSound 
	'Log("Activity_Resume(lcar.RedAlert=" & LCAR.RedAlert & ")")
	LCAR.ScreenIsOn = True
	Phone1.Initialize("Phone")
	'If HttpUtils.Complete = True Then JobDone1(HttpUtils.Job)
	If GPSenabled Then StartGPS
	LCAR.BGisInit=False
	'STimer.Increment=1000
	If SensorEnabled Then Listen(True)
	'If DateTime.GetMinute(DateTime.Now) <> LCARSeffects2.OldDate Then LCARSeffects2.StarshipsClean =False
	LCAR.CheckLoopingSound 
	If CurrentSection=19 Then PlayScienceSound
	'InitTTS(True)
	SetShowWhenLocked(True)
	HandleCMD
'	If LCAR.WasRedAlert Then
'		LCAR.SetRedAlert(True, "Activity_Resume")
'		LCAR.WasRedAlert=False
'		LCAR.FlagSet =False
'	End If
	TimerMain.Initialize("Timermain", 10 )
	TimerMain.Enabled = True
	ForceImmersiveMode
	ResizeScreen
	HandleNFC
	
	'OnMyMark = API.lCase(Texts.Get(0))''VR_Handle(API.lCase(Texts.Get(0)))
	If VRCMD.Length > 0 Then 
		 VR_Handle(VRCMD)
		 VRCMD = ""
	End If
End Sub

Sub GetExtra(I As Intent, Extra As String, Default As String) As String
	If I.HasExtra(Extra) Then Return I.GetExtra(Extra) 
	Return Default 
End Sub

Sub StartTimer(Time As Int)
	cTimer = Time
	TimerAction(1)
	ShowSection(4, False)
End Sub

Sub HandleNFC As Boolean 
	Dim NFCstring As String, NFCAction As String 
	'http://nexus5.wonderhowto.com/how-to/make-google-now-obey-custom-voice-commands-even-without-root-0156382/
	If Activity.GetStartingIntent <> StoredIntent Then 
		StoredIntent = Activity.GetStartingIntent
		Select Case StoredIntent.Action
			Case ""
			Case "com.google.android.gms.actions.SEARCH_ACTION", "com.google.android.gms.actions.CREATE_NOTE"'Google now search/note
				If StoredIntent.HasExtra("query") Then VR_Handle(StoredIntent.GetExtra("query"))
				If StoredIntent.HasExtra("android.intent.extra.TEXT") Then VR_Handle(StoredIntent.GetExtra("android.intent.extra.TEXT"))
			Case "android.intent.action.SET_ALARM"
				NFCAction = "android.intent.extra.alarm.DAYS"
				If StoredIntent.HasExtra(NFCAction) Then NFCAction = API.Implode(",", StoredIntent.GetExtra(NFCAction)) Else NFCAction = ""
				HandleAlarm(Array As String(GetExtra(StoredIntent, "android.intent.extra.alarm.HOUR", "0"), GetExtra(StoredIntent, "android.intent.extra.alarm.MINUTES", "0"), NFCAction), "STARTINGINTENT")
			
			Case "android.intent.action.SHOW_ALARMS"
				ShowSection(37, False)
			
			Case "android.intent.action.DISMISS_ALARM"
				API.BelayCurrentAlarm(True)
				
			Case "android.intent.action.SET_TIMER"
				NFCstring = GetExtra(StoredIntent, "android.intent.extra.alarm.LENGTH", GetExtra(StoredIntent, "android.provider.AlarmClock.EXTRA_LENGTH", "0"))
				If IsNumber(NFCstring) Then StartTimer(NFCstring)

			Case "android.nfc.action.TAG_DISCOVERED", "android.nfc.action.NDEF_DISCOVERED"
				If Not( IsPaused("main") ) And Not(API.IsScreenLocked) Then 'LCAR.ScreenIsOn
					If Not(NFC_EnableForeground) Then Return False 
					NFCstring = NFCtostring(StoredIntent)
					LogColor("NFC TAG: " & NFCstring, Colors.Red)
					If CurrentSection = 79 Then 
						If API.AddNFCtag(NFCstring) = True Then 
							AddNFCtag(NFCstring)
						Else 
							LCAR.LCAR_SetSelectedItem(3, API.NFCtags.IndexOf(NFCstring))
						End If 
						Return False 
					End If 
					NFCAction = Settings.GetDefault("nfc" & NFCstring, "")
					If NFCAction.Length = 0 Then 
						LCAR.ToastMessage(BG, API.GetString("nfc_none"), 3)
					Else 	
						VR_Handle( NFCAction )
					End If 
					Return True 
				End If
			Case Else 
				LogColor("ACTION: " & StoredIntent.Action, Colors.Blue)
				LogColor("EXTRAS: " & StoredIntent.ExtrasToString, Colors.Blue)
		End Select
	End If
End Sub
Sub NFC_EnableForeground As Boolean 
	If SDKversion >= 10 Then 
		Try 
			NfcF.EnableForeground
			'("NFC LISTENER INITIATED")
			Return True 
		Catch 
			Log("NFC LISTENER FAILED TO INITIATE")
			Return False 
		End Try 
	End If
End Sub
Sub AddNFCtag(NFCstring As String)
	Dim Action As String = Settings.GetDefault("nfc" & NFCstring, "")
	SeedSetting(NFCstring, Action, Action)
	LCAR.LCAR_SetSelectedItem(3, LCAR.LCAR_SelectedItem)
End Sub


'WARNING, NFC TAG MISSING
Sub NFCtostring(NFCIntent As Intent) As String 
	Dim List_NdefRecords As List, NdefRecord2 As NdefRecord, temp As Int, Payload As String
	List_NdefRecords = NFC1.GetNdefRecords(Activity.GetStartingIntent)
	For temp = 0 To List_NdefRecords.Size-1 
		NdefRecord2 = List_NdefRecords.Get(temp)
		'If NdefRecord2.IsTextType Then NfcText = NdefRecord2.GetAsTextType
		'If NdefRecord2.IsUriType Then NfcText = NdefRecord2.GetAsUriType 
		'EXTRAS: Bundle[{android.nfc.extra.NDEF_MESSAGES=[Landroid.os.Parcelable;@f3c0cb9, android.nfc.extra.ID=[B@887f8fe, android.nfc.extra.TAG=TAG: Tech [android.nfc.tech.NfcA, android.nfc.tech.Ndef]}]
		Payload = ByteArrayTostring(NdefRecord2.GetPayload)
		'Log("Type:     " & NdefRecord2.GetAsTextType)
		'Log("URI Type: " & NdefRecord2.GetAsUriType)'FAILS
		'Log("Payload:  " & Payload)
		Return Payload' . .GetNdefByteArray)
	Next
End Sub
'WARNING, NFC TAG MISSING


Sub ByteArrayTostring(Data() As Byte) As String 
	Dim tempstr As String, temp As Int 
	For temp = 0 To Data.Length - 1
		tempstr = tempstr & API.Hex(Data(temp))
	Next
	Return tempstr.Replace("-", "")
End Sub

Sub HandleCMD
	Dim theCMD As Intent ,CMDtext As String  , tempstr As String 
	theCMD = Activity.GetStartingIntent()
	If theCMD.HasExtra("CMD") And theCMD.HasExtra("DAT") Then
		CMDtext = theCMD.GetExtra("CMD")
		tempstr = theCMD.GetExtra("DAT")
		If tempstr <> LastExecuted Then
			Log(theCMD.ExtrasToString)
			LastExecuted=tempstr
			Select Case CMDtext
				Case Null
				Case "COMMSSettings":ShowSection(32,False)
				Case "keyboard"
					STimer.ReturnAddress = ""
					If theCMD.hasextra("return") Then STimer.ReturnAddress = theCMD.GetExtra("return")
					BringUpKeyboard(theCMD.GetExtra("title"), theCMD.GetExtra("message"), theCMD.GetExtra("Value"))
				
				Case Else: Log(CMDtext & " NOT HANDLED")
			End Select
		End If
	End If
End Sub

Sub BringUpKeyboard(Title As String, Message As String, DefaultValue As String)
	CurrentSection = 10000
	LCAR.KBLayout=0
	LCAR.SymbolsEnabled=True
	LCAR.SelectText(DefaultValue)
	LCARSeffects.ShowPrompt(LCAR.EmergencyBG,-10, Title, Message,  -12, API.GetString("kb_ok"), API.GetString("cancel"))
End Sub

Sub GetKeyState As String 
	Dim temp As Int ,tempstr As String 
	For temp = 0 To Buttons.Length -1
		tempstr = tempstr & Buttons(temp)
	Next
	SetKeyState(0,0)
	ButtonsChanged=False
	Return tempstr
End Sub
Sub SetKeyState(KeyCode As Int,State As Byte) As Boolean 
	'Dim GameMode As Boolean , Buttons(13) As Boolean , ButtonsChanged As Boolean 
	Dim temp As Int '0 is not pushed, 1 is down, 2 is released
	Select Case KeyCode
		Case 84: Return True'search, exit gamemode
		Case 0:'reset
			For temp = 0 To Buttons.Length -1
				If Buttons(temp) = 2 Then Buttons(temp)=0
			Next
			ButtonsChanged=True
			Return False
			
		Case 19, KeyCodes.KEYCODE_W:  temp=0'  Buttons(0) = State'up
		Case 22, KeyCodes.KEYCODE_D:  temp=1' Buttons(1) = State'right
		Case 20, KeyCodes.KEYCODE_S:  temp=2' Buttons(2) = State'down
		Case 211, KeyCodes.KEYCODE_A:  temp=3' Buttons(3) = State'left
		
		Case 23, KeyCodes.KEYCODE_ENTER, API.BUTTON_A:  temp=4' Buttons(4) = State'X
		Case 4, KeyCodes.KEYCODE_L, API.BUTTON_B:   temp=5' Buttons(5) = State'back and O
		Case 99, KeyCodes.KEYCODE_SPACE,API.BUTTON_C:  temp=6' Buttons(6) = State'Square
		Case 100, KeyCodes.KEYCODE_DEL,API.BUTTON_X: temp=7' Buttons(7) = State'Triangle
		
		Case 108, KeyCodes.KEYCODE_F,API.BUTTON_START: temp=8'Buttons(8) = State'start
		Case 109, KeyCodes.KEYCODE_G,API.BUTTON_SELECT: temp=9'Buttons(9) = State'select
		Case 82, KeyCodes.KEYCODE_H,API.BUTTON_MODE:  temp=10'Buttons(10) = State'menu
		
		Case 102, KeyCodes.KEYCODE_Q,API.BUTTON_L1: temp=11'Buttons(11) = State'l shoulder
		Case 103, KeyCodes.KEYCODE_P,API.BUTTON_R1: temp=12'Buttons(12) = State'r shoulder
		
		Case 24,API.BUTTON_L2:  temp=13'Buttons(13) = State'vol up
		Case 25,API.BUTTON_R2:  temp=14'Buttons(14) = State'vol down
		
		Case Else:temp=-1
	End Select
	If temp>-1 Then
		If Buttons(temp) <> State Then
			Buttons(temp)=State
			ButtonsChanged=True
		End If
	End If
End Sub

Sub Activity_KeyUp (KeyCode As Int) As Boolean
	If GameMode Then
		If SetKeyState(KeyCode, 2) Then  
			GameMode=False
			ShowUMRMenu(-2)
		End If
	End If
End Sub






Sub Activity_KeyPress (KeyCode As Int) As Boolean 'return true if you want to consume the event
	'api.IsOuya		82=OUYA 96=O 97=A 99=U 100=Y 102=L1 103=R1 104=L2 105=R2 106=L3 107=R3

	If KeyCode=79 Or KeyCode = KeyCodes.KEYCODE_HEADSETHOOK Then'headset button
		Select Case HeadsetAction
			Case 0: Return False
			Case 1: VRListen
		End Select
	Else If GameMode Then
		SetKeyState(KeyCode, 1)
	Else If LCAR.IsKeyboardVisible(Null,-1,False) Then
		If KeyCode=84 Then
			VRListen
		Else
			'Msgbox("Key pressed: " &  KeyCode, "KEYBOARD")
			If LCAR.HandleKeyboard(KeyCode) Then 
				LCAR.HideToast'("Activity_KeyPress")
				LCAR.ToastMessage(BG, API.GetStringVars("kb_capslock", Array As String(BoolToText(LCAR.KBCaps))), 2)
			End If
		End If
	Else
		Select Case KeyCode'0=up, 1=right, 2=down, 3=left, -1=X, 4=[], 5=Tri, 6=Ls, 7=Rs, 8=Start
			'Case 19, KeyCodes.KEYCODE_W: 							LCAR.PushEvent(LCAR.LCAR_HardwareBTN, 0       ,0,0,0,0,0, LCAR.Event_Down)'up
			'Case 22, KeyCodes.KEYCODE_D: 							LCAR.PushEvent(LCAR.LCAR_HardwareBTN, 1       ,0,0,0,0,0, LCAR.Event_Down)'right
			'Case 20, KeyCodes.KEYCODE_S: 							LCAR.PushEvent(LCAR.LCAR_HardwareBTN, 2       ,0,0,0,0,0, LCAR.Event_Down)'down
			'Case 21, KeyCodes.KEYCODE_A: 							LCAR.PushEvent(LCAR.LCAR_HardwareBTN, 3       ,0,0,0,0,0, LCAR.Event_Down)'left
			'Case 23, KeyCodes.KEYCODE_ENTER, API.BUTTON_A,0,188 : 	LCAR.PushEvent(LCAR.LCAR_HardwareBTN,-1       ,0,0,0,0,0, LCAR.Event_Down)'center/cross/X/O (OUYA), center dpad(SONY), click (SONY)
			
			'Case 99, KeyCodes.KEYCODE_SPACE: 						LCAR.PushEvent(LCAR.LCAR_HardwareBTN, 4       ,0,0,0,0,0, LCAR.Event_Down)'square, 		U
			'Case 100, KeyCodes.KEYCODE_DEL: 						LCAR.PushEvent(LCAR.LCAR_HardwareBTN, 5       ,0,0,0,0,0, LCAR.Event_Down)'triangle, 	Y
			'Case 102, KeyCodes.KEYCODE_Q,API.BUTTON_L1: 			LCAR.PushEvent(LCAR.LCAR_HardwareBTN, 6       ,0,0,0,0,0, LCAR.Event_Down)'l shoulder,	L1
			'Case 103, KeyCodes.KEYCODE_P,API.BUTTON_R1: 			LCAR.PushEvent(LCAR.LCAR_HardwareBTN, 7       ,0,0,0,0,0, LCAR.Event_Down)'r shoulder,	R1
			'Case 108, KeyCodes.KEYCODE_F,API.BUTTON_START: 		LCAR.PushEvent(LCAR.LCAR_HardwareBTN, 8       ,0,0,0,0,0, LCAR.Event_Down)'start
			
			'Case 109, API.BUTTON_SELECT: 	TakeScreenshot' lcar.PushEvent(lcar.LCAR_HardwareBTN, 9       ,0,0,0,0,0, lcar.Event_Down)'select
			
			'Case 164'mute (SONY)
			'	API.AllowVolumeAccess=True
			'	LCAR.Volume(-999,True)
			'0=dpad center,60=hollow up arrow,86=stop,87=next,88=prev,89=rewind,111=esc,117=search,121=pause,126=play
			'129=eject,130=rec,164=mute,166=channel up,167=channel down,170=tv,172=GUIDE/DVR,174=Star,188=click
			
			Case 82:	'menu
				'If WallpaperService.AllowPreview Then
				'	ShowSection(23,False)
				'Else 
				PlayRandomBeep
				If NeedsMenu Then'API.APIlevel <11 OR 
					ForceImmersiveMode
					MakeMenu(True)
				Else
					ShowSection(-3,False)
					'ShowSettings(True,False)'settings
				End If
			
			Case 4, API.BUTTON_C, 104', KeyCodes: 	'back and O, L2 on OUYA
'				If API.CheckLock Then
'					Log("CheckLock")
'					ShowModeSelect
'					GotoSleep
'					Activity.Finish 
'				Else 
				PlayRandomBeep
				If CurrentSection= 0 And CurrentSettingsSection = -25 And SkipIntro > 0 Then'size selection dialog
					RedoIntro(SkipIntro, "Back")
				else If CurrentSection = 5 And WebMode = 4 Then'web browser in file explorer
					HandleDIRmenu(-5,0)
				else If CurrentSection=999 Then
					If API.CWA.Action<>3 Then ShowModeSelect(7)
					HandleAnswer(False)
				Else If API.CheckLock Then
					ShowModeSelect(8)
					GotoSleep
					Log("back button pressed, exiting")
					ActivityFinish("Back button")
				'Else If WallpaperService.AllowPreview And Not(WallpaperService.WasFromMainmenu) And CurrentSection <> 82 Then'not the new intro
				'	ShowSection(23,False)
				Else If CurrentSection=74 Then'tropes
					If Tropes.CurrentSection = 0 Then
						ShowModeSelect(9)
					Else
						Tropes.HandleSetting(0, 4)
					End If
				Else If CurrentSection = 72 Then'card games 
					If LCAR.IsListVisible(3) Then 
						ShowModeSelect(10)
					Else 
						ShowSection(72,False)
					End If 
				Else If LastBack < DateTime.Now - 1000 Then
					LastBack = DateTime.Now
					doshuffle = CurrentSection = -1 And LCAR.IsListVisible(0)
					Log("Back pressed in section: " & CurrentSection & " Do shufle: " & doshuffle & " at: " & LastBack)
					
					StopSpeaking(0)
					SpeakText=""
					Games.Paused = True
					
					WasAVREC=False
					ShowModeSelect(11)'back and O
				End If 
				
			Case 24,25 : 'volume
				API.AllowVolumeAccess=True
				Return LCAR.SetVol(KeyCode=24)' ToastMessageShow("VOLUME: " &  LCAR.SetVol(True) & "%",False)' LCAR.Mute = False'vol up
				
			Case API.BUTTON_B
				Activity_KeyPress( API.IIF(CurrentSection = 17, 103,84))

			Case 84,117'search
				HideMenu
				If LCAR.IsNumboardVisible Then
					VRListen
				Else '
					Select Case CurrentSection
						Case 0, 12, 13, 4'GNDN: intro, clock,analysis, autodestruct
						
						Case 3'sensor screen
							Select Case UMRsection
								Case 0:LCAR.SetRedAlert(Not(LCAR.RedAlert), "Search button in sensor screen")
								Case 1,2:ShowSensorsSection(-1)
							End Select
						Case 5'memory alpha
							If LCAR.RedAlert Then
								ShowModeSelect(12)
							Else
								'lcar.ShowKeyboard(BG,10)
								If LCAR.ElementMoving Or LCAR.IsListVisible(16) Then
									PlayError
								Else
									LCAR.ToastMessage(BG, API.GetString("web_welcome"), 4)
									LCAR.PlaySound(6, False)
									LCAR.IsKeyboardVisible(BG,10,True) 
									LCAR.HideSideBar(BG,-1,0)
								End If
							End If
						Case 7'UMR
							VRListen
						Case 10'alert status
							SwapMode(51 , 1)
						Case 14'warp core
							LCAR.SetRedAlert(Not(LCAR.RedAlert), "Search button in warp core")
							WarpRumble(-1)
						Case 15' captain's log
							BrowseWeb("file://" & File.Combine(File.DirInternalCache, "gplus.html"),1)'back
						Case 16'Angry Tribbles
							Games.Paused = Not(Games.Paused)
						Case 17'PdP
							LCAR.PushEvent(LCAR.LCAR_HardwareBTN, 5       ,0,0,0,0,0, LCAR.Event_Down)
						Case 22'Personal log
							ActivateMic(LCAR.DirDefaultExternal, LCARSeffects.UniqueFilename(LCAR.DirDefaultExternal, "LOG.mp3", "DATETIME"))
							LCARSeffects.ShowPrompt(BG, 12, API.getstring("log_recording"), API.getstring("log_pressstop"), 5, API.getstring("log_stop"), "")
						Case 37'alarms	
							API.SaveAlarm(Settings)
							ShowSection(999,False)
							API.AlarmIndex=-999
							API.isDemoing=True
						Case 39
							LCARSeffects3.ToggleEnterprise(97)
						Case 72
							Games.CARD_WINGAME
						Case 74
							Tropes.HandleSetting(0,74)
						Case 83'file explorer
							HandleDIRmenu(-3, 84)
						Case Else
							'If WallpaperService.AllowPreview Then
							'	ShowSection(23,False)
							'Else
								LCAR.SetRedAlert(Not(LCAR.RedAlert), "Search button")
							'End If
					End Select
				End If
			Case Else
				If Not(API.HandleControllerButton(KeyCode)) Then Log("UNHANDLED PRESS: "& KeyCode )
			
		End Select
	End If
	If API.debugMode Then Log("PRESS: " & KeyCode )
	Return True
End Sub

Sub WarpRumble(Time As Int)
	'1501 ms in regular mode, 3037 in red alert
	'RumblePeriod VibratePeriod
	If WarpCoreRumble Then 
		If Time=-1 Then
			LCAR.MinTimer=0
			LCAR.TimerPeriod=0
			If LCAR.RedAlert Then
				LCAR.TimerPeriod=3037
			Else
				LCAR.TimerPeriod=1501
				'LCAR.RumblePattern( Array As Long(1, 150,50,   150,50,    150,50,     150, 25,     150,25,     150,12,      150))
			End If
			'LCAR.RumblePeriod(75)
			WarpRumble(0)
		Else If LCAR.RedAlert Then
			LCAR.HandleRumbleTimer(Time,   0, 190, 75)
			LCAR.HandleRumbleTimer(Time, 190, 570,  0)
			LCAR.HandleRumbleTimer(Time, 570, 950, 75)
			LCAR.HandleRumbleTimer(Time, 950,1330,  0)
			LCAR.HandleRumbleTimer(Time,1330,1708, 75)
			LCAR.HandleRumbleTimer(Time,1708,2088,  0)
			LCAR.HandleRumbleTimer(Time,2088,2467, 75)
			LCAR.HandleRumbleTimer(Time,2467,2847,  0)
			LCAR.HandleRumbleTimer(Time,2847,3038, 75)
		Else
			LCAR.HandleRumbleTimer(Time,   0,  93, 75)
			LCAR.HandleRumbleTimer(Time,  93, 187, 25)
			LCAR.HandleRumbleTimer(Time, 187, 562,  0) 
			LCAR.HandleRumbleTimer(Time, 562, 655, 25)
			LCAR.HandleRumbleTimer(Time, 655, 843, 75)
			LCAR.HandleRumbleTimer(Time, 843, 937, 25)
			LCAR.HandleRumbleTimer(Time, 937,1312,  0)
			LCAR.HandleRumbleTimer(Time,1312,1408, 25)
			LCAR.HandleRumbleTimer(Time,1408,1502, 75)
		End If
	End If
	If Time = -1 Then 'StartWarpCoreLightpack
		LCAR.LightpackChangePattern(2, 1, -1, 0)
		'LCAR.LightpackPattern=2
		'LCAR.LightpackUpdateFreq=1
		'LightpackEvent(-4,0, 0,0,0)'smoothness
	End If
End Sub

'for the sound effect from contact
Sub DoContact(Index As Int, TimeRemaining As Int)
	Dim temp As Int 
	Select Case Index'ContactDelays As List, ContactStage As Int  , timerID=3
		Case 0'show section
			If AprilFools Then
				ContactStage=0
				ContactDelays.Initialize 
				API.NewTimer("Contact", 3,API.IIF(API.debugMode,5,10))
				LCAR.Volume(8, False)
			End If
			Return
		Case 1'sound done
			If ContactDelays.Size > 0 Then
				temp = ContactDelays.Get(0)
				ContactDelays.RemoveAt(0)
				If temp < 0 Then'change volume
					LCAR.Volume(Abs(temp), False)
					DoContact(1,0)
					Return
				Else If temp = 0 Then
					LCAR.playsound(39, False)
				Else
					API.NewTimer("Contact", 3, temp)
				End If
			End If
		Case 2'timer done
			If TimeRemaining= 0 Then LCAR.playsound(39, False)
	End Select
	If ContactDelays.Size = 0 And ContactStage<29 Then
		ContactStage=ContactStage+1
		Select Case ContactStage
			Case 1:	CopyArray(ContactDelays, Array As Int(-8,1,    -16,1,   -24,1,     -32,1,     -40,1,     -48,1,      -56,1,     -64,1,    -72,1,     -80,1,    -88,1,    -100,1))
			Case 2'36:32 to 41:05 (3 minutes, 33 seconds)
				LCAR.ToastMessage(BG, API.GetString("contact_sig"), 10)
				DoPrime(0,API.IIF(API.debugMode,20, 213))
			Case 3'41:42 (37 seconds)
				DoPrime(37,2)
			Case Else
				DoPrime(2, GetPrime(ContactStage-3))
		End Select
	End If
End Sub'                                    3 4 5 6  7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27   28
Sub GetPrime(Index As Int) As Int '         0 1 2 3  4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20  21  22  23  24   25 
	Return API.IIFIndex(Index, Array As Int(2,3,5,7,11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97, 101))  
End Sub
Sub DoPrime(FirstDelay As Int, Number As Int)
	Dim temp As Int 
	Log("Do prime: " & Number)
	ContactDelays.Initialize
	For temp = 1 To Number
		ContactDelays.Add(API.IIF(temp=1,FirstDelay, 0))
	Next
End Sub
Sub CopyArray(Dest As List, Data() As Int)
	Dim temp As Int 
	Dest.Initialize 
	For temp = 0 To Data.Length -1
		Dest.Add(Data(temp))
	Next
End Sub





Sub Activity_Touch (Action As Int, X As Float, Y As Float)
	'for when multitouch isnt working 
	If Not(LCAR.MultiTouchEnabled ) Then Activity_GesturesTouch(Activity, 0,Action,X,Y)
End Sub

Sub Activity_GesturesTouch(View As Object, PointerID As Int, Action As Int, X As Float, Y As Float) As Boolean
	'Log("ID: " & PointerID & " ACTION: " & action)
	If LCAR.GesturesTouch(0, G, PointerID, Action, X, Y) Then HandleEvents(0)
	
	'lcar.LCAR_AddListItem(0,  "Clicked: " & PointerID &  " - "   ,   lcar.LCAR_RandomColor,   PointerID , "", False,  X & "," & y,  0,False)
	Return True
End Sub

Sub SetElement18Text(Text As String) As String 
	Dim Width As Int, Width2 As Int = 103, Element As LCARelement 
	LCAR.forceshow(18,True)
	Width= Min(LCAR.ScaleHeight,LCAR.Scalewidth)
	If LCARSeffects.IsFrameVisible Then
		If LCAR.SmallScreen Then 
			Width2=53 
		Else If LCAR.CrazyRez >0 Then 
			Width2=100*LCAR.CrazyRez + LCAR.ListitemWhiteSpace 
		End If
		Width=Width - Width2' API.IIF(LCAR.SmallScreen,53,103)
	End If
	Element= LCAR.LCARelements.Get(18)
	Element.LOC.currX=-Width
	Element.Align = LCAR.GetScaledPosition(0,False)
	Element.Text=API.TextWrap(BG, LCAR.LCARfont, LCAR.Fontsize,  Text.ToUpperCase,  Width)
	Element.IsClean=False
	Return Text 
	'LCAR.LCAR_SetElementText( 18, API.TextWrap(BG, LCAR.LCARfont, LCAR.Fontsize,  Text.ToUpperCase,  Width) , "")
End Sub
'Requires background services
Sub SetElement18Text2(Text As String)
	SetElement18Text(API.IIF(STimer.AllowServices, Text, API.GetString("bg_services")))
End Sub
'Sub HandleRick(Setit As Boolean) As Boolean 
'	Return False
'	HasShown=Settings.GetDefault("hasshown", False)
'	If Setit Then
'		Settings.Put("hasshown", True)
'		LoadSettings(True)
'	Else If Not(HasShown) Then
'		LCARSeffects.ShowPrompt(BG, 12, "WARNING",  "Please send issues to technisbetas@gmail.com putting them in the reviews doesn't help me find/fix them. Many of you are asking for things I've already done!!! coughRickcough" , -1, "I PROMISE", "")
'		LCAR.ToastMessage(BG,  "PLEASE STOP IGNORING THIS", 10)
'		Return True
'	End If
'End Sub

Sub GetHeightOfHelp(Top As Int, SpaceLeftUnder As Int) As Int 
	Dim NumOfListitems As Int ,Height As Int 
	Height = LCAR.ScaleHeight - Top - SpaceLeftUnder
	NumOfListitems = Floor(Height / LCAR.ListItemsHeight(1))
	Height = NumOfListitems*LCAR.ListItemsHeight(1)
	SpaceLeftUnder = LCAR.ScaleHeight - Top - Height + LCAR.ListItemsHeight(2)
	Return SpaceLeftUnder
End Sub

Sub ShowModeSelect(Reason As String) As Boolean 
	Dim temp As Int,temp2 As Int,temp3 As Int, tempstr As String ,DontRandom As Boolean,Width As Int = 100 * LCAR.ScaleFactor,Items As Int = 6 ',Smaller As Boolean ' ,Element As LCARelement 
	If SectionLocked Then Return False
	Log("showmodeselect: " & Reason)
	Dim IsSmaller As Boolean = API.isSmallScreenDevice
	RequestScreenOrientation(-1)
	WallpaperService.SubScreenIndex = -1
	If AprilFools Then LCARSeffects2.ForcedNumber=3
	API.StopTimer(6)'API.NewTimer("NNN Shutdown", 6, Seconds)
	LCAR.DontCancel=False
	IsRecording=False
	LCARSeffects2.LockUniBMP=False
	LCARSeffects2.HelpMode = False
	LCAR.NeedsResuming=-1
	ModeSelect=False
	API.StopTimer(6)
	LCARSeffects.BlockFrame=False
	LCAR.CurrentStyle=LCAR.lcar_TNG 
	StopRecording
	'QuestionAsked=False
	LCARSeffects2.ClearRandomNumbers 
	LCAR.DrawFPS=False
	LCAR.MinTimer=0
	LCAR.TimerPeriod=0
	LCAR.StopRumble
	WebMode=0
	STimer.Increment=1000
	LCAR.ToastAlign= False
	Wireframe.PurgeModels 
	LCAR.HideToast'("showmodeselect")
	LCAR.SymbolsEnabled=False 
	LCAR.BypassHardwareKB=False
	LCAR.ClearScreen(BG)
	WallpaperService.WasFromMainmenu=False
	API.ResetBrightness
	StopCamera
	If Activity.Width<480 Or Activity.Height< 480 Then
		tempstr= Settings.GetDefault("SmallScreen", "")
		If tempstr.Length =0 Then
			webview1.Visible = False 
			LCARSeffects.ShowPrompt(BG, 12, API.GetString("smallscreen"), API.GetString("usesmallscreen"), 0,API.GetString("no").ToUpperCase, API.GetString("yes").ToUpperCase)
			Return False
		Else If tempstr.EqualsIgnoreCase("true") Then
			SmallScreenMode
		End If
	End If
	If TestZoom Then Return False 
	
	Select Case CurrentSection
		Case -999:DontRandom=LCAR.LessRandom 
		Case -1: 
			If LCAR.GetListItemCount(0)=0 Then WasAVREC=True
			If BackToQuit And Not(WasAVREC) Then 
				ActivityFinish("Show mode select")
				WasAVREC=True
			Else If doshuffle And Reason = 11 Then
				DontRandom=LCAR.LessRandom 
				MenuSection=MenuSection+1
				Log("CLEAR LIST 0: SHUFFLE")
				LCAR.LCAR_ClearList(0,0)
				doshuffle=False
			End If
		Case 24: Eval.SaveLoadCustomVars(Settings, True)
	End Select
		
	'lcar.LCAR_AddLCAR("ModeOK",  0,        10,     -40,-20,lcar.ItemHeight,20,0, lcar.LCAR_Orange, lcar.LCAR_Button, "OK","","",1,  False, 5,True, 0,255)'element 4
	'lcar.ForceElementData(4, 10, 50%y+40, 0,0, 100%x , lcar.Fontsize,0,0,255,255,True,False)
	
	If needsborgswap Then BorgSwap 
	LCAR.LightpackChangePattern(0,0,0,0)
	'If HandleRick Then Return
	
	LCARSeffects.frameoffset=0
	webview1.Visible = False
	StopWifi
	Listen(False)
	SensorEnabled=False
	CurrentSection=-1
	LCAR.Stop("Show mode select")
	StopGPS(True)
	'GPSenabled=False
	'If GPS1.GPSenabled Then GPS1.Stop 
	
	'LCAR.LCAR_HideAll(BG,False)
	
	LCAR.ForceHideAll(BG)
	
	
		temp= API.IIF( IsSmaller,0, LCAR.ItemHeight+3) 'TOP            74'71+3 'LCAR.TextHeight(BG, "TESTING")+3
		temp2=-25' API.IIF(Smaller, -LCAR.ItemHeight-3, -25)'Remaining space after list
		temp3=GetHeightOfHelp(temp,temp2)'Height of HELP
		
		If LCAR.Educational Then Items = 1
	'If LastVersion.EqualsIgnoreCase(GetVersion) Then
		LCAR.ResizeList(19, Width,LCAR.ListItemsHeight(Items),0,0,temp,True)'API.IIF(LCAR.SmallScreen, 50,100)	-LCAR.ItemHeight -3
		If Not(DontRandom) Then
			LCAR.LCAR_ClearList(19,0)'side bar
			If LCAR.Educational Then
				LCAR.LCAR_AddListItems (19, LCAR.LCAR_Random, 0, Array As String(API.GetString("exit")))
			Else
				LCAR.LCAR_AddListItems (19, LCAR.LCAR_Random, 0, API.GetStrings("mode", 0))
			End If
		End If
		
		'If LCAR.GetListItemCount(0) = 0 Then
		'	SeedSectionList(-1, "EMPTY", True)
		'	Log("IS EMPTY")
		'else if LCAR.LessRandom Then 
		'	SeedSectionList(-1, "LessRandom", True)
		'End If
		'	SeedSectionList(0)
		'Else If LCAR.LessRandom Then
		'	SeedSectionList(MenuSection)
		'End If
		
		LCAR.LCAR_HideElement(BG,19, True,True,False)
		If temp>0 Then LCAR.ResizeElement(87,  0,0,-1,LCAR.ItemHeight, 0,0,-1,LCAR.ItemHeight)'top elbow
		
		If (LCAR.ScaleHeight-temp - LCAR.ListItemsHeight(Items)-temp3) > LCAR.ItemHeight And temp>0 Then
			If temp>0 Then LCAR.GetElement(87).LWidth= Width-3
			LCAR.GetElement(4).LWidth= Width-3'help button
		
			LCAR.LCAR_SetElementText(LCARSeffects.FrameElement+11, API.GetString("kb_ok"), "")
			LCAR.ForceElementData(LCARSeffects.FrameElement+11, 0, temp+ LCAR.ListItemsHeight(Items), 0,0, Width-3, -temp3  -3          , 0,0,0,255,True,True) 'OK Button
			'LCAR.ForceElementData(LCARSeffects.FrameElement+6, 0, 0, 0,0,      0, LCAR.ItemHeight           , 0,0,0,255,True,True) 
			'LCAR.ForceElementData(4,  0,-LCAR.ItemHeight*2, 0,0, -1 ,LCAR.ItemHeight*2, 0,0,0,255,False,False)
			LCAR.ForceElementData(4,  0,-temp3, 0,0,  -1 ,temp3, 0,0,0,255,False,False)'HELP button
			LCAR.ForceShow(4,True)
		Else If IsSmaller Then'Smaller=True
			temp2=-1
		Else
			temp2=-LCAR.ItemHeight-3
			LCAR.LCAR_SetElementText(LCARSeffects.FrameElement+11, "", "")
			LCAR.ForceElementData(LCARSeffects.FrameElement+11, 0, temp+ LCAR.ListItemsHeight(Items), 0,0, 97, -1          , 0,0,0,255,True,True) 
			LCAR.ForceElementData(88, Width, -LCAR.ItemHeight, 0,0, -1,LCAR.ItemHeight, 0,0, 0,255,True,True)
			LCAR.ForceShow(88,True)
		End If
		If Not(IsSmaller) Then
			LCAR.ForceShow(87,True)
			LCAR.ForceShow(LCARSeffects.FrameElement+11,True)
		End If
		
		'SetElement18Text( "THE CAPTAIN'S LOG (FNCT) SHOWS MY PROGRESS")
		LCAR.LCAR_SetElementText(LCARSeffects.FrameElement, "", "")
		LCAR.LCAR_SetElementText(82, "", "")
		
		'temp=LCAR.Stage 
		'If temp=7 OR temp=8 Then lcar.LCAR_HideElement(bg,4,False,True,false)
		LCAR.RandomizeColors(0)
		'LCAR.LCAR_GetListItem(0,16).ColorID=LCAR.LCAR_Red 
		
		LCAR.resizeList(0,    -1,     0,        -1,       Width +    API.IIF(LCAR.LessRandom, 30 , 0) ,temp, True)
		LCAR.Stage=8
		'LCAR.SetRedAlert(False)
		
		'lcar.HideGroup(1,  True, False)
		LCAR.LCAR_HideElement(BG,0,True,True,False)
		'LCAR.resizeList(0, -1, -LCAR.itemheight-10,-1,0,0,False)
		LCAR.resizeList(0, -1, temp2,-1,0,0,False)
		'lcar.LCAR_HideElement(bg,4,False,True)
		

		'Element= lcar.LCARelements.Get(4)
		'element.Opacity.Current=0
		'element.Opacity.Desired=255
		'element.Visible = True
		'lcar.LCARelements.Set(4,element)
		LoadSettings(True)
		'If Not(HasShown) Then
			'ToastMessageShow("Please send issues to technisbetas@gmail.com, putting them in the reviews doesn't help me find/fix them", True)
		'	LCAR.ToastMessage(BG, "Please send issues to technisbetas@gmail.com, putting them in the reviews doesn't help me find/fix them", 5)
			'If DOS>-1 Then HasShown=True 
		'	HasShown=True
		'End If
	'Else
		'msgbox(   ,"CHANGE LOG")
	'End If
	LCAR.LockListStart(19,False)
	LCARSeffects2.StarshipsClean =False
	'AlignLists
	
	LCAR.BlankScreen(BG)
	LCAR.ClearScreen(BG)
	
	If LCAR.Educational Then MenuSection= 6
	SeedSectionList(MenuSection, "SHOW MODE", False)
	
	LCAR.FadeList(BG,0,True)
	LCAR.FadeList(BG,19,True)
	'Msgbox("IsListVisible: " &  LCAR.IsListVisible(0), "GetListItemCount: " & LCAR.GetListItemCount(0))
	
	'If Not(HasShown) Then
		'LCAR.ToastMessage(BG, "CLICK HELP INSTEAD OF OK TO GET THE MANUAL FOR EACH SECTION", 3)
		'HasShown=True
	'End If
	If Not(File.ExternalWritable) Or Not(File.ExternalReadable) Then
		LCAR.SetRedAlert(True, "MEMFULL")
		LCAR.ToastMessage(BG, API.GetString("no_sd"), 5)
	End If
	LCAR.ForceHide(85)
	LCAR.Stop("MODESELECT")
End Sub

Sub NextStage(Element1 As Int, Element2 As Int)
	LCARSeffects.NextStage(Element1,Element2,4)
End Sub
Sub TestZoom() As Boolean 
	If Not(Settings.ContainsKey("SelectedZoom")) Then
		Settings.Put("SelectedZoom", True)
		ShowSettingsSection(-25)
		LoadSettings(True)
		Return True
	End If
End Sub


'Sub Test
	'Dim angle As Int
	'For angle=0 To 360 Step 45
	'	x=findXY(50,50,50,angle,True)
	'	y=findXY(50,50,50,angle,False)
	'	Log("angle: " & angle & " X: " & X & " Y: " & Y ) 
	'Next
'End Sub


Sub DisconnectUMR()
	If Lightpackmode Then
		SendText("unlock")
		Lightpackmode= False
	End If
	LCAR.SRV_State= Games.PT_Local
	GameMode =False
	RepeatMode =False
	RAWmode=False
	IsServer=False
	Socket1.Close 
	Socket1_Connected(False)
	If CurrentSection = 7 Then ShowModeSelect(13)
End Sub

Sub BelayTimer As Boolean 
	If AprilFools Then
		If cTimer <> 1980 And cTimer <> 600 Then
			If API.IsTimerRunning(0) >5 Then 
				LCAR.ToastMessage(BG, API.GetString("auto_afm"), 2)
				Return False
			End If
			DownloadAndPlay("selfdestructterm",0)
		End If
	End If 
	API.Broadcast("timer", 0)
	API.StopTimer(0)
	API.NOTITitle = ""
	API.AutoUpdateNoti
	'ShowTimer(False)
	RequestScreenOrientation(-1)
	ShowSection(4, False)
End Sub

Sub ResizeTimer
	Dim Element As LCARelement ' API.IIF(LCAR.SmallScreen,54,104)
	Element=LCAR.GetElement(19) 'big text (timer)
	Element.Size.offY=0
	Element.Size.currY = API.GetTextHeight(BG, -Min(Activity.Width,Activity.Height) - LCAR.GetScaledPosition(3,True) , "2222222222222222", LCAR.LCARfont)-1
	LCAR.forceshow(19,True)
End Sub

Sub ShowTimer(isRunning As Boolean )
	If isRunning Then
		If cTimer = 1980 And AprilFools Then
			ShowSection(46,False)
		Else If cTimer = 600 And AprilFools Then
			RequestScreenOrientation(0)
			CurrentSection = 996
			LCARSeffects4.ResetEventHorizon(BG, 105)
		Else
			HideSideBar
			UMRsection=2
			LCAR.LCAR_HideElement(BG, 5, True,False,False)
			SetElement18Text(API.GetString("auto_destruct"))
			ResizeTimer
			LCAR.LCAR_HideElement(BG, 5, True,False,False)
			LCAR.DontCancel=True 
			LCAR.SetRedAlert(True, "ShowTimer")
			LCAR.ForceElementData(20, 100 * GetScalemodeFlt,-LCAR.ItemHeight ,  0,0,-1,LCAR.ItemHeight, 0,0,255,255,True,False)
			LCAR.forceshow(20,True)
			LCAR.Stop("SELF DESTRUCT")
			LCAR.PlaySound(2,False)
			LCAR.DontCancel=True
		End If
	Else
		SeedSideBar(API.GetStrings("auto_side",0), True,True)', "STRT", "CLR"
		'UMRsection=0
		LCAR.RandomizeColors(5)
		LCAR.LCAR_HideElement(BG, 5, True,True,False)
		'LCAR.forceshow(18,True)
		LCAR.forceshow(19,False)
		LCAR.forceshow(20,False)
		SetElement18Text(Password.ToUpperCase)
		LCAR.SetRedAlert(False,"ShowTimer")
		LoadTimers(0)
	End If
End Sub 

Sub ShowNotConnected(Text As String)
	CurrentSection = -4
	If CurrentSection<> 999 Then
		LCAR.LCAR_HideAll(BG,False)
		If Text.Length=0 Then Text= API.GetString("no_connection")
		If AprilFools Then
			LCAR.LightpackChangePattern(3, 1000, LCAR.Classic_Blue, 128)
			LCAR.MoveLCAR(77,   0, 0,    0,  0, 0, True, False, False)'static
			LCAR.ForceShow(77,True)
			LCAR.LCAR_SetElementText(77,Text, "")
		Else 
			LCAR.LightpackChangePattern(3, 1000, LCAR.LCAR_Red, 128)
			If LCAR.SmallScreen Then
				LCAR.MoveLCAR(77,   56, 102,   0,  0, 0, True, False, False)'static
			Else
				LCAR.MoveLCAR(77, 100 * LCAR.ScaleFactor  + 15 , LCAR.GetScaledPosition(3,False),   0,  0, 0, True, False, False)'static
			End If
			LCAR.SetRedAlert(True,"ShowNotConnected")
			ShowFrame(True,True)
			LCAR.ForceShow(77,True)
			LCAR.LCAR_SetElementText(LCARSeffects.FrameElement+11, "", "")
			SetElement18Text(Text)
		End If
		LCAR.PlaySoundAnyway(32)
	End If
End Sub

Sub ShowWebMenu(DoAnimation As Boolean)
	SeedSideBar(API.GetStrings("web_side", 0), DoAnimation,True)
End Sub

Sub BrowseWeb2(URL As String)
	LCAR.ForceHideAll(BG)
	CurrentSection=5
	BrowseWeb(URL, 0)
End Sub
Sub BrowseWeb(URL As String, Mode As Int)As Boolean 
	If CurrentSection<> 999 Then
		WebMode=Mode
		LCAR.ToastAlign=True
		Select Case WebMode
			Case -1:Return False 
			Case 0,4'normal, file explorer
				CurrentSection=5
				LCARSeffects.frameoffset=0
				LCAR.LCAR_HideAll(BG,True)
				If API.IsConnected Then
					'MoveWebview
					'Log("3136")
					LCAR.SetRedAlert(False,"BrowseWeb")
					'ShowFrame(True,True)
					ShowWebMenu(True)
					'webview1.loadurl(api.MakeHTML(""))
					LCAR.LCAR_SetElementText(LCARSeffects.FrameElement, API.GetString("web_search"), "")
					LCAR.LCAR_SetElementText(LCARSeffects.FrameElement+11, API.GetString("exit"), "")
					SetElement18Text(API.Title.Replace(" - ", CRLF).Replace(" | ", CRLF).ToUpperCase)
				Else
					ShowNotConnected("")
					Return False
				End If
			Case 3'tropes
				
			Case 1000
				HandleEducationalSetting(1000,-1)
		End Select
		LCAR.ToastAlign=True
		
		webview1.Left= API.iif(LCAR.SmallScreen, 50,100) + LCAR.ChartSpace
		webview1.top= API.iif(LCAR.SmallScreen, 100,195)
		
		ShowBrowser
		
		LastURL=URL
		If URL.Length=0 Then
			'Log("3159")
			LCAR.SetRedAlert(False,"BrowseWeb")
			SetElement18Text(API.Title.Replace(" - ", CRLF))
			webview1.Visible = True
			webview1.loadurl(API.ScrollTo(-1))
		Else If URL.ToLowerCase.StartsWith("file:///") Then
			webview1.LoadUrl(URL & API.aHREF)
		Else
			If Not(API.DownloadURL( LastURL )) Then
				ShowNotConnected(API.GetString("web_busy"))
				Return False
			End If
		End If
		Return True
	End If
End Sub

Sub GetScalemodeFlt As Float
	Return LCAR.GetScalemode 
End Sub

Sub ShowSensorScan(Index As Int)
	Dim Element As LCARelement
	If Index=-1 Then
		LCARSeffects.frameoffset=LCAR.ListItemsHeight(5)
		ShowFrame(True,True)
		LCAR.HideGroup(2,True,True)
		'LCAR.LCAR_HideElement(BG,5,False,True,False)
		LCAR.ResizeList(17, 100* GetScalemodeFlt + LCAR.ListitemWhiteSpace, LCARSeffects.frameoffset,  -1,  0,LCAR.GetScaledPosition(4,False),True)
		LCAR.ForceShow(5,True)
		LCAR.LCAR_HideElement(BG,17,True,True,True)
		LCAR.RandomizeColors(17)
		Listen(True)
	Else
		If (CurrSensor=0 And Index>0) Or (Index=0 And CurrSensor>0 ) Then
			Element= LCAR.LCARelements.Get(5)
			Element.Enabled= (Index=0) 
			Element.Align=Element.lwidth'X
			Element.TextAlign=Element.rwidth'Y
			'LCAR.LCARelements.Set(5, Element)'use SetSensorXY
		End If
		CurrSensor=Index
	End If
End Sub

Sub ShowUMRMenu(OldListID As Int)
	'LCARSeffects.FrameOffset=LCAR.ItemHeight+3
	'LCARSeffects.NeedsRedrawFrame=True
	
	SeedSideBar(Array As String(API.GetString("back")),  OldListID=-2, True)
	'ShowFrame(False, True)
	
	If OldListID<0 Then
		UMRsection=-1
		LCAR.HideGroup(16 ,False,False)
		'ShowFrame(True,True)
	Else
		LCAR.LCAR_HideElement(BG,OldListID,True,False,True)
	End If
	
	'LCAR.forceshow(71,True)
	LCAR.LCAR_HideElement(BG,12,True,True,True)
End Sub
Sub ShowSensorsSection(Index As Int)
	LCAR.ClearScreen(BG)
	'Select Case UMRsection
	'	Case 0'hide main
			LCAR.LCAR_HideElement(BG, 63, False, False, True)
			LCAR.LCAR_HideElement(BG, 02, True,  False, True)
	'	Case 1'hide multi-spectral
			LCAR.LCAR_HideElement(BG, 71, False,  False, True)
			LCAR.LCAR_HideElement(BG, 21, True,  False, True)
	'	Case 2'hide axis selection
			LCAR.LCAR_HideElement(BG, 20, True,  False, True)
	'		LCAR.LCAR_HideElement(BG, 21, True,  False, True)
	'	case 3'hide settings system
			LCAR.LCAR_HideElement(BG, 3, True,  False, True)
			LCAR.LCAR_HideElement(BG, 4, True,  False, True)
	'End Select
	LCARSeffects.HideallFrameBits(BG, False,True)
	LCAR.ForceHide(72)
	'Log("3232")
	LCAR.SetRedAlert(False,"ShowSensorsSection")
	UMRsection=Index
	
	If UMRsection>0 Then
		LCAR.ResizeList(21,  -1, LCAR.GetScaledPosition(0,False), 20, LCAR.GetScaledPosition(0,True),0,True)
	
'		If LCAR.SmallScreen Then
'			LCAR.ResizeList(21,  -1, 65, 20, 53,0 ,True)
'		Else
'			LCAR.ResizeList(21,  -1,  130, 20,  100 + LCAR.ChartSpace,0 ,True)
'		End If
	End If
	Select Case UMRsection
		Case -1'red alert toggle
			If LCAR.SmallScreen Then
				LCAR.ResizeList(21,  -1, -1, 20,  53,100 ,True)
			Else
				LCAR.ResizeList(21,  -1, -1, 20, 100+ LCAR.ChartSpace,200 ,True)
			End If
			LCAR.LCAR_HideElement(BG, 21, True,  True, True)
			
		Case 0'show main
			LCAR.forceshow(63,True)
			LCAR.LCAR_SetListStyle(BG, 2, LCAR.LCAR_Meter, True)
			ResizeRuler(True)
			
		Case 1'show multi-spectral
			LCAR.ForceShow(71,True)
			LCAR.LCAR_HideElement(BG, 21, True,  True, True)
			ResizeRuler(False)
			
		Case 2'show axis selection
			LCARSeffects2.MakeMIR(20, AprilFools)
			LCAR.LCAR_HideElement(BG, 20, True,  True, True)
			LCAR.LCAR_HideElement(BG, 21, True,  True, True)
			
		Case 3'show data section
			ShowSection12(15)
	End Select
End Sub
Sub ResizeRuler(isTop As Boolean)'element 72
	Dim Left As Int, Height As Int, Top As Int, Direction As Int ,Bottom As Int = 165'OneThird As Int, 
	LCARSeffects.HideFrameBits(BG, isTop, False,False)
	'stroke = Element.Align , whitespace = Element.TextAlign, direction = Element.LWidth, cells = Element.RWidth) 
	'OneThird= LCAR.ScaleWidth/3
	Left= LCAR.GetScaledPosition(1,True)'    OneThird+3
	If LCAR.SmallScreen Then
		Height=10
		Direction=4
		Top = API.IIF(isTop,  72, 85)
	Else
		Height=17 * GetScalemodeFlt
		Bottom = Bottom*GetScalemodeFlt - (LCAR.ListitemWhiteSpace *2)
		'Top=Bottom - Height - LCAR.ListitemWhiteSpace
		Direction=12* GetScalemodeFlt
		'Top = 145
		If Not(isTop) Then Top = Top + Height + LCAR.ListitemWhiteSpace
		
		Top = LCAR.GetScaledPosition( API.IIF(isTop, 1,2) , False)
	End If	
	If Not(isTop) Then Direction=Direction*-1
	LCAR.ForceElementData(72, Left, Top, 0,0, -1, Height,0,0,0,255,True,True)
	LCAR.GetElement(72).LWidth = Direction
	LCAR.ForceShow(72,True)
End Sub


Sub SelectSensor(Index As Int, ListID As Int)
	Dim temp As Int ,Item As LCARlistitem ,ColorID As Int ,GraphID As Int
	If ListID = 20 Then
		Item = LCAR.LCAR_GetListItem(20, Index)
		temp = LCAR.LCAR_FindListItem(21, Item.Tag, 2, False, -1) 
		If temp=-1 Then 'axis is not currently selected, add it
			ColorID=LCAR.LCAR_RandomUnusedColor(21, True)
			If ColorID=-1 Then
				LCAR.ToastMessage(BG, API.GetString("toomany_axis"), 4)
			Else
				GraphID = LCARSeffects2.ActivateAxis(Index, ColorID)
				'Msgbox(GraphID, "GRAPHID")
				LCAR.LCAR_AddListItem(21, Item.Text, ColorID,  GraphID, Item.Tag, False, Item.Side, Item.WhiteSpace , False, -1)
			End If
		Else'axis is currently selected, remove it
			Item = LCAR.LCAR_GetListItem(20, Index)
			GraphID= LCARSeffects2.FindAxis( Item.Tag)
			If LCARSeffects2.ActivateAxis(GraphID, -1) >-1 Then LCAR.LCAR_FindListItem(21, Item.Tag,2, True,-1)
		End If
	Else'remove the clicked axis
		LCAR.ClearScreen(BG)
		Item = LCAR.LCAR_GetListItem(21, Index)
		GraphID= LCARSeffects2.FindAxis( Item.Tag)
		If LCARSeffects2.ActivateAxis(GraphID, -1) >-1 Then LCAR.LCAR_RemoveListitem(21, Index)
	End If
End Sub



Sub RandomizeGraph(SensorID As Int)
	'If CurrentSensor<>Event.Index2 Then
	'element 63 style=Element.Align,cols=Element.LWidth, rows=Element.RWidth
	Dim Element As LCARelement 
	If LCAR.LCARelements.Size>63 Then
		Element = LCAR.LCARelements.Get(63)
		Element.Align= Rnd(API.IIF(LCAR.SmallScreen,1,0), 3)
		Element.LWidth= Rnd(2,6)
		Element.rWidth= Rnd(2,4)
		If CurrentSensor<> SensorID Then
			CurrentSensor=SensorID
			LCARSeffects2.ClearGraph(0)
		End If
	End If
End Sub






Sub HideSideBar
	LCAR.HideSideBar(BG,19,3)
End Sub
Sub SeedSideBar(Items As List,DoAnimation As Boolean, LeftBar As Boolean )
	LCAR.SeedSideBar(BG,19,Items, DoAnimation, LeftBar, 3)
End Sub

Sub SaveCustom(MakeUnique As Boolean )
	Games.PDP_SaveCustom(BG, MakeUnique)
End Sub


Sub HandleButtonList(Index As Int) As Boolean
	Dim tempstr As String 
	Select Case CurrentSection
		Case 23'live wallpaper settings
			ShowSection(36,False)
		Case 32': HandleAskQuestion(, , "", True)
			LCAR.SelectText("")
			LCARSeffects.ShowPrompt(BG,-10, API.getstring("quick_reply"), API.GetString("sms_reply"), -10, API.GetString("kb_ok"), API.GetString("cancel"))
			'QuestionAsked=True
		Case 41'widget refresh
			CallSub(Widgets,"Widget_UpdateSettings")
			LCAR.ToastMessage(BG, API.GetString("widg_refreshing"),2)
		Case 42'klingon translator
			Select Case Index
				Case 0: Translator.AutoTranslate
				Case 1: 
					LCAR.IsClean=False
					Games.UT=Not(Games.UT)
			End Select
		Case 47'weather
			If Weather.CanUpdateYet Or API.debugMode Then
				Weather.NeedsUpdate = True
				Weather.CheckWeather("", True)
				LCAR.ToastMessage(BG, API.GetString("weat_refreshing"),2)
			Else
				LCAR.ToastMessage(BG, API.GetString("weat_wait"),2)
			End If
		Case 49'games
			Select Case Index 
				Case 0'host
					If LCAR.SRV_State = Games.PT_Local Then
						ServerListen
					Else
						LCAR.ToastMessage(BG, API.GetStringVars("hosting_already", Array As String(ServerIPport)),4)
						LCAR.PlaySound(12,False)
					End If
				Case 1'join
					If LCAR.SRV_State = Games.PT_Local Then
						LCAR.ForceHideAll(BG)
						LCAR.ShowNumBoard(BG, ServerIP)
					Else
						LCAR.ToastMessage(BG, API.GetString("connected_already"),2)
						LCAR.PlaySound(12,False)
					End If
				Case 2'close
					DisconnectUMR
					If Socket1.IsInitialized Then Socket1.Close 
					LCAR.ToastMessage(BG, API.GetString("disconnected"),2)
			End Select
		Case 52'lightpack
			Select Case Index 
				Case 0'connect
					If API.Len(Settings.Get("lightpackpass"))>0 Then
						LCAR.SetRedAlert(False, "Lightpack")
						ServerIP = API.parseip(Settings.Get("lightpackip"))
						Socket1.Initialize("Socket1")
						Socket1.Connect(API.GetIP(ServerIP,False) , ServerIP.Port ,  20000)
						SetElement18Text(API.GetString("connecting"))
						LCAR.PlaySound(25, False)
					Else
						LCAR.ToastMessage(BG, API.GetString("password_required"),2)
						LCAR.playsound(12, False)
					End If
				Case 1'disconnect
					DisconnectUMR
			End Select
		Case 71'APK installer
			Select Case Index
				Case 0:API.AutoUpdateAPKS = ToggleValue(API.AutoUpdateAPKS, API.GetString("apk_updating"), 0)'LCAR.SetButtonText(0, BoolToBool(API.AutoUpdateAPKS))
				Case 1:API.AutoInstallAPKs = ToggleValue(API.AutoInstallAPKs, API.GetString("apk_installing"), 1)'LCAR.SetButtonText(1, BoolToBool(API.AutoInstallAPKs))
			End Select 
		Case 72'card games
			Games.CARD_HandleOptions(BG, 5, Index)
		Case 73'ADD DIR
			tempstr = FILELIST(API.GetString("select_dir"), API.GetString("photo_widget"), File.DirRootExternal, API.GetString("kb_ok"), API.GetString("cancel"), "", True)
			If API.IsDirectory(tempstr) Then
				API.AddFile("PhotoWidget", tempstr)
				ShowSection(73, False)
			End If
		Case 74'tropes
			Tropes.HandleSetting(5, Index)
		
		Case 1001,1002,1003,1004
			HandleEducationalSidebar(True, Index)
		Case Else
			'LCAR.ToastMessage(BG, "UNHANDLED BUTTON: " & CurrentSection & "." & Index, 3)
			Return HandleSettings(Index, LCAR.ButtonList)
	End Select
	Return True
End Sub

Sub ToggleValue(Value As Boolean, Name As String, Index As Int) As Boolean 
	Value=Not(Value)
	LCAR.HideToast'("ToggleValue")
	LCAR.SetButtonText(Index, BoolToBool(Value))
	LCAR.ToastMessage(BG, Name & " = " & BoolToBool(Value), 3)
	Return Value
End Sub

Sub HandleSidebar(Index As Int)'listid 19
	Select Case CurrentSection
		Case -2'Settings
			CurrentSettingsSection=Index
			ShowSettings(False,False)
		Case -1'Mode select
			If LCAR.Educational Then 
				EducationalMode(False)
			Else
				SeedSectionList(Index, "SIDEBAR", True)
				If Index = 3 And AprilFools Then 
					Index=Rnd(0,3)
					Select Case Index
						Case 0: PlayWOPRsound(3)
						Case 1,2: DownloadAndPlay("incominggame" & Index, 0)
					End Select
				End If
			End If
		Case 3'sensors
			ShowSensorsSection(Index)
		Case -3, 4'autodestruct timer
			If CurrentSection=-3 Then 
				CurrentSection=4
				LCAR.forceshow(19,False)
				LCAR.LCAR_HideElement(BG, 5, True,True,False)
			End If
			Select Case Index
				Case 0: LoadTimers(0)	'edit current timer
				Case 1: LoadTimers(1)	'view saved timers
				Case 2: TimerAction(1)	'start
				Case 3: TimerAction(0)	'reset
			End Select
		
		Case 5'memory alpha
			Select Case Index
				Case 0'read
					ReadPage
				Case 1'back
					If Not(HistoryList(LCAR.LCAR_FindListItem(16,API.FileLoaded,2,False,-1)+1)) Then ShowModeSelect(14)
				Case 2'history
					HistoryList(-1)
			End Select
		Case 7'UMR
			ShowUMRMenu(UMRsection) 
		Case 17'PdP
			Games.PDP_HandleSettings(BG, 17,Index)
		Case 22'Personal log
			If Index=3 Then
				If LCAR.GetListItemCount(23)>0 Then PlayNextSound(-2)
			Else If LCAR.LCAR_GetSelectedItem(23)>-1 Then
				CurrentSound=-1
				Select Case Index
					Case 0'play	
						PlayNextSound(0)
					Case 1'edit
						TextPrompt(API.GetString("log_rename"), API.GetString("log_rename_prompt"), 6, LCAR.LCAR_GetListitemText(23,-1,0), True)
					Case 2'delete
						ShowPrompt(API.GetString("log_delete"), API.GetStringVars("confirm_delete", Array As String(LCAR.LCAR_GetListitemText(23,-1,2))), 7, API.GetString("no"), API.GetString("yes"))
				End Select
			Else
				LCAR.ToastMessage(BG, API.GetString("log_none"), 3)
			End If
		Case 24'calculator
			HandleCalc(19, Index)

		Case 32'comms settings
			LCAR.HideButtonBar(BG)
			CurrentSettingsSection = -17 - Index
			ShowSettings(False,True)

		Case 37'alarms
			If CurrentSettingsSection = -21 Then 'main
				If Index = 2 Then
					API.StartDoze: Return 
				Else
					API.BelayCurrentAlarm(Index=0)
				End If
			Else
				Select Case Index
					Case 1: API.savealarm(Settings)
					Case 2: API.DeleteAlarm(Settings)
				End Select
			End If
			ShowSection(37,False)
		
		Case 39'metaphasic
			LCARSeffects3.LoadMetaphasicImage(Index, 97)
		
		Case 62'reminders
			Select Case Index
				Case 0:TextPrompt(API.getstring("widget_14"), API.getstring("reminder_prompt"),14, RandomReminder.ToUpperCase, True)'add
				Case 1:API.ReminderAction(1,-1)'delete
			End Select
			
		Case 72'card games
			Games.CARD_HandleOptions(BG, 19, Index)
		
		Case 83'file explorer
			HandleDIRmenu(19, Index)
		
		Case 85'Dr Pulaski
			Games.DrP_Pause
		
		Case 1001,1002,1003,1004
			HandleEducationalSidebar(False, Index)
			
		Case Else
			Msgbox("Unhandled: " & CurrentSection, "CurrentSection")
	End Select
End Sub
Sub RandomReminder As String
	Return API.GetString("rem" & Rnd(0, API.GetString("reminders")))
End Sub

Sub PlayNextSound(Index As Int)
	'Dim tempstr As String 
	Select Case Index 
		Case -2
			CurrentSound= LCAR.LCAR_GetSelectedItem(23)
			CurrentSound= Max(-1,CurrentSound-1)
			PlayNextSound(-1)
		Case -1
			CurrentSound=CurrentSound+1
			If LCAR.GetListItemCount(23) > CurrentSound Then
				PlayLog(CurrentSound)
			Else
				CurrentSound=-1
			End If
		Case 0
			CurrentSound=-1
			PlayLog(-1)
		Case 1
			If CurrentSound>-1 Then PlayNextSound(-1)
	End Select
End Sub
Sub PlayLog(Index As Int)
	Dim tempstr As String = LCAR.LCAR_GetListitemText(23,Index,2) 
	LCAR.Stop("Playlog")
	LCAR.ToastMessage(BG, API.GetStringVars("log_playing", Array As String(tempstr)),3)
	LogSound=LCAR.AddSound("LOG", tempstr , LCAR.DirDefaultExternal)
	LCAR.PlaySound(LogSound, False)
	CMD = Regex.Split(CRLF, "")
	HandleSubtitles(0)
End Sub


Sub HandleSubtitles(Index As Int) As Int 
	Dim tempstr As String ,Time As Int
	If Index=0 Then'StartMicroTimer
		tempstr = LCAR.LCAR_GetListitemText(23,-1,2)
		tempstr = API.Left(tempstr, tempstr.Length -3) & "txt"
		Subtitles.Initialize 
		If File.Exists(LCAR.DirDefaultExternal,tempstr) Then
			CMD = Regex.Split(CRLF, File.ReadString(LCAR.DirDefaultExternal,tempstr))
			Subtitles.Append("Y")
			LCAR.HideToast' ("HandleSubtitles1")
		End If
		DataSize=0
		LCAR.StartMicroTimer(100)
		StartTime=DateTime.Now 
	Else If Index=-1 Then
		Index=DataSize
	End If
	If Subtitles.IsInitialized Then
		If Subtitles.Length=1 Then
			If Index<CMD.Length And Index>-1 Then
				If API.Instr(CMD(Index), "=",0)>0 Then
					Time = API.getSide( CMD(Index), "=",True,False)
					tempstr = API.getSide( CMD(Index), "=",False,False)
					StartTime=StartTime+Time
					'Log("Index: " & Index & "Duration: " & Time & " Text: " & tempstr)
					LCAR.HideToast' ("HandleSubtitles2")
					LCAR.ToastMessage(BG, tempstr, Floor(Time/1000))
				End If
			Else 
				LCAR.StartMicroTimer(0)
			End If
			DataSize=Index+1
		End If
	End If
	Return DataSize
End Sub

Sub ShowPrompt(Title As String, Text As String,QuestionID As Int, RightButton As String, LeftButton As String)
	LCARSeffects.ShowPrompt(BG, 12, Title, Text, QuestionID, RightButton, LeftButton)
End Sub
Sub TextPrompt(Title As String, Text As String, QuestionID As Int, Default As String, SymbolsEnabled As Boolean)
	LCAR.LCAR_HideAll(BG, False)
	HideWebview
	LCAR.SelectText(Default)
	LCARSeffects.ShowPrompt(BG,-10, Title, Text,QuestionID,API.GetString("kb_ok"), API.GetString("cancel"))
	LCAR.SymbolsEnabled = SymbolsEnabled
End Sub

'Sub SwapFFTMode(Dir As Int)
	'dim 'element 79
'	If Dir=1 Then
'		FFTMode=FFTMode+1
'		If FFTMode > 2 Then FFTMode = 0 
'	Else
'		FFTMode=0
'	End If
'	LCAR.SetGraphStyle(79, API.IIF(FFTMode=0, 4,5), -1,-1)
'	LCAR.SetGraphID(79, API.IIF(FFTMode=0, 1,3) )
'End Sub


Sub AddOmega
	DOSITEM = LCAR.LCAR_FindListItem(0, "-2", 2, False,-1)
	If (MenuSection =0 Or MenuSection = 5) And DOS > -1 And DOSITEM=-1 Then SeedSection(API.GetString("sec_-2"), -2)
End Sub
Sub ListColor(Index As Int, ColorID As Int)
	LCAR.SetListitemColor(0, Index, ColorID)
End Sub
Sub SeedSections(Indexes() As String)
	Dim temp As Int 
	For temp = 0 To Indexes.Length-1
		SeedSection("", Indexes(temp))
	Next
	LCAR.GetList(0).ShowNumber = Not(LCAR.SmallScreen)
End Sub
Sub SeedSection(Name As String, Index As Int) As Int 
	Dim Number As Int = API.IIF(Index < 0, 1000 + Index, Index),  temp As Int' = LCAR.LCAR_FindListItem(3, Name, 0, False,  Number)
	'If temp > -1 Then Return temp 
	If Name.Length=0 Then Name = API.GetSectionInfo(Index,1)
	temp = LCAR.LCAR_FindListItem(0, Name, 0, False, Number)
	If temp > -1 Then Return temp 
	If Name.Length>0 Then Return LCAR.LCAR_AddListItem(0, Name, LCAR.LCAR_Random, Number,  Index, False, "", 0 , False, -1) 
	Return-1
End Sub
Sub LWPLIST As List
	Return API.LWPLIST
End Sub

Sub SaveRandomColor(Index As Int)
	'Dim temp As Int 
	If LCAR.LessRandom Then
		If Index=5 Then
			ListColors(5)=LCAR.ForceRandomColor
			LCAR.SetListitemColor(19,0,-1)
		Else
			ListColors(Index) = LCAR.SetListitemColor(19, API.IIF(Index=0, 5,Index), -1)
			Select Case Index
				Case 3
					Do While LCAR.CurrRandom = ListColors(0) Or LCAR.CurrRandom = ListColors(3)
						LCAR.ForceRandomColor
					Loop
				Case 4
					LCAR.CurrRandom = ListColors(0)
				Case Else
					LCAR.ForceRandomColor
			End Select
		End If
	End If
End Sub

Sub RemoveSection(Index As Int, tempstr As String) As String
	Return tempstr.Replace("," & Index & ",", ",")
End Sub
Sub GetSections(Index As Int)
	Dim tempstr As String = API.GetSectionInfo(Index,-1)
	tempstr = RemoveSection(42, tempstr)'klingon translator
	tempstr = RemoveSection(16, tempstr)'angry tribbles
	tempstr = RemoveSection(-2, tempstr)'OMEGA DIRECTIVE
	tempstr = RemoveSection(-1, tempstr)'MODE SELECT
	tempstr = RemoveSection(0, tempstr)'INTRO
	tempstr = RemoveSection(86, tempstr)'tCARS
	Dim Sections() As String = Regex.Split(",", tempstr)
	SeedSections(Sections)
End Sub

Sub SeedSectionList(Section As Int, Reason As String, Force As Boolean) As Boolean'at 37 sections
	Dim Count As Int = LCAR.GetListItemCount(0)
	If Count > 0 And Not(Force) Then Return False
	Log("Seed Sections: " & Reason & " has " & Count & " items. CLEAR LIST" )
	If Section = -1 Then Section = Max(0, MenuSection)
	If Section >5 And Not (LCAR.Educational) Then Section=0
	If MenuSection = Section Then 
		If LCAR.LessRandom Then
			For temp = 1 To 5
				LCAR.SetListitemColor(19, temp, ListColors(temp-1))
			Next
			LCAR.SetListitemColor(19,0,ListColors(5))
		End If
		If LCAR.GetListItemCount(0)>0 Then Return
	End If
	SelectedSection=-999
	MenuSection = Section
	LCAR.LCAR_ClearList(0,0)
	'ALL SENSORS FUNCTIONAL GAME GNDN/NOVELTY SYSTEM
	If Section = 0 Or Section = 5 Then 'System 
		LCAR.ForceRandomColor
		SeedSection("", 0) 'intro
		SaveRandomColor(0)
	End If
	If Section = 0 Or Section = 1 Then 'sensors
		GetSections(0)
		SaveRandomColor(1)'If LCAR.LessRandom Then LCAR.SetListitemColor(19, 1, -1)
	End If
	If Section = 0 Or Section = 2 Then'functional
		GetSections(1)
		ListColor(SeedSection("GSF4:tlhIngan Hol mughwI'", 42), LCAR.LCAR_Red)
		SaveRandomColor(2)'If LCAR.LessRandom Then LCAR.SetListitemColor(19, 2, -1)
	End If
	If Section = 0 Or Section = 3 Then 'games
		ListColor(SeedSection(API.GetString("sec_16"), 16), LCAR.LCAR_Red)
		GetSections(2)
		SaveRandomColor(3)'If LCAR.LessRandom Then LCAR.SetListitemColor(19, 3, -1)
	End If
	If Section = 0 Or Section = 4 Then 'GNDN/Novelty
		GetSections(3)
		ListColor(SeedSection(API.GetString("sec_86"), 86), LCAR.TCAR_LightTurquoise)
		SaveRandomColor(4)'If LCAR.LessRandom Then LCAR.SetListitemColor(19, 4, -1)
	End If
	If Section = 0 Or Section = 5 Then 'System 
		AddOmega
		GetSections(4)'"-3,-2,-1,0,23,36,35,32,38,41"   
		SaveRandomColor(5)
	End If
	If Section = 6 Or LCAR.Educational Then
		GetSections(5)
	End If
	If Section>0 Then LCAR.LCAR_SortList(0)
	Return True 
End Sub


Sub SetShowWhenLocked(State As Boolean)
    Dim r As Reflector
	Try
	   	r.Target = r.GetActivity
	    r.Target = r.RunMethod("getWindow")
	    r.RunMethod2("addFlags", 6815872, "java.lang.int")
	Catch
		Log(LastException.Message)
	End Try
End Sub

Sub CheckForFile(SiteIndex As Int, Filename As String) As Boolean 
	If Not(File.Exists(LCAR.DirDefaultExternal, Filename)) Then Return DownloadFile(SiteIndex, Filename, False, False)
End Sub
Sub ToastSection(Index As Int)
	Dim tempstr As String, Seconds As Int = 3  , Sound As String , Style As Int, Looping As Boolean 
	LCAR.CurrentStyle=LCAR.LCAR_TNG 
	If AprilFools Then
		CheckForFile(0, "sysfwars.png")
		Select Case Index 
			Case 42'Disable ferengi toast for these sections
			Case Else
				If Rnd(0,6)=0 Or API.debugMode Then
					LCAR.Stop ("ToastSection")
					Style = Settings.GetDefault("styletoast", -1)
					If Style = -1 Then Style = Rnd(0,5)
					Select Case  Style
						Case 0'Ferengi
							LCARSeffects3.Qangle=0
							LCAR.CurrentStyle=LCAR.Ferengi 
							Seconds=7
							Sound= "quarks"
						Case 1'PC load letter
							LCAR.ToastImage(BG, "pcload.png", 2)
							Return
						Case 2'StarshipTroopers
							LCAR.CurrentStyle=LCAR.StarshipTroopers 
							Sound= "more"
							tempstr=API.GetString("troopers")
						Case 3'Freedom Wars
							If File.Exists(LCAR.DirDefaultExternal, "sysfwars.png") Then
								LCAR.CurrentStyle=LCAR.FreedomWars
								Sound="fwars"
								tempstr=API.GetString("freedom_wars") 'RandomDisciplinaryNotice
							End If
						Case 4'Knight Rider
							LCAR.CurrentStyle=LCAR.KnightRider
							Sound = "kitt"
							Looping=True
							Seconds=4
					End Select
				End If
		End Select
	End If
	Select Case LCAR.CurrentStyle
		Case LCAR.FreedomWars
		Case Else: tempstr=tempstr.ToUpperCase 
	End Select
	If DoSectionToast Then
		If tempstr.Length=0 Then tempstr=API.GetSectionInfo(Index,2)
		If Sound.Length>0 Then LCAR.PlaySound( LCAR.AddSound("LOG", Sound & ".ogg", File.DirAssets), Looping)
		LCAR.ToastMessage(BG,tempstr,Seconds)
	End If
End Sub

'Sub RandomDisciplinaryNotice As String 
	'Select Case Rnd(0,1)
		'Case 0: 
		'Return "Unauthorized Possession of Endangered Resources:Unauthorized Possession of an item of Rarity Rating Lv. 4 is considered a contravention of the State Directive on Endangered Resources."
	'End Select
'End Sub




Sub ShowSection(Index As Int, IsRightSide As Boolean ) As Boolean 
	Dim DontShow As Boolean , WasSection As Int = CurrentSection, tempstr As String , RedAlertEnabled As Boolean = True
	If SectionLocked Then Return False
	LCAR.HideToast' ("Showsection")
	LCAR.CurrentStyle=LCAR.LCAR_TNG
	LCARSeffects2.HelpMode = False
	If IsRightSide Then
		tempstr = API.gethelpfile(Index)
		If tempstr.Length = 0 Then
			LCAR.ToastMessage(BG, API.GetString("no_help"),3)
			Return False 
		Else
			BrowseMySite(tempstr)
			LCAR.LCAR_HideElement(BG,19,True,False, True)
		End If
		
'		Select Case Index
'			Case -1,11,13: BrowseMySite("help")
'			Case -2:BrowseMySite("dos")
'			Case 20,25,26,27,28,29,34,43,44,53,54,55, 56,57, -999: 
'			Case Else: BrowseMySite(Index)
'		End Select
	Else If Index=-999 Then
		LCAR.SetRedAlert( Not(LCAR.RedAlert), "ShowSection")
		LCAR.ToastMessage(BG, API.GetString("no_section"), 2)
		LCAR.PlaySound(0,False)
	Else 
		WallpaperService.WasFromMainmenu=True
		LCAR.LockListStart(19,False)
		LCAR.LCAR_SetElementText(LCARSeffects.FrameElement+11, "", "")
		LCAR.ForceHideAll(BG)
		LCAR.LCAR_HideElement(BG,19,True,False, True)
		'LCAR.SetRedAlert(False)
		SetElement18Text("")
		LCAR.LCAR_HideElement(BG,18, False,False,True )
		LCAR.LCAR_HideElement(BG,0,True,False,True )
		LCAR.LCAR_HideElement(BG,4,False,False,True)
		If Index <> -1 Then CurrentSection=Index
		LCAR.DrawFPS=True
		Log("Showsection: " & Index)
		Select Case Index		
			Case -4'disconnected
				ShowNotConnected("")
			
			Case -3 'settings
				RedAlertEnabled=False
				ShowSettings(True,False)
				
			Case -2'OMEGA MODE
				HasShown=True
				StopWifi
				LCAR.ForceHideAll(BG)' (BG,False)
				LCAR.GetElement(70).LWidth=DOS
				LCAR.forceshow(70,True)			
				LoadSettings(True)
				AddOmega
				DownloadAndPlay("emhbackupmodule-omega", 1)
			
			Case -1'main menu
				ShowModeSelect(15)
				
			Case 0'intro
				RedoIntro(1, "Intro 1")
				
			Case 1'Chart				wifi
				If API.isWIFI_enabled Then
					If Hotspots.IsInitialized Then StartWifiOver
					ShowFrame(True, False)' True)
					InitHotspots
					LCAR.LCAR_ClearList(1,0)
					LCAR.LCAR_SetListStyle(BG, 1, LCAR.LCAR_Chart,  True)
					LCAR.forceshow(68,True)
				Else
					ShowNotConnected(API.getstring("no_wifi"))
				End If
				
				
			Case 2'Sensor scan			none
				ShowSensorScan(-1)
				ShowRandomNumbers(API.GetString("snsr_scan"))
				
			Case 3'meters				sensors
				SeedSideBar(API.GetStrings("snsr", 0), True,True)', "MIC"), True,True)
				'ShowFrame(True,True)
				UMRsection=-1
				Listen(True)
				ShowSensorsSection(0)
												
			Case 4'timer				timer
				LoadTimers(0)
				ShowTimer(API.GetTimer("Main").Length>0) 'stimer.TimerList.Size>0)
				
			Case 5'memory alpha 
				LCAR.SymbolsEnabled=True
				RedAlertEnabled=False
				BrowseWeb("",0)

			
			Case 6'fwd navigation scan
				ShowFrame(True,True)
				LCAR.forceshow(27,True)
				ShowRandomNumbers(API.GetString("sec_6"))
				'SetElement18Text("FWD NAVIGATION SCAN")
				Listen(True)
			
			Case 7' UMR
				If Socket1.Connected Then
					SeedSideBar(Array As String(API.GetString("back")), True,True)
					'LCARSeffects.FrameOffset = LCAR.ItemHeight +3
					'ShowFrame(True,True)
					LCAR.LCAR_HideElement(BG,12,True,True,False)
					'LCAR.MoveLCAR(71, 0,API.IIF(LCAR.SmallScreen, 132,256),API.IIF(LCAR.SmallScreen, 50,100),LCAR.ItemHeight, 0,True,True,False)   '256,100
					'LCAR.forceshow(71,True)
				Else If API.IsConnected Then 				
					LCAR.ShowNumBoard(BG, ServerIP)
					ResizeScreen
					LCAR.forceshow(40,True)
					LCAR.forceshow(78,True)
				Else
					ShowNotConnected("")
				End If
				
			Case 8'Tactical
				Listen(True)
				
				If GPS1.GPSenabled = False Then
					'ToastMessageShow("Please enable the GPS device.", True)
					ShowNotConnected(API.getstring("no_gps"))
				Else
					LCARSeffects.frameoffset=LCAR.ListItemsHeight(GPSitems)
					ShowFrame(True, True)
					StartGPS
					SetElement18Text(API.GetString("init_gps"))
					ShowTactical
				End If
			
			Case 9'Okudagram
				'lcarseffects.Okuda=lcarseffects.GetInternalOkudagram(1)'0=random
				'lcar.forceshow(48, True)
				'lcar.forceshow(49, True)
				LCAR.CurrentStyle=LCAR.LCAR_TMP
				LCAR.ForceShowGroup(14, True)
				LCAR.LCAR_HideElement(BG,14,True,True, True)
				LCARSeffects.GridLines=True
				ResizeScreen
			
			Case 10,43' red alert, clock
				LCAR.GetElement(51).Enabled = True 
				LCAR.GetElement(51).ElementType = API.IIF(AprilFools And Index = 10, API.IIF(API.debugMode, LCAR.AIR_Alart, LCAR.TMP_Alert), LCAR.LCAR_Alert)
				LCAR.CurrentStyle=LCAR.LCAR_TMP
				RedAlertEnabled=False
				'LCAR.SetRedAlert(False, "ShowSection 10")
				LCAR.ForceShowGroup(15,True)
				SwapMode(51,0)			
			
			Case 11'federation database
				LCAR.ForceShow(57 ,True)
				
			Case 12'starbase clock
				'Log("3814")
				LCAR.CurrentStyle=LCAR.LCAR_TMP
				RedAlertEnabled=False'LCAR.SetRedAlert(False, "ShowSection Clock")
				LCAR.ForceShowGroup(18,True)
				
			Case 13'sensor analysis
				'Log("3820")
				RequestScreenOrientation(0)
				RedAlertEnabled=False'LCAR.SetRedAlert(False, "ShowSection sensor analysis")
				ShowFrame(True,True)
				LCARSeffects2.SeedScanAnalysis(18, LCAR.LCAR_TNG)
				ShowRandomNumbers(API.GetString("snsr_ana"))
				LCAR.LCAR_HideElement(BG, 18,True,True, True)
				
			Case 14'warp core status 
				LCAR.ForceShow(64 ,True)
				If LCAR.PlaySound(14,True) Then
					WarpRumble(-1)
				Else
					LCAR.ToastMessage(BG, API.GetString("no_warp"), 4)
				End If
				'STimer.Increment=10
				'StartService(STimer)
				
			Case 15'Captian's log/Google Plus changelog
				If API.IsConnected Then 
					GPlus.GetFacebookAccessToken("")
					GPlus.GetTwitterAccessToken("")
					GPlus.GetTwitterAccessCode(TwitterJob, Me)
					
					LCAR.CurrentStyle=LCAR.LCAR_ENT
					PageToken=""
					LCAR.ForceShowGroup(21,True)
					LCAR.LCAR_HideElement(BG, 22,True,True,True)
					'DownloadGPlusFeed
					WebMode=1
					ResizeScreen
					needsreloading=False
				Else
					ShowNotConnected("")
				End If
				
			Case 16'Angry Tribbles
				RequestScreenOrientation(0)
				LCAR.CurrentStyle = LCAR.Klingon 
				ResizeScreen
				LCAR.ForceShow(69 ,True)'group 23
				Games.Paused=False
				LCAR.LightpackChangePattern(3, 200, LCAR.LCAR_Red, 128)
				
			Case 17'PDP
				LCAR.LCAR_SetElementText(LCARSeffects.FrameElement+11, "", "")
				Games.PDPSetup
				'Log("3859")
				RedAlertEnabled=False'LCAR.SetRedAlert(False,"ShowSection PDP")
				'ShowFrame(True,True)
				CurrentSettingsSection=-1
				ShowSettings(True,True)
				'LCAR.ForceShow(74 ,True)
				'Msgbox(CurrentSection, "SECTION")
				
			Case 18'frequency
				PurgeBuffer
				StopRecording
				If StartRecording Then
					ShowFrame(False, False)
					LCAR.ForceShow(79,True)
					'SwapFFTMode(0)
					ShowRandomNumbers(API.GetString("snsr_freq"))
					DoContact(0,0)
					'LCARSeffects2.ClearGraph(3)
					LCAR.LightpackChangePattern( 5 , 200, 0, 255)
				Else
					ShowNotConnected(API.GetString("no_mic"))
				End If
			
			Case 19'moire
				LCAR.CurrentStyle=LCAR.LCAR_TOS
				LCAR.ForceShow(80 ,True)
				PlayScienceSound
			
			Case 20'photic sonar
				LCAR.CurrentStyle=LCAR.LCAR_TMP
				LCAR.ForceShow(81 ,True)
				LCAR.LightpackChangePattern(3, 100, LCAR.Classic_Blue, 128)
			
			Case 21'PToE
				LCAR.ForceShow(83 ,True)

			Case 22'Personal log
				If Settings.GetDefault("SecurePLOG", "false") Then
					If Unlocked Then ShowSection2(22)
				Else
					ShowSection2(22)
				End If
				
			Case 23'Live Wallpaper
				'LCAR.ForceShowGroup(33)
				ShowSettingsSection(-10)
				If API.Model(0).ToLowerCase.Contains("samsung") And Not(GetFSMmode="DISABLED") Then
					LCAR.ToastMessage(BG, API.GetString("no_scroll"), 4)
				End If
				
			Case 24'calculator
				'SeedSideBar(Array As String("NUM", "TXT", "VAR", "ANS"), True,True)', "MIC"), True,True)
				HandleCalc(-1,-2)
				'LCAR.LCAR_HideElement(BG, 25,True,True,True)
			
			Case 25'number 1 LWP preview
				PreviewLWP(10)'PreviewLWPname("NUMBER ONE")
			Case 26'transporter LWP preview
				PreviewLWP(14)'PreviewLWPname("TRANSPORTER")
			Case 27'shuttles LWP preview
				PreviewLWP(16)'PreviewLWPname("SHUTTLES")
			Case 28'warp core 2 LWP preview	
				'File.Exists(LCAR.DirDefaultExternal, "warpcorehi.jpg")  File.Exists(LCAR.DirDefaultExternal, "warpcorelo.jpg")
				PreviewLWP(15)'PreviewLWPname("WARP CORE 2")
				If LCAR.PlaySound(14,True) Then WarpRumble(-1)
			
			Case 29'environmental
				LCAR.LightpackChangePattern(3, 100, LCAR.Classic_Blue, 128)
				LCAR.ForceShow(86, True)
				
			Case 30'starfield preview
				PreviewLWP(18)'PreviewLWPname("STARFIELD")
			
			Case 31'communicator
				HandleCOMMS("COMMS")
				
			Case 32'Communicator settings
				If Unlocked Then
					LCAR.Stop("COMMS")
					ShowSettingsSection(-17)
					If API.Model(0).ToLowerCase.Contains("htc") And Not(Settings.GetDefault("AltMethod", "false")) Then
						LCAR.ToastMessage(BG, API.GetString("no_answer"), 4)
					End If
				End If
				
			Case 33'science II
				ShowFrame(True, True)
				LCAR.ForceShow(89, True)
				LCAR.ForceShow(90, True)
				LCAR.LightpackChangePattern(3, 100, LCAR.LCAR_Orange, 128)
				
			Case 34'may the fourth
				RequestScreenOrientation(0)
				LCAR.CurrentStyle=LCAR.StarWars
				LCARSeffects3.ResetStarWars(91)
				LCAR.LightpackChangePattern(3, 200, LCAR.LCAR_Yellow, 128)
			
			Case 35'day dream settings 
				LCAR.Stop ("DD")
				ShowSettingsSection(-20)
				
			Case 36'MSD Downloader
				If API.IsConnected Then 
					LCAR.CurrentStyle=LCAR.LCAR_ENT
					ResizeScreen
					ShowMSDs(-2,True)
				Else
					ShowNotConnected("")
				End If
				
			Case 37'alarms
				DontShow= True
				If API.HasDeadMan Then DontShow = Unlocked
				If DontShow Then ShowSettingsSection(-21)
				
			Case 38'security
				If Unlocked Then ShowSettingsSection(-23)
				
			Case 39'SOHO/metaphasic shields
				RedAlertEnabled=False'LCAR.SetRedAlert(False, "SOHO")
				SeedSideBar(Array As String("171", "195", "284", "304", "CON", "MAG", "C2", "C3"), True,True) 
				ShowRandomNumbers(API.GetString("snsr_meta"))
				LCARSeffects3.LoadMetaphasicImage(-1, 97)
			
			Case 40'TWOK
				LCAR.CurrentStyle=LCAR.LCAR_TMP
				Games.BMN_EnterSystem(BG,True)
				
			Case 41'Widgets
				If Widgets.mAppWidgetIdList.Size=0 Then
					ShowModeSelect(16)
					LCAR.ToastMessage(BG, API.GetString("widg_none"), 3)
				Else
					ShowSettingsSection(-24)
				End If
				
			Case 42'translator
				'Translator.Translate("Testing", "en", Translator.KlingonLanguage(False))
				ShowSettingsSection(-26)
				Dim Disclaimers As List = API.GetStrings("bing", 0)
				For WasSection = 0 To Disclaimers.Size - 1
					LCAR.ToastMessage(BG, Disclaimers.Get(WasSection), 5)
				Next 
			
			'case 43'alert condition status clock 
			Case 44'CONN station
				PreviewLWP(22)'PreviewLWPname("CONN")
			
			Case 45'Chronowerx OS
				LCARSeffects3.CHX_ShowLogo(100,False)
				
			Case 46'DRADIS
				RequestScreenOrientation(0)
				LCAR.CurrentStyle=LCAR.BattleStar
				LCAR.ForceShow(101, True)'element 101 (group 43)
				
			Case 47'WEATHER SETTINGS
				ShowSettingsSection(-27)
			
			Case 48'TRICORDER	
				LCAR.LightpackChangePattern(4, 1000, 0, 0)
				RequestScreenOrientation(1)
				LCARSeffects4.StartTricoder (102)'SYS_Camera
				
			Case 49'3D Minesweeper
				ShowSettingsSection(-28)
				PlayWOPRsound(-1)
				
			Case 50'solar system
				LCAR.CurrentStyle = LCAR.LCAR_ENT
				RequestScreenOrientation(0)
				LCAR.ForceShow(104, True)
				
			Case 51'debug menu
				ShowSettingsSection(-29)
				
			Case 52'lightpack
				ShowSettingsSection(-30)
				
			Case 53, 63'DS9 (shatterglass, wireframe)
				If API.IsOnWifi Then DownloadFile(0, "sysds9.png", False, True)
				LCARSeffects5.SetupDS9(CurrentSection,True)
				LCAR.GetElement(106).Align = API.IIF(CurrentSection=53, 1,2)
				LCAR.ForceShow(106, True)'element 106 (group 48) align=1
				
			Case 54,80'VOYAGER/ENT-E SHIELDS
				RequestScreenOrientation(0)
				ShowFrame(True,True)
				LCAR.LCAR_GetElement(107).Align = API.IIF(Index = 54, 1,2)
				LCAR.ForceShow(107, True)
				ShowRandomNumbers(API.getstring("vehicle_status"))
			
			Case 55'wireframe
				LCAR.ForceShow(108,True)
			
			Case 56 'OPS
				PreviewLWP(28)'PreviewLWPname("OPS")
			
			Case 57'number 2 LWP preview
				PreviewLWP(29)'PreviewLWPname("NUMBER TWO")
			
			Case 58'icon modifier
				ShowSettingsSection(-31)
			
			Case 59'Romulan clock
				PreviewLWP(30)'PreviewLWPname("ROMULAN")
				'LCAR.CurrentStyle = LCAR.Romulan 
				
			Case 60'KLINGON CLOCK
				PreviewLWP(31)'PreviewLWPname("KLINGON")
				LCAR.CurrentStyle = LCAR.Klingon
			
			Case 61'SINE WAVE
				LCAR.CurrentStyle=LCAR.LCAR_TMP
				LCAR.ForceShow(109,True)
			
			Case 62'reminders
				ShowSettingsSection(-32)
						
			Case 64'TOS BRIDGE
				If Not(LCARSeffects3.CheckForTOS) Then DownloadFile(0, "systos.png", False, True)
				PreviewLWP(33)'PreviewLWPname("TOS BRIDGE")
				LCAR.CurrentStyle = LCAR.LCAR_TOS
				
			Case 65'unit conversion
				ShowSettingsSection(-35)
				BigOptions=True
			
			Case 66'ENT Bridge
				PreviewLWP(34)'PreviewLWPname("NX01 BRIDGE")
				LCAR.CurrentStyle = LCAR.LCAR_ENT 
			
			Case 67'tactical sub screen
				PreviewLWP(35)'PreviewLWPname("TACTICAL 2")
				
			Case 68'transporter 2
				PreviewLWP(36)'PreviewLWPname("TRANSPORTER 2")
				
			Case 69'CORRIDOR
				PreviewLWP(37)'PreviewLWPname("CORRIDOR")'PreviewLWPname("UFP LOGO")
				
			Case 70'Q NET
				PreviewLWP(38)'PreviewLWPname("Q NET")
				
			Case 71'APK addon installer
				If API.IsConnected Then
					SetElement18Text(API.GetString("loading"))
					API.GetFileList("", True)
				Else
					ShowNotConnected("")
				End If
				
			Case 72'card games
				ShowSettingsSection(-37)
				
			Case 73'photo widget settings
				ShowSettingsSection(-38)
				
			Case 74'trek tropes
				'If API.IsConnected Then
					Tropes.Login
					ShowSettingsSection(-2)
					LCAR.SetRedAlert(False, "Show 74")
				'Else
				'	ShowNotConnected("")
				'End If
			Case 75'SHELIAK
				PreviewLWP(39)'PreviewLWPname("SHELIAK")
				
			Case 76'cardassian
				LCAR.CurrentStyle=LCAR.Cardassian 
				'PreviewLWPname("CARDASSIAN")
				PreviewLWP(40)
			
			Case 77'warp field
				PreviewLWP(41)'PreviewLWPname("WARP FIELD")
			
			Case 78'nardi noise nnaker
				ShowSettingsSection(-3)
			
			Case 79'NFC
				ShowSettingsSection(-4)
			
			Case 81 'DNA
				PreviewLWP(43)'PreviewLWPname("DNA")
			
			Case 82'UFP LOGO
				RedoIntro(2, "Intro 2")
			
			Case 83'File Explorer
				ShowSettingsSection(-5)

			Case 84'PLASMA CONSTRICTION
				'Hackers PreviewLWPname("HACKERS") 
				ShowFrame(True,True)
				ShowRandomNumbers(API.GetStringVars("plasma_con", Array As String(Rnd(100,1000))))
				LCAR.ForceShow(112, True)
			
			Case 85'Dr. Pulaski
				If Not(Games.Paused) Then Games.DrP_Pause
				ShowSettingsSection(-6)
			
			Case 86'tCARS
				LCAR.CurrentStyle = LCAR.tCARS
				PreviewLWP(45)'PreviewLWPname("TCARS")
				
			Case 87'BORG
				LCAR.CurrentStyle = LCAR.BORG
				PreviewLWP(46)'
			
			Case 88'Ferengi
				PreviewLWP(47)
			
			Case 89'ENT-B Bridge
				PreviewLWP(48)'PreviewLWPname("ENT-B BRIDGE")
				LCAR.CurrentStyle = LCAR.LCAR_TMP
				
			Case 90'Bridge settings
				ShowSettingsSection(-7)
			
			Case 91
				PreviewLWP(49)'PreviewLWPname("ENT-B HELM")
				LCAR.CurrentStyle = LCAR.LCAR_TMP
				
			Case 92
				If API.IsPackageInstalled("com.omnicorp.scifiui") Then 
					API.StartPackage("com.omnicorp.scifiui")
				Else 
					OpenMarketplace(0, "com.omnicorp.scifiui")
				End If
				
			'996 is EventHorizon
			Case 997:	ShowSettingsSection(-25)'size wizard
			Case 998:	WidgetResizer(-2)'widget resizer	
			Case 999:	If WasSection <> 999 Then ShowUFPLogo'alarm answer screen		 
'			Case 9990:	API.HandleFTL("", "")

			'eductional mode
			Case Else
				If Index>1000 And Index<1010 Then ShowEducationalSection(Index, 0)
		End Select
		
		WasSection=Settings.GetDefault("alertstatus", 0)
		If WasSection>0 And Not(IsInSettings) And RedAlertEnabled Then
			LCAR.SetRedAlert(True, "HandleBattery")'Activity_KeyPress(84)
			If WasSection = 2 Then LCAR.RedAlertMode = LCAR.Classic_Blue 
		Else If Not(RedAlertEnabled) Then
			LCAR.SetRedAlert(False, "ShowSection")
		End If
	End If 
	AlignLists
End Sub
Sub IsInSettings As Boolean 
	Return LCAR.IsListVisible(0) Or LCAR.IsListVisible(3) Or LCAR.IsListVisible(4)
End Sub






Sub EducationalMode(Enabled As Boolean) '
	If Enabled And Not(Educational.IsInitialized) Then
		If File.Exists(LCAR.DirDefaultExternal, "educational.ini") Then 
			Educational = File.ReadMap(LCAR.DirDefaultExternal, "educational.ini")
		Else
			Educational.Initialize 
		End If
	End If
	MenuSection = API.IIF(Enabled, 6, 0)
	LCAR.Educational=Enabled
	Log("CLEAR LIST 0: EDU")
	LCAR.LCAR_ClearList(0,0)
	ShowModeSelect(17)
End Sub
Sub ShowEducationalSection(Index As Int, SubIndex As Int)
	Dim Items As List, temp As Int , ListID As Int , temp2 As Int, tempstr As String 
	Items.Initialize 
	LCAR.LCAR_HideAll(BG,False)
	If Index <> 1004 Then HideWebview
	Select Case Index
		Case 1001'psionics/sensor meters
			If SubIndex>9 Then Educational.Put("psi.page", Floor(SubIndex/10)*10)
			temp2=Educational.GetDefault("psi.page", 0)
			For temp = 0 To 9
				Items.Add( Educational.GetDefault("psi.p" & (temp+temp2) & ".name", "P" & (temp+temp2)) )
			Next
			SeedSideBar(Items, False , True) 
			LCAR.SeedButtonBar(BG, Array As String("NAME", "PGUP", "PGDN", "PG 0"))
			SetElement18Text("SECTION: " & (temp2/10) & " SUBSECTION: " & (SubIndex Mod 10) & " (" & Items.Get(SubIndex Mod 10) & ")")
			LCAR.SetSelectedItem(LCAR.GetList(19) ,  SubIndex Mod 10)
			ListID=LCAR.LCAR_FindList("Educational")
			If ListID = -1 Then
				'ListID= LCAR.LCAR_AddList("Educational", 0, 1,2,  115,200,  -1 ,-1,  False,  3,LCAR.leftside,  0, True,SensorEnabled,False ,LCAR.LCAR_Meter )'list 2
				ListID = LCAR.LCAR_AddList("Educational", 0, 8,8,     LCAR.GetScaledPosition(3,True)  , LCAR.GetScaledPosition(3,False) , -1,-1, True,  0, 0,0, False, False, False , LCAR.LCAR_Meter)
			End If 
			LCAR.LCAR_ClearList(ListID,0)
			For temp = 1 To 8
				temp2=Educational.GetDefault("psi.p" & SubIndex & ".value" & temp, Rnd(0,100))
				'Log("Item: " & SubIndex & "." & temp & " = " & temp2)
				Educational.Put("psi.p" & SubIndex & ".value" & temp, temp2)
				LCAR.AddChartItem(ListID,LCAR.LCAR_RandomColor,  temp2, -1, "P" & temp,"" )
			Next
			'Log("List items: " & ListID & ": " & LCAR.GetListItemCount(ListID))
			'LCAR.LCAR_HideElement(BG,ListID,True,True, True)
			LCAR.LCAR_SetListStyle(BG, ListID, LCAR.LCAR_Meter, True)
		Case 1002'database
			ShowSettingsSection(-33)
			
		Case 1003'metaphasic
			For temp = 1 To 10
				tempstr=Educational.GetDefault("psi.m" & temp, Rnd(0,1000))
				Educational.Put("psi.m" & temp,tempstr)
				Items.Add(tempstr)
			Next
			SeedSideBar(Items, True,True) 
			'SetElement18Text("I HAVE NO IDEA WHAT THIS IS SUPPOSED TO DO")
			LCARSeffects3.LoadMetaphasicImage(-1, 97)
			LCAR.SeedButtonBar(BG, Array As String("NAME", "RND"))
			LoadEducationalRandom(1,True)
	End Select
End Sub
Sub HandleEducational(Data As ElementClicked)
	Dim SubSection As Int = LCAR.LCAR_GetSelectedItem(19)+1', ListID As Int
	'Select Case Data.EventType	
		'Case LCAR.Event_Down 
			Select Case Data.ElementType 
				Case LCAR.LCAR_List
					If Data.Index2>-1 And Data.Index2 < 8 Then
						Educational.Put("psi.p" & SubSection & ".value" & (Data.Index2+1), Data.Index3)
						LCAR.SetGraphPercent(LCAR.LCAR_FindList("Educational"), Array As Int(Data.Index2, Data.Index3 ) )
						'Log("psi.p" & SubSection & ".value" & Data.Index2 & " = " & Data.Index3)
					End If
			End Select
	'End Select
End Sub
Sub HandleEducationalSidebar(IsButtonList As Boolean, Index As Int)
	Dim SubSection = LCAR.LCAR_GetSelectedItem(19)+1, temp As Int 
	Select Case CurrentSection 
		Case 1001'sensor meters
			SubSection=SubSection-1
			temp=Educational.GetDefault("psi.page", 0)
			If IsButtonList Then 
				If Index=0 Then
					TextPrompt("RENAME", "RENAME THIS PRESET", 20, LCAR.LCAR_GetListItem(19, SubSection).Text, True)
				Else 
					temp = Max(0, temp + API.IIF(Index=1, 10, -10)) 
					If Index = 3 Then temp = 0
					Educational.Put("psi.page", temp)
					ShowEducationalSection(1001, SubSection+temp)
				End If
			Else
				ShowEducationalSection(1001, Index+temp)
			End If
		Case 1002'database
			Select Case Index
				Case 0'Add
					GenerateEducationalHTML(-1)
			End Select
		Case 1003'metaphasic
			If IsButtonList Then
				Select Case Index
					Case 0: TextPrompt("RENAME", "RENAME THIS BUTTON", 20, LCAR.LCAR_GetListItem(19, LCAR.LCAR_SelectedItem).Text, True)
					Case 1: LoadEducationalRandom(SubSection,True)'RND
				End Select
			Else
				LoadEducationalRandom(Index+1, False)
			End If
			'temp = Rnd(0,1000)
			'LCAR.LCAR_SetListitemText(19, Index, temp, "")
			'Educational.Put("psi.m" & SubSection,temp)
		Case 1004'viewing web page
			Select Case Index
				Case 0: ShowEducationalSection(1002,0)'exit
				Case 1: API.SendMediaButton(KeyCodes.KEYCODE_MEDIA_PREVIOUS ) 'prev
				Case 2:	API.SendMediaButton(KeyCodes.KEYCODE_MEDIA_PLAY_PAUSE)'pause
				Case 3: API.SendMediaButton(KeyCodes.KEYCODE_MEDIA_NEXT)'next
			End Select
	End Select
End Sub
Sub LoadEducationalRandom(Section As Int, Randomize As Boolean)
	Dim temp As Int, tempstr As StringBuilder 
	If Randomize Or Not(Educational.ContainsKey("psi.v" & Section)) Then
		tempstr.Initialize 
		For temp = 1 To 40
			tempstr.Append( API.IIF(temp=1, "", " ") & Rnd(0,101))
		Next
		Educational.Put("psi.v" & Section, tempstr.ToString)
	End If
	LCAR.LCAR_SetElementText(97, LCAR.LCAR_IGNORE, Educational.Get("psi.v" & Section))
End Sub
Sub HandleEducationalKeyboard(Text As String)'LCARSeffects.PromptQID 
	Dim SubSection As Int = LCAR.LCAR_GetSelectedItem(19)+1
	Select Case CurrentSection
		Case 1001'sensor meters
			SubSection = SubSection - 1 + Educational.GetDefault("psi.page", 0)
			If Text.Length>0 Then Educational.Put("psi.p" & SubSection & ".name", Text.ToUpperCase)
			ShowEducationalSection(1001, SubSection)
		Case 1003'metaphasic
			Educational.Put("psi.m" & SubSection,Text)
			ShowEducationalSection(1003,0)
		Case 1004'database
			Select Case LCARSeffects.PromptQID 
				Case 20: GetEntryData(False , SettingIndex, "name", Text.ToUpperCase)
				Case 21: GetEntryData(False, SettingIndex, "note", Text.ToUpperCase)
					
				
			End Select
			Log(CurrentSection & " - " & LCARSeffects.PromptQID & " " & SettingIndex & " " & Text)
			GenerateEducationalHTML(SettingIndex)
	End Select
End Sub
Sub HandleEducationalSetting(ListID As Int, Index As Int) As Boolean 
	Dim temp As Int, Items As Int 
	Select Case ListID
		Case -1'seed settings
			SetElement18Text("DATABASE ENTRIES")
			Items=Educational.GetDefault("psi.entries", 0)
			LCAR.LCAR_ClearList(3,0)
			For temp = 0 To Items-1
				SeedSetting( GetEntryData(True, temp, "name", "UNNAMED"), GetEntryData(True, temp, "note", ""), DateTime.Date(GetEntryData(True, temp, "bday", 0)))
			Next

		Case 3'clicked a setting
			LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("EDIT", "DELETE"))
			Return True 
			
		Case 4'clicked a subsetting, uses SettingIndex
			Select Case Index
				Case 0'edit
					GenerateEducationalHTML(SettingIndex)
				Case 1'delete
					DeleteEducationalEntry(SettingIndex)
					HandleEducationalSetting(-1,-1)
			End Select
		
		Case 19'seed sidebar
			SeedSideBar(Array As String("ADD"),  True,True)
		
		Case 1000'seed webview
			CurrentSection=1004
			SeedSideBar( Array As String("EXIT", "PREV", "PAUSE", "NEXT"), False,True)
			
		Case 1001'date picker
			SettingIndex = Educational.Get("current")
			GetEntryData(False , SettingIndex, "bday", WorkingDate)
			GenerateEducationalHTML(SettingIndex)
	End Select
End Sub

Sub GetEntryData(Get As Boolean, Index As Int, Name As String, Default As String) As String 
	If Get Then
		Return Educational.GetDefault("psi." & Name & Index, Default)
	Else
		Educational.Put("psi." & Name & Index, Default)
	End If
End Sub
Sub DeleteEducationalEntry(Index As Int)
	Dim Items As Int =Educational.GetDefault("psi.entries", 0), temp As Int, temp2 As Int , Photos As Int, tempstr() As String = Array As String("name", "bday", "photos", "note", "rate0","rate1","rate2")
	For temp = Index To Items -2 
		For temp2 = 0 To tempstr.Length-1 
			GetEntryData(False, temp, tempstr(temp2), GetEntryData(True, temp+1, tempstr(temp2), ""))
		Next
		Photos = GetEntryData(True, temp, "photos", 0)
		For temp2 = 0 To Photos - 1
			GetEntryData(False, temp, "photo" & temp2, GetEntryData(True, temp+1, "photo" & temp2, ""))
		Next
	Next
	Educational.Put("psi.entries", Items-1)
End Sub
Sub DeleteEducationalPhoto(Index As Int, Photo As Int)
	Dim Photos As Int = GetEntryData(True, Index, "photos", 0), temp As Int' , Filename As String = GetEntryData(True, Index, "photo" & temp, "")
	'If File.Exists(API.GetDir(Filename), API.GetFile(Filename)) Then File.Delete( API.GetDir(Filename), API.GetFile(Filename))
	For temp = Photo To Photos-2
		GetEntryData(False, Index, "photo" & temp, GetEntryData(True, Index, "photo" & (temp+1), ""))
	Next
	GetEntryData(False, Index, "photos", Photos-1)
End Sub
Sub GenerateEducationalHTML(Index As Int)
	Dim Items As Int =Educational.GetDefault("psi.entries", 0), Filename As String = "http://text.com/", tempstr As StringBuilder , Color As String = API.MakeHTMLColor(LCAR.LCAR_Orange), temp As Int 
	If Index=-1 Then'add new entry
		Index=Items
		GetEntryData(False, Items, "name", "UNNAMED")
		GetEntryData(False, Items, "bday", DateTime.Now)
		GetEntryData(False, Items, "photos", 0)
		GetEntryData(False, Items, "note", "[EMPTY]")
		GetEntryData(False, Items, "rate0", Rnd(0,100))
		GetEntryData(False, Items, "rate1", Rnd(0,100))
		GetEntryData(False, Items, "rate2", Rnd(0,100))
		Items=Items+1
		Educational.Put("psi.entries", Items)
	End If
	tempstr.Initialize 
	Educational.Put("current", Index)
	tempstr.Append(API.MakeLCARbutton(LCAR.LCAR_Orange, " HREF=" & Filename & "?name>NAME</A>" , True,  GetEntryData(True, Index, "name", ""), False))
	tempstr.Append(API.MakeLCARbutton(LCAR.LCAR_Orange, " HREF=" & Filename & "?bday>BIRTHDAY: " & DateTime.Date(GetEntryData(True, Index, "bday", "")) & "</A>", True, "AGE: " & API.DateDiff(DateTime.Now, GetEntryData(True, Index, "bday", "")), False))
	tempstr.Append(API.MakeLCARbutton(LCAR.LCAR_Orange, " HREF=" & Filename & "?rate>RATES:</A>", True, GetEntryData(True, Index, "rate0", "") & "|" & GetEntryData(True, Index, "rate1", "") & "|" & GetEntryData(True, Index, "rate2", ""), False))
	
	tempstr.Append(API.MakeLCARbutton(LCAR.LCAR_Orange, " HREF=" & Filename & "?note>NOTE: ", False, "", False) & GetEntryData(True, Index, "note", "") & "</A><P>")
	tempstr.Append(API.MakeLCARbutton(LCAR.LCAR_Orange, " HREF=" & Filename & "?pics>ADD PICTURE (CLICK A PHOTO TO REMOVE IT)</A><BR>", False, "", False))
	
	Items = GetEntryData(True, Index, "photos", 0)
	For temp = 0 To Items-1 
		tempstr.Append( "<A HREF=" & Filename & "?photo" & temp & "><IMG SRC='file://" & GetEntryData(True, Index, "photo" & temp, "") & "' WIDTH=50%></A>" ) 
	Next
	
	tempstr.Append("<P>TIME STAMP: " & DateTime.Now)
	Color = API.MakeHTML(tempstr.ToString)
	If webview1.Visible Then
		WebMode = 0 
		webview1.LoadUrl(Color)
		WebMode = 1000
	Else
		BrowseWeb(Color,1000)
	End If
End Sub
Sub HandleEducationalURL(URL As String)
	Dim Index As Int = SettingIndex
	URL = API.GetSide(URL, "?", False, False).ToLowerCase 
	
	Select Case URL
		Case "name"
			TextPrompt("NAME", "NAME THIS PERSON", 20, GetEntryData(True, Index, URL, ""), False)
			Return
		Case "bday"
			DatePicker(0, GetEntryData(True, Index, URL, ""))
			Return
		Case "rate"
			GetEntryData(False, Index, "rate0", Rnd(0,100))
			GetEntryData(False, Index, "rate1", Rnd(0,100))
			GetEntryData(False, Index, "rate2", Rnd(0,100))
		Case "note"
			TextPrompt("NOTE", "NOTE THIS PERSON", 21,  GetEntryData(True, Index, URL, ""), True)
			Return
		Case "pics"
			Choosecontent("image/*", "CHOOSE AN IMAGE")
			Return
		Case Else
			If URL.StartsWith("photo") Then
				URL = API.Right(URL, URL.Length - 5)
				Log("Delete photo " & URL)
				DeleteEducationalPhoto(Index, URL)
			Else
				Log("Unhandled URL= " & URL)
				Return
			End If
	End Select
	Log("HandleEducationalURL: " & Index & " " & URL)
	GenerateEducationalHTML(Index)
End Sub
Sub HandleEducationalFile(Filename As String)
	Dim Index As Int = SettingIndex, Photos As Int = GetEntryData(True, Index, "photos", 0)
	GetEntryData(False, Index, "photo" & Photos, Filename) 
	GetEntryData(False, Index, "photos", Photos+1)
	GenerateEducationalHTML(Index)
End Sub









Sub PlayWOPRsound(ID As Int)
	Dim tempstr As String 
	'Log(AprilFools & " " & LCAR.CurrentStyle & " " & LCAR.Ferengi)
	If AprilFools And Not(LCAR.SpecialToast) Then 
		If ID<0 Then ID = Rnd(0,3)
		tempstr = "wopr" & API.IIFIndex(ID, Array As String("greetings", "side", "chess", "shallwe", "strange"))  & ".ogg"
		'Log("WOPR: " & tempstr)
		LCAR.PlaySoundFile("", tempstr, False)
	End If
End Sub

'Date: -1=day, -2=month, -3=year, -4=all, anything>-1 brings up the picker
Sub DatePicker(QuestionID As Int, Date As Long) As Long 
	Select Case Date
		Case -1:	Return LCAR.LCAR_GetListitemText(3, 0, 1)'day
		Case -2:	Return LCARSeffects3.GetMonth(LCAR.LCAR_GetListitemText(3, 1, 1))+1'month
		Case -3:	Return (LCAR.LCAR_GetListitemText(3, 2, 1) * 100) + (LCAR.LCAR_GetListitemText(3, 3, 1) * 10) + (LCAR.LCAR_GetListitemText(3, 4, 1))
		Case -4: 	Return API.MakeDate(DatePicker(0,-3),     DatePicker(0, -2),       DatePicker(0,-1),      -1 ,-1,-1,0)
		Case Else
			LCARSeffects.PromptQID = QuestionID
			WorkingDate = Date
			LCAR.LCAR_HideAll(BG,False)
			HideWebview
			ShowSettingsSection(-34)
	End Select
End Sub
Sub HandleDatePicker(QuestionID As Int)
	WorkingDate = DatePicker(0,-4)
	Select Case QuestionID
		Case 0: HandleEducationalSetting(1001,0)'Educational birthday
			
		Case Else
			Log("Unhandled date: " & QuestionID & " " & DateTime.Date(WorkingDate))
	End Select
End Sub


'Image mime = image/*
Sub Choosecontent(Mime As String, Title As String)
	Chooser.Initialize("Chooser")
	Chooser.show(Mime, Title)
End Sub
Sub Chooser_Result(Success As Boolean, Dir As String, FileName As String)
	If Success Then
		FileName = API.GetPathFromContentResult(FileName)
		If FileName.Length>7 And File.Exists(API.GetDir(FileName), API.GetFile(FileName)) Then
			Select Case CurrentSection
				Case 1001,1002,1003,1004,1005: HandleEducationalFile(FileName)
			End Select
		End If
	End If
End Sub


Sub ShowSettingsSection(Index As Int)
	LCAR.Stop("SHOW SET")
	LCAR.LCAR_ClearList(19,0)
	CurrentSettingsSection=Index
	ShowSettings(True, Index<0)
End Sub

Sub WidgetResizer(Index As Int)
	Dim ID As Int = Widgets.CurrentWidget, Width As Int, Height As Int, Element As LCARelement,Increment As Int = 10 ', Cellsize = lcarseffects3.CellSize(
	Width = 300 * LCAR.GetScalemode 
	LCAR.ResizeElement(99, -Width,-Width, Width,Width, -Width,-Width, Width,Width)
	
	If Index >-2 Then 
		Element= LCAR.GetElement(98)
		Width =  Element.Size.currX '+ Element.Size.offX
		Height = Element.Size.curry '+ Element.Size.offY
	End If
	Select Case Index
		Case -2'show
			If ID>-1 Then
				Width = LCARSeffects3.GetWidgetSetting(ID, "Width",320)
				Height= LCARSeffects3.GetWidgetSetting(ID, "Height",320)
				LCAR.ForceShow(99, True)
			End If
		Case -1'enter
			LCAR.ForceHideAll(BG)
			LCARSeffects3.SetWidgetSetting(ID, "Width", Width)
			LCARSeffects3.SetWidgetSetting(ID, "Height", Height)
			ShowSection(41,False)
		Case 0: Height= Max(Height - Increment, 50)'up
		Case 1: Width = Min(Width + Increment,LCAR.ScaleWidth)'right
		Case 2: Height= Min(Height+Increment,LCAR.ScaleHeight)'down
		Case 3: Width = Max(Width-Increment,50)'left
	End Select
	LCAR.IsClean=False
	If Index <> -1 Then
		LCAR.ResizeElement(98,0,0,Width,Height,0,0,Width,Height)
		SetElement18Text(Width & "x" & Height)
		LCAR.ForceShow(98, True)
	End If
End Sub

Sub ShowSection2(Index As Int)
	Select Case Index
		Case 22'personal log
			ShowFrame(True, True)
			LCAR.LCAR_SetElementText(LCARSeffects.FrameElement, API.getstring("log_record"), "")
			SeedSideBar(API.GetStrings("log_side", 0), True,True)
			SeedLogs
	End Select
End Sub


Sub HandleCOMMS(ExtraInfo As String) As Boolean 
	Dim PM As PackageManager, tempintent As Intent 
	'Log("3949")
	LoadSettings(True)
	LCAR.SetRedAlert(False,"HandleCOMMS")
	tempintent = PM.GetApplicationIntent("com.omnicorp.lcarui.dialer")
	If tempintent.IsInitialized Then
		ShowModeSelect(18)
		If ExtraInfo.length >0 Then 
			tempintent.PutExtra("CMD", ExtraInfo)
			ExtraInfo=DateTime.Now
			tempintent.PutExtra("DAT", ExtraInfo)
			Log("LCARS: " & tempintent.ExtrasToString)
		End If
		StartActivity(tempintent)
	Else
		CurrentSettingsSection=-16
		ShowSettings(True,True)
	End If
	
	'tempintent.Initialize(tempintent.ACTION_VIEW, "https://play.google.com/store/apps/developer?id=OmniCorp&hl=en")
	'tempintent.SetComponent("com.android.vending/com.google.android.finsky.activities.MainActivity")
	'StartActivity(tempintent)
End Sub

Sub OpenMarketplace(index As Int, PackageID As String)
	Dim tempintent As Intent' , P As PhoneIntents
	'https://play.google.com/store/apps/details?id=com.omnicorp.lcarui.dialer
	Select Case index
		Case 0'google play
			tempintent.Initialize(tempintent.ACTION_VIEW, "market://details?id=" & PackageID)
		Case 1'apk add on installer
			'tempintent = P.OpenBrowser("http://www.androidpit.com/en/android/market/apps/app/com.omnicorp.lcarui.dialer/LCARS-Dialer")
			ShowSection(71, False)
	End Select
	If tempintent.IsInitialized Then StartActivity(tempintent)
End Sub

Sub HideSubSettings
	If LCAR.IsListVisible(4) Then  LCAR.LCAR_HideElement(BG,4,True,False,True)
	LCAR.LCAR_ClearList(4,0)
	ResizeSetting(5)
End Sub




Sub BruteForceAlarm
	Dim SoundID As Int = 38
	If Not(LCAR.IsPlaying) Then 
		If API.CWA.IsInitialized Then
			If API.CWA.SoundEnabled Then SoundID = API.CWA.SoundID 
			LCAR.Volume(100,False)
			API.SetVolume(True,True, "Brute")
			LCAR.PlaySound(SoundID, True)
			LCAR.DontCancel=True
			Log("BRUTEFORCE " & SoundID)
		End If 
	End If 
End Sub
Sub ShowUFPLogo'SetVolume
	Dim ElementPicture As Int=94, ElementBigText As Int=95, ElementAnswer As Int=96,Y As Int, Height As Int, Y2 As Int=38 ,Text2 As String ="TIME TO WAKE UP", Action As Int 'ElementTopBar As Int=93,
	Dim IsTimer As Boolean = LCAR.IsPlaying And LCAR.WasPlaying = 5
	
	LCAR.ForceHideAll(BG)
	SectionLocked=True
	AwaitingAnswer=True
	CurrentSection=999
	NeedsShowFrame=False
	LCARSeffects.BlockFrame=True
	Try'element 93 to 96 (group 39)
		If webview1.IsInitialized Then webview1.Visible=False
		LCAR.ForceHideAll(BG)
	Catch
		API.ForceMain
	End Try
	
	LCAR.NukeEvents
	LCAR.SetRedAlert(False,"ShowUFPlogo")
	CurrentSection=999
	
	If IsTimer Then 
		Text2 = "TIME IS UP"
		Y2=5
	Else 
		If API.CWA.IsInitialized Then
			If API.CWA.SoundEnabled Then Y2=API.CWA.SoundID 
			If API.CWA.Text.Length>0 Then Text2 = API.CWA.Text
			Action = API.CWA.Action 
			Log("Action: " & Action)
			If Action = 4 Then 'alert
				LCAR.GetElement(51).ElementType = LCAR.LCAR_Alert
				LCAR.GetElement(51).Enabled = False 
				LCAR.ForceShowGroup(15,True)
				SwapMode(51,-3)	
			End If 
		End If
		API.SendPebble(API.GetString("pebble_alert"), Text2)
		LCAR.Stop("UFP")
	End If
	
	API.AllowVolumeAccess=True
		API.SetSpeakerPhone(True)
		LCAR.Volume(100,False)
		API.SetVolume(True,True, "ShowUFP")
		Log("cvol: " & LCAR.cvol)
		LCAR.PlaySound(Y2, True)
		LCAR.DontCancel=True
	API.AllowVolumeAccess=False
	
	If Action <> 4 Then
		Y=LCAR.ItemHeight*2
		Height=Min((LCAR.ScaleHeight-Y) * 0.5, 246* LCAR.ScaleFactor)
		Y=LCAR.ItemHeight + ((LCAR.ScaleHeight-Y)/4-(Height/2))
		LCAR.ForceElementData(ElementPicture,0, Y,   0,0,     -1,Height,     0,0,     0,255,     True,True)
		LCAR.GetElement(ElementPicture).RWidth=1
	
		Y=Y+Height
		Y2=LCAR.ScaleHeight/2
	
		Height =Min( LCAR.GetTextHeight(BG, (Y2-LCAR.ItemHeight*2)/3,  Text2),  LCAR.GetTextHeight(BG, -LCAR.ScaleWidth,  Text2))
		Y=Max(Y,Y2)
		LCAR.ForceElementData(ElementBigText,0,Y,      0,0,     -1, Height,      0,0,      0,255,      True, True)
		LCAR.LCAR_SetElementText(ElementBigText, "", Text2)
	End If 
	
	LCAR.ResetLCARAnswer(ElementAnswer,-1)
	
	LCAR.ForceShowGroup(39,True)
	
	If Action = 4 Then
		'LCAR.ForceHide(ElementBigText)
		LCAR.LCAR_HideElement(BG, ElementBigText, False, False,True)
	Else 
		LCARSeffects2.LoadUniversalBMP("", API.IIF(AprilFools, "mu.png","ufp.png"), LCAR.LCAR_Answer)
		LCARSeffects2.LockUniBMP=True
		LCAR.ForceShow(ElementPicture,True)
	End If 
	
	RequestScreenOrientation(1)
End Sub

Sub Unlocked As Boolean 
	If API.Locked Then HandlePassword("")
	If Not(API.Locked) Then API.PassAttempts =0
	Return Not(API.Locked)
End Sub
Sub HandlePassword(PasswordAttempt As String)As Boolean
	Dim DoPass As Boolean 
	If API.Locked And API.DeadmanPass.Length>0 Then
		VRQuestionID=2
		If PasswordAttempt.Length=0 Then
			API.PassAttempts =0
			If Not (VRListen) Then TextPrompt(API.GetString("password"), API.GetString("pass_prompt"),  11 ,"", True)
		Else If PasswordAttempt.EqualsIgnoreCase(API.DeadmanPass) Then 
			DoPass=True
		Else
			API.PassAttempts = API.PassAttempts+1
			If API.PassAttempts >5 Then
				LCAR.PlaySound(13,True)
				ShowPrompt(API.getstring("error"), API.GetString("pass_toomany"), -1, API.GetString("kb_ok"),"")
			Else
				If Not (VRListen) Then
					ShowModeSelect(19)
					LCAR.ToastMessage(BG, API.GetString("pass_failed"),3)
				End If
			End If
		End If
	Else
		DoPass=True
	End If
	If DoPass Then
		API.Locked =False
		If ModeSelect Then
			ShowModeSelect(20)
		Else
			ShowSection(CurrentSection, False)
		End If
	End If
	VRQuestionID=2
End Sub

Sub HandleAnswer(Answer As Boolean)
	API.IsDeadMan=False
	API.SetSpeakerPhone(False)
	If API.HandleAlarmAnswer(Answer,Settings) Then
		API.AllowVolumeAccess=True
		SectionLocked=False
		API.SetVolume(False,False, "HandleAnswer")
		If Answer Then'wake up
			If API.CWA.Action=3 Then
				API.Locked =True
				API.IsDeadMan=True
				ModeSelect=True
				Unlocked
			Else
				ShowModeSelect(21)
				Log("HandleAnswer")
				GotoSleep
				If API.AlarmIndex>-999 Then ActivityFinish("Answered alarm") 
			End If
		Else'snooze
			ShowModeSelect(22)
			Log("Tried to snooze")
			If API.CWA.Snooze>0 Then ActivityFinish("Snoozed")
		End If
		AwaitingAnswer=True
		Log("awaiting answer")
'	Else
'		CurrentSection=999
'		API.UserEscapedAlarm
	End If
End Sub







Sub PreviewDD(SetBrightness As Boolean)
	'Log("ACTIVATED DD PreviewDD")
	If SetBrightness And Not(DreamService.Bright) Then API.SetScreenBrightness(0.25)
	WallpaperService.DDisrunning=True
	CurrentSection = -998
	PreviewLWP(SaveLWPsetting("DAY", -1,True))
End Sub
Sub PreviewLWPname(Name As String)
	Dim temp As Int, LWPs As List 
	WallpaperService.DDisrunning=False
	'Log("DEACTIVATED DD PreviewLWPname")
	If Name.Length=0 Then
		PreviewLWP(-1)
	Else 
		LWPs = LWPLIST
		temp = LWPs.IndexOf(Name.ToUpperCase)
		Log("PREVIEWING LWP: " & temp & " - " & Name)
		PreviewLWP( LWPs.IndexOf(Name.ToUpperCase) )
	End If
	LCAR.DrawFPS=True
End Sub
Sub PreviewLWP(LWPid As Int)
	If LWPid>-2 Then
		Log("PREVIEWING LWP: " & LWPid)
		HideWebview
		WebMode=-1
		Select Case LWPid
			Case 37:CheckForFile(1, "sysorange.png")'Corridor panel
		End Select
		Select Case LWPid 
			Case 14, 16, 22, 27, 28, 36 'shuttles,ops,conn,transporter, transporter 2
			Case 31, 41:	RequestScreenOrientation(1)'klingon clock (portrait)
			Case Else:		RequestScreenOrientation(0)'landscape
		End Select
		LCAR.DrawFPS=True
		LCAR.LCAR_HideAll(BG,False)
		LCAR.HideToast
		WallpaperService.SettingsLoaded=False
		SaveLWPsetting("PRV", LWPid, False)
		WallpaperService.PreviewMode = True
		WallpaperService.AllowPreview = True 
		LCAR.ForceShow(85, True)
	End If
End Sub

Sub HandleCalc(ListID As Int, ItemID As Int) As Boolean 
	Dim ListItem As LCARlistitem ,temp As Int ,tempstr As String 
	ListItem = LCAR.LCAR_GetListItem(ListID,ItemID)
	Select Case ListID
		Case -1'system
			Select Case ItemID
				Case -2,-1'seed sidebar (-1 = no animation, hide keyboard, -2=animated, show section)
					SeedSideBar(API.GetStrings("calc_side",0), ItemID=-2,True)', "MIC"), True,True)
					LCAR.BypassHardwareKB=True
					If ItemID=-2 Then 
						IsAsking=0
						AcceptOnlyNumbers=False
						LCAR.SelectText("0")'clear initial text box
						LCAR.ToastMessage(BG, API.GetString("calc_warning"),8)
						Eval.RegisterInternals
						Eval.SaveLoadCustomVars(Settings, False)
					End If
					LCAR.ShowTextbox(BG)
					LCAR.LCAR_HideElement(BG, 24,True,True,True)'show the list
					UMRsection=0
					
				Case 0'OK button
					If IsAsking>0 Then
						LCAR.LCAR_HideElement(BG, 24,True, False,True)'hide the calculator
						Select Case IsAsking
							Case 1'variable/settings questions
								'Msgbox(LCAR.GetSelectedText, IsAskingID)
								Eval.SetStackItem(-1, IsAskingID-2, LCAR.GetSelectedText)
								If Eval.VarStack.Size>0 Then
									ShowSection12(12)
								Else
									HandleCalc(19,0)
								End If
							Case 2' Graphing questions
								temp=LCAR.LCAR_GetSelectedItem(26)
								LCAR.LCAR_SetListitemText(26, temp, LCAR.LCAR_GetListItem(26,temp).Text, LCAR.GetSelectedText)
								LCAR.LCAR_HideElement(BG, 26,True, True,True)'show the questions
							Case 3'variable editing
								Select Case IsAskingID
									Case 2: Eval.CurrentVar.name = LCAR.GetSelectedText'name
									Case 5: Eval.CurrentVar.Equation = LCAR.GetSelectedText'equation for a sub
									Case Else: Eval.SetValue(Eval.CurrentVar, IsAskingID-7, LCAR.GetSelectedText)
								End Select
								ShowSection12(13)
							Case 4'parameter
								Select Case IsAskingID
									Case 0:Eval.CurrentPar.name = LCAR.GetSelectedText 'name
									Case 1:Eval.CurrentPar.Default =LCAR.GetSelectedText 'value
									Case 2: Eval.CurrentPar.varTypeS = LCAR.GetSelectedText 'I forget
								End Select
								ShowSection12(14)
						End Select
						IsAsking=0
						AcceptOnlyNumbers=False
					Else
						If AprilFools Then
							Eval.EvalError= ""
							tempstr = "47" 'API.IIFIndex(Rnd(0,2), Array As Int(3,47))
						Else
							tempstr= Eval.Val( LCAR.GetSelectedText )
						End If
						If Eval.EvalError.Length >0 Then 
							tempstr = Eval.EvalError & ": " & Eval.EvalMoreData
							LCAR.PlaySound(31,False)
						Else If Eval.HelpText.Length=0 Then
							LCAR.PlaySound(30,False)
							LCAR.LCAR_AddListItem(25, LCAR.GetSelectedText, LCAR.LCAR_Random, LCAR.GetListItemCount(25),  "" , False, tempstr.ToUpperCase , 0 , False, -1)
						Else If Not(AprilFools) Then
							ShowPrompt(API.getstring("help") & Eval.helptopic, Eval.HelpText.ToUpperCase, 8, API.GetString("kb_ok"), "")
						End If
						LCAR.ToastMessage(BG, tempstr,4)
					End If
				Case 1'show keyboard
					UMRsection=1
			End Select
		Case 19'sidebar
			'hide everything
			'LCAR.LCAR_HideElement(BG,19, True,True,True)
			LCAR.HideToast'("HandleCalc_sidebar")
			UMRsection=ItemID
			LCAR.LCAR_HideElement(BG, 3,True, False,True)'hide the settings
			LCAR.LCAR_HideElement(BG, 4,True, False,True)'hide the sub-settings
			LCAR.LCAR_HideElement(BG, 24,True, False,True)'hide the calculator
			LCAR.LCAR_HideElement(BG, 25,True, False,True)'hide the answers
			LCAR.LCAR_HideElement(BG, 26,True, False,True)'hide the questions
			LCAR.ForceHide(84)'hide the graph
			LCAR.HideGroup(33,False,False)
			If LCAR.IsKeyboardVisible(Null,0,False) Then LCAR.HideKeyboard(BG,10)'hide keyboard
			Select Case ItemID
				Case 0'number entry
					HandleCalc(-1,-1)
				Case 1'text entry
					If AcceptOnlyNumbers Then
						HandleCalc(-1,-1)
					Else
						LCAR.LCAR_HideElement(BG,19, True,False,True)
						LCAR.ShowKeyboard(BG,10)
						LCAR.SymbolsEnabled=True
					End If
				Case 2'variables
					CurrentSettingsSection=-11
					ShowSettings(False,True)
				Case 3'answer list
					LCAR.LCAR_HideElement(BG, 25,True, True,True)'show the answers
				Case 4'graphing
'					If IsAsking <2 Then
'						LCAR.LCAR_ClearList(26,0)
'						LCAR.LCAR_AddListItem(26, "Y", LCAR.lcar_random, -1, "", False, "X^2", 0, False, -1)
'						LCAR.LCAR_AddListItem(26, "INCREMENT", LCAR.lcar_random, -1, "", False, "1", 0, False, -1)
'						LCAR.LCAR_AddListItem(26, "START X", LCAR.lcar_random, -1, "", False, "0", 0, False, -1)
'						LCAR.LCAR_AddListItem(26, "FINISH X", LCAR.lcar_random, -1, "", False, "10", 0, False, -1)
'						LCAR.LCAR_AddListItem(26, "VIEW", LCAR.lcar_random, -1, "VIEW", False, "", 0, False, -1)					
'						LCAR.LCAR_HideElement(BG, 26,True, True,True)'show the questions
'					End If
					LCAR.LCAR_HideElement(BG, 26,True, True,True)'show the questions
			End Select
		Case 24'mininumboard
			' Array As String("\", "7", "4", "1", "0", "<ı", "/", "8", "5", "2", ".", "BKSP", "*", "9", "6", "3", "(", "CLR", "-", "+", "!", "=", ")", "DEL", "^", "|", "<", ">", "OK", "ı>")
			LCAR.HideToast'("HandleCalc_mininumboard")
			LCAR.LCAR_HideElement(BG, 18,False,False,True)
			If ListItem.Text = "OK" Then
				If CurrentSection = 24 Then'calc
					HandleCalc(-1,0)
				Else
					HandleSettings(0,0)
				End If
			Else
				temp = API.GetKeyCode(ListItem.Text,False, False)
				If AcceptOnlyNumbers Then
					Select Case ListItem.Text
						Case "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", API.GetString("kb_ok"), "ı>", API.GetString("kb_delete"), API.GetString("kb_backspace"), API.GetString("kb_clr"), "<ı"
						Case ".":  If LCAR.GetSelectedText.Contains(".") Or NoDecimals Then Return False
						Case "-":  If LCAR.GetSelectedText.Contains("-") Then Return False
						Case Else: Return False
					End Select
				End If
				LCAR.HandleKeyboard( temp )
			End If
		Case 25'answers
			If ItemID=0 Then
				LCAR.LCAR_ClearList(25,1)
			Else
				LCAR.selecttext( LCAR.LCAR_GetListItem(25, ItemID).Side )
			End If
		Case 26
			If ItemID <> 4 Then LCAR.LCAR_HideElement(BG, 26,True, False,True)'hide the questions
			If ItemID < 4 Then
				AskQuestion(2,ItemID,ItemID>0)
			Else 'view
				Select Case ItemID
					Case 4: ToggleShape					
					Case 5:	GenerateGraph(2)
				End Select
			End If
	End Select
End Sub
Sub ToggleShape
	Dim Element As LCARlistitem 
	Element = LCAR.LCAR_GetListItem(26,4)
	Element.Tag = 1- Element.Tag 
	Element.Side = API.IIFIndex(Element.Tag, Eval.EnumStrings(-8))
	Element.IsClean=False
	LCAR.SetGraphStyle(84, API.IIFIndex(Element.Tag, Array As Int( 1, 3 )), -1,-1)
End Sub

Sub AskQuestion(QuestionID As Int, ItemID As Int, OnlyNumbers As Boolean)
	Dim Default As String 
	AcceptOnlyNumbers=OnlyNumbers
	NoDecimals=False
	Select Case QuestionID
		Case 1'settings
			LCAR.LCAR_HideElement(BG, 3,True, False,True)'hide the settings
			LCAR.LCAR_HideElement(BG, 4,True, False,True)'hide the sub-settings
			Default = LCAR.LCAR_GetListItem(3, ItemID).side
		Case 2 ' Graphing questions
			Default = LCAR.LCAR_GetListItem(26, ItemID).Side
			If ItemID=0 Then
				If Default.Length =0 Then Default = LCAR.GetSelectedText
			Else
				NoDecimals=True
			End If
		Case 3' variable editor
			Select Case ItemID
				Case 2:	Default = Eval.CurrentVar.name
				Case 5: Default = Eval.CurrentVar.Equation 
				Case Else: Default = Eval.Currentvar.Values.Get(ItemID-7)
			End Select
		Case 4'parameter editor
			Select Case ItemID
				Case 0:	Default = Eval.CurrentPar.name
				Case 1: Default = Eval.CurrentPar.Default 
				Case 2: Default = Eval.CurrentPar.varTypeS
			End Select
	End Select
	IsAsking= QuestionID
	IsAskingID = ItemID
	LCAR.SelectText(Default)
	If OnlyNumbers Then
		HandleCalc(19,0)
	Else
		HandleCalc(19,1)
	End If
End Sub
Sub GenerateGraph(GraphID As Int)
	Dim Equation As String,Inc As String , Start As String, Finish As String 
	Dim Bottom As Double, BottomSet As Boolean , Top As Double, TopSet As Boolean 
	Dim temp As Int,temp2 As Int, Current As String , Values As List , tempGraph As Graph 
	
	Equation= LCAR.LCAR_GetListItem(26, 0).Side
	Inc= LCAR.LCAR_GetListItem(26, 1).Side
	Start= LCAR.LCAR_GetListItem(26, 2).Side
	Finish= LCAR.LCAR_GetListItem(26, 3).Side
	LCAR.SelectText("Y=" & Equation)
	
	Values.Initialize 
	Eval.EvalError = ""
	Eval.EvalMoreData = ""
	If Equation.ToUpperCase.Contains("X") Then
		If Not(IsNumber(Inc)) Then Inc = 1
		If IsNumber(Start) And IsNumber(Finish) Then
			If Start<Finish And Inc>0 Or Start>Finish And Inc<0 Then
				For temp = Start To Finish Step Inc
					If Eval.EvalError.Length=0 Then
						Eval.SetVariable("X",0,False,0, temp, False)
						Current= Eval.Val(Equation)
						If IsNumber(Current) Then
							Values.Add(Current)
							If Not(BottomSet) Or Current<Bottom Then 
								Bottom=Current
								BottomSet=True
							End If
							If Not(TopSet) Or Current>Top Then 
								Top=Current
								TopSet=True
							End If
						Else If Eval.EvalError.Length=0 Then
							Eval.EvalError = API.getstring("calc_nan")
							Eval.EvalMoreData = "X=" & temp & ", " & Equation & "=" & Current
						End If
					Else
						Exit
					End If
				Next
			Else If Eval.EvalError.Length=0 Then
				Eval.EvalError = API.getstring("calc_nodata")
			End If
		Else If Eval.EvalError.Length=0 Then
			Eval.EvalError = API.getstring("calc_startend_nan")
			Eval.EvalMoreData = "Start=" & Start & ", Finish=" & Finish
		End If
	Else If Eval.EvalError.Length=0 Then
		Eval.EvalError = API.getstring("calc_x_not_found")
		Eval.EvalMoreData = Equation
	End If
	If Top<=Bottom Or Not(BottomSet) Or Not(TopSet) Or Values.Size<2 Then Eval.EvalError =  API.getstring("calc_nodata")
	
	If Eval.EvalError.Length=0 Then
		temp=LCARSeffects2.FindGraph(GraphID)
		LCARSeffects2.ClearGraph(temp)
		tempGraph=LCARSeffects2.GetGraph(temp)
		tempGraph.MaxPoints= Values.Size 
		For temp2 = 0 To Values.Size -1
			LCARSeffects2.AddPoint(temp, NormalizePoint(Bottom,Top, Values.Get(temp2)))
		Next
		LCAR.ForceShow(84,True)
	Else
		LCAR.ToastMessage(BG, Eval.EvalError.ToUpperCase & CRLF & Eval.EvalMoreData.ToUpperCase, 4)
	End If
End Sub
Sub NormalizePoint(Bottom As Double, Top As Double, Value As Double) As Int 
	'normalized from 0 to 100
	Return (Value-Bottom) / (Top - Bottom) * 100
End Sub

Sub SeedLogs
	Dim temp As Int , Files As List,tempstr As String ', LCARL As LCARlist,HasRenamed As Boolean = Settings.GetDefault("HasRenamed", False)
	LCAR.LCAR_ClearList(23,0)
	'LCARL = LCAR.GetList(23)
	'If LCARL.ListItems.Size = 0 Then
		Files= File.ListFiles(LCAR.DirDefaultExternal)
		If Files.IsInitialized Then
			For temp = 0 To Files.Size-1
				tempstr= Files.Get(temp)
				If Not(File.IsDirectory(LCAR.DirDefaultExternal,tempstr)) Then
					If tempstr.ToLowerCase.EndsWith(".mp3") Then
						If File.Size(LCAR.DirDefaultExternal, tempstr) =0 Then
							File.Delete(LCAR.DirDefaultExternal, tempstr)
						Else
'							If Not(HasRenamed) Then'LCARSeffects.UniqueFilename(LCAR.DirDefaultExternal, "LOG.mp3", "DATETIME")
'								tempstr = API.Left(tempstr, tempstr.Length - 7) & ".mp3"
'								Log("Rename: " & Files.Get(temp) & " to " & tempstr)
'								API.RenameFile(LCAR.DirDefaultExternal, Files.Get(temp),LCAR.DirDefaultExternal,tempstr)
'							End If
							AddLog(tempstr,0,"")
						End If
					End If
				End If
			Next
		End If
	'End If
	'Settings.put("HasRenamed", True)
	LCAR.LCAR_HideElement(BG, 23,True,True, True)
End Sub
Sub AddLog(Filename As String, Operation As Int, NewName As String )
	'XXXXX (length-24 chars chars), space, date (10 chars) space, time (8 chars), .mp3 (4 chars)
	Dim Item As LCARlistitem,tempstr As String  ,tempstr2 As String 
	Select Case Operation
		Case -2'clicked
			'SetElement18Text(Filename & " WAS RECORDED AT: " & LCAR.Stardate(-2, File.LastModified(LCAR.DirDefaultExternal,Filename), False, 1))
			SetElement18Text( API.GetStringVars("log_date", Array As String(Filename, LCAR.Stardate(-2, File.LastModified(LCAR.DirDefaultExternal,Filename), False, 1))))
		
		Case -1
			If NewName.Length>0 Then
				File.WriteString(LCAR.DirDefaultExternal, API.Left(Filename, Filename.length-3) & "txt", NewName)
				LCAR.ToastMessage(BG, API.getstring("log_subs"), 2)
				Subtitles.Initialize 
			End If
		Case 0'add to list
			If Filename.Length>4 And Not(Filename.Contains("_")) Then
				LCAR.LCAR_AddListItem(23, API.Left(Filename, Filename.Length-4).ToUpperCase , LCAR.LCAR_Random, -1, Filename, False, LCAR.Stardate(-2, File.LastModified(LCAR.DirDefaultExternal,Filename), False, 1) , 0,False,-1)
			End If
		Case 1'rename using newname
			LCAR.Stop("ADDLOG")
			Item = LCAR.LCAR_GetListItem(23, LCAR.LCAR_GetSelectedItem(23) )'LCAR.LCAR_FindListItem(23, Filename, 2,False,-1))
			NewName.Replace("_"," ")
			tempstr = NewName &  ".mp3" ' " " & Item.Side &
			If API.RenameFile(LCAR.DirDefaultExternal,Item.Tag,LCAR.DirDefaultExternal,tempstr) Then
				tempstr2 = API.Left(Item.Tag, Item.Tag.length-3) & "txt"
				API.RenameFile(LCAR.DirDefaultExternal, tempstr2, LCAR.DirDefaultExternal, NewName & " " & Item.Side & ".txt")'rename log				
				Item.Text=NewName
				Item.Tag=tempstr
				Item.IsClean=False
			Else
				LCAR.ToastMessage(BG, API.getstring("log_failed"), 3)
			End If
		Case 2'delete
			LCAR.Stop("DELLOG")
			tempstr = API.Left(Filename, Filename.length-3) & ".txt"
			File.Delete(LCAR.DirDefaultExternal, Filename)
			File.Delete(LCAR.DirDefaultExternal, tempstr)'delete log
			LCAR.LCAR_FindListItem(23, Filename, 2,True,-1)
	End Select
End Sub

Sub ShowRandomNumbers(Text As String)
	LCAR.forceshow(82,True)
	LCAR.LCAR_SetElementText(82, Text, "")
End Sub
Sub PlayScienceSound
	LCAR.PlaySound(API.iif(LCAR.RedAlert ,29 ,28),True)
End Sub






Sub LoadGPlusFeed(Index As Int)
	Dim temp As LCARlistitem 
	temp=LCAR.LCAR_GetListItem(22, Index)
	If temp.tag.Length>1 Then
		'LCAR.LCAR_AddLCAR("Feeds", 0,(temp+5)*3,0, temp,50,0,0, LCAR.LCAR_Yellow, LCAR.ENT_Button ,  "LCARS UI", "LIST", "", 21,False, 0, True, 0,0)' element 75 (group 21)
		LCAR.LCAR_SetElementText(75, temp.Text.ToUpperCase , API.GetString("gplus_list"))
		PlusID = temp.Tag 
		GPlus.Clear 
		DownloadGPlusFeed
	Else
		AddSocialMediaFeeds(22, temp.Tag)
	End If
End Sub
Sub DownloadGPlusFeed 
	LCAR.LCAR_SetElementText(66, API.GetString("loading"), API.GetString("back"))' lcarseffects2.RandomENT , 
	API.Download("plus", GPlus.PostsURL(PlusID, ""))
End Sub






Sub HandleEvents(Interval As Int) '
	Dim Event As ElementClicked,temp As Int 
	If Not( MultiCore) And Interval>-1 Then DrawScreen(Interval)
	If LCAR.EventList.Size>0 And Not(LCAR.Locked)  Then
		Do Until LCAR.EventList.Size=0
			Event = LCAR.EventList.Get(0)
			LCAR.EventList.RemoveAt(0)			
			Select Case Event.EventType 
				Case LCAR.LCAR_PdP
					Select Case Event.ElementType
						Case Games.PDP_ScoreMade
							Select Case Event.Index2 
								Case Games.PDP_Chain 
									LCAR.ToastMessage(BG, API.getstringvars("mem_chain", Array As String(Event.X)) , 1)
								Case Games.PDP_Combo'combo
									LCAR.ToastMessage(BG, API.getstringvars("mem_combo", Array As String(Event.X)) , 1)
							End Select
						Case Games.PdP_GameOver
							Select Case Games.PdPMode
								Case Games.PdP_Puzzle 
									If Games.PdP_Level=0 Then 
										SeedSideBar(Array As String(API.getstring("auto_side0"), API.getstring("back")), False,True)
									Else
										Games.PDPClearUndo
										If Event.Index2 = Games.YouWon Then 
											If Games.PdP_Level>0 And Games.PdP_Level< Games.PDP_CustomLevel Then HandleSetting("PdP" & Games.PdP_Level & "-" & Games.PdP_SubLevel , True,True, True)
											SeedSideBar(Array As String(API.getstring("next"), API.getstring("back")), False,True)
										Else
											SeedSideBar(Array As String(API.getstring("mem_retry"), API.getstring("back")), False,True)
										End If
									End If
								Case Else
									SeedSideBar(Array As String(API.getstring("back")), False,True)
							End Select
						Case Games.PdP_Rumble 
							LCAR.Rumble(1)
						Case Games.PDP_Paused
							LCAR.Stop("PAUSE")
							If Event.Index2=1 Then'paused 
								Select Case Games.PdPMode
									Case Games.PdP_Edit
										SeedSideBar(Array As String(API.getstring("back"), API.getstring("calc_clear")), False,True)
									Case Games.PdP_Puzzle 
										SeedSideBar(Array As String(API.getstring("back"), API.getstring("mem_retry"), API.getstring("mem_undo")), False,True)
									Case Else
										SeedSideBar(Array As String(API.getstring("back")), False,True)
								End Select
							Else
								Select Case Games.PdPMode 
									Case Games.PdP_Edit	
										PuzzleSidebar
									Case Else
										HideSideBar
										ShowGameBoard
								End Select
								
							End If
					End Select
				
				Case LCAR.Event_Other 
					Select Case Event.ElementType
						Case LCAR.LCAR_ThreeDGame
							SendText("game " & Event.Index2 & " " & Event.X & " " & Event.Y & " " & Event.X2 & " " & Event.Y2)
					End Select
				
				Case LCAR.Event_Move
					Select Case Event.ElementType
						Case LCAR.LCAR_List 
							'Log("MOVED TO: " &  Event.X & "," & Event.Y &  " FROM: "  & Event.X2 & "," & Event.Y2)
							Select Case Event.Index
								Case LCAR.KBListID
									If Event.X < Event.X2 Then 'left 
										LCAR.HandleKeyboard(KeyCodes.KEYCODE_DPAD_LEFT)
									else if Event.X > Event.X2 Then 'right 
										LCAR.HandleKeyboard(KeyCodes.KEYCODE_DPAD_RIGHT)
									End If
							End Select
						Case LCAR.LCAR_SensorGrid	
							Select Case Event.Index 
								Case 52
									MouseStage=2
									SendText("mouse " & Event.X2 & " " & Event.Y2)
							End Select
						Case LCAR.LCAR_Slider 
							If  Event.Y2>0 Then 
								SendText("mouse scroll 1")
							Else If Event.Y2<0 Then
								SendText("mouse scroll -1")
							End If
					End Select
				Case LCAR.Event_Scroll 
					Select Case Event.ElementType 
						Case LCAR.TMP_Reliant
							Games.BMN_HandleAnswer(BG,-1, Event.Index2)
					End Select
					
				Case LCAR.Event_Down 
					Select Case Event.ElementType
						Case LCAR.SYS_System
							Select Case Event.Index
								Case 0: ShowSection(Event.index2,False)
								Case 1: 
									ActivityFinish("Sys event closed activity")
								Case 2: VRListen
								Case 3:'playsound
									LCAR.Stop("EVNT SND") 
									LCAR.PlaySound(Event.index2,False)
							End Select
						
						Case LCAR.LCAR_ToastDone
							LCAR.PullNextToast(BG)
						Case LCAR.LCAR_HardwareBTN 
							'If Not( LCAR.LCAR_DpadList(LCAR.VisibleList,  Event.Index))  Then
							'If lcar.IsKeyboardVisible(BG,-1,False) Then
								'lcar.LCAR_DpadList(lcar.KBListID,  event.Index)
							'Else If lcar.IsNumboardVisible Then
								'lcar.LCAR_DpadList(lcar.NumListID,  event.Index)
							'Else
							If CurrentSection <> 7 And IsSidebarVisble And (Event.Index=6 Or Event.Index=7) Then
								LCAR.LCAR_DpadList(19, API.IIF(Event.Index=6, 0,2))
								LCAR.LCAR_DpadList(19, -1)
							Else if LCAR.IsListVisible(ButtonMenu) Then 
								LCAR.LCAR_DpadList(ButtonMenu,  Event.Index)	
							Else 
								If WallpaperService.AllowPreview And (Event.Index = 1 Or Event.Index = 3) Then'right is 1, left is 3
									temp=API.IIF(Event.Index = 1, -20,20)
									CallSubDelayed3(WallpaperService, "BypassScroll", 85, temp )
								End If
								
								'If LCAR.IsListVisible(LCAR.ButtonList) Then 
								'LCAR.LCAR_DpadList
								'If LCAR.VisibleList <> LCAR.ButtonList Then  
								If LCAR.LCAR_DpadList(4, Event.Index) Then
									If Event.Index = -1 Then HideSubSettings
								Else If Not( LCAR.LCAR_DpadList(3, Event.Index)) Then
									Select Case CurrentSection 
										Case 0,1,3,6'0=intro, 1=wifi chart, 3=sensor meters, 6=navigation scan
										Case -1'main menu
											If Event.Index =-1 Then
												'If IsNotDropdown Then
												LCAR.pushevent(LCAR.LCAR_Button, LCARSeffects.FrameElement+11,   0,0,0,0,0, LCAR.Event_up ) 
												'LCAR.pushevent(LCAR.LCAR_Button, LCARSeffects.FrameElement+11,   0,0,0,0,0, LCAR.Event_up ) 'double click
											Else
												LCAR.LCAR_DpadList(0,  Event.Index)		
											End If
										Case 2:	LCAR.LCAR_DpadList(17,  Event.Index)'sensor list
										Case 4:	If Not(LCAR.LCAR_DpadList(5,  Event.Index)) And Event.Index = -1 Then ShowTimer(False) 'timer
										Case 5:	LCAR.LCAR_DpadList(16,  Event.Index)'history
										Case 7: LCAR.LCAR_DpadList(LCAR.VisibleList,  Event.Index)'umr
										Case 8:	LCAR.LCAR_DpadList(9,  Event.Index)'tactical
										Case 9: LCAR.PushEvent(LCAR.LCAR_Dpad,  49, 0,0,0,0, Event.Index , LCAR.Event_up )'okudagram
										Case 10: If Event.Index =-1 Then LCAR.pushevent(LCAR.LCAR_Alert , 51,   0,0,0,0,0, LCAR.Event_up )  'alert status
										Case 16: Games.TRI_HandleMouse(Event.Index, 0, LCAR.LCAR_Dpad)'angry tribbles
										Case 17'PdP
											If Not(Games.PDPHandleMouse(Event.Index, 0, LCAR.LCAR_Dpad, Event.Index2)) Then LCAR.LCAR_DpadList(19,  Event.Index)'context menu
										Case 21 'PToE
											LCARSeffects2.PToEHandleMouse(Event.Index,0, LCAR.LCAR_Dpad)
											LCAR.dirtyelement(83)
										Case 50: LCARSeffects4.SOL_HandleMouse(Event.Index, 0, LCAR.LCAR_Dpad, 0,0)'solar system
										Case 55: Wireframe.HandleMouse(Event.Index, LCAR.LCAR_Dpad, 0,0)'wireframe
										Case 85: Games.DrP_HandleMouse(113, Event.Index, 0, LCAR.LCAR_Dpad, 0,0)'dr pulaski
										Case Else'settings
											Select Case CurrentSection 
												Case 49'3d minesweeper/checkers/chess/tic tac toe
													If LCAR.IsElementVisible( Games.ThreeD_ElementID ) Then
														Games.ThD_HandleMouse(Event.Index, Event.Index2, LCAR.LCAR_Dpad) 
													End If
												Case 72'card games
													If LCAR.IsElementVisible(Games.CARD_ElementID) Then
														If Not(Games.CARD_HandleMouse(Event.Index, Event.Index2, LCAR.LCAR_Dpad,0,0)) Then Return 
													End If
											End Select
											'Log("DPAD LIST: " & LCAR.VisibleList)
											LCAR.LCAR_DpadList(LCAR.VisibleList, Event.Index)
									End Select
								End If
							End If
							'End If
						Case LCAR.LCAR_SensorGrid	
							Select Case Event.Index 
								Case 52
									MouseStage=1
							End Select
						
						Case LCAR.SYS_Lightpack
							LightpackEvent(Event.Index, Event.Index2, Event.X,Event.Y, Event.X2 )
						
						Case LCAR.EVENT_Horizon
							Select Case Event.Index'0=select, 1=time, 2=arm, 3=disarm, 4=disable, 5=release
								Case 0,1'download image
									If Not(LCARSeffects4.EH_Better) Then
										API.Download("MSD", "http://sites.google.com/site/programalpha11/home/" & API.IIF(Event.Index = 0, "lcars", "pictures") & "/syseventhor.png")
									End If
								Case 3: BelayTimer'disarm
							End Select
						
						Case LCAR.LCAR_Answer
							BruteForceAlarm
					End Select
			
				Case LCAR.Event_up 
					Select Case Event.ElementType
						Case LCAR.LCAR_OK'button on keyboard
							Select Case CurrentSection
								Case -2
									RenameStarship
								Case 5
									Searchfor( LCAR.GetSelectedText) ' LCAR.LCAR_GetElement(LCAR.KBCancelID+5).Text)
								Case 7
									SendText("sendtext " & LCAR.GetSelectedText) '
								Case 24'calculator
									HandleCalc(-1,0)
									
								Case Else
									If LCARSeffects.IsPromptVisible(Null) Or LCARSeffects.QuestionAsked Then  
										LCAR.PushEvent(LCAR.LCAR_Button, LCARSeffects.PromptID+6, 0,0,0,0,0,LCAR.Event_up )
										'Select Case LCARSeffects.PromptQID 'ShowSettings(True,True) 10
									End If
							End Select
					
							
						Case LCAR.LCAR_Keyboard'show=1/hide=-1
							'If Event.Index = 1 AND LCAR.IsListVisible(19) Then HideSideBar
							'If Not(LCARSeffects.IsPromptVisible(BG)) Then
								LCAR.forceshow(18, Event.Index=-1 )
								LCARSeffects.ResizeLeftBar(Event.Index, Event.Index2)
							'End If
							Select Case CurrentSection
								Case 5'memory alpha
									If LCAR.SmallScreen Then webview1.Visible = (Event.Index=-1)
									MoveWebview
									If Event.Index=-1 Then 
										ShowWebMenu(False)
									Else
										LCAR.HideSideBar(BG,-1,0)
									End If
								Case 7'UMR
									If Event.Index = -1 Then  ShowUMRMenu(-1)' LCAR.LCAR_HideElement(BG,12,True,True,False) ShowSection(7,False)'
								Case -2'Settings (Starship name prompt)
									If Event.Index = -1 Then ShowSettings(True,False)
								Case 24'calculator
									HandleCalc(-1,Event.Index)
								Case 22
									If Event.Index = -1 And Not(LCAR.clickedok) Then  ShowSection(22,False)
								Case 32
									If Event.Index = -1 Then ShowSettings(True,True)
								
								'Case 1001
									'If Event.Index = -1 Then HandleEducationalKeyboard(LCAR.GetSelectedText)
								
								Case 10000'Launcher
									If Event.Index = -1  And Not(LCAR.clickedok) Then 
										ShowModeSelect(23)
										API.BroadcastToLauncher("keyboard","")
									End If
							End Select
							
						
						Case LCAR.LCAR_SensorChanged
							'lcar.SetSensorXY(5, event.X ,event.Y)
							Select Case Event.Index 
								Case 0'MICROPHONE		1 Axis
									'lcar.SetGraphPercent(2, Array As Int( 4, event.X) )
									SetSensorData(API.getstring("snsr_mic"), Event.X)
									SetSensorData2(5,Event.X, 0, 0, False)
									LCARSeffects2.SetSensorData(0, Event.X)
								Case 1'ACCELEROMETER	3 axes
									SetSensorData(API.getstring("snsr_acc") & " X",  Event.X)
									SetSensorData(API.getstring("snsr_acc") & " Y",  Event.y)
									SetSensorData(API.getstring("snsr_acc") & " Z",  Event.X2)
									SetSensorData2(1,Event.X, Event.y, Event.X2, True)
									LCARSeffects2.SetSensorData(1, Event.X)
									LCARSeffects2.SetSensorData(2, Event.y)
									LCARSeffects2.SetSensorData(3, Event.X2)
								Case 2'MAGNETIC			3 axes
									'lcar.SetGraphPercent(2, Array As Int( 1, event.X,2, event.Y, 3,event.x2) )
									SetSensorData(API.getstring("snsr_mag") & " X",  Event.X)
									SetSensorData(API.getstring("snsr_mag") & " Y",  Event.y)
									SetSensorData(API.getstring("snsr_mag") & " Z",  Event.X2)
									SetSensorData2(2,Event.X, Event.y, Event.X2,True)
									LCARSeffects2.SetSensorData(4, Event.X)
									LCARSeffects2.SetSensorData(5, Event.y)
									LCARSeffects2.SetSensorData(6, Event.X2)
									
									temp=TotalMagneticField(Event.X,Event.Y,Event.X2)
									If temp>TMF Then TMF=temp
									LCAR.PushEvent(LCAR.LCAR_SensorChanged, 11, 0, (temp/TMF) * 100, 0,0, 0,0)

								Case 3'ORIENTATION		3 axes
									'event.x should point to magnetic north
									'lcar.SetSensorXY(5, event.X,event.Y ,True)
									'lcar.SetSensorXY(5, findXY(50,50,50,event.y2,True), findXY(50,50,50,event.y2,False) ,False)
									'Log("ANGLE: " & event.X & " XY " &  findXY(50,50,25,event.X,True) & ", " & findXY(50,50,25,event.X,False))
									'Log(Event.X & ", " & Event.X2 & ", " & Event.Y & ", " & Event.Y2)
									If 	SetSensorData(API.getstring("snsr_com") & " X",  Event.X) Then
										SetSensorData(API.getstring("snsr_com") & " Y",  Event.y)
									Else If Not( SetSensorData2(3,Event.X, Event.y, Event.X2,True) ) Then
										LCAR.IncrementSensorX(27,  Event.y2,  Event.y)'LCAR.IncrementSensorX(27,  Event.X, Event.y)
										LCARSeffects.GPSAzimuth = Event.y2
										UpdateGPS
									End If
									LCARSeffects2.SetSensorData(7, Event.X)
									LCARSeffects2.SetSensorData(8, Event.y)
									LCARSeffects2.SetSensorData(9, Event.x2)
								Case 4'GYROSCOPE		3 axes
									'lcar.SetGraphPercent(2, Array As Int( 5, event.X,6, event.Y, 7,event.x2) )
									SetSensorData(API.getstring("snsr_gyr") & " X",  Event.X)
									SetSensorData(API.getstring("snsr_gyr") & " Y",  Event.y)
									SetSensorData(API.getstring("snsr_gyr") & " Z",  Event.X2)
									SetSensorData2(4,Event.X, Event.y, Event.X2,True)
									LCARSeffects2.SetSensorData(10, Event.X)
									LCARSeffects2.SetSensorData(11, Event.y)
									LCARSeffects2.SetSensorData(12, Event.X2)
								Case 5'LIGHT			1 axis
									'lcar.SetGraphPercent(2, Array As Int( 0, event.X) )
									SetSensorData(API.GetString("snsr_lit"),  Event.X)
									SetSensorData2(6,Event.X, 0, 0, False)
									LCARSeffects2.SetSensorData(13, Event.X)
								Case 6'PRESSURE		NOT SUPPORTED
									SetSensorData(API.GetString("snsr_prs"),  Event.X)
									SetSensorData2(7,Event.X, 0, 0, False)
									LCARSeffects2.SetSensorData(14, Event.X)
								Case 7'TEMPERATURE		NOT SUPPORTED
									SetSensorData(API.GetString("snsr_tem"),  Event.X)
									SetSensorData2(8,Event.X, 0, 0, False)
									LCARSeffects2.SetSensorData(15, Event.X)
								Case 8'PROXIMITY		NOT SUPPORTED
									SetSensorData(API.GetString("snsr_prx"),  Event.X)
									SetSensorData2(9,Event.X, 0, 0, False)
									LCARSeffects2.SetSensorData(16, Event.X)
									
								Case 9'Battery
									SetSensorData(API.GetString("snsr_bat"),  Event.X)
									SetSensorData2(10,Event.X, 0, 0, False)
									LCARSeffects2.SetSensorData(17, Event.X)
									
								Case 10'Medical Insurance Remaining
									SetSensorData(API.GetString("snsr_mir"),  Event.X)
									SetSensorData2(11,Event.X, 0, 0, False)
									LCARSeffects2.SetSensorData(19, Event.X)
									
								Case 11'total magnetic field
									SetSensorData(API.GetString("snsr_tmf"),  Event.X)
									SetSensorData2(12,  Event.X, 0,0,False)
									LCARSeffects2.SetSensorData(18, Event.X)
							End Select
							
						Case LCAR.LCAR_StoppedPlaying
							'Log("LCAR_StoppedPlaying Section: " & CurrentSection & " Sound ID: " & Event.Index)
							Select Case CurrentSection
								Case -2:If Not(Keytones) Then LCAR.ToastMessage(BG, API.getstringvars("milli", Array As String(Event.Index2)), 2)
								Case 999
									If API.CWA.IsInitialized Then
										If API.CWA.SoundEnabled Then 
											If API.CWA.SoundID = -1 Then API.CWA.SoundID= 38
											LCAR.PlaySound(API.CWA.SoundID, True)
										End If
									End If 
								Case 37,-1'disable it in alarms settings, alarm screen, settings,
								Case Else
									LCAR.CheckLoopingSound
									Select Case Event.Index 
										Case 1'opening/intro
											'AprilFools
											If Not(LCAR.IsPlaying) Then
												If (Not(AprilFools) And CurrentSection = 0) Or CurrentSection = 82 Then ShowModeSelect(24)
											End If
											'lcar.stage=2
											'lcar.HideGroup(0, False, True)
										Case 5'self destruct
											'If API.IsScreenLocked Then
												API.AllowVolumeAccess=True
												API.SetVolume(False,False,"StoppedPlaying 5")
												ShowModeSelect(25)
												'GotoSleep
												'If API.WasPaused Then Activity.Finish 
											'End If
										Case 12
											If AprilFools And CurrentSection=0 Then 
												LCAR.PlaySoundAnyway(BorgSound)
												LCAR.CurrentStyle=LCAR.BORG
												BorgMode=15'swap X times
											End If
										
										Case 39'Contact Sound
											DoContact(1,0)
											
										Case LogSound
											PlayNextSound(1)
									End Select
							End Select
							
						Case LCAR.LCAR_SensorGrid
							Select Case Event.Index
								Case 52'mousepad
									'Log("Clicked: " & Event.X & ", " & Event.Y )
									If MouseStage = 1 Then SendText("mouse left")
									MouseStage=0
							End Select
							
						Case LCAR.LCAR_Graph
							Select Case Event.Index
								'Case 79
									'SwapFFTMode(1)
							End Select
						
							
						Case LCAR.LCAR_StoppedMoving
							Select Case Event.Index 
								Case 0'opening fade in
									LCAR.Stage = 1
									LCAR.MoveLCAR(0, 0,0,0,0,255,False,False,True)
									LCAR.MoveLCAR(1,10,10, 0,0,0,True,False,False)
									LCAR.MoveLCAR(2,10,-10-LCAR.ItemHeight, 0,0,0,True,False,False)
									LCAR.MoveLCAR(3, 0,0,0,0,255,False,False,True)
								Case 1
									'AprilFools
									If AprilFools Then
										LCAR.Stop("APRFL")
										LCAR.PlaySoundAnyway(12)
									Else
										If Not(LCAR.IsPlaying ) Then ShowModeSelect(26)
									End If
									
								Case 2: ShowModeSelect(27)'opening is now done
								Case 3,4,5,6: NextStage(5+Event.Index,10+Event.Index)' frame animation stage 1, elbows and top square now visible, reveal small squares 8 and 13	
								Case 7 'end showframe
									If LCAR.redalert Then LCAR.ResetRedAlert
									LCAR.Stage=9
								Case 8'end showmodeselect
									'lcar.Stage=8
									'lcar.LCAR_HideElement(bg,4, False, True)
								Case 10'showkeyboard
								
								Case 11'BORG
									BorgStart
								Case 12'Prompt
							
								Case 20'chx_windows
									LCARSeffects3.CHX_DeleteWindow(-1)
							End Select
							
						Case LCAR.LCAR_Textbox
							If Event.Index = 19 Then ShowTimer(False)
							
						Case LCAR.LCAR_CodeChanged 'toggled red alert 1=red alert 0=condition green
							If LCAR.RedAlertMode = LCAR.LCAR_RedAlert Then
								Select Case CurrentSection
									Case 4'alarm
									Case Else 
										If Event.index=1 And Not(LCAR.DontCancel) Then LCAR.Stop("CODECHANGE")
										LCAR.DontCancel=False
								End Select
								Select Case CurrentSection
									Case 999'alarm
										'GNDN
									Case 14 'warp core status
										LCAR.PlaySound(API.iif(Event.Index = 0,14 ,24), True)
									Case 19'TOS MOIRE
										PlayScienceSound
									Case 20'photic sonar
										If Event.Index = 1 Then LCAR.PlaySound(33, False)
									Case Else
										If CurrentSection<>28 Then LCAR.LightpackPattern=Event.Index
										If Event.Index = 1 Then 
											LCAR.PlaySound(0, False)
											LCAR.LightpackUpdateFreq=2 * DateTime.TicksPerSecond 
											If CurrentSection<>28 Then LightpackEvent(-4,0, 64,0,0)
										Else If CurrentSection<>28 Then 
											LCAR.LightpackColor(-1, 0, LCAR.LCAR_Orange, False,255)
										End If
								End Select
								If webview1.Visible And Event.index=1 Then LCAR.SetRedAlert(False, "Webview visible")
							End If
							LCARSeffects2.SetColors 
							'MakeMenu
							
						Case LCAR.LCAR_TimerIncrement	
							'event.index= index of timer, event.index2=time remaining
							Select Case Event.Index 
								Case -1'high resolution timer
									Select Case CurrentSection
										Case 14 'warp core status
											WarpRumble(Event.index2)
										Case 22'Personal log subtitles
											If DateTime.Now >= StartTime Then HandleSubtitles(-1)
										Case Else 'red alert lightpack
											Log("Red alert: " & Event.index2)
									End Select
								Case 0'auto destruct timer
									Select Case CurrentSection
										Case 4'regular section
											If Not(LCAR.RedAlert) Then LCAR.SetRedAlert(True,"TIMER EVENT")
											LCAR.forceshow(19,True)
											LCAR.LCAR_SetElementText( 19,  API.GetTime(Event.index2),  "")
										Case 46'DRADIS, element 101
											LCAR.SetLRwidth(101,Event.index2,0)
										Case 996'Event Horizon
											LCAR.SetLRwidth(105,Event.index2,0)
									End Select
									'cTimer: 600=event horizon (10 min),1980=dradis (33 min), 30=robocop (30 sec)
									If cTimer = 30 And AprilFools Then
										Select Case Event.index2 
											Case 24: LCAR.PlaySoundFile("", "ed209s20.ogg", False)
											Case 17: LCAR.PlaySoundFile("", "ed209s15.ogg", False)
											Case 6: LCAR.PlaySoundFile("", "ed209s05.ogg", False)
										End Select
									Else
										Select Case Event.index2 
											Case 183: If CurrentSection = 996 Then LCAR.PlaySoundFile("", "eharmed.ogg", False)
											Case 60: LCAR.PlaySound(3,False)
											Case 12: LCAR.PlaySound(4,False)
											Case 0: LCAR.PlaySoundAnyway(-5)'If CurrentSection=4 Then 
										End Select
									End If
									If Event.index2=0 Then
										API.NOTITitle = ""
										API.AutoUpdateNoti
										CurrentSection=4
										ShowTimer(False)
									End If
									
								Case 1'fps counter
									
									'setelement18text("FPS: " & lcar.FPS)
									'lcar.DrawText(bg,0,0, "FPS: " & lcar.FPS, lcar.lcar_orange,1,False,255,0)
									LCAR.LCAR_SetElementText( 6,"FPS: " & LCAR.FPS , "")
								
								Case 2'alarm timer
									If Event.index2 =0 Then 
										API.HandleAlarm(False)
										ShowModeSelect(28)
										ActivityFinish("Alarm timer")
									End If
								
								Case 3'contact
									DoContact(2,Event.index2)
								
								Case 4'playsound delay
									If Event.index2 = 0 Then 
										If LCAR.PlaySoundfile("", SpeakText, False) Then ToastSound(SpeakText)
											'Select Case SpeakText
											'	Case "cantdothat.ogg": LCAR.ToastImage(BG, "hal.png", 3)
											'	Case Else: 	ToastSound(SpeakText)
											'End Select
										'End If
									End If
								
								Case 5, 6'shut down timers
									If Event.index2 = 0 Then 
										If Event.Index = 6 Then LCAR.Stop("NNN")'Nardi
										ActivityFinish("Lockscreen timer shutoff")
									End If
								
								Case 7'Nardi big text
									If Event.index2 = 0 Then CallSub2(WallpaperService, "ToggleBigText", False)
							End Select
						
						Case LCAR.LCAR_Graph
							If CurrentSensor>-1 Then 
								LCAR.HideToast'("LCAR_Graph")
								LCAR.ToastMessage(BG, LCAR.LCAR_GetListItem(2, CurrentSensor).Text, 4)
							End If
						Case LCAR.LCAR_Engineering
							Select Case Event.index2
								Case 0:ShowModeSelect(29)
								Case 1:Activity_KeyPress(84)
								Case Else:TakeScreenshot
							End Select
						
						Case LCAR.TMP_Reliant
							Games.BMN_HandleAnswer(BG,-2,0)
						Case LCAR.TMP_FireControl	
							Games.BMN_HandleAnswer(BG,-3, Floor(Event.X /(Event.x2/3)))
						
						Case LCAR.LCAR_List'-1
							Select Case Event.Index
							
								Case 0'selection
									LCAR.HideToast'("selection")
									temp=TranslateSection(Event.Index2)
									If temp>-999 Then
										If Event.Index2 = SelectedSection Then 
											ShowSection(temp,False)
										Else
											ToastSection(temp)
										End If
										SelectedSection=Event.Index2
									End If
									
								Case 1'wifi
									'Log(LCAR.LCAR_GetListItem(Event.Index, Event.Index2).tag)
									'If Event.Index2 = -1 OR Event.Index2 > LCAR.GetListItemCount(Event.Index) Then
									Try
										LCAR.HideToast'("wifi")
										LCAR.ToastMessage(BG, LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Text, 3)
									Catch
										ShowModeSelect(30)
									End Try
									
								Case 2'sensor meters
									If LCAR.GetListItemCount(2) > Event.Index2 Then
										LCAR.HideToast'("sensor meters")
										LCAR.ToastMessage(BG, LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Text, 4)
										RandomizeGraph(Event.Index2)
									End If
									
								Case 3'settings
									HandleSettings(Event.Index2,3)
									
								Case 4'options
									HandleSettings(Event.Index2,4)
									
								Case 5'timer stuff
									HandleTimer(Event.index2)
								
								Case LCAR.KBListID '6
									LCAR.HideToast'("KBListID 6")
									If Event.Index2>-1 And LCAR.ListWasScrolling <> Event.Index Then LCAR.HandleKeyboard( LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Number )
								Case LCAR.NumListID '7
									If Event.Index2>-1 Then ServerIP= LCAR.HandleNumboard(BG, LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Number, ServerIP, Settings)
								Case LCAR.NumListID+1 '8
									If Event.Index2>-1 Then ServerIP= LCAR.LoadIP(BG, Event.Index2, Settings, ServerIP.Port)
								
								Case 9'Tactical
									Select Case Event.Index2
										Case -1
										Case 0'Listen
											ServerListen
										Case 1'Connect
											LCAR.LCAR_HideAll(Null, False)
											LCAR.ShowNumBoard(BG, ServerIP)
										Case 2'Deploy
											'GPSitems=GPSitems+1
											AddGPScoordinate(LCARSeffects.GetGPScoordinate(0))
										Case Else'Collect (INDEX=3, GPS_COORD=2)	
											'GPSitems=GPSitems-1
											CollectProbe(Event.Index2-1)
											
									End Select
								
								Case 10'UMR action list
									'If Event.Index2 =0 Then'BACK
									'	ShowUMRMenu(10)
									'Else
										IsVoiceCommand=False
										SendText("exe " &  LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Text)
									'End If
								Case 11'tasklist
									'If Event.Index2 =0 Then'BACK
									'	ShowUMRMenu(11)
									'Else
										IsVoiceCommand=False
										SendText("switchto " & LCAR.LCAR_GetListItem(Event.Index, Event.Index2).tag )
									'End If
								Case 12'UMR feature list
									ShowUMRMenu(-1)
									LCAR.LCAR_HideElement(BG,12,True,False,True)
									IsVoiceCommand=False
									Select Case Event.Index2
										Case -1
										Case 0'actions
											UMRsection=10
											LCAR.LCAR_HideElement(BG,10,True,True,True)
										Case 1'tasks
											UMRsection=11
											LCAR.LCAR_ClearList(11,0)
											'LCAR.LCAR_AddListItem(11, "BACK", LCAR.LCAR_Orange , -1,  "", False, "" ,0,False,-1)
											LCAR.LCAR_HideElement(BG,11,True,True,True)
											SendText("task")
										Case 2'keyboard
											'LCAR.LCAR_HideElement(BG,71, False,False,True)
											LCAR.LCAR_HideElement(BG,19, True,False,True)
											LCAR.ShowKeyboard(BG,10)
										Case 3'file browser
											UMRsection=13
											LCAR.LCAR_HideElement(BG,13,True,True,True)
											LCAR.LCAR_ClearList(13,0)
											'LCAR.LCAR_AddListItem(13, "BACK", LCAR.LCAR_Orange , -1,  "", False, "" ,0,False,-1)
											SendText("folder")
										Case 4'mouse
											ResizeScreen
											LCAR.ForceShowGroup(16,True)
										Case 5'gamemode
											LCARSeffects.ShowPrompt(BG,10, API.getstring("umr5"), API.getstring("umr_exit"), 3, API.GetString("auto_start"), API.getstring("cancel"))
										Case 6'voice
											VRListen 
										Case Else'Disconnect
											SendText("disconnect")
											DisconnectUMR
											
									End Select
								Case 13'file list
									'If Event.Index2 =0 Then'BACK
										'ShowUMRMenu(13)
									'Else
										IsVoiceCommand=False
										SendText("folder dir " & Chr(34) & LCAR.LCAR_GetListItem(Event.Index, Event.Index2).tag & Chr(34) & " 1")
										If LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Number=-1 Then
											LCAR.LCAR_ClearList(13,0)
											LCAR.LCAR_AddListItem(13, "..", LCAR.LCAR_Orange , -1,  "", False, "" ,0,False,-1)
										End If
									'End If
								
								Case 14'Okuda main
									OkudaMode = Event.Index2
									LCAR.LCAR_HideElement(BG,14,True,False,True)
									LCAR.LCAR_ClearList(15,0)
									Select Case OkudaMode
										Case 0'tool
											Event.Y2 = LCAR.LCAR_AddListItems(15, LCAR.LCAR_Random,0, API.getstrings("okuda_tool", 0)) 
										Case 1'mode
											Event.Y2 = LCAR.LCAR_AddListItems(15, LCAR.LCAR_Random,0, API.GetStrings("okuda_mode", 0))
										Case 2'colors
											Event.Y2 = LCAR.LCAR_AddListItems(15, LCAR.LCAR_Random,0, Array As String("1: " & LCARSeffects.GetOkudaSegColor(False), "2: " & LCARSeffects.GetOkudaSegColor(True),  API.getstring("okuda_blink") & ": " & API.IIF(LCARSeffects.OkudaSeg.Blinking, API.getstring("yes"), API.getstring("no"))))
										Case 3'sides
											Select Case LCARSeffects.OkudaSeg.SegmentType 'Dim Blank As Int,aCircle As Int, aSquare As Int, SemiCircle As Int, Lines As Int, Bar As Int,
												Case LCARSeffects.blank
													Event.Y2 = 0
												Case LCARSeffects.acircle	':	lcar.LCAR_AddListItems(15, lcar.LCAR_Random,0, Array As String("DIAMETER", "BOTTOM", "LEFT"))
													LCAR.LCAR_AddListItem(15, API.getstring("okuda_diameter") & ": " & LCARSeffects.OkudaSeg.top, LCAR.LCAR_Random, -1, "1", False,  LCARSeffects.OkudaSeg.top , 0,False,-1)
													LCAR.LCAR_AddListItem(15, API.getstring("okuda_bottom") & ": " & LCARSeffects.OkudaSeg.bottom, LCAR.LCAR_Random, -1, "3", False,  LCARSeffects.OkudaSeg.bottom , 0,False,-1)
													LCAR.LCAR_AddListItem(15, API.getstring("umr_left") & ": " & LCARSeffects.OkudaSeg.Left, LCAR.LCAR_Random, -1, "0", False,  LCARSeffects.OkudaSeg.Left , 0,False,-1)
													Event.Y2 = 3
												Case LCARSeffects.asquare
													LCAR.LCAR_AddListItem(15, API.getstring("okuda_length") & LCARSeffects.OkudaSeg.Left, LCAR.LCAR_Random, -1, "0", False,  LCARSeffects.OkudaSeg.Left , 0,False,-1)
													LCAR.LCAR_AddListItem(15, API.getstring("okuda_width") & LCARSeffects.OkudaSeg.right, LCAR.LCAR_Random, -1, "2", False,  LCARSeffects.OkudaSeg.right , 0,False,-1)
													Event.Y2 = 2 
												Case LCARSeffects.semicircle':	lcar.LCAR_AddListItems(15, lcar.LCAR_Random,0, Array As String("LEFT", "TOP", "RIGHT", "BOTTOM"))
													LCAR.LCAR_AddListItem(15, API.getstring("umr_left") & ": " & LCARSeffects.OkudaSeg.Left, LCAR.LCAR_Random, -1, "0", False,  LCARSeffects.OkudaSeg.Left , 0,False,-1)
													LCAR.LCAR_AddListItem(15, API.getstring("okuda_top") & ": " & LCARSeffects.OkudaSeg.top, LCAR.LCAR_Random, -1, "1", False,  LCARSeffects.OkudaSeg.top , 0,False,-1)
													LCAR.LCAR_AddListItem(15, API.getstring("umr_right") & ": " & LCARSeffects.OkudaSeg.right, LCAR.LCAR_Random, -1, "2", False,  LCARSeffects.OkudaSeg.right , 0,False,-1)
													LCAR.LCAR_AddListItem(15, API.getstring("okuda_bottom") & ": " & LCARSeffects.OkudaSeg.bottom, LCAR.LCAR_Random, -1, "3", False,  LCARSeffects.OkudaSeg.bottom , 0,False,-1)
													Event.Y2 = 4
												Case LCARSeffects.lines		':	lcar.LCAR_AddListItems(15, lcar.LCAR_Random,0, Array As String("LINE 1", "LINE 2", "LINE 3", "LINE 4"))
													LCAR.LCAR_AddListItem(15, API.getstring("okuda_bar") & " 1: " & LCARSeffects.OkudaSeg.top, LCAR.LCAR_Random, -1, "0", False,  LCARSeffects.OkudaSeg.top , 0,False,-1)
													LCAR.LCAR_AddListItem(15, API.getstring("okuda_bar") & " 2: " & LCARSeffects.OkudaSeg.bottom, LCAR.LCAR_Random, -1, "1", False,  LCARSeffects.OkudaSeg.bottom , 0,False,-1)
													LCAR.LCAR_AddListItem(15, API.getstring("okuda_bar") & " 3: " & LCARSeffects.OkudaSeg.Left, LCAR.LCAR_Random, -1, "2", False,  LCARSeffects.OkudaSeg.Left , 0,False,-1)
													LCAR.LCAR_AddListItem(15, API.getstring("okuda_bar") & " 4: " & LCARSeffects.OkudaSeg.right, LCAR.LCAR_Random, -1, "3", False,  LCARSeffects.OkudaSeg.right , 0,False,-1)
													Event.Y2 = 4
												Case LCARSeffects.bar		':	lcar.LCAR_AddListItems(15, lcar.LCAR_Random,0, Array As String("LEFT", "RIGHT"))
													LCAR.LCAR_AddListItem(15, API.getstring("umr_left") & ": " & LCARSeffects.OkudaSeg.Left, LCAR.LCAR_Random, -1, "0", False,  LCARSeffects.OkudaSeg.Left , 0,False,-1)
													LCAR.LCAR_AddListItem(15, API.getstring("umr_right") & ": " & LCARSeffects.OkudaSeg.right, LCAR.LCAR_Random, -1, "2", False,  LCARSeffects.OkudaSeg.right , 0,False,-1)
													Event.Y2 = 2'* (lcar.ItemHeight+3)
												Case Else
													LCAR.ToastMessage(BG, API.getstring("okuda_select") ,3)
											End Select 
										Case 4'file
											Event.Y2 = LCAR.LCAR_AddListItems(15, LCAR.LCAR_Random,0, API.getstrings("okuda_file", 0)) '+ lcarseffects.OkudaCount(Settings)
											Event.Y2 = Event.Y2 + LCARSeffects.LoadOkudagrams(15,Settings)
										Case 5'Era
											Event.Y2 = LCAR.LCAR_AddListItems(15, LCAR.LCAR_Random,0, API.getstrings("okuda_era", 0)) 
											OkudaMode=9
										Case Else
											Msgbox(OkudaMode, "ERROR OKUDA 1")
									End Select
									HandleOkuda(Event.Y2)'resizes list
									
								Case 15'Okuda Secondary
									Event.Y2=0
									LCAR.LCAR_HideElement(BG,15,True,False,True)
									Select Case OkudaMode
										Case 0'tool
											LCARSeffects.Okudatool = Event.Index2
											LCAR.LCAR_SetListitemText(14,0,API.getstring("okuda_tools0"),  LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Text)
										Case 1'mode
											LCARSeffects.OkudaSeg.SegmentType = Event.Index2
											LCAR.LCAR_SetListitemText(14,1,API.getstring("okuda_tools1"),  LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Text)
										Case 2'colors
											OkudaMode=5+Event.Index2
											If Event.Index2 = 2 Then
												LCAR.LCAR_ClearList(15,0)
												Event.Y2 = LCAR.LCAR_AddListItems(15, LCAR.LCAR_Random,0, Array As String(API.getstring("on"), API.getstring("off")))
											Else
												LCAR.LCAR_ClearList(15,0)
												Event.Y2 = LCAR.LCAR_AddLCARcolors(15, True)
											End If
										Case 3'sides
											'Msgbox(lcar.LCAR_GetListItem(event.Index, event.Index2).tag, lcarseffects.SelectedSegment)
											OkudaMode=8
											LCARSeffects.SelectedSegment=LCAR.LCAR_GetListItem(Event.Index, Event.Index2).tag
											LCAR.LCAR_ClearList(15,0)
											Select Case LCARSeffects.OkudaSeg.SegmentType
												Case LCARSeffects.acircle
													Select Case Event.Index2
														Case 0'diameter
															'setelement18text("SELECT YOUR DIAMETER")
															Event.Y2 = LCAR.LCAR_AddListItems(15, LCAR.LCAR_Random,0, Array As String("0.1", "0.2", "0.3", "0.4", "0.5", "0.6", "0.7", "0.8", "0.9", "1.0", "1.1", "1.2", "1.3", "1.4", "1.5", "1.6", "1.7", "1.8", "1.9", "2.0", "2.1", "2.2", "2.3", "2.4", "2.5"))
														Case 1,2'bottom,left
															'setelement18text("Select your bottom/left offset")
															Event.Y2 = LCAR.LCAR_AddListItems(15, LCAR.LCAR_Random,0, Array As String("-0.5", "-0.4", "-0.3", "-0.2", "-0.1", "0.0", "0.1", "0.2", "0.3", "0.4", "0.5"))
													End Select
												Case LCARSeffects.asquare
													'setelement18text("Select your width/length")
													Select Case Event.Index2
														Case 0'length
															Event.Y2 = LCAR.LCAR_AddListItems(15, LCAR.LCAR_Random,0, Array As String("0.1", "0.2", "0.3", "0.4", "0.5", "0.6", "0.7", "0.8", "0.9", "1.0", "1.1", "1.2", "1.3", "1.4", "1.5"))
														Case 1'width
															Event.Y2 = LCAR.LCAR_AddListItems(15, LCAR.LCAR_Random,0, Array As String("0.1", "0.2", "0.3", "0.4", "0.5", "0.6", "0.7", "0.8", "0.9", "1.0", "1.1", "1.2", "1.3", "1.4", "1.5", "1.6", "1.7", "1.8", "1.9", "2.0"))
													End Select
												Case LCARSeffects.semicircle, LCARSeffects.bar
													'setelement18text( "Right/Top must be bigger than Left/Bottom")
													Event.Y2 = LCAR.LCAR_AddListItems(15, LCAR.LCAR_Random,0, Array As String("0.1", "0.2", "0.3", "0.4", "0.5", "0.6", "0.7", "0.8", "0.9", "1.0", "1.1", "1.2", "1.3", "1.4", "1.5"))
												Case LCARSeffects.lines
													'setelement18text("0 is no line" & CRLF & "1 is a primary color line" & CRLF & "2 is a secondary color line" & CRLF & "Doesn't blink")
													Event.Y2 = LCAR.LCAR_AddListItems(15, LCAR.LCAR_Random,0, Array As String("0", "1", "2"))
											End Select
										Case 4'file
											'event.Y2=1
											Select Case Event.Index2
												Case 0'clear
													LCARSeffects.Okuda.Initialize 
												Case 1'save
													LCARSeffects.SaveOkuda(Settings)
													LoadSettings(True)
												Case 2,3,4,5,6,7,8' 2=randomize, 3,4,5,6,7,8=presets
													LCARSeffects.Okuda = LCARSeffects.GetInternalOkudagram(Event.Index2-2,Settings) 
												Case Else'9=-1, 10=-2
													LCARSeffects.Okuda = LCARSeffects.GetInternalOkudagram(-(Event.Index2-8),Settings) 
											End Select
											LCAR.IsClean = False

										Case 5'color 1
											If Event.Index2> LCAR.lcar_RedAlert Then Event.Index2=Event.Index2-1
											LCARSeffects.OkudaSeg.ColorID= Event.Index2
											LCARSeffects.SaveSegment
										Case 6'color 2
											If Event.Index2> LCAR.lcar_RedAlert Then Event.Index2=Event.Index2-1
											LCARSeffects.OkudaSeg.BlinkColorID = Event.Index2
											LCARSeffects.SaveSegment
										Case 7'blink
											LCARSeffects.OkudaSeg.Blinking = (Event.Index2=0)
											LCARSeffects.SaveSegment
										Case 8'left,top,right,bottom
											Select Case LCARSeffects.SelectedSegment
												Case 0:LCARSeffects.OkudaSeg.Left = LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Text
												Case 1:LCARSeffects.OkudaSeg.top = LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Text
												Case 2:LCARSeffects.OkudaSeg.right = LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Text
												Case 3:LCARSeffects.OkudaSeg.bottom = LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Text
											End Select
											LCARSeffects.SaveSegment
											
										Case 9'Era 
											LCAR.GetElement(50).Align=Event.Index2
											HandleOkuda(-1)	
											
										Case Else
											Msgbox(OkudaMode, "ERROR OKUDA 2")
									End Select
									HandleOkuda(Event.Y2)'resizes list
'									If Event.Y2=0 Then
'										LCAR.LCAR_HideElement(BG,14,True,True,True)
'										LCAR.isclean=False
'									Else
'										LCAR.ResizeList(15, 203, Event.Y2 * (LCAR.ItemHeight+3),-1,0,0,False)
'										LCAR.LCAR_HideElement(BG,15,True,True,True)
'									End If
									
								Case 16'History
									HistoryList(Event.Index2)
									
								Case 17'Sensor List
									ShowSensorScan(Event.Index2)
								
								Case 18
									TakeScreenshot
								
								Case 19' sidebar
									HandleSidebar(Event.Index2)
								
								Case 20,21
									SelectSensor(Event.Index2, Event.Index)
								
								Case 23
									AddLog(LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Tag, -2, "")
								
								Case 22
									LoadGPlusFeed(Event.Index2)
								
								Case 23'personal log GNDN
									
								Case 24,25,26'Calculator lists
									HandleCalc(Event.Index,Event.Index2)
								
								Case LCAR.ButtonList
									HandleButtonList(Event.Index2)
									
								Case ButtonMenu
									HandleButtonMenuClicked(LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Tag)
								
								Case Games.SwitchList,LCARSeffects3.TMPlist
									Games.BMN_HandleAnswer(BG, Event.Index, Event.Index2)
								 	Return
								
								Case LCARSeffects3.CHX_menubarID 
									'Log("CHX_menubarID Event.Index2: " & Event.Index2)
									LCARSeffects3.CHX_ItemClick(BG, Event.Index, LCAR.LCAR_List, Event.Index2,0,0, LCAR.Event_Up)
									Return 
									
								Case Else
									'Msgbox("Element Clicked: " &  lcar.LCAR_GetListItem(event.Index, event.Index2).Text  , "List: " & event.Index & " Item: " & event.Index2 )
									'SetElement18Text(LCAR.LCAR_GetListItem(Event.Index, Event.Index2).Text)'was uncommented
									'lcar.forceshow(18,True)
									'lcar.LCAR_SetElementText( 18, lcar.LCAR_GetListItem(event.Index, event.Index2).Text, "")
									
									HandleEducational(Event)
							End Select
							PlayRandomBeep
						
						Case LCAR.CHX_Iconbar
							LCARSeffects3.CHX_ItemClick(BG, Event.Index, LCAR.CHX_Iconbar, Event.Index2,0,0, LCAR.Event_Up)
						Case LCAR.CHX_Window
							LCARSeffects3.CHX_ItemClick(BG, Event.Index, LCAR.CHX_Window, Event.Index2,Event.x,Event.y, LCAR.Event_Up)
						
						Case LCAR.Legacy_Button
							Select Case Event.index
								Case 58: LCARSeffects2.StarshipsClean =False
								Case 59: LCAR.ClearScreen(Null)
								Case 60: LCARSeffects2.DoPaths = Not(LCARSeffects2.DoPaths)
								Case 61: LCARSeffects2.HelpMode = Not(LCARSeffects2.HelpMode): LCAR.ClearScreen(Null)
							End Select
							
						Case LCAR.LCAR_Matrix, LCAR.LCAR_StarBase, LCAR.TOS_Moires, LCAR.Legacy_Sonar, LCAR.LCAR_Omega
							TakeScreenshot
							
						Case LCAR.LCAR_Dpad
							Select Case Event.Index 
								Case 49: OkudaDpad(Event.Y2)
								Case 99: WidgetResizer(Event.Y2)
							End Select
							
						Case LCAR.LCAR_Okuda 
							'Msgbox( event.X2 & ", " & event.y2, "OKUDA CELL")
							If LCARSeffects.GridLines Then
								LCARSeffects.SelectCoordinate(Event.X2 , Event.y2)
							Else
								TakeScreenshot
							End If
							
						Case LCAR.LCAR_Alert, LCAR.AIR_Alart, LCAR.TMP_Alert
							SwapMode(Event.Index , 1)
						
						Case LCAR.CHX_Logo
							LCARSeffects3.CHX_ShowLogo(100,True)
							
						Case LCAR.LCAR_Elbow 
							Select Case Event.Index 
								Case LCAR.KBCancelID
									LCAR.ClickedOK=False
									LCAR.HideKeyboard(BG,10) 'Cancel
									'QuestionAsked=False
								Case LCAR.KBCancelID+4': lcar.HandleKeyboard(KeyCodes.KEYCODE_DPAD_CENTER)'OK
									LCAR.ClickedOK=True
									LCAR.HideKeyboard(BG,10)
									LCAR.PushEvent(LCAR.LCAR_OK, LCAR.KBCancelID+5,0,0,0,0,0,0)
								
								Case LCAR.NumButtonID: ShowModeSelect(31)'Cancel
								Case LCAR.NumButtonID+4'ok (UMR/GPS)
									Select Case CurrentSection
										Case 52'lightpack
											Settings.Put("lightpackip" , API.GetIP(ServerIP, True))
											ShowSettingsSection(-30)
										Case 83'file explorer
											HandleDIRmenu(-1,1)
										Case Else
											If CurrentSection<>7 Then 	ShowFrame(True,True)
											Socket1.Initialize("Socket1")
											Socket1.Connect(API.GetIP(ServerIP,False) , ServerIP.Port ,  20000)
											SetElement18Text(API.GetString("connecting"))
											LCAR.PlaySound(25, False)
									End Select
									
								Case 4'SelectMode OK
									ShowSection(TranslateSection(LCAR.LCAR_GetSelectedItem(0)), True)
									
								Case Else
									TakeScreenshot
							End Select
							PlayRandomBeep
							
						Case LCAR.ENT_Button 
							Select Case Event.Index
								Case 65:ShowModeSelect(32)'exit
								Case 66:Activity_KeyPress(84)'BrowseWeb("file://" & File.Combine(File.DirInternalCache, "gplus.html"))'back
								Case 67:TakeScreenshot'prt scr
								Case 75: 
									webview1.Visible = Not(webview1.Visible)
									If webview1.Visible Then MoveWebview
									'AddSocialMediaFeeds(22, 0)
								Case 92: 
									PreviewLWP(-1)
							End Select
							
						Case LCAR.LCAR_Button
							Select Case Event.Index 
								Case LCARSeffects.FrameElement
									Activity_KeyPress(84)
									If CurrentSection = 22 Then Return
							
								Case LCARSeffects.PromptID+5, LCARSeffects.PromptID+6' Yes, No
									If LCAR.LCAR_GetElement(LCARSeffects.PromptID+4).SideText.Length>0 Then'AND Not(LCAR.IsMultilineEnabled) Then
										LCAR.HideToast'("PromptID")
										LCAR.ToastMessage(BG, API.GetString("no_read"), 2)
										LCAR.PlaySound(0,False)
									Else
										Event.Index2 = Abs( Event.Index - LCARSeffects.PromptID-6)'0=no/right, 1=yes/left
										LCAR.HideGroup(LCARSeffects.PromptGroup, False,True)
										Select Case LCARSeffects.PromptQID 'ShowSettings(True,True) 10
											Case -2
												ExitApplication
											Case -1
												'HandleRick(True)
												ShowModeSelect(33)
											Case 0
												LCAR.SmallScreen = Event.Index2=1
												Settings.Put("SmallScreen", LCAR.SmallScreen)
												LoadSettings(True)
												If LCAR.SmallScreen Then
													'ToastMessageShow("Small screen mode activated",False)
													LCAR.ToastMessage(BG, API.getstring("small_screen"), 4)
													SmallScreenMode
												End If
												ShowModeSelect(34)
											Case 1'starship id
												If Event.Index2= 0 Then
													ShowSettings(True,False)
												Else
													AskStarshipName
												End If
											Case 2'starship name
												If Event.Index2= 0 Then
													RenameStarship
												Else
													ShowSettings(True,False)
												End If
											Case 3'UMR game mode start
												If Event.Index2= 0 Then
													GameMode = True
												Else
													ShowUMRMenu(-2)
												End If
											Case 4'PDP Filename
												'LCAR.hidekeyboard(BG,10)
												LCAR.LCAR_HideAll(BG,False)
												If Event.Index2= 0 Then 
													Games.PDPFilename = LCAR.GetInputText.trim & ".pon"
													SaveCustom(True)
												End If
												ShowGameBoard
												PuzzleSidebar
											Case 5'stop recording
												ShowSection(22,False)
												AddLog(DeactivateMic(False),-1,Subtitles.ToString)
											Case 6'rename log
												If Event.Index2= 0 Then	AddLog( LCAR.LCAR_GetListitemText(23,-1,2), 1, LCAR.GetInputText.trim)
												ShowSection(22,False)
											Case 7'delete log
												If Event.Index2= 1 Then	AddLog(LCAR.LCAR_GetListitemText(23,-1,2),2,"")
												ShowSection(22,False)
											Case 8'return to calculator
												ShowSection(24,False)
												'LCAR.BackupRestoreKB(False,"")
											Case 9
												HandleSettings(Event.Index2, -1)
											Case 10
												If Event.Index2= 0 Then SMSQuickReply(-1, LCAR.GetSelectedText, -1)
											Case 11
												If Event.Index2= 0 Then HandlePassword(LCAR.GetSelectedText)
											Case 12'send kb to launcher
												API.BroadcastToReturnAddress("keyboard", LCAR.GetSelectedText)
												ShowModeSelect(34.5)
											Case 13'send msgbox to launcher
												API.BroadcastToLauncher("msgbox", Event.Index2=1)
												ShowModeSelect(35)
											Case 14'reminder
												HandleReminder("add reminder " &  LCAR.GetSelectedText)
												ShowSection(62,False)
											Case Else
												Select Case CurrentSection 
													Case 1001,1002,1003,1004,1005'educational mode
														HandleEducationalKeyboard( API.IIF(Event.Index2= 0, LCAR.GetSelectedText, ""))
													
													Case Else
														Log("Unhandled question: " & LCARSeffects.PromptQID)
												End Select
												
										End Select
										If LCAR.IsKeyboardVisible(Null,0,False) Then LCAR.HideKeyboard(BG,0)
									End If
							
								Case LCAR.KBCancelID+1: LCAR.HandleKeyboard(KeyCodes.KEYCODE_DEL) 'Backspace
								Case LCAR.KBCancelID+2: LCAR.HandleKeyboard(KeyCodes.KEYCODE_SPACE) 'Space
								Case LCAR.KBCancelID+3: LCAR.HandleKeyboard(KeyCodes.KEYCODE_UNKNOWN)'Delete
								
								Case LCAR.NumButtonID+1: LCAR.HandleNumboard(BG, KeyCodes.KEYCODE_DEL, ServerIP, Settings) 'backspace
								Case LCAR.NumButtonID+2: LCAR.HandleNumboard(BG, KeyCodes.KEYCODE_UNKNOWN, ServerIP, Settings)'Delete
								Case LCAR.NumButtonID+3: LCAR.DeleteIP(LCAR.SelectedIP,Settings) 'lcar.HandleNumboard(BG,"DELETE IP", serverIP, Settings)'Delete IP
								
								Case LCAR.NumButtonID+5:LCAR.HandleNumboard(BG,API.getstring("prev"), ServerIP, Settings)'Prev octet
								Case LCAR.NumButtonID+6:LCAR.HandleNumboard(BG,API.getstring("next"), ServerIP, Settings)'Next octet
								Case LCAR.NumButtonID+7: LCAR.SaveIP( ServerIP , Settings)' lcar.HandleNumboard(BG,"SAVE IP", serverIP, Settings)'Save IP
								
								Case LCARSeffects.FrameElement+11'left sidebar button
									Select Case CurrentSection
										Case -1'mode select
											ShowSection(TranslateSection(LCAR.LCAR_GetSelectedItem(0)), False)
										'Case 8 'tactical test
											'AddGPScoordinate(API.CreateLocation( LCARSeffects.GetGPScoordinate(0), 0, 50))
										Case 17: Games.PDPPause 
										Case 24
											If LCAR.IsKeyboardVisible(Null,0,False) Then
												LCAR.HideKeyboard(BG,10)
												HandleCalc(-1,-1)
											Else
												ShowModeSelect(36)
											End If
										Case 32: HandleCOMMS("")
										Case Else: ShowModeSelect(37)
									End Select
								
								
								
									
								Case 20'Belay
									If Password.Length>0 Then 
										If Not( VRListen) Then BelayTimer
									Else
										BelayTimer
									End If
									
								Case 40'Download UMR
									If File.Exists(File.DirRootExternal , "UMR.ZIP") Then
										LCAR.LCAR_SetElementText( 40, API.GetStringVars("umrserver_success", Array As String(File.DirRootExternal & "/UMR.ZIP")) , "")
									Else If Not(UMRDOWNLOADING) Then
										UMRDOWNLOADING=True
										API.download("umrserver",  UMRURL)				
										LCAR.LCAR_SetElementText( 40,API.getstring("umr_downloading") , "")
									End If
								Case 48' Toggle Okudagram UI
									OkudaDpad(-2)
									
								Case 54: SendText("mouse left")
								Case 55: SendText("mouse middle")
								Case 56: SendText("mouse right")
								
								'Case 71:ShowUMRMenu(UMRsection) ': ShowSection(7,False)'UMR back
								Case 78: 
									ServerListen
									LCAR.LCAR_SetElementText( 78, Server.GetMyIP & ":" & DefaultPort , "")
									
								Case 88
									ShowSection(TranslateSection(LCAR.LCAR_GetSelectedItem(0)), Event.Index2=1)
							End Select
							PlayRandomBeep
							
						Case LCAR.LCAR_Textbox
						Case LCAR.LCAR_Slider
						
						Case LCAR.LCAR_AnswerMade'answer slider
							HandleAnswer( Event.Index2=1 )
							
						Case LCAR.SYS_Camera
							Log("SYS_Camera event: " & Event.Index)
							Select Case Event.Index 
								Case 0: If Not(LCARSeffects4.CameraIsOn) Then SetupCamera
								Case 1
									StopCamera
									StopRecording
									'StopGPS(True)
								Case 2: camEx.ToggleFlash 
								Case 3'toggle camera
									StopCamera
									LCARSeffects4.TRI_FrontCamera = Not(LCARSeffects4.TRI_FrontCamera)
									SetupCamera
								Case 4: camEx.TakePicture
								Case 5: Listen(True)
								Case 6: Listen(False)
								Case 7: 
									Log("SYS_CAMERA BACK")
									Activity_KeyPress( 4 )
								
								Case 8: StartGPS
								Case 9: StartRecording
							End Select
					End Select
			End Select
			'lcar.LCAR_AddListItem(0,  "Clicked: " & lcar.ClickedType(Event) &  " - " & event.X2  ,   lcar.LCAR_RandomColor,  event.Index , "", False,  event.X & "," & event.y,  0,False)
		Loop
	End If
End Sub

'If items = -1 then refresh era
Sub HandleOkuda(Items As Int)
	Dim temp As Int
	If Items = -1 Then 
		 LCAR.LCAR_SetListitemText(14, 5, LCAR.LCAR_IGNORE, API.Getstring("okuda_era" & LCAR.GetElement(50).Align))
	else If Items=0 Then
		LCAR.LCAR_HideElement(BG,14,True,True,True)
		LCAR.LCAR_HideElement(BG,15,True,False,True)
	Else
		temp= Items * (LCAR.ItemHeight+3)
		If temp> Min(Activity.Height,Activity.Width) Then temp=-1
		LCAR.ResizeList(15,  Max(203, LCAR.TextWidth(BG, "COLOR  DARK ORANGE")) , temp,-1,0,0,False)
		LCAR.LCAR_HideElement(BG,15,True,True,True)
	End If
	LCAR.ClearScreen(BG)
End Sub

Sub OkudaDpad(Direction As Int)
	Select Case Direction
		Case -2'Toggle UI
			LCARSeffects.GridLines = Not(LCARSeffects.GridLines)
			LCAR.ForceShow(49, LCARSeffects.GridLines)
			'LCAR.LCAR_HideElement(BG,49,False,LCARSeffects.GridLines,True)
			LCAR.LCAR_HideElement(BG,14,True,LCARSeffects.GridLines,True)'menu
			LCAR.LCAR_HideElement(BG,15,True,False, True)
			LCAR.IsClean=False
		Case -1:  LCARSeffects.SelectCoordinate(LCARSeffects.SelectedGrid.x , LCARSeffects.SelectedGrid.y)'Center
		Case 0: LCARSeffects.SelectCoordinate(LCARSeffects.SelectedGrid.x , LCARSeffects.SelectedGrid.y+1)'up
		Case 1: LCARSeffects.SelectCoordinate(LCARSeffects.SelectedGrid.x+1 , LCARSeffects.SelectedGrid.y)'right
		Case 2: LCARSeffects.SelectCoordinate(LCARSeffects.SelectedGrid.x , LCARSeffects.SelectedGrid.y-1)'down
		Case 3: LCARSeffects.SelectCoordinate(LCARSeffects.SelectedGrid.x-1 , LCARSeffects.SelectedGrid.y)'left
	End Select
End Sub

Sub HistoryList(Index As Int)As Boolean 
	Dim Item As LCARlistitem 
	If Index =0 Then'CLEAR
		ClearHistory(16, API.GetString("web_side2"),  API.GetString("web_clear_hist"))
	Else If Index=-1 Then
		If LCAR.IsKeyboardVisible(BG, 0, False)  Then
			PlayError
			Return False
		Else If API.IsConnected Then
			webview1.Visible = Not(webview1.Visible)
			MoveWebview
			If Not(webview1.Visible) Then
				LCAR.LCAR_HideElement(BG, 16,True , True, True)
				LCAR.RandomizeColors(16)
				Return True
			End If
		Else
			'Log("5314")
			LCAR.SetRedAlert(False,"HistoryList")
			CurrentSection=-999
			ShowModeSelect(38)
			Return False
		End If
	Else If Index < LCAR.GetListItemCount(16) Then
		Item = LCAR.LCAR_GetListItem(16, Index)
		If Item.IsInitialized Then
			API.Title = Item.Text.ToUpperCase 
			SetElement18Text(API.Title.Replace(" - ", CRLF))
			API.FileLoaded= Item.Tag 
			API.BaseHref= GetBaseHREF("History", Item.Number)
			needsreloading=True
		End If
	Else
		Return False
	End If
	LCAR.LCAR_HideElement(BG, 16,True,False,True)
	Return True
End Sub
Sub IsSidebarVisble As Boolean 
	Return LCAR.IsListVisible(19)
End Sub

Sub TimerAction(ActionID As Int)
	Select Case ActionID
		Case 0'Reset
			cTimer=0
			SetElement18Text("00:00")
		Case 1'Start
			If cTimer>0 Then	
				API.StartTimer(cTimer)
				'API.Broadcast("timer", cTimer)
				'Log("TimerAction: " & cTimer & " = " & API.GetTime(cTimer))
				'API.NewTimer("Main", 0, cTimer )
				'API.NOTITitle = API.GetStringVars("auto_noti", Array As String(DateTime.Time(DateTime.Now+cTimer)))
				'API.AutoUpdateNoti
				ShowTimer(True)
				'LCAR.DontCancel=True
				'LCAR.PlaySound(2,False)
			Else
				LCAR.ToastMessage(BG, API.GetString("auto_none"), 3)
			End If
		Case 2' save
			SaveTimer(cTimer)
		Case 3'delete
			DeleteTimer(cTimer)
		Case 4'stardate
			CurrentSection=-3
			LCAR.LCAR_HideElement(BG, 5, True, False,False)
			LCAR.forceshow(18,True)
			ResizeTimer
	End Select
End Sub

Sub ShowTactical
	LCAR.forceshow(39,True)
	LCAR.forceshow(73,True)
	LCAR.LCAR_HideElement(BG, 9,True,True,False)
	ResizeGPS(GPSitems)
End Sub
Sub CollectProbe(Index As Int)'start at 2
	LCARSeffects.RemoveGPScoordinate(Index, Settings)
	'LCARSeffects.ResizeFrame(-GPSitems)
	LCAR.LCAR_RemoveListitem(9,LCAR.LCAR_LastListitem)'LISTEN,CONNECT,DEPLOY,PROBE 0 (ID=2, INDEX=3)
	'LCAR.ResizeList(9,103, LCAR.ListItemsHeight(GPSitems),-1,0,0,False)
	ResizeGPS(GPSitems-1)
End Sub

Sub AddGPScoordinate(Coordinate As Location)
	'Dim tempstr As String
	LCARSeffects.AddGPScoordinate( -1, Coordinate, 9,True,Settings)
	ResizeGPS(GPSitems+1)
	'tempstr=API.IIF(LCAR.SmallScreen,"P", "PROBE ") & ResizeGPS(GPSitems+1)
	'LCAR.LCAR_AddListItem(9, tempstr  , LCAR.LCAR_Random,  -1,  "", False, "" ,0,False,-1)
End Sub


Sub ResizeGPS(Items As Int)As Int 
	GPSitems=Items
	LCARSeffects.ResizeFrame(-GPSitems) 'ResizeFrame(GPSitems)
	LCAR.ResizeList(9, 100 * LCAR.GetScalemode  + 3, LCAR.ListItemsHeight(GPSitems),-1,0,LCAR.GetScaledPosition(4,False),True)
	UpdateGPS
	Return Items-3 
End Sub

Sub SwapMode(ElementID As Int, Stage As Int) As Int
	Log("Swap mode: " & ElementID & " to " & Stage) 
	Select Case CurrentSection
		Case 43: LCAR.SwapMode(ElementID,999,True)
		Case Else: LCAR.SwapMode(ElementID,Stage,True)
	End Select
End Sub

Sub TakeScreenshot
	Dim tempstr As StringBuilder, Filename As String 
	If Screenshots Then
		tempstr.Initialize 
		Filename= LCARSeffects.SaveScreenshot(BG.Bitmap, File.DirRootExternal, "Screenshot.PNG")
		If Filename.Length=0 Then
			tempstr.Append(API.GetString("prtscr_failure"))
		Else
			Try
				tempstr.Append(API.GetString("prtscr_success") & ":" & CRLF & Filename )
				If webview1.Visible Then
					Filename = LCARSeffects.SaveScreenshot(webview1.CaptureBitmap,File.DirRootExternal, "Browser.PNG")
					If Filename.Length>0 Then tempstr.Append(CRLF & API.GetString("prtscr_webview") & ": " & Filename )
				End If
				If LCAR.CurrentStyle <> LCAR.LCAR_TNG Then 
					tempstr.Initialize 
					tempstr.Append(LCAR.GetText(API.getstring("prtscr_screenshot"), "qawHaq") & ":" & CRLF & Filename )
				End If
			Catch
				tempstr.Initialize 
				tempstr.Append(API.GetString("prtscr_failure"))
			End Try
		End If
		LCAR.ToastMessage(BG, tempstr.ToString , 4)
	End If
End Sub










Sub SwapColor(ElementID As Int) As Int
	Dim temp As Int, Element As LCARelement 
	Element = LCAR.LCARelements.Get(ElementID)
	Select Case Element.ElementType 
		Case LCAR.LCAR_Textbox 
			temp = Element.Size.currY 
			Element.Size.currY =BorgFontSize
			BorgFontSize=temp
		Case LCAR.LCAR_Picture 
			temp = Element.LWidth 
			Element.LWidth = BorgPic
			BorgPic=temp
	End Select
	temp = Element.ColorID 
	Element.ColorID = LCAR.BORG_Color
	Element.IsClean = False
	LCAR.LCARelements.Set(ElementID,Element)
	LCAR.NumberWhiteSpace=0 
	LCAR.NumberTextSize=0
	Return temp
End Sub
Sub BorgSwap
	Dim ColorIDBuffer As Int, FontBuffer As Typeface 
	LCAR.IsClean=False
	
	If BorgSound = -1 Or BorgPic = - 1 Then
		BorgFontSize= 24
		BorgSound = LCAR.findsound("BORG")
		BorgPic = LCAR.LoadPicture("borg.gif", "")
		'BorgColor= LCAR.BORG_Color'LCAR.AddLCARcolor("BORG", 0, 120,0, 64)
	End If
	
	
	ColorIDBuffer=SwapColor(1)
	SwapColor(2)
	SwapColor(3)
	LCAR.BORG_Color=ColorIDBuffer
	
	FontBuffer = LCAR.LCARfont 
	LCAR.LCARfont = LCAR.BorgFont
	LCAR.BorgFont = FontBuffer

	SwapColor(0) '0 insignia	swap with borg insignia	
	needsborgswap=Not(needsborgswap)
	LCARSeffects2.ForcedNumber=-1
	LCAR.LightpackColor(-1, 0, API.IIF(needsborgswap, LCAR.BORG_Color, LCAR.LCAR_Orange), False,255)
End Sub
Sub BorgDone
	LCAR.LCAR_HideElement(BG, 0,False,False,False)
	LCAR.LCAR_HideElement(BG, 3,False,False,False) 
	LCAR.Stage=11
	'																											xoffset					yoffset
	LCAR.ForceElementData(1, LCAR.ScaleWidth/2 - LCAR.ItemHeight, LCAR.ScaleHeight/2 - LCAR.ItemHeight,       -LCAR.ScaleWidth/2,        -LCAR.ScaleHeight/2+ LCAR.ItemHeight, 			LCAR.ItemHeight*2, LCAR.ItemHeight,  LCAR.ScaleWidth, 0,255,255,True,True)
	LCAR.ForceElementData(2, LCAR.ScaleWidth/2 - LCAR.ItemHeight, LCAR.ScaleHeight/2 - LCAR.ItemHeight,       LCAR.ScaleWidth/2,        LCAR.ScaleHeight/2- LCAR.ItemHeight, 			LCAR.ItemHeight*2, LCAR.ItemHeight,  LCAR.ScaleWidth, 0,255,255,True,True)
End Sub	
Sub BorgStart
	LCAR.Stage=12
	LCAR.LCAR_HideAll(BG,True)
	If BorgElement = 0 Then BorgElement = LCAR.LCAR_AddLCAR("BORG",  0, 0, 0,-1,-1,  0,0,LCAR.BORG_Color, LCAR.LCAR_Borg,"","","", LCAR.LCARGroups.size , True, 0,False,0,255)
	LCAR.ForceShow(BorgElement, True)
End Sub











Sub AskStarshipName
	If Starshipname.Length=0 Then
		LCAR.SelectText(API.GetString("name_nouss"))
	Else
		LCAR.SelectText(Starshipname)
	End If
	LCARSeffects.ShowPrompt(BG,-10, API.GetString("name_title"), API.GetString("name_prompt"),2,API.GetString("kb_ok"), API.GetString("cancel"))
End Sub

Sub RenameStarship
	Dim tempstr As String ,doit As Boolean 
	tempstr=LCAR.GetInputText.trim.ToUpperCase 
	doit=True 
	Select Case tempstr
		Case "ENTERPRISE", "VOYAGER", "DEFIANT", "CONSTITUTION", "EXCELSIOR", "GALAXY", "INTREPID", "STARGAZER", "AMBASSADOR", "OBERTH", "RELIANT", "COLUMBIA", "EQUINOX", "GRISSOM", "PEGASUS","NEBULA","PROMETHEUS","SARATOGA", "SOVEREIGN", "SUTHERLAND", "V'GER" :doit=False
	End Select
	
	If StarshipID = "NX-01"  Or doit Then 
		Starshipname=tempstr
		LoadSettings(True)
		ShowStarshipID
	Else
		LCARSeffects.ShowPrompt(BG, 12, API.GetString("name_title"), API.GetString("name_creative"),  1, "OK", "NAME")
	End If
End Sub
Sub ShowStarshipID
	Dim tempstr As String 
	Select Case Round(API.GetDevicePhysicalSize)
		Case 0,1,2,3: 	tempstr = API.getstring("name_scout")
		Case 4,5: 		tempstr = API.getstring("name_light")
		Case 6,7: 		tempstr = API.getstring("name_heavy")
		Case Else: 		tempstr = API.getstring("name_dread")
	End Select
	tempstr= API.GetStringVars("name_text", Array As String(StarshipID)) & CRLF & API.IIF(Starshipname.Length =0, API.GetString("name_none"), API.GetStringVars("name_class", Array As String( API.Model(1), Starshipname.ToUpperCase))) & " (" & tempstr & ")"
	SetElement18Text(tempstr)
End Sub


Sub ResizeSetting(Items As Int)
	Dim temp As Int, Width As Int = 100, Y As Int = 200
	If LCAR.SmallScreen Then Width = 50
	If LCAR.CrazyRez>0 Then 
		Width=Width*LCAR.CrazyRez
		Y = LCAR.GetScaledPosition(3,False)
	End If
	If LCAR.GetListItemCount(19) =0 Then LCAR.LCAR_HideElement(BG, 19,True,False,True)
	If CurrentSection=-1 Then Return
	If Items=-999 And Not(LCAR.SmallScreen) Then
		'temp=(Activity.Width- API.IIF(LCAR.SmallScreen, 54,104))* 0.33
		LCAR.LCAR_HideElement(BG,4,True,False,True)
		'If LCAR.SmallScreen Then
		'	LCAR.resizeList(3, 0,0, temp, 54,100,True)
		temp=(Activity.Width-(Width+4))* 0.33
		LCAR.resizeList(3, 0,0, temp, 0,0,False)
	Else
		Select Case CurrentSection
			Case 23,31,35,38,41,42,49: Items=1
			Case Else:Items = LCAR.GetListItemCount(19)'side bar
		End Select
		If LCAR.SmallScreen Or BigOptions Then
			temp=(Activity.Width-Width-4)* 0.33
			LCAR.resizeList(3, 0,0, temp, Width+4,100,True)
			LCAR.resizeList(4, 0,-1 ,-1, Width+4,100,True)
		Else
			temp=(Activity.Width-104)* 0.33
			'temp=(Activity.Width-100-(LCAR.ChartSpace*2))* 0.25
			'LCAR.resizeList(3,  temp*3,-1, temp,0,0,False )
			If LCAR.IsListVisible(4) And LCAR.GetListItemCount(4) >0 Then
				LCAR.resizeList(3, -temp,-1, 0,0,0,False )
			Else
				LCAR.resizeList(3, -1,-1, temp,0,0,False )
			End If
			LCAR.resizeList(4, -1, -1, -1, -temp, 200,True) '100+LCAR.ChartSpace+ (temp*2), 200,  True )
		End If
		Select Case CurrentSection
			Case 23,35,42:	LCARSeffects.frameoffset=0
			Case Else: LCARSeffects.frameoffset=LCAR.ListItemsHeight(Abs(Items))
		End Select
		LCAR.ResizeList(19, Width+3, LCARSeffects.frameoffset, -1,0,0,False)
	'ShowFrame(False,True)
	End If
	LCARSeffects.MoveListY(3)
	LCARSeffects.MoveListY(4)
End Sub

Sub BrowseMySite(Page As String)As Boolean 
	Dim URL As String 
	If CurrentSection<> 999 Then
		LCAR.HideToast'("BrowseMySite")
		LCAR.SymbolsEnabled=True
		URL=MyURL & "lcars"	
		If Page.Length=0 Then 
			Return BrowseWeb(URL,0)'About 
		Else
			Return BrowseWeb(URL & "/" & Page, 0)
		End If
	End If
End Sub



Sub ShowGameBoard
	Games.PDP_ShowGameBoard(BG)
End Sub
Sub ShowSubSettings(Section As Int)
	CurrentSettingsSection=Section
	ShowSettings(False,True)
End Sub

Sub PuzzleSidebar
	Games.PDP_PuzzleSidebar(BG)
End Sub







Sub HandleAskQuestion(Title As String, Text As String, Default As String, MultiLine As Boolean)As Boolean 
	'lcar.ForceHideAll 
	'QuestionAsked=True
	LCAR.SelectText(Default)
	LCAR.SymbolsEnabled=True
	If MultiLine Then LCAR.ToggleMultiLine(True)
	LCARSeffects.ShowPrompt(BG,-10, Title, Text, API.iif(MultiLine,-9,9), API.GetString("kb_ok"), API.GetString("cancel"))
	LCAR.ToastMessage(BG, API.getstring("kb_pressback"), 2)
End Sub

Sub GetSettingID(Index As Int, Up As Boolean) As Double 
	Dim temp As Double 
	If Index<10 Then
		temp= (Index /10)
	Else If Index=10 Then
		temp= 0.01
	Else
		temp= (Index /100)
	End If
	If Up Then
		Return CurrentSettingsSection + temp
	Else
		Return CurrentSettingsSection - temp
	End If
End Sub
Sub GetSetting(ID As Int) As String 
	Return LCAR.LCAR_GetListItem(3,ID).Side 
End Sub

Sub MakeIcon(Make As Boolean)
	Dim Filename As String = GetSetting(1) & ".png", Dir As String = API.GetPackageDirDefaultExternal("com.omnicorp.lcarui.launcher"), CornerRadius As Int= GetSetting(0)
	Dim BG2 As Canvas, BG3 As Canvas , BMP As Bitmap, SRC As Bitmap , Dest As Bitmap , Color As Int , P As Path , X As Int, Y As Int ,Color2 As Int 
	LCAR.HideToast 'MakeIcon
	If File.Exists(Dir, Filename) Then 
		Log("CornerRadius = " & CornerRadius)
	'If Make Then
		SRC.Initialize(Dir, Filename)
		Color=SRC.GetPixel(0,0)
		
		BMP.InitializeMutable(SRC.Width,SRC.Height)
		Dest.InitializeMutable(SRC.Width,SRC.Height)
		BG2.Initialize2(BMP)
		LCAR.ActivateAA(BG2,True)
		
		LCAR.DrawCircle2(BG2, 0,0, CornerRadius,CornerRadius,  1, Color, False)'TL
		LCAR.DrawCircle2(BG2, SRC.Width-CornerRadius+1,0, CornerRadius,CornerRadius, 3, Color, False)'TR
		LCAR.DrawCircle2(BG2, 0, SRC.Height-CornerRadius+1, CornerRadius,CornerRadius, 7, Color,False)'BL
		LCAR.DrawCircle2(BG2, SRC.Width-CornerRadius+1,SRC.Height-CornerRadius+1, CornerRadius,CornerRadius,  9, Color, False)'BR
		
		'BG2.DrawCircle(CornerRadius,CornerRadius, CornerRadius, Color,True,0)'TL
		'BG2.DrawCircle(SRC.Width-CornerRadius,CornerRadius, CornerRadius, Color,True,0)'TR
		'BG2.DrawCircle(CornerRadius,SRC.Height-CornerRadius, CornerRadius, Color,True,0)'BL
		'BG2.DrawCircle(SRC.Width-CornerRadius,SRC.Height-CornerRadius, CornerRadius, Color,True,0)'BR
		
		P.Initialize(0,CornerRadius)
		P.LineTo(CornerRadius,CornerRadius)
		P.LineTo(CornerRadius,0)
		P.LineTo(SRC.Width-CornerRadius+1,0)
		P.LineTo(SRC.Width-CornerRadius+1,CornerRadius)
		P.LineTo(SRC.Width,CornerRadius)
		
		P.LineTo(SRC.Width,SRC.height-CornerRadius+1)
		P.LineTo(SRC.Width-CornerRadius+1,SRC.height-CornerRadius+1)
		P.LineTo(SRC.Width-CornerRadius+1,SRC.height)
		P.LineTo(CornerRadius,SRC.height)
		P.LineTo(CornerRadius,SRC.height-CornerRadius+1)
		P.LineTo(0,SRC.height-CornerRadius+1)
		
		BG2.ClipPath(P)
		LCARSeffects4.DrawRect(BG2, 0,0, SRC.Width,SRC.Height, Color,0)
		BG2.RemoveClip 
		

		BG3.Initialize2(Dest)
		For Y = 0 To SRC.Height-1
			For X = 0 To SRC.Width-1
				Color2=BMP.GetPixel(X,Y)
				If Color2=Color Then  Color2=SRC.GetPixel(X,Y)
				BG3.DrawPoint(X,Y,Color2)
			Next
		Next
		'BG2.DrawBitmap(SRC, Null, LCARSeffects4.SetRect(0,0, SRC.Width,SRC.Height))
		
		
		LCARSeffects.SaveImage(Dest, File.DirRootExternal,Filename, False) 
		LCAR.ToastMessage(BG, Filename & " saved", 2)
	'Else If File.Exists(File.DirRootExternal,Filename) Then
		API.OpenFile(File.Combine(File.DirRootExternal,Filename))
	'Else
	'	LCAR.ToastMessage(BG, Filename & " not made yet", 2)
	End If
End Sub

Sub SeedSecondList(Start As Int, Finish As Int)
	Dim Items As List, temp As Int 
	Items.Initialize 
	For temp = Start To Finish 
		Items.Add(temp)
	Next
	LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Items)
End Sub
Sub MaxItem(Index As Int, Low As Int, High As Int) 
	Dim Item As LCARlistitem = LCAR.LCAR_GetListItem(3, Index)
	If IsNumber(Item.Side) Then
		If Item.Side < Low Then	Item.side = Low
		If Item.side > High Then Item.side = High
		Item.IsClean = False
	End If
End Sub


Sub SettingsArray(Index As Int) As List 
	Return API.GetStrings("strings_" & Index & "_", 0)
End Sub

Sub StartNardiAutomatic(Time As String)
	Dim Seconds As Int = API.ToSeconds(Time), Wallpaper As String = SelectedLWP("NNN"), Filename As String = SaveLWPsetting("FIL", "", True)
	If Time.Contains("volume") Then 
		Dim Command() As String = Regex.Split(" ", Time), tempstr As String = GetWordRelative(Command, "volume", 0, True, "")
		Select Case tempstr
			Case "quarter": tempstr = "25%"
			Case "half": tempstr = "50%"
			Case "full": tempstr = "100%"
		End Select
		If API.right(tempstr, 1) = "%" And IsNumber(tempstr.Replace("%", "")) Then LCAR.Volume( tempstr.Replace("%", ""), True)
	End If
	StartNardi(Seconds, Wallpaper, SaveLWPsetting("KSO", True, True), SaveLWPsetting("KSB", True, True), Filename)
End Sub
Sub StartNardi(Seconds As Int, Wallpaper As String, KeepScreenOn As Boolean, KeepScreenBright As Boolean, Filename As String)
	Dim P As PhoneWakeState, Error As String, Errors As List 
	If Wallpaper = "NONE" Or Wallpaper = "" Or Filename = "" Or Seconds < 1 Then 
		PlayError
		
		Errors.Initialize
		If Wallpaper = "NONE" Or Wallpaper.Length=0 Then Errors.Add(API.getstring("nardi_screen"))
		If Seconds < 1 Then Errors.Add(API.getstring("nardi_duration"))
		If Filename.Length=0 Then Errors.Add(API.getstring("nardi_sound"))
		Error = API.GetStringVars("nardi_missing", Array As String(API.CommaDelimit(Errors), API.GetString(API.IIF(Errors.Size = 1, "nardi_one", "nardi_multi"))))
		
		LCAR.ToastMessage(BG, Error, 2)
	Else
		CurrentSection = 78
		WallpaperService.WasFromMainmenu=True
		Filename = Filename & ".mp3"
		Log("STARTNARDI " & Seconds & " " & Wallpaper & " " & KeepScreenOn & " " & KeepScreenBright & " " & Filename)
		If KeepScreenOn Then 
			API.NewTimer("NNN", 6, Seconds)
			P.KeepAlive(KeepScreenBright)
		End If 
		PreviewLWPname(Wallpaper)
		If Filename.Length>0 And Not(Filename.EqualsIgnoreCase("NONE")) Then 
			LCAR.PlaySoundFile(LCAR.DirDefaultExternal, Filename, True)
			'DownloadAndPlay(Filename, 1)
			LCAR.DontCancel = True 
		End If 
	End If 
End Sub
Sub NNdownload(Filename As String)
	If Not(NNsoundexists(Filename)) And API.IsConnected Then API.Download("file", "http://www.trekcore.com/audio/background/" & Filename & ".mp3")			
End Sub
Sub NNsoundexists(Filename As String) As Boolean 
	Return Filename.EqualsIgnoreCase("NONE") Or File.Exists(LCAR.DirDefaultExternal, Filename & ".mp3") Or File.Exists(LCAR.DirDefaultExternal, Filename & ".ogg")
End Sub
Sub LoadNNsounds(Section As Int) As List 
	Dim Sounds As List, temp As Int, tempstr As String  
	Select Case Section 
		Case 0'ERAs
			Sounds = Array As String("TOS1", "TOS2", "TOS3", "TOS4", "TNG1", "TNG2", "DS9", "VOY")
		Case 1'files
			Sounds.Initialize
			Sounds.Add("NONE")
			Select Case SaveLWPsetting("ERA", "TNG1", True)
				Case "TOS1": Sounds.AddAll(Array As String("tos_bridge_1_activate", "tos_bridge_2", "tos_bridge_3", "tos_bridge_4", "tos_bridge_5", "tos_bridge_6", "tos_bridge_7", "tos_bridge_8_powerup", "tos_bridge_9", "tos_bridge_battle"))
				Case "TOS2": Sounds.AddAll(Array As String("tos_bridge_pike", "tos_bridge_season_3", "tos_bridge_viewscreen_fast", "tos_bridge_viewscreen_slow", "tos_briefing_room", "tos_computer_room_1", "tos_computer_room_2", "tos_corridor_1", "tos_corridor_2", "tos_corridor_3"))
				Case "TOS3": Sounds.AddAll(Array As String("tos_engineering_1", "tos_engineering_2", "tos_engineering_3", "tos_engineering_4", "tos_power_room_1", "tos_power_room_2", "tos_power_room_3", "tos_ship_hum_1", "tos_ship_hum_2", "tos_shuttle_tones"))
				Case "TOS4": Sounds.AddAll(Array As String("tos_shuttlecraft_interior_1", "tos_shuttlecraft_interior_2", "tos_space_wind", "tos_starbase_background", "tos_transporter_room", "tos_transporter_room_2"))
				Case "TNG1": Sounds.AddAll(Array As String("tng_bridge_1", "tng_bridge_2", "tng_bridge_3", "tng_brig", "tng_brig_2", "tng_cargobay", "tng_commandcenter", "tng_data_room", "tng_engine_1", "tng_engine_2"))
				Case "TNG2": Sounds.AddAll(Array As String("tng_engineering_hum", "tng_hum_clean", "tng_jeffreystube", "tng_lab", "tng_room", "tng_room_2", "tng_sickbay", "tng_sickbay_2"))
				Case "DS9": Sounds.AddAll(Array As String("ds9_infirmary", "ds9_opps", "ds9_promenade"))
				Case "VOY": Sounds.AddAll(Array As String("voy_astrometrics", "voy_bridge", "voy_engineering", "voy_relativity_bridge", "voy_core_1", "voy_core_2", "voy_core_3", "voy_core_4"))
			End Select
			If Not(API.IsConnected) Then 
				For temp = Sounds.size - 1 To 0 Step - 1
					If Not(NNsoundexists(Sounds.get(temp))) Then Sounds.RemoveAt(temp)
				Next
			End If
	End Select 
	LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random, 0, Sounds)
	If Section = 1 Then 
		For temp = 0 To Sounds.size - 1  
			tempstr = Sounds.Get(temp)
			If Not(tempstr.EqualsIgnoreCase("NONE")) Then 
				tempstr = API.uCase(API.right(tempstr, tempstr.Length - 4)).Replace("_", " ")
				LCAR.LCAR_SetListitemText(4, temp, tempstr, Sounds.Get(temp))
			End If 
		Next
	End If
	Return Sounds 
End Sub

Sub SettingsRange(Start As Int, Finish As Int, Increment As Int, ForcedDigits As Int) As List 
	Dim temp As Int, Items As List, tempstr As String
	Items.Initialize
	For temp = Start To Finish Step Increment 
		tempstr = temp 
		If ForcedDigits>0 Then tempstr = API.PadtoLength(tempstr, True, ForcedDigits, "0")
		Items.Add(tempstr)
	Next
	Return Items 
End Sub
Sub HandleSettings(Index As Int, ListID As Int) As Boolean 
	Dim SettingID As Double ,Value As Boolean,TextValue As String , tempitem As LCARlistitem , ShowList As Boolean 
	If CurrentSettingsSection>=0 Then'above -1, this is the settings section
		SettingID=GetSettingID(Index,True)
		ShowList=True
	Else
		Select Case CurrentSettingsSection
			Case -1, -2, -5, -11,-12,-13,-14,-15,-17,-18,-19,-22,-24,-32,-33,-35'these items can still have a side bar
			Case Else:	HideSideBar'these items cannot
		End Select
		'Msgbox(CurrentSection,"SECTION")
		Select Case CurrentSettingsSection
			Case -1, -2, -4, -5, -12, -13, -15,-16,-18,-21,-22,-26,-28, -32, -33, -36, -37, -38'show only currsection, not index of item. Add at ShowSettings too
				SettingID=CurrentSettingsSection
			Case Else'current section.index of item				
				SettingID=GetSettingID(Index,False)
		End Select
		Select Case CurrentSettingsSection'these sections below 0 can show the sub list
			Case -1, -2,-3, -5,-6, -7, -10,-11,-16,-17,-18,-19,-20,-22,-23,-24,-26,-27,-28,-29,-31,-32, -33, -34,-35,-36,-37, -38:ShowList=True
		End Select
	End If
	'Msgbox(SettingID, "SettingID")
	If ListID =3 Then'main list
		LCAR.HideToast 'HandleSettings
		LCAR.LCAR_ClearList (4,0)
		'lcar.forceshow(18,True)
		'lcar.LCAR_SetElementText( 18, lcar.LCAR_GetListItem(event.Index, event.Index2).Tag, "")
		If Index>-1 Then
			tempitem=LCAR.LCAR_GetListItem(ListID, Index)
			Select Case CurrentSettingsSection 
				Case -16,-36'dont show the tag for these items
				Case Else: SetElement18Text(tempitem.Tag)
			End Select
			'AA,Mute,UseMic
			SelectedSetting=SettingID
			SettingIndex=Index
						
			Select Case SettingID
				Case -1
					Select Case Games.PDP_HandleSettings(BG, 3,Index) 
						Case 1: ShowSettingsSection(-1)	
						Case 2: Return
					End Select
				
				Case -2
					ShowList = Tropes.HandleSetting(ListID, SettingIndex)
				
				Case -3.0'time selector
					LoadTimers(0)
					ShowTimer(API.GetTimer("Main").Length>0)
				Case -3.4: LoadNNsounds(0)'ERA
				Case -3.5: LoadNNsounds(1)'sounds
				
				Case -4'NFC tags
					ShowList=HandleAskQuestion(API.GetString("nfc_action"), API.getstring("nfc_vrec"), tempitem.TAG, False) 
				
				Case -5'File explorer
					ShowList = HandleDIRmenu(3, Index)
					
				'Dr. Pulaski
				Case -6.0:			LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsRange(0,20,1,2))'virus level
				Case -6.1:			LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Games.DrP_VirusDifficultyString(-1))'virus difficulty	
				Case -6.3, -6.4: 	LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random, 0, Array As String("OK"))'virus difficulty	
				
				'Bridge
				Case -7.0:			LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsList("-7.0"))'cardassian keytone
				Case -7.2:			LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsRange(1,10,1,0))' Array As Int(1,2,3,4,5,6,7,8,9,10))
				Case -7.3:			LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, API.getstrings("sec_64_", 0))'TOS
				Case -7.4:			LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, API.getstrings("sec_66_", 0))'NX-01
				Case -7.5:			LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, API.getstrings("sec_89_", 0))'TMP
					
				Case -10.0'FPS
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("0", "1", "2", "4", "8", "16", "32", "64") )'zoom
				Case -3.1, -10.1, -20.0'Screens
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, LWPLIST)'zoom
					ShowList=True
				Case -10.2: LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0,SettingsArray(0) )'alert condition status
					
				'-10.2=red alert
				Case -10.3'Select MSDs
					'LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("LIST OF MSDs") )'zoom
					ShowMSDs(4,False)
				Case -10.4'Download MSDs from http://sites.google.com/site/programalpha11/home/lcars
					If API.IsConnected  Then
						If API.ListSize(WallpaperService.MSDList)>0 Then' WallpaperService.MSDList.IsInitialized Then
							ShowMSDs(4,True)
						Else
							ShowMSDs(-1,False)
							'SetElement18Text("DOWNLOADING MSD LIST")
							'HttpUtils.Download("MSDS", "http://sites.google.com/site/programalpha11/home/lcars")
						End If
					Else
						LCAR.ToastMessage(BG, API.getstring("no_connection"), 3)
					End If
				Case -10.5, -10.6, -10.7, 0.9, 0.01 'Top/Bottom Overscan portrait/landscape, 
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsRange(0, 100, 5, 0))' Array As String("0", "5", "10", "15", "20", "25", "30", "35", "40", "45", "50", "55", "60", "65", "70", "75", "80", "85", "90", "100") )'zoom
				Case -10.9,-10.01,-29.5'OPEN
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.GetString("open")))
				Case -10.11'FORCED SCROLLING
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("disabled"), API.getstring("passive"), API.getstring("aggressive")))
				Case -10.13'DARKNESS
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsRange(0,192,16,0))' Array As Int(0, 16,32,48,64,80,96,112,128,144,160,176,192))
				
				Case -11.0'degree mode
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Eval.EnumStrings(-1))
				Case -11.1'insert var type'EnumType	
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Eval.EnumStrings(-2))
				Case -11.2'variable name	
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Eval.EnumStrings(Eval.EnumType))
				Case -11.3'insert variable
					tempitem = LCAR.LCAR_GetListItem(3,2)
					If tempitem.Side.Length>0 Then
					'If LCAR.LCAR_GetSelectedItem(3)>-1 Then
						If Eval.EnumType<5 Then'variable/const
							If tempitem.Side.Length>0 Then
								LCAR.InsertText( tempitem.Side )	
								ShowSettings(False,True)
							End If
						Else'function
							Eval.PushSubOntoStack( tempitem.Side  )
							ShowSection12(12)
						End If
					End If
					ShowList=False
				Case -11.4'edit variables
					ShowSection12(13)
					ShowList=False
				Case -11.5'show sub
					ShowSection12(12)
					ShowList=False
				Case -12'calculator
					Select Case Index
						Case 0'insert the sub into the prev item in the stack
							Eval.PullStackItem(True)
							If Eval.VarStack.Size=0 Then
								HandleCalc(19,0)
							Else
								ShowSection12(12)
							End If
						Case 1'remove from stack without processing
							Eval.PullStackItem(False)
						Case Else'set variable
							Eval.SetStackItem(-1,-1, Index-2)
							tempitem = LCAR.LCAR_GetListItem(3, Index)
							If tempitem.Tag=2 Then'Boolean
								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Eval.EnumStrings(-7) )
							Else
								AskQuestion(1, Index, tempitem.Tag=0)
							End If
							Eval.DoHelp(BG, Eval.VarStack.Get(Eval.VarStack.Size-1)   , Index-2)
					End Select
				Case -13 'variable editor
					LCAR.LCAR_ClearList(4,0)
					Select Case Index
						Case 0:LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("log_side1"), API.getstring("new")) )'edit mode
						Case 1:'variable type
							LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Eval.EnumStrings(-4) )'select variable type
						Case 2:'variable name
							If Eval.IsEditing Then
								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Eval.EnumStrings(Eval.MapVariableType(Eval.CurrentVar.varType )))
							Else
								AskQuestion(3,2,False)
							End If
						Case 3:'save
							If Eval.isvalidvar( Eval.CurrentVar,False) Then
								If Eval.IsEditing Then
									Eval.VarList.Set(Eval.VarIndex, Eval.CopyVar( Eval.CurrentVar))
								Else
									Eval.Val(Eval.SaveVar(Eval.CurrentVar))
								End If
								Eval.VarIndex=-1
								'ShowSection(24,False)
								HandleCalc(19,0)
								LCAR.ToastMessage(BG, Eval.SaveVar(Eval.CurrentVar), 3)
								Eval.CurrentVar.Initialize 
							Else
								LCAR.ToastMessage(BG, Eval.EvalError.ToUpperCase, 4)
							End If
						Case 4:LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Eval.EnumStrings(-6) )'delete
						Case 5
							If Eval.CurrentVar.varType = Eval.ch_routine Then
								AskQuestion(3,5,False)
							Else	
								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Eval.EnumStrings(-6) )'is a constant
							End If
						Case 6'add a value
							Eval.AppendValue(Eval.CurrentVar)
							ShowSection12(13)
						Case Else: 
							If Eval.CurrentVar.varType = Eval.ch_boolean Then
								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("true"), API.getstring("false"), API.getstring("auto_delete")))
							Else
								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("log_side1"), API.getstring("auto_delete")) )'edit a value/parameter
							End If
					End Select
					ShowList = LCAR.GetListItemCount(4)>0
					
				Case -14.0 'parameter name
					AskQuestion(4,0,False)
				Case -14.1 'parameter type
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Eval.EnumStrings(-5))
					ShowList=True
				Case -14.2 'parameter default value
					If Eval.CurrentPar.varType = Eval.ch_boolean Then
						LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Eval.EnumStrings(-7) )
						ShowList=True
					Else
						AskQuestion(4,1, Eval.CurrentPar.varType = Eval.ch_numeric)
					End If
				Case -14.3 'save parameter	
					Eval.CurrentVar.Values.Set(Eval.ParIndex, Eval.CopyPar(Eval.CurrentPar))
					Eval.CurrentPar.Initialize 
					Eval.ParIndex=-1
					ShowSection12(13)
				Case -14.4:'delete parameter	
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Eval.EnumStrings(-6) )
					ShowList=True 
				
				Case -15'something to do with sensors?
					ShowList=Index=0
					If ShowList Then LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, GetSensors)
					
				'Case -17.0
				'	LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("EXECUTE"))
				Case -17.0
					ShowList=HandleAskQuestion(API.getstring("name_yours"), API.getstring("name_yours_prompt"), YourName.ToUpperCase, False)
				Case -17.4
					ShowList=API.CountryList(4)
				Case -17.5'purge
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, API.getstrings("purge",0))
				Case -17.7'orientation
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, API.getstrings("orient",0))
				
				Case -18
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("log_side1"), API.getstring("auto_delete")))'zoom
				
				Case -19.0, -19.1, -19.2, -19.3, -19.4, -19.5,-19.7
					tempitem= LCAR.LCAR_GetListItem(3, LCAR.LCAR_SelectedItem)
					ShowList=HandleAskQuestion( tempitem.Text , tempitem.Tag, tempitem.Side, False) 
				Case -19.01:						LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsRange(5,60,5,0))' Array As String("5","10","15","20","25","30","35","40","45","50","55","60") )'zoom
				Case -19.11:						LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("0","10","20","30","40","50","100") )'zoom
				
				'lockscreen/daydream
				Case -20.5:							LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As Int(0, 5, 10, 15, 30, 45, 60, 120, 180, 240, 300, 360, 3600))
				
				Case -21.0'alarms main
					CurrentSettingsSection=-22
					SeedSideBar(Array As String(API.getstring("kb_cancel"),API.getstring("auto_save"),API.getstring("kb_delete")), False,True)
					SetElement18Text(API.LoadAlarm(Index,3))
					
				Case -22.0'alarms view/edit
					Select Case Index
						Case 0,3,8,9,10,11,12,13,14:	LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("enabled"), API.getstring("disabled")))
						Case 1:							LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsRange(0,23,1,0))'Array As Int(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23))'hour
						Case 2
							If API.debugmode Then AddDebugMinutes
							LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random, 0, SettingsRange(0,55,5,2))'Array As String("00", "05","10","15","20","25","30","35","40","45","50","55"))'minute
						Case 4:							LCAR.EnumSounds(4)'sound id
						Case 5:							LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, API.getstrings("alarm_type",0))'action
						Case 6,7:						LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("0", "1","2","5","10","15","20","25","30"))
						Case 15:						ShowList=HandleAskQuestion(API.getstring("alarm_title"), API.getstring("alarm_prompt"), API.CWA.text, False)
						
						Case Else: LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("TEST", "test2", "test3") )'zoom
					End Select
			
				'security
				Case -23.0:								
						LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("log_side1")))'set password
						ShowList=True
				Case -23.2:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("calc_clear")))'clear autodestruct password
				
				'widgets
				Case -24.0:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Widgets.mAppWidgetIdList)  'widget ids		
				Case -24.1:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, LCARSeffects3.WidgetTypes) 'widget types
				Case -24.2: 							LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("32", "64", "96", "128", "160", "192", "224", "255") )'alphas
				Case -24.4:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("1","2","5","10","15","20","25","30", "40", "50", "60"))'delays
				Case -24.5:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String( WidgetMode(0), WidgetMode(1), WidgetMode(2)))'widget update mode
				Case -24.8:								API.EnumApps(4, "audio/mpeg", "[" & API.getstring("all") & "]", True, True)'media players
				
				'Size quick menu
				Case -25.0: 							API.ModifySize(BG, True,False): SetScaleFactor(0, False)	'INCREASE LCARS SIZE
				Case -25.1: 							API.ModifySize(BG, True,True): 	SetScaleFactor(0, False)	'INCREASE FONT SIZE
				Case -25.2:								SetScaleFactor(1, False)		'INCREASE SCALE FACTOR
				Case -25.3:								SetScaleFactor(-1, False)		'DECREASE SCALE FACTOR
				Case -25.4: 							API.ModifySize(BG, False,True): SetScaleFactor(0, False)	'DECREASE FONT SIZE
				Case -25.5: 							API.ModifySize(BG, False,False):SetScaleFactor(0, False)	'DECREASE LCARS SIZE
				
				Case -26.0'Klingon
					Select Case Index
						Case 0:							ShowList=HandleAskQuestion(API.getstring("bing_title"), API.getstring("bing_prompt"), "", False)'text
						Case 1: 						Translator.SeedLanguages(4,True) 'input lang
						Case 2:							Translator.SeedLanguages(4,False)'output lang
						Case Else:						SpeakKlingon(3,Index)
					End Select

				'Weather
				Case -27.0: 							LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Weather.PossibleValues(0))'units
				Case -27.1: 							LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Weather.PossibleValues(1))'hours
				Case -27.2:								ShowList=HandleAskQuestion(API.getstring("weat_title"), API.getstring("weat_prompt"), Weather.CurrentCity.ToUpperCase, False)'City
				Case -27.3:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Weather.PossibleValues(2))'providers

				'3D Board games
				Case -28
					If Index = 7 Then'resume
						LCAR.LCAR_HideAll(BG, False)
						Games.ThD_CanResume(True)		
						Return
					Else
						LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Games.ThD_Strings(Index, GetSetting(1),GetSetting(0)))'game
					End If
		
				'debug menu
				Case -29.2:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsList("29.2"))'toast style
				Case -29.4:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("RESTART", "SHUTDOWN"))'API.Shutdown(False)
				
				'lightpack 
				Case -30.0'ip.port
					LCAR.LCAR_HideAll(Null, False)
					ServerIP = API.ParseIP( Settings.Get("lightpackip"))
                    LCAR.ShowNumBoard(BG, ServerIP)
					Return
				Case -30.1'password
					ShowList=HandleAskQuestion(API.getstring("lpack_title"), API.getstring("pass_prompt"), Settings.Get("lightpackpass"), False)
				
				'icon modifier
				Case -31.0:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsRange(0,30,2,0))'Array As Int(0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20,  22, 24, 26, 28, 30) )'corner radius
				Case -31.1:								LCAR.EnumFiles(4, API.GetPackageDirDefaultExternal("com.omnicorp.lcarui.launcher"), ".png")
				Case -31.2: 							LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("MAKE"))
				
				'Reminders
				Case -32: 								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("auto_delete")))
				
				'Educational mode
				Case -33:								ShowList = HandleEducationalSetting(3, Index)
				
				'Date picker
				Case -34.0:								SeedSecondList(1, LCARSeffects3.GetDaysInMonth(DatePicker(0,-2), DatePicker(0,-3))) 'day
				Case -34.1:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, LCARSeffects3.GetMonths) 'month
				Case -34.2:								SeedSecondList(18,24)'20XX
				Case -34.3, -34.4:						SeedSecondList(0,9) 'XX1X, XXX4
				Case -34.5:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("kb_ok")))
				
				'Unit conversion
				Case -35.0:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Trig.UnitList(-1))'unit type
				Case -35.1:								ShowList=AskKBorNUM
				Case -35.2,-35.3:						LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Trig.UnitList(LCAR.lcar_getlistitemtext(3,0,1)))'input/output unit
				Case -35.4:								
					ShowList=False
					ConvertUnits(-1)
				
				'APK Installer
				Case -36:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("apk_download")))'unit type
				
				'Card games
				Case -37:								Games.CARD_HandleOptions(BG, 3,Index)
				
				'PHOTO WIDGET
				Case -38:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("photo_remove")))'unit type
				
				'Settings
				'GUI
				Case 0.1:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsRange(0,API.MaxZoomFactor,1,0))'Array As String("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10") )'zoom
				Case 0.4:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, GetScalemode(True))
				Case 0.5:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("50%", "55%", "60%", "65%", "70%", "75%", "80%") )'text size
				Case 0.8:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("0", "90", "180", "270"))
				Case 0.12:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsArray(0))'alert condition
				Case 0.14:								ShowNumberEntry(False, API.RealHeight)
				Case 0.15:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, API.EnumLanguages)
				
				'SND
				Case 1.0:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("0%", "10%", "20%", "30%", "40%", "50%", "60%", "70%", "80%", "90%", "100%") )'volume
				Case 1.2:	  							LCAR.EnumSounds(4) 'soundtest
				Case 1.3:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("kb_copy"), API.getstring("set_ringtone"), API.getstring("set_alarm"), API.getstring("set_notif")))
				Case 1.4:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, BeepModes)' Array As String("DISABLED", "RANDOM", "TONE 1", "TONE 2", "TONE 3", "TONE 4", "TONE 5", "TONE 6"))
				Case 1.5:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("ignore"), API.getstring("vrec")))
				Case 1.7:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsRange(0,1000,50,4))
					
				'ACT
				Case 2.2:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsList("2.2"))'Intro
				Case 2.4:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("off"), "25", "50", "75", "100", "125", "150") )'rumble
				Case 2.9:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, API.SearchProviders)'Search providers						
				Case 2.11:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsList("2.11"))'Notification widgets
				Case 2.13:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, SettingsList("2.13"))'screen orientation
				Case 2.14:								LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, API.getstrings("datemode_", 0))'date mode 

				Case 2.6, 3.0,3.1,3.2,-16,-24.3
														LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("open")))
														ShowList=True
				'MISC
				Case 3.3: ShowStarshipID:				LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(API.getstring("rename"), API.getstring("magic")))
				
				Case Else
					Select Case CurrentSettingsSection '.SettingIndex
						Case 25'language
							If SettingIndex > 6 Then 
								API.LoadTranslation(tempitem.Text)
								LoadTranslation
							End If
						Case Else 
							LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String(BoolToText(True), BoolToText(False)) )'boolean values
							ShowList=True
					End Select
			End Select
			If ShowList Then
				LCAR.LCAR_FindListItem(4, tempitem.Side, 0,False,-2)
				ShowSideList(Index)
			End If
		End If
	Else If ListID=4 Then'side list
		If Index>-1 Then'
			LCAR.HideToast'("Handlesettings")
			TextValue=LCAR.LCAR_GetListItem(4,Index).Text
			LCAR.ToastMessage(BG,LCAR.LCAR_GetListItem(3,SettingIndex).Text & " = " & TextValue, 3)
			
			Value=Index=0
			Select Case SelectedSetting
				Case -16
				Case Else:	LCAR.LCAR_SetListitemText(3, SettingIndex, LCAR.LCAR_IGNORE, LCAR.LCAR_GetListitemText(4,Index,0))
			End Select
			Select Case SelectedSetting	
				Case -1:'pdp
					If Games.PDP_HandleSettings(BG, 4,Index) = 1 Then ShowSettingsSection(-1)					
				Case -2:
					Tropes.HandleSetting(ListID, Index)
				
				'Nardi noise nnaker	
				Case -3.1: SaveLWPsetting("NNN", Index,False)'Selected screen
				Case -3.2: SaveLWPsetting("KSO", Value,  False)'keep screen on
				Case -3.3: SaveLWPsetting("KSB", Value,  False)'keep screen bright	
				Case -3.4: SaveLWPsetting("ERA", TextValue,  False)'era 
				Case -3.5'sound file
					SaveLWPsetting("SND", TextValue,  False)
					TextValue = LCAR.LCAR_GetListItem(4,Index).Tag
					SaveLWPsetting("FIL", TextValue,  False)
					NNdownload(TextValue)
				
				Case -5'file explorer
					HandleDIRmenu(4, Index)
					
				'Dr. Pulaski
				Case -6.0: 			Games.DrP_VirusLevel = Index
				Case -6.1: 			Games.DrP_VirusDifficulty = Index 
				Case -6.2: 			Games.DrP_Motion = Value 
				Case -6.3, -6.4	
					LCAR.ForceHideAll(BG)
					SeedSideBar(Array As String("PSE"), False, True)
					Games.DrP_StartGame(113, SelectedSetting = -6.3)
					If Games.DrP_Motion Then Listen(True)
					Return False
					
				'Bridge 
				Case -7.0:			Wireframe.CardassianKeytone=Index'Cardassian Keytone
				Case -7.1:			ShowSubBridges = Value
				Case -7.2:			SaveLWPsetting("PAN", TextValue, False)
				Case -7.3:			SaveLWPsetting("TOS", Index, False)
				Case -7.4:			SaveLWPsetting("NX1", Index, False)
				Case -7.5:			SaveLWPsetting("TMP", Index, False)
					
				'Live Wallpaper
				Case -10.0: 'refresh rate
					If Index=0 Then 
						SaveLWPsetting("FPS", 0, False)
					Else
						SaveLWPsetting("FPS", Round(Power(2, Index-1)),False)
					End If
				Case -10.1: 	SaveLWPsetting("SCR", Index,False)'Selected screen
				Case -10.2: 	SaveLWPsetting("ALERT", Index,False)'red alert mode
				Case -10.3'select MSD
					SaveLWPsetting("MSD", LCAR.LCAR_GetListItem(4,Index).Tag ,False)
				Case -10.4'Download MSD
					If Index=0 Then
						WallpaperService.MSDList.Clear 
						ShowMSDs(-1,False)
					Else If API.IsConnected And Not(IsLoading) Then
						tempitem=LCAR.LCAR_GetListItem(4,Index)
						LCAR.Toastmessage(BG, API.getstring("umr_downloading"), 2)
						API.Download("MSD", tempitem.Tag)
						IsLoading=True
						WallpaperService.MSDList.RemoveAt( WallpaperService.MSDList.IndexOf(tempitem.Tag))
						LCAR.LCAR_RemoveListitem(4,Index)
					Else
						LCAR.ToastMessage(BG, API.getstring("downloading_already"), 3)
					End If
				Case -10.5:		SaveLWPsetting("TOP", Index*5,False) 'top overscan
				Case -10.6:		SaveLWPsetting("BOT", Index*5,False) 'bottom overscan portrait
				Case -10.7:		SaveLWPsetting("LND", Index*5,False) 'bottom overscan landscape
				Case -10.8:		SaveLWPsetting("SCL", Value,  False)'scale mode
				Case -10.9: 	API.LWPselector'live wallpaper selector
				Case -10.01: 
					'LCAR.LCAR_HideAll(BG,False)
					WallpaperService.WasFromMainmenu=False
					PreviewLWP(-1)
					Return False 
				Case -10.11: 	SaveLWPsetting("FSM", Index,False)
				Case -10.12: 	LCAR.LWPUnlocked= Value
				Case -10.13:	SaveLWPsetting("DRK", TextValue,False)
					
				'Calc
				Case -11.0'degree mode
					Eval.AngleMode = Index
				Case -11.1'var type
					Eval.EnumType = Index
					tempitem = LCAR.LCAR_GetListItem(3,2)
					tempitem.Side= ""
				
				'Calc
				Case -13
					Select Case SettingIndex
						Case 0:'edit mode
							Eval.IsEditing = Value
							Eval.CurrentVar.Initialize 
							ShowSection12(13)
						Case 1:'variable type
							Eval.CurrentVar.Initialize 
							tempitem = LCAR.LCAR_GetListItem(4,Index)
							If Index<5 Then
								Eval.CurrentVar.varType = Eval.GetVarType( tempitem.Text  )
							Else
								Eval.CurrentVar.varType = Eval.ch_custom 
								Eval.CurrentVar.Equation =  tempitem.Text  						
							End If
							ShowSection12(13)
						Case 2:'variable name
							tempitem = LCAR.LCAR_GetListItem(4,Index)
							Eval.CurrentVar = Eval.CopyVar( Eval.GetVariableData( tempitem.Text, 0,False,0))
							Eval.VarIndex = Eval.FindVariable(tempitem.Text, 0,False,0)
							ShowSection12(13)
						'Case 3:'save. no sub options
						Case 4:'delete
							If Value Then
								If Eval.IsEditing Then
									Eval.DeleteVariable(Eval.VarIndex)
								Else
									Eval.CurrentVar.Initialize 
								End If
								Eval.VarIndex=-1
								HandleCalc(19,0)
								'ShowSection(24,False)
							End If
						Case 5:'is a constant
							Eval.CurrentVar.isConst = Value
						'Case 6:'add a value. no sub options
						Case Else: '(starts at 7) edit a value/parameter
							If Eval.CurrentVar.varType = Eval.ch_boolean Then
								If Index = 2 Then
									If Not (Eval.DeleteValue(Eval.CurrentVar, SettingIndex-7)) Then
										LCAR.ToastMessage(BG, API.getstring("delete_failed"), 3)
									Else
										ShowSection12(13)
									End If
								Else
									Eval.SetValue(Eval.CurrentVar, SettingIndex-7 , Value)
								End If
							Else If Value Then 'edit
								If Eval.CurrentVar.varType = Eval.ch_routine Then
									Eval.ParIndex = SettingIndex-7
									Eval.CurrentPar = Eval.copypar( Eval.CurrentVar.Values.Get(Eval.ParIndex) )
									ShowSection12(14)
								Else
									AskQuestion(3, SettingIndex, Eval.CurrentVar.varType = Eval.ch_numeric)
								End If
							Else'delete
								If Not (Eval.DeleteValue(Eval.CurrentVar, SettingIndex-7)) Then
									LCAR.ToastMessage(BG, API.getstring("last_failed"), 3)
								Else
									ShowSection12(13)
								End If
							End If
							
					End Select
				
				'Calc
				Case -14.1'parameter type
					tempitem = LCAR.LCAR_GetListItem(3,1)
					Eval.CurrentPar.varType = Eval.GetVarType(tempitem.Side)
					Eval.CurrentPar.Default=""
				Case -14.4'delete parameter
					If Value Then
						If Not(Eval.DeleteValue(Eval.CurrentVar, Eval.ParIndex)) Then
							LCAR.ToastMessage(BG, API.getstring("last_failed"), 3)
						End If
						ShowSection12(13)
					End If
				
				'Raw sensor data
				Case -15
					If SettingIndex = 0 Then
						CurrentSensor2=Index
						ResizeSetting(-999)
						LCAR.LCAR_SetListitemText(3, 1, LCAR.LCAR_IGNORE, "0")
						LCAR.LCAR_SetListitemText(3, 2, LCAR.LCAR_IGNORE, "0")
						LCAR.LCAR_SetListitemText(3, 3, LCAR.LCAR_IGNORE, "0")
						LCAR.LCAR_SetListitemText(3, 4, LCAR.LCAR_IGNORE, API.IIFIndex(CurrentSensor2, Array As String("", API.getstring("units_m_s2"), API.getstring("units_tesla"), API.getstring("units_degrees"), API.getstring("units_radians_s"), API.getstring("units_si_lux"), "", "", "" )))
						LCAR.LCAR_SetListitemText(3, 5, LCAR.LCAR_IGNORE, "0")
						LCAR.LCAR_SetListitemText(3, 6, LCAR.LCAR_IGNORE, "0")
						LCAR.LCAR_SetListitemText(3, 7, LCAR.LCAR_IGNORE, "0")
					End If
				
				Case -16 :		OpenMarketplace(SettingIndex, "com.omnicorp.lcarui.dialer")
				
				'COMMS PHN
				'Case -17.0:	Text entry
				Case -17.1:		Settings.Put("AnswerCalls", Value)
				Case -17.2:		Settings.Put("SpeakName", Value)
				Case -17.3: 	Settings.Put("BlockUnknown",Value)
				Case -17.4: 	Settings.Put("BlockCountry", LCAR.LCAR_GetListItem(4, Index).Tag)
				Case -17.5: 	HandleCOMMS( API.IIFIndex(Index, Array As String("PurgeInbox","PurgeOutbox","PurgeBothBoxes")))
				Case -17.6:		Settings.Put("AltMethod", Value)
				Case -17.7	
								Settings.Put("Orientation", Index)
								LoadSettings(True)
				Case -17.8:		Settings.Put("FwdPebble", Value)
				Case -17.9:		Settings.Put("IgnoreNew", Value)
				
				'COMMS SMS
				Case -18
					If Index=0 Then'edit
						tempitem= LCAR.LCAR_GetListItem(3, LCAR.LCAR_SelectedItem)
						HandleAskQuestion(API.getstring("quick_reply"), API.getstring("sms_edit"), tempitem.Text, False)
					Else
						ShowList=DeleteSMSQuickReply(3, SettingIndex,"")
					End If
				
				'COMMS MAIL
				Case -19.6:		Settings.Put("EMAILssl", Value)
				Case -19.8:		Settings.Put("EMAILmissed", Value)
				Case -19.9:		Settings.Put("EMAILsms", Value)
				Case -19.01:	Settings.Put("EMAILperiod", (Index+1)*5)
				Case -19.11:	Settings.Put("EMAILmessages", Index*10)
				
				'Daydream/lockscreen
				Case -20.0: 	SaveLWPsetting("DAY", Index,False)'Selected day dream screen
				Case -20.1
						Settings.Put("ActAsLockscreen", Value)
						STimer.ActAsLockscreen=Value
						API.StartPhoneEvents
				Case -20.2: 	SaveLWPsetting("MED", Value,False)'show media controls
				Case -20.3:
						Settings.Put("OnlyWhenCharging", Value)
						STimer.OnlyWhenCharging=Value
				Case -20.4:		DreamService.Bright=Value
				Case -20.5: 	WallpaperService.TimeOut=TextValue
				
				'alarms
				Case -22.0:		
						HideSubSettings
						Select Case SettingIndex
							Case 0:		API.CWA.Enabled=Value
							Case 1:		API.CWA.Hour=TextValue
							Case 2:		API.CWA.Minute=TextValue
							Case 3:		API.CWA.SoundEnabled=Value
							Case 4
								API.CWA.SoundID=Index
								LCAR.PlaySoundAnyway(Index)
							Case 5
								API.CWA.Action=Index
								If Index = 3 Then
									If Not(API.CWA.SoundEnabled) Then'deadman
										API.CWA.SoundEnabled=True
										LCAR.ToastMessage(BG,API.getstring("auto_deadman"),3)
									End If
									If API.DeadmanPass.Length=0 Then LCAR.ToastMessage(BG, API.getstring("pass_required"),3)
								End If
							Case 6:		API.CWA.Length=TextValue
							Case 7:		API.CWA.Snooze=TextValue
							Case Else:	API.CWA.Repeats.Set(SettingIndex-8,Value)
						End Select

				'security
				Case -23.0'edit password
					API.TempPass =""
					If Not(VRQuestion(1)) Then 
						LCAR.HideToast' ("edit password")
						LCAR.ToastMessage(BG, API.getstring("pass_offline"), 3)
					End If
				Case -23.1'secure personal log
					Settings.Put("SecurePLOG", Value)
				Case -23.2'erase auto-destruct password
					Password=""
					LCAR.ToastMessage(BG, API.getstring("pass_erased"), 3)
				
				'widgets
				Case -24.0'widgetid
					Widgets.CurrentWidget = TextValue
					ShowSettings(True,True)
					WidgetMode(3)
				Case -24.1'widget type
					CheckWidgetID
					LCARSeffects3.SetWidgetSetting(-1, "Type", Index) 'type
					WidgetMode(3)
				Case -24.2'widget alpha
					CheckWidgetID
					LCARSeffects3.SetWidgetSetting(-1, "Alpha", TextValue) 'Alpha
				Case -24.3'widget resolution
					If CheckWidgetID> -1 And API.APIlevel < 12 Then
						ShowSection(998,False)
						WidgetMode(3)
					Else 
						LCAR.HideToast'("widget resolution")
						LCAR.ToastMessage(BG, API.getstring("widg_resolution"), 3)
					End If
					Return False 
				Case -24.4
					CheckWidgetID
					LCARSeffects3.SetWidgetSetting(-1, "Delay",TextValue)'Widgets.UpdateTime = TextValue 'Settings.Put("WidgetUpdate",TextValue)
				Case -24.5: SetWidgetMode(Index)'Widgets.OnlyWhenScreenIsOn=Value
				Case -24.6:	API.InternalEvents=Value
				Case -24.7: Widgets.LockStardateMode=Value
				Case -24.8: API.AndroidMediaPlayer = LCAR.LCAR_GetListItem(4,Index).Tag
				
				Case -26.0'Klingon
					Select Case SettingIndex
						Case 1:	Translator.Src = Translator.GetLanguageID(TextValue)
						Case 2: Translator.Dest= Translator.GetLanguageID(TextValue)
					End Select
					
				'weather
				Case -27.0:		Weather.CurrentUnits = TextValue
				Case -27.1:		Weather.ChangeUpdatePeriod(TextValue)
				Case -27.3:		Weather.ChangeProvider(Index)
					
				'3d minesweeper
				Case -28' -28.4
					'Log("3d games " & SettingIndex & "." & Index & " Clicked")
					If SettingIndex = 6 Then
						If TextValue = API.getstring("open") Then 
							Start3DGame
						Else
							LCAR.HideToast' ("minesweeper")
							LCAR.ToastMessage(BG, API.getstring("no_game"), 2)
						End If
						Return  False 
					Else
						HideSubSettings
						If SettingIndex = 0 Or SettingIndex = 1 Then Update3DGameSettings
						ShowList=False
					End If
					
				'debug 
				Case -29.0: EducationalMode(Value )
				Case -29.1: LCAR.PartyTime = Value
				Case -29.2:	Settings.Put("styletoast", Index-1)
				Case -29.3: STimer.AllowServices = Value
				Case -29.4: API.Shutdown(Value)
				Case -29.5: ShowSettingsSection(-25)'size quickmenu
				
				'icon modifier
				Case -31.1: SetElement18Text(TextValue)
				Case -31.2: MakeIcon(Value)
				
				'reminders
				Case -32
					API.ReminderAction(1, SettingIndex)' Then LCAR.LCAR_RemoveListitem(3, SettingIndex)
					HideSubSettings
				
				'educational
				Case -33:	HandleEducationalSetting(4,Index)
					
				'date picker
				Case -34.1,-34.2,-34.3, -34.4:	MaxItem(0, 1, LCARSeffects3.GetDaysInMonth(DatePicker(0 ,-2), DatePicker(0,-3)))'month
				Case -34.5: HandleDatePicker(LCARSeffects.PromptQID)
				
				'unit conversion
				Case -35.0:	ConvertUnits(0)
				Case -35.2,-35.3: ConvertUnits(1)
				
				'APK downloader
				Case -36:		
					API.Download("apk", LCAR.LCAR_GetListItem(3,LCAR.LCAR_SelectedItem).Tag)
					LCAR.ToastMessage(BG, API.getstringvars("msds_downloading", Array As String(LCAR.LCAR_GetListItem(4,Index).Text)), 3)
				
				'Card games
				Case -37
					Games.CARD_HandleOptions(BG, 4,Index)
				
				'photo widget
				Case -38
					API.RemoveFile("PhotoWidget", LCAR.LCAR_GetListItem(3,LCAR.LCAR_SelectedItem).Tag)
					LCAR.LCAR_RemoveListitem(3,LCAR.LCAR_SelectedItem)
					LCAR.LCAR_HideElement(BG, 4,True, False,True)
					
				'GUI
				Case 0.0: 		LCAR.AntiAliasing= Value:LCAR.IsClean =False'AA
				Case 0.1
					LCAR.Zoom = Index
					LCAR.LoadLCARSize(BG)'Zoom
					AlignLists
					ResizeSetting(4)
					LCARSeffects.NeedsRedrawFrame=True
					ShowFrame(False,True)
					SetElement18Text( LCAR.GetElement(18).Text.Replace(CRLF, "") )
				Case 0.2: 		LCAR.LOD = Value'LOD
				Case 0.3: 		StartFPScounter(Value)'fps counter
				Case 0.4:
					If Index>0 Then
						SetScaleFactor((Index+1)*0.5, True)
					Else If LCAR.CrazyRez>0 Then
						LCAR.CrazyRez=0
						If Value Then 
							LCAR.SmallScreen = True 
							LCAR.LCAR_HideAll(BG, False)
							SmallScreenMode
							ShowSettings(True,False)
						Else 
							SetScaleFactor(1, True)
						End If
					Else If LCAR.LargeScreen Then
						LCAR.ToastMessage(BG,API.getstring( "no_smallscreen"), 3)
					Else
						LCAR.SmallScreen = Value'smallscreen							
						If LCAR.SmallScreen Then
							LCAR.LCAR_HideAll(BG, False)
							SmallScreenMode
							ShowSettings(True,False)
						Else
							SetScaleFactor(1, True)
						End If
						WallpaperService.SettingsLoaded=False
					End If
				Case 0.5
					LCAR.Fontfactor = 50 + Index*5 
					LCAR.LoadLCARSize(BG)
					AlignLists
				Case 0.6: 		Games.UT = Value
				Case 0.7: 		LCAR.LessRandom=Value
				Case 0.8:		LCARSeffects4.TRI_CameraOrientation = TextValue
				Case 0.9
					LCAR.OverscanX = TextValue
					LCAR.ScaleWidth = Activity.Width - TextValue*2
				Case 0.01
					LCAR.OverscanY = TextValue
					LCAR.ScaleHeight = Activity.Height - TextValue*2
				Case 0.11:		LCAR.SmoothScrolling = Value
				Case 0.12:		Settings.Put("alertstatus", Index)
				Case 0.13:		
					API.FullscreenMode = Value
					LCAR.HideToast'HandleSettings
					If Value Then ForceImmersiveMode Else LCAR.ToastMessage(BG, API.getstring("immersive_refresh"), 4)
				Case 0.15
					API.LoadTranslation(TextValue)
					ShowSettingsNoClear(False)

				'SOUND
				Case 1.0'headset volume 		
					'API.AllowVolumeAccess=True
					'LCAR.Volume(Index*10,True)'ToastMessageShow("VOLUME: " & LCAR.Volume(Event.Index2*10) & "%",False)     
					LCAR.hVol = Index*10
				Case 1.1: 		MicEnabled = Value'use mic
				Case 1.2'PlaySound test
					LCAR.Stop("1.2 SND")
					LCAR.PlaySoundAnyway(Index)
				Case 1.3: 		CopyRingtone(Index, False)
				Case 1.4'keytones
					Keytones=Index>0
					KeyToneIndex=Index
				Case 1.5: HeadsetAction=Index'headset button
				Case 1.6: AllowVRecOffline=Value'allow offline voice recognition
				Case 1.7: API.BluetoothDelay=TextValue'bluetooth primer
						
				'BEHAVIOR
				Case 2.0: 		BackToQuit = Value'Allow back button to exit
				Case 2.1: 		Screenshots = Value
				Case 2.2: 		SkipIntro = Index
				Case 2.3: 		LCAR.HasHardwareKeyboard  = Value
				Case 2.4: 		LCAR.RumbleUnit = Index*25 :LCAR.Rumble(1)'LCAR.RumbleEnabled=Value
				Case 2.5: 		WarpCoreRumble = Value
				Case 2.6: 		API.InputMethodSelector 
				Case 2.7: 		LCAR.UseAnotherFolder = Value
				Case 2.8: 		MenuEnabled = Value
				Case 2.9:		API.SearchProvider = Index
				Case 2.01:		API.SetNoti(Value)
				Case 2.11		
					btimer.NotificationWidget = Index-1
					API.AutoUpdateNoti
				Case 2.12: 		API.UsePebble=Value
				Case 2.13:		ScreenOrientation = Index
				Case 2.14:		API.datemode = Index
				
				'MISC
				Case 3.0:		BrowseMySite(""):ShowList=False' BrowseWeb("http://sites.google.com/site/neotechni/Home/lcars",0)'About 
				Case 3.1: 		BrowseMySite("help"):ShowList=False' BrowseWeb("http://sites.google.com/site/neotechni/Home/lcars/help",0)'Help
				Case 3.2: 		BrowseMySite("changes"):ShowList=False'
				Case 3.3: 
					If Value Then
						AskStarshipName 'ShowStarshipID
						ShowList=False
					Else
						If API.IsConnected Then
							LCAR.ToastMessage(BG, API.getstring("umr_downloading"), 4)
							API.download("System", MagicURL)
						Else
							LCAR.ToastMessage(BG, API.getstring("offline"), 4)
						End If
					End If
				Case 3.4: 		SetupAprilFoolsMode(Value)
				Case 3.5:		API.debugMode = Value

				Case Else:
					Log("Unhandled: " & SelectedSetting)
			End Select
			LoadSettings(True)
			If LCAR.SmallScreen And Index>-1 And ShowList Then
				LCAR.LCAR_HideElement(BG,4,True,False,True)
				LCAR.LCAR_HideElement(BG,3,True,True,True)
			Else If Not(ShowList) Then
				LCAR.LCAR_HideElement(BG,4,True,False,True)
			End If
		End If
	else if ListID = LCAR.ButtonList Then 'button menu
		SelectedSetting = CurrentSettingsSection
		If SelectedSetting>-1 Then SelectedSetting = SelectedSetting + (Index * 0.1) Else SelectedSetting = SelectedSetting - (Index * 0.1)
		Select Case SelectedSetting
			Case -3.0'start nnn
				StartNardi(cTimer, SelectedLWP("NNN"), SaveLWPsetting("KSO", True, True), SaveLWPsetting("KSB", True, True), SaveLWPsetting("FIL", "", True))
			'Case -6.0,-6.1'pulaski (start, resume)
			'	LCAR.ForceHideAll(BG)
			'	SeedSideBar(Array As String("PSE"), False, True)
			'	Games.DrP_StartGame(113, SelectedSetting=-6.0)
			'	If Games.DrP_Motion Then Listen(True)
			'	Return False
				
			Case Else'just section
				Select Case CurrentSettingsSection 
					Case -5'file explorer
						HandleDIRmenu(LCAR.ButtonList, Index)
					Case Else: Log("Button menu: " & SelectedSetting & " is not handled")
				End Select
		End Select
		Return True 
	Else 'keyboard
		'QuestionAsked=False
		If Index=0 Then
			Dim ItemName As String = LCAR.lcar_getlistitem(3, SettingIndex).Text
			TextValue=LCAR.GetSelectedText.Trim 
			LCAR.lcar_getlistitem(3, SettingIndex).Side = TextValue 
			Log("SelectedSetting: " & SelectedSetting & " =  " & TextValue)
			Select Case SelectedSetting	
				Case -4: Settings.put("nfc" & ItemName,  TextValue)
					
				Case -5
					HandleDIRmenu(-1,0) 'file explorer
					ShowSettingsNoClear(False)
					Return False 
				
				Case -17.0:	YourName = TextValue 
				Case -19.0, -19.1, -19.2, -19.3, -19.4, -19.5, -19.7
					'Msgbox(API.IIFIndex(SettingIndex, Array As String("SMTPserver", "SMTPport", "POP3server", "POP3port", "EMAILuser", "EMAILpass")), SettingIndex & " = " & LCAR.GetSelectedText)
					Settings.Put(  API.IIFIndex(SettingIndex, Array As String("SMTPserver", "SMTPport", "POP3server", "POP3port", "EMAILuser", "EMAILpass", "", "EMAILaddress")), TextValue)
				Case -18.0
					DeleteSMSQuickReply(3,SettingIndex,TextValue)
				Case -22.0
					API.CWA.text = TextValue
					ShowSettingsNoClear(True)
					Return False 
	
				Case -26.0
					Translator.CurrentText = TextValue
				Case -27.2
					Weather.ChangeCity(TextValue)
				Case -30.1
					Settings.Put("lightpackpass", TextValue)
				
				Case -35.1
					LCAR.LCAR_SetListitemText(3,1, LCAR.LCAR_IGNORE, TextValue)
					ShowSettingsNoClear(False)
					LCAR.SelectText(LCAR.lcar_ignore)
					ConvertUnits(1)
					Return False 
				
				Case 0.14
					If IsNumber(TextValue) Then 
						If TextValue < Max(GetDeviceLayoutValues.Width, GetDeviceLayoutValues.Height) Then 
							LCAR.ToastMessage(BG, API.getstringvars("longest_axis", Array As String(TextValue)), 2)
						Else 
							API.RealHeight = TextValue
							ForceImmersiveMode
						End If 
					Else
						LCAR.ToastMessage(BG, API.getstringvars("calc_isnan", Array As String(TextValue)), 2)
					End If 
				
				Case Else: Log("Keyboard question: " & SelectedSetting & " is unhandled")
			End Select
		End If
		'ShowSection(32,False)
		ShowSettings(True,True)
	End If
End Sub
 
'If Absolute=True, Value will be taken verbatem. Otherwise Value: -1=one step lower (to a minimum of 0.5), 1=one step higher (to a maximum of 5)
Sub SetScaleFactor(Value As Float, Absolute As Boolean)
	Dim SetValues As Boolean = True 
	If Not(Absolute) Then 
		If Value = 0 Then 
			SetValues = False 
		else If Value = -1 Then 'down
			Value = Max(LCAR.CrazyRez - 0.5, 0.5)
		else If LCAR.SmallScreen Then 'up from 0
			Value = 1 
		Else'up from anything else 
			 Value = Min(LCAR.CrazyRez + 0.5, 5)
		End If
	End If
	If SetValues Then 
		LCAR.SmallScreen = Value < 1
		If LCAR.SmallScreen Then Value = 0
		LCAR.LCAR_HideAll(BG, False)
		LCAR.CrazyRez = Value
		SmallScreenMode
		ShowSettings(True,CurrentSettingsSection < 0)
	End If 
	SetElement18Text(API.GetStringvars("set-25", Array As String(LCAR.Zoom, GetScalemode(False), LCAR.Fontfactor)))
End Sub

Sub AskKBorNUM As Boolean 
	Dim UnitType As String = LCAR.LCAR_GetListitemText(3,0,1), Number As Int, Unit As String =  LCAR.lcar_getlistitemtext(3,2,1).ToUpperCase 
	If UnitType.EqualsIgnoreCase(API.getstring("units_23"))  Then Number = Trig.GetConversionValue(UnitType, Unit)
	If Number <= 10 Then
		Return ShowNumberEntry(False, LCAR.lcar_getlistitemtext(3,1,1))' HandleAskQuestion("VALUE", "ENTER THE VALUE TO BE CONVERTED", LCAR.lcar_getlistitemtext(3,1,1), False)'text'input value
	Else
		Return HandleAskQuestion(API.GetString("sec_65"), API.getstringvars("units_please", Array As String(Unit)), LCAR.lcar_getlistitemtext(3,1,1), False)
	End If
End Sub

Sub ConvertUnits(FromWhat As Int) As String 
	Dim UnitType As String = LCAR.LCAR_GetListitemText(3,0,1), InputValue As String, InputUnit As String, OutputUnit As String, OutputValue As String, numsys As String = API.getstring("units_23")
	Select Case FromWhat
		Case -1'switch units
			InputValue = LCAR.LCAR_GetListitemText(3,2,1)
			LCAR.LCAR_SetListitemText(3,2, LCAR.LCAR_IGNORE, LCAR.LCAR_GetListitemText(3,3,1))
			LCAR.LCAR_SetListitemText(3,3, LCAR.LCAR_IGNORE, InputValue)
		Case 0'unit type changed
			LCAR.LCAR_SetListitemText(3,2, LCAR.LCAR_IGNORE, Trig.UnitList(UnitType).get(0))
			LCAR.LCAR_SetListitemText(3,3, LCAR.LCAR_IGNORE, Trig.UnitList(UnitType).get(1))
	End Select
	InputValue = LCAR.LCAR_GetListitemText(3,1,1)
	If IsNumber(InputValue) Or UnitType.EqualsIgnoreCase(numsys) Then
		InputUnit =  LCAR.LCAR_GetListitemText(3,2,1)
		OutputUnit = LCAR.LCAR_GetListitemText(3,3,1)
		If UnitType.EqualsIgnoreCase(numsys) Then
			OutputValue = Trig.ConvertNumbers(InputValue, InputUnit, OutputUnit)
		Else
			OutputValue = Trig.ConvertUnits(UnitType, InputValue, InputUnit, OutputUnit)
		End If
		If Eval.EvalError.Length = 0 Then
			If OutputValue.Length=0 Then OutputValue = "0"
			SetElement18Text(InputValue & " (" & InputUnit & ") = " & OutputValue & " (" & OutputUnit & ")")
		Else
			SetElement18Text(API.getstringvars("units_error", Array As String(Eval.EvalError)))
		End If 
	Else
		SetElement18Text(API.getstringvars("units_error", Array As String(API.GetString("units_nan"))))
	End If
	HideSubSettings
	Return OutputValue
End Sub









Sub AddDebugMinutes
	'If API.debugmode Then LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random, 0, Array As String(DateTime.GetMinute(DateTime.Now)+2,DateTime.GetMinute(DateTime.Now)+3,DateTime.GetMinute(DateTime.Now)+4))
	Dim temp As Int = DateTime.GetMinute(DateTime.Now)+2
	LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random, 0, Array As String( temp Mod 60, ((temp+1) Mod 60), ((temp+2) Mod 60 )))
End Sub

Sub ShowSettingsNoClear(Animated As Boolean)
	Dim Items As List, temp As Int 
	For temp = 0 To LCAR.LCARlists.Size-1
		LCAR.LCAR_HideElement(BG, temp, True, False, True)
	Next
	Items.Initialize 
	For temp = 0 To LCAR.GetListItemCount(19) -1
		Items.Add( LCAR.lcar_getlistitem(19,temp).Text)
	Next	
	SeedSideBar(Items,Animated,True)
	HideSubSettings 
	LCAR.LCAR_HideElement(BG,18,False,True, Not(Animated))
	LCAR.LCAR_HideElement(BG,3,True,True,Not(Animated))
End Sub

Sub Show3DgameSettings
	Dim GameType As Int = Games.ThreeD_Minesweeper , ThreeDMode As Boolean = True
	If Games.ThreeDGame.IsInitialized Then
		GameType = Games.ThreeDGame.GameType 
		ThreeDMode= Games.ThreeDGame.Size.Z > 0  
	End If
	Games.Player1Type = Games.PT_Local
	Games.Player2Type = Games.PT_Local
	
	SetElement18Text(API.GetString("sec_49"))
	LCAR.SeedButtonBar(BG, Array As String("HOST", "JOIN", "CLOSE"))
	SeedSetting(API.GetString("3d_set1"), "", API.ReverseIIFindex(GameType, Array As String(Games.ThreeD_TicTacToe, "TICTACTOE", Games.ThreeD_Chess, "CHESS", Games.ThreeD_Checkers, "CHECKERS"), "MINESWEEPER"))
	SeedSetting(API.GetString("3d_set2"), API.GetString("3d_sed2"), API.IIF(ThreeDMode, "3D", "2D"))
	SeedSetting(API.GetString("3d_set3"), API.GetString("3d_sed3"), "")
	SeedSetting(API.GetString("3d_set4"), API.GetString("3d_sed4"), "")
	SeedSetting(API.GetString("3d_play1"), API.GetString("3d_mine"), "")
	SeedSetting(API.GetString("3d_play2"), API.GetString("3d_mine"), "")
	SeedSetting(API.GetString("3d_start"), "", "")
	If Games.ThD_CanResume(False) Then SeedSetting(API.GetString("3d_resume"), "", "")
	Update3DGameSettings
End Sub
Sub Update3DGameSettings
	LCAR.lcar_setlistitemtext(3, 2, LCAR.LCAR_IGNORE, Games.ThD_Strings(2, GetSetting(1),GetSetting(0)).Get(0))'layout
	LCAR.lcar_setlistitemtext(3, 3, LCAR.LCAR_IGNORE, Games.ThD_Strings(3, GetSetting(1),GetSetting(0)).Get(0))'mines
	If GetSetting(0) = "MINESWEEPER" Then
		LCAR.lcar_setlistitemtext(3, 4, LCAR.LCAR_IGNORE, "LOCAL")
		LCAR.lcar_setlistitemtext(3, 5, LCAR.LCAR_IGNORE, "NONE")
	Else If LCAR.SRV_State <> Games.PT_Local Then
		LCAR.lcar_setlistitemtext(3, 4, LCAR.LCAR_IGNORE, API.IIF(LCAR.SRV_State = Games.PT_Server, "LOCAL", "REMOTE"))
		LCAR.lcar_setlistitemtext(3, 5, LCAR.LCAR_IGNORE, API.IIF(LCAR.SRV_State = Games.PT_Server, "REMOTE", "LOCAL"))
	Else
		LCAR.lcar_setlistitemtext(3, 4, LCAR.LCAR_IGNORE, API.IIF(Games.Player1Type = Games.PT_Local, "LOCAL", "AUTO"))
		LCAR.lcar_setlistitemtext(3, 5, LCAR.LCAR_IGNORE, API.IIF(Games.Player2Type = Games.PT_Local, "LOCAL", "AUTO"))
	End If
End Sub
Sub Start3DGame
	Dim temp As Int 
	LCAR.LCAR_HideAll(BG, False)
	Games.Player1Type = Games.PT_Local 
	Games.Player2Type = Games.PT_Local 
	If GetSetting(0) <> "MINESWEEPER" Then
		If GetSetting(4).EqualsIgnoreCase("AUTO") Then Games.Player1Type = Games.PT_AI 
		If GetSetting(5).EqualsIgnoreCase("AUTO") Then Games.Player2Type = Games.PT_AI 
	End If
	Select Case GetSetting(1) & GetSetting(0)'CHECKERS CHESS TICTACTOE
		Case "2DMINESWEEPER"
			Games.ThD_NewGame(103, Games.ThreeD_Minesweeper, -GetSetting(2), GetSetting(3))
		Case "3DMINESWEEPER"
			Games.ThD_NewGame(103, Games.ThreeD_Minesweeper, Games.ThD_Strings(2, GetSetting(1), GetSetting(0)).IndexOf(GetSetting(2)), GetSetting(3))
		Case "2DCHECKERS", "3DCHECKERS"
			Games.ThD_NewGame(103, Games.ThreeD_Checkers, API.IIF(GetSetting(1) = "3D", 0,1), 0)
		Case "2DCHESS", "3DCHESS"
			If GetSetting(1) = "3D" Then temp = Games.ThD_Strings(2, GetSetting(1), GetSetting(0)).IndexOf(GetSetting(2))'attack boards
			Games.ThD_NewGame(103, Games.ThreeD_Chess, API.IIF(GetSetting(1) = "3D", 0,1), temp)
		Case "2DTICTACTOE", "3DTICTACTOE"
			Games.ThD_NewGame(103, Games.ThreeD_TicTacToe, Games.ThD_Strings(2, GetSetting(1), GetSetting(0)).IndexOf(GetSetting(2)) + 3, API.IIF(GetSetting(1) = "2D", 0,1))
		Case "2D8589934592", "3D8589934592"
			temp = Games.ThD_Strings(2, GetSetting(1), GetSetting(0)).IndexOf(GetSetting(2))
			Games.ThD_NewGame(103, Games.ThreeD_8589934592, API.IIF(GetSetting(1) = "3D", 0,1), temp)
	End Select
	Games.ThD_SetAnimation(10)
End Sub




Sub CopyRingtone(Index As Int, Silent As Boolean) As Boolean 
	Dim tempstr As String , SndFile As Int , Sound As LCARSound, Ring As RingtoneManager 
	If Index=0 Then
		tempstr = LCAR.LCAR_GetListItem(3,2).side
		SndFile= LCAR.FindSound(tempstr)
		If SndFile>-1 Then
			tempstr = API.GetSystemDir(API.DIRECTORY_RINGTONES)
			If tempstr.Length=0 Then
				If Not(Silent) Then LCAR.ToastMessage(BG, API.getstring("ring_unable"), 3)
			Else
				Sound = LCAR.SoundList.Get(SndFile)
				If File.Exists(tempstr, Sound.Filename) Then
					If Not(Silent) Then LCAR.ToastMessage(BG, API.GetStringVars("ring_exists", Array As String(Sound.Filename)), 3)
				Else
					Try
						File.Copy(Sound.Dir, Sound.Filename, tempstr, Sound.Filename)
						tempstr = Ring.AddToMediaStore(tempstr, Sound.Filename, Sound.Name, True,True,True,False)
						LCAR.LCAR_GetListItem(3,3).tag = tempstr
						If Not(Silent) Then LCAR.ToastMessage(BG, API.GetStringVars("ring_copied", Array As String(Sound.Filename)),3)
						Return True
					Catch
						If Not(Silent) Then LCAR.ToastMessage(BG, API.GetStringVars("ring_failed", Array As String(Sound.Filename, tempstr)),3)
					End Try
				End If
			End If
		Else
			If Not(Silent) Then LCAR.ToastMessage(BG, API.getstring("ring_nosound"), 3)
		End If
	Else
		tempstr = LCAR.LCAR_GetListItem(3,3).Tag
		CopyRingtone(0, True)
		If API.SetRingtone(Index, tempstr) Then
			LCAR.ToastMessage(BG, API.getstringvars("ring_wasset", Array As String(API.GetString(API.IIFIndex(Index, Array As String("", "ring_tone", "ring_alarm", "ring_noti"))))), 3)
		Else
			LCAR.ToastMessage(BG, API.getstring("ring_denied"), 3)
		End If
	End If
End Sub

Sub ShowSection12(TheSection As Int)
	CurrentSettingsSection = -TheSection
	ShowSettings(False,True )
End Sub
Sub ShowSideList(Index As Int)
	Dim temp As Int 
	LCAR.LCAR_HideElement(BG,4,True,True,True)
	If LCAR.SmallScreen  And Index>-1 Then 
		LCAR.LCAR_HideElement(BG,3,True,False,True)
	Else
		'Log("RESIZESETTING: " & LCAR.GetListItemCount(19))
		ResizeSetting(4)
		'ResizeSetting(4)
	End If
	Dim LCARLIST As LCARlist = LCAR.LCARlists.Get(4), LISTITEM As LCARlistitem
	For temp = 0 To LCARLIST.ListItems.Size - 1 
		LISTITEM = LCARLIST.ListItems.Get(temp)
		If LISTITEM.Selected Then Return 
	Next
	If LCARLIST.SelectedItem = -1 Then LCARLIST.SelectedItem = 0
End Sub
Sub ShowSettings(doFrame As Boolean, AllowGame As Boolean )
	Dim temp As Int
	WallpaperService.AllowPreview=False
	'LCAR.stage=9
	BigOptions=False
	LCAR.Stop("SHOW SETTINGS")
	LCAR.CurrentStyle = LCAR.LCAR_TNG 
	If AllowGame Then
		Select Case CurrentSettingsSection
			Case -11,-12, -13,-14:	temp=5'calculator screen
			Case -15: temp=4'raw sensor data
			Case -17,-18,-19:temp=3
			Case -22,-32,-33:temp=2'alarm clock, reminders
			Case Else:	HideSideBar'dont forget to add it to ResizeSetting 
		End Select
	Else 
		If CurrentSettingsSection<0 Or CurrentSettingsSection>3 Then CurrentSettingsSection=0
		CurrentSection=-2
	End If
	
	LCAR.LCAR_SetElementText(LCARSeffects.FrameElement, "", "")
	LCAR.LCAR_SetElementText(LCARSeffects.FrameElement+11, "", "")
	LCAR.GetList(3).MultiSelect = False 
	
	'LCAR.LCAR_HideElement(BG, 19, True, False,True)
	Select Case CurrentSettingsSection
		Case -17,-18,-19,-21,-22,-32,-33:If doFrame Then LCAR.LCAR_HideAll(Null,False)' hideall
	End Select
	Select Case CurrentSettingsSection'Add to: these items can still have a side bar
		Case -5: HandleDIRmenu(-2, 0)
		Case -17,-18,-19:SeedSideBar(API.getstrings("side_dial", 0),  doFrame,True)
		Case -21:SeedSideBar(API.getstrings("side_timr", 0),  False, True)
		Case -22:SeedSideBar(API.getstrings("side_edit", 0),  doFrame,True)
		Case -32:SeedSideBar(API.getstrings("side_rmnd", 0),  doFrame,True)
		Case -33:HandleEducationalSetting(19,-1)
		Case Else
			If doFrame  Then 
				LCAR.LCAR_HideAll(Null,False)' hideall
				webview1.Visible = False
				If AllowGame Then 
					HideSideBar
					ShowFrame(doFrame,True)
				Else
					'Msgbox("ShowSettings", "SEEDSIDEBAR")
					SeedSideBar (API.getstrings("side_sett", 0), True,True )
				End If
				'LCARSeffects.frameoffset=LCAR.ListItemsHeight(4)
				'ShowFrame(True,True)
				'LCAR.ResizeList(19, API.IIF(LCAR.SmallScreen, 53,103), LCARSeffects.frameoffset, -1,0,0,False)
			End If
	End Select		
	'If LCAR.GetListItemCount(19) = 0 Then LCAR.LCAR_HideElement(BG, 19, True, False,True)
	
	LCAR.RandomizeColors(3)
	'LCAR.RandomizeColors(19)
	LCAR.LCAR_HideElement(BG, 3,True,True,False)
	'LCAR.LCAR_HideElement(BG, 19,True,True,False)

	'If Not(LCAR.smallscreen) Then LCAR.LCAR_HideElement(BG, 4,True,True,False)
	LCAR.LCAR_HideElement(BG, 4,True, False, True)
	
	ResizeSetting(API.iif(AllowGame,temp,4))
	
	LCARSeffects2.StarshipsClean =False
	SetElement18Trans
	
	LCAR.LCAR_ClearList(3,0)
	Select Case CurrentSettingsSection
		Case -1'panel de pon
			Games.PDP_HandleSettings(BG, 0,0)
			
		Case -2'tropes
			Tropes.ShowMenu(0)
		
		Case -3'nardi noise nnaker
			SetElement18Text(API.IIF(API.IsConnected, API.GetSectionInfo(78,1), API.GetString("set-3")))
			SeedSettingTrans(API.GetTime(cTimer))'listitem 0
			SeedSettingTrans(SelectedLWP("NNN"))'listitem 1
			SeedSettingTrans(BoolToText(SaveLWPsetting("KSO", True, True)))'listitem 2
			SeedSettingTrans(BoolToText(SaveLWPsetting("KSB", True, True)))'listitem 3
			SeedSettingTrans(SaveLWPsetting("ERA", "TNG1", True))'listitem 4
			SeedSettingTrans(SaveLWPsetting("SND", "", True))'listitem 5
			LCAR.SeedButtonBar(BG, Array As String("START"))
			
		Case -4'NFC	
			For temp = 0 To API.NFCtags.Size - 1
				AddNFCtag(API.NFCtags.Get(temp))
			Next
			
		Case -5'File explorer	
			ShowDIR("")
			
		Case -6'Dr. Pulaski
			SetElement18Text(API.GetString("sec_85"))
			SeedSettingTrans(Games.DrP_VirusLevel)'listitem 0
			SeedSettingTrans(Games.DrP_VirusDifficultyString(Games.DrP_VirusDifficulty))'listitem 1
			SeedSettingTrans(BoolToText(Games.DrP_Motion))'listitem 2
			SeedSettingTrans("")'listitem 3
			If Not(Games.DrP_Gameisover) Then SeedSettingTrans("")'listitem 4
		
		Case -7'Bridge
			SeedSettingTrans(SettingsList("-7.0").Get(Wireframe.CardassianKeytone))'listitem 0
			SeedSettingTrans(BoolToText(ShowSubBridges))'listitem 1
			SeedSettingTrans(SaveLWPsetting("PAN", 5, True))'listitem 2
			SeedSetting(API.getstring("sec_64"), API.GetString("sed-7.345"), API.GetString("sec_64_" & SaveLWPsetting("TOS", 0, True)))'listitem 3 (TOS)
			SeedSetting(API.getstring("sec_66"), API.GetString("sed-7.345"), API.GetString("sec_66_" & SaveLWPsetting("NX1", 0, True)))'listitem 4 (NX-01)
			SeedSetting(API.getstring("sec_89"), API.GetString("sed-7.345"), API.GetString("sec_89_" & SaveLWPsetting("TMP", 0, True)))'listitem 5 (TMP)
			
		Case -10'Live Wallpaper settings
			LCAR.SeedButtonBar(BG, Array As String("MSDS"))
			SetElement18Text(API.GetString("sec_23"))
			SeedSettingTrans(SaveLWPsetting("FPS", 0,True))'listitem 0
			SeedSettingTrans(SelectedLWP("SCR"))'listitem 1
			SeedSettingTrans(API.IIFIndex(SaveLWPsetting("ALERT", 0, True), SettingsArray(0)))'listitem 2
			SeedSettingTrans(API.getside(API.getside(SaveLWPsetting("MSD", "", True), ".",True,False),"[",True,False).ToUpperCase )'listitem 3
			SeedSettingTrans("")'listitem 4
			SeedSettingTrans(SaveLWPsetting("TOP", 0, True))'listitem 5
			SeedSettingTrans(SaveLWPsetting("BOT", 0, True))'listitem 6
			SeedSettingTrans(SaveLWPsetting("LND", 0, True))'listitem 7
			SeedSettingTrans(BoolToText(SaveLWPsetting("SCL", False, True)))'listitem 8
			SeedSettingTrans("")'listitem 9
			SeedSettingTrans("")'listitem 10
			SeedSettingTrans(GetFSMmode)'listitem 11
			SeedSettingTrans(BoolToText(LCAR.LWPUnlocked))'listitem 12
			SeedSettingTrans(SaveLWPsetting("DRK", 0, True))'listitem 13
		
		Case -11'calculator
			SeedSettingTrans(API.IIFIndex(Eval.AngleMode, Eval.EnumStrings(-1)))
			SeedSettingTrans(API.IIFIndex(Eval.EnumType, Eval.EnumStrings(-2)))
			SeedSettingTrans("")
			SeedSettingTrans("")
			SeedSettingTrans("")
			If Eval.VarStack.Size>0 Then SeedSettingTrans("")
		Case -12'function insertion wizard
			Eval.ShowStackItem(-1, 3,BG)
		Case -13'variable editor wizard
			SeedSettingTrans(API.IIF(Eval.IsEditing, API.GetString("log_side1"), API.GetString("new")))
			SeedSettingTrans(Eval.GetVarType( Eval.CurrentVar.varType ).ToUpperCase)
			SeedSettingTrans(Eval.CurrentVar.name.ToUpperCase)
			SeedSettingTrans("")
			SeedSettingTrans("")
			If Eval.CurrentVar.varType = Eval.ch_routine Then
				SeedSetting(API.GetString("set-11.7a"), "", Eval.CurrentVar.Equation)
				SeedSetting(API.GetString("set-11.8a"), "", "")
				Eval.CurrentVar.isConst = False
			Else
				SeedSetting(API.GetString("set-11.7b"), "", API.IIF(Eval.CurrentVar.isConst, API.GetString("yes"), API.GetString("no")))
				SeedSetting(API.GetString("set-11.8b"), "", "")
			End If
			Eval.ListValues(3, Eval.CurrentVar)
		Case -14'parameter editor wizard
			SeedSettingTrans(Eval.CurrentPar.name.ToUpperCase)
			SeedSettingTrans(Eval.GetVarType( Eval.CurrentPar.varType ).ToUpperCase)
			SeedSettingTrans(Eval.CurrentPar.Default)
			SeedSettingTrans("")
			SeedSettingTrans("")
			
		Case -15'raw sensor data
			'SetElement18Text("RAW SENSOR DATA")'CHOOSE YOUR SENSOR
			SeedSettingTrans(API.IIFIndex(CurrentSensor2,GetSensors) )'listitem 0
			SeedSettingTrans("")'listitem 1
			SeedSettingTrans("")'listitem 2
			SeedSettingTrans("")'listitem 3
			SeedSettingTrans("")'listitem 4
			SeedSettingTrans("")'listitem 5
			SeedSettingTrans("")'listitem 6
			SeedSettingTrans("")'listitem 7
		
		Case -16'Communicator not installed
			SeedSettingTrans("")
			SeedSettingTrans("")
			
		Case -17'Communicator is installed
			If API.APIlevel > 19 Then SetElement18Text(API.GetString("set-17b"))
			'SeedSetting("REFRESH CACHE", "REGENERATE THE PHONE NUMBER CACHE", "")
			SeedSettingTrans(YourName.ToUpperCase)'listitem 0
			SeedSettingTrans(BoolToText(Settings.GetDefault("AnswerCalls", "false")))'listitem 1
			SeedSettingTrans(BoolToText(Settings.GetDefault("SpeakName", "false")))'listitem 2
			SeedSettingTrans(BoolToText(Settings.GetDefault("BlockUnknown", "false")))'listitem 3
			SeedSettingTrans(API.CountryName(Settings.GetDefault("BlockCountry", 0)))'listitem 4
			SeedSettingTrans("")'listitem 5
			SeedSettingTrans(BoolToText(Settings.GetDefault("AltMethod", "false")))'listitem 6
			SeedSettingTrans(API.IIFIndex(Settings.GetDefault("Orientation", 0), API.getstrings("orient", 0)))'listitem 7
			SeedSettingTrans(BoolToText(Settings.GetDefault("FwdPebble", "false")))'listitem 8
			SeedSettingTrans(BoolToText(Settings.GetDefault("IgnoreNew", "false")))'listitem 9
			
		Case -18'SMS
			LCAR.SeedButtonBar(BG, Array As String(API.GetString("new")))
			SMSQuickReply(3,"",-1)
		Case -19'EMAIL
			SeedSettingTrans(Settings.GetDefault("SMTPserver", "smtp.gmail.com"))
			SeedSettingTrans(Settings.GetDefault("SMTPport", "465"))
			SeedSettingTrans(Settings.GetDefault("POP3server", "pop.gmail.com"))
			SeedSettingTrans(Settings.GetDefault("POP3port", "995"))
			SeedSettingTrans(Settings.GetDefault("EMAILuser", ""))
			SeedSettingTrans(API.PasswordText(Settings.GetDefault("EMAILpass", API.CODEC(Settings.GetDefault("EMAILencrypted", ""), False, API.GetEncryptionKey(False))), "*", 8))
			SeedSettingTrans(BoolToText(Settings.GetDefault("EMAILssl", "false")))
			SeedSettingTrans(Settings.GetDefault("EMAILaddress", ""))
			SeedSettingTrans(BoolToText(Settings.GetDefault("EMAILmissed", "false")))
			SeedSettingTrans(BoolToText(Settings.GetDefault("EMAILsms", "false")))
			SeedSettingTrans(Settings.GetDefault("EMAILperiod", 15))
			SeedSettingTrans(Settings.GetDefault("EMAILmessages", 15))
		
		Case -20'Daydream
			SetElement18Text2(API.getstring("set-20"))
			SeedSettingTrans(SelectedLWP("DAY"))'listitem 0
			SeedSettingTrans(BoolToText(STimer.ActAsLockscreen))'listitem 1
			SeedSettingTrans(BoolToText(SaveLWPsetting("MED", False,True)))'listitem 2
			SeedSettingTrans(BoolToText(STimer.OnlyWhenCharging))'listitem 3
			SeedSettingTrans(BoolToText(DreamService.Bright))'listitem 4
			SeedSettingTrans(WallpaperService.TimeOut)'listitem 5
		
		Case -21'-22 is viewing/editing an alarm
			'SetElement18Text("ALARMS")
			SetElement18Text2(API.LoadAlarm(-1,3))
		
		Case -23'Security
			SeedSettingTrans(API.DeadmanPass.ToUpperCase)'API.PasswordText(API.DeadmanPass, "*",8))'listitem 0
			SeedSettingTrans(BoolToText(Settings.GetDefault("SecurePLOG", "false")))'listitem 1
			SeedSettingTrans(Password)'listitem 2
			
		Case -24'Widgets
			SetElement18Text2(API.getstring("set-24"))
			LCAR.SeedButtonBar(BG, Array As String("REFRESH"))
			If Widgets.CurrentWidget =-1 Then Widgets.CurrentWidget = Widgets.mAppWidgetIdList.Get(0)
			SeedSettingTrans(Widgets.CurrentWidget)'listitem 0
			SeedSettingTrans(LCARSeffects3.WidgetType(LCARSeffects3.GetWidgetSetting( Widgets.CurrentWidget, "Type", -1)))'listitem 1
			SeedSettingTrans(LCARSeffects3.GetWidgetSetting( Widgets.CurrentWidget, "Alpha", 192))'listitem 2
			SeedSettingTrans(API.IIF(Widgets.CurrentWidget>-1, LCARSeffects3.GetWidgetSetting(Widgets.CurrentWidget, "Width", 320) & "x" & LCARSeffects3.GetWidgetSetting(Widgets.CurrentWidget, "Height", 320), "AUTOMATIC"))'listitem 3
			SeedSettingTrans(LCARSeffects3.GetWidgetSetting(Widgets.CurrentWidget, "Delay", 10))'Settings.GetDefault("WidgetUpdate", 1))'listitem 4
			SeedSettingTrans(WidgetMode(-1))'listitem 5
			SeedSettingTrans(BoolToText(API.InternalEvents))'listitem 6
			SeedSettingTrans(BoolToText(Widgets.LockStardateMode))'listitem 7
			SeedSettingTrans(API.AppName(API.AndroidMediaPlayer).ToUpperCase)'listitem 8
			
		Case -25'size setup
			SetScaleFactor(0, False)
			For temp = 1 To 6
				SeedSettingTrans("")
			Next
			If API.EnumLanguages.Size > 1 Then 
				SeedSettingTrans("")
				LCAR.LCAR_AddListItems(3, LCAR.LCAR_Random, 10, API.EnumLanguages)
			End If 
			
		Case -26'klingon translator
			LCAR.SeedButtonBar(BG, Array As String(API.GetString("kb_ok"), API.GetString("set-26ut")))
			SeedSettingTrans(Translator.CurrentText.ToUpperCase)
			SeedSettingTrans(Translator.GetLanguageName(Translator.Src).ToUpperCase)
			SeedSettingTrans(Translator.GetLanguageName(Translator.Dest).ToUpperCase)
			Translator.SeedHistory(3,0)
		
		Case -27'weather settings
			SetElement18Text2(API.GetStringVars("set-27", Array As String(API.DayLabel(Weather.NextUpdate, True),API.TheTime(Weather.NextUpdate)))) ') LCAR.Stardate(-2, Weather.NextUpdate, False, 2) )
			LCAR.SeedButtonBar(BG, Array As String(API.GetString("set-27rfrsh")))
			SeedSettingTrans(Weather.CurrentUnits.ToUpperCase)'metric,imperial,kelvin
			If AprilFools And Weather.CurrentUnits.EqualsIgnoreCase("imperial") Then SetElement18Text(API.GetString("set-27imp"))
			SeedSettingTrans(Weather.UpdatePeriod)
			SeedSettingTrans(Weather.CurrentCity.ToUpperCase)
			SeedSettingTrans(Weather.ProviderName(-1))
			If API.debugMode Then 
				If Weather.HasWeatherData(Weather.CurrentWeather) Then
					temp = Weather.FindToday(Weather.CurrentWeather)
					If temp>-1 Then
						Dim tempDay As WeatherDay = Weather.CurrentWeather.days.Get(temp)
						SeedSetting("DEBUG DATA", "", 		"METRIC")
						SeedSetting("HIGH", "", 			Round2(tempDay.Maximum,2) & "°C")
						SeedSetting("LOW", "", 				Round2(tempDay.Minimum,2) & "°C")
						SeedSetting("MORNING TEMP", "", 	Round2(tempDay.Morning,2) & "°C")
						SeedSetting("DAY TEMP", "", 		Round2(tempDay.Day,2) & "°C")
						SeedSetting("EVENING TEMP", "", 	Round2(tempDay.Evening,2) & "°C")
						SeedSetting("NIGHT TEMP", "", 		Round2(tempDay.Night,2) & "°C")
						SeedSetting("CURRENT TEMP", "", 	Round2(Weather.CurrentTemperature(tempDay),2) & "°C")
						If Weather.CurrentUnits.EqualsIgnoreCase("imperial") Then		
							SeedSetting("DEBUG DATA", "", 	"IMPERIAL")
							SeedSetting("HIGH", "", 		Round2(Trig.ConvertUnits( 0, tempDay.Maximum, "C", Weather.CurrentUnits),2) & "°" & Weather.CurrentWeather.Units)
							SeedSetting("LOW", "", 			Round2(Trig.ConvertUnits( 0, tempDay.Minimum, "C", Weather.CurrentUnits),2) & "°" & Weather.CurrentWeather.Units)
							SeedSetting("MORNING TEMP", "", Round2(Trig.ConvertUnits( 0, tempDay.Morning, "C", Weather.CurrentUnits),2) & "°" & Weather.CurrentWeather.Units)
							SeedSetting("DAY TEMP", "", 	Round2(Trig.ConvertUnits( 0, tempDay.Day, "C", Weather.CurrentUnits),2) & "°" & Weather.CurrentWeather.Units)
							SeedSetting("EVENING TEMP", "", Round2(Trig.ConvertUnits( 0, tempDay.Evening, "C", Weather.CurrentUnits),2) & "°" & Weather.CurrentWeather.Units)
							SeedSetting("NIGHT TEMP", "", 	Round2(Trig.ConvertUnits( 0, tempDay.Night, "C", Weather.CurrentUnits),2) & "°" & Weather.CurrentWeather.Units)
							SeedSetting("CURRENT TEMP", "", Round2(Trig.ConvertUnits( 0, Weather.CurrentTemperature(tempDay), "C", Weather.CurrentUnits),2) & "°" & Weather.CurrentWeather.Units)
						End If
						SeedSetting("CURRENT TIME", "", 	API.IIFindex(Weather.CurrentTimeOfDay, Array As String("MORNING", "DAY", "EVENING", "NIGHT")))
						SeedSetting("WIND SPEED", "", 		Round2(tempDay.Speed,2) & Weather.CurrentWeather.UnitsSpeed)
						SeedSetting("RAIN", "", 			Round2(tempDay.Rain,2) & Weather.CurrentWeather.UnitsDistance)
						SeedSetting("SNOW", "", 			Round2(tempDay.Snow,2) & Weather.CurrentWeather.UnitsDistance)
						SeedSetting("HUMIDITY", "", 		Round2(tempDay.Humidity,2) & "%")
						SeedSetting("CLOUD COVERAGE", "", 	Round2(tempDay.Clouds,2) & "%")
						SeedSetting("PRESSURE", "", 		Round2(tempDay.Pressure,2) & Weather.CurrentWeather.UnitsPressure)
					Else 
						SeedSetting("DEBUG DATA", "", "MISSING")
					End If
				Else 
					SeedSetting("DEBUG DATA", "", "UNAVAILABLE")
				End If 
			End If
		
		Case -28'3d minesweeper
			Show3DgameSettings
		
		Case -29'debug menu
			SeedSettingTrans(BoolToText(LCAR.Educational))'listitem 0
			SeedSettingTrans(BoolToText(LCAR.PartyTime))'listitem 1
			SeedSettingTrans(SettingsList("29.2").Get( Settings.GetDefault("styletoast", -1) +1))'listitem 2
			SeedSettingTrans(BoolToText(STimer.AllowServices))'listitem 3
			SeedSettingTrans("")'listitem 4
			SeedSettingTrans("")'listitem 5
			
		Case -30'lightpack
			'LCAR.SeedButtonBar(BG, Array As String("CONN", "DISC"))
			If Not(Settings.ContainsKey("lightpackip")) Then 	Settings.Put("lightpackip", "127.0.0.1:3636")
			If Not(Settings.ContainsKey("lightpackpass")) Then 	Settings.Put("lightpackpass", "")
			SeedSettingTrans(Settings.Get("lightpackip"))'listitem 0
			SeedSettingTrans(Settings.Get("lightpackpass"))'listitem 1
		
		Case -31'icon modifier
			SeedSettingTrans(0)'listitem 0
			SeedSettingTrans("")'listitem 1
			SeedSettingTrans("")'listitem 2
		
		Case -32'reminders
			SetElement18Text2(API.GetString("set-32"))
			For temp = 0 To Widgets.Reminders.Size-1
				SeedSetting(Widgets.Reminders.Get(temp), Widgets.Reminders.Get(temp), "")
			Next
		
		Case -33'list of database entries for educational mode
			HandleEducationalSetting(-1,-1)
		
		Case -34'date picker, uses WorkingDate
			SetElement18Text(API.GetStringVars("set-34", Array As String(DateTime.Date(WorkingDate))))
			SeedSettingTrans(DateTime.GetDayOfMonth(WorkingDate) )'listitem 0
			SeedSettingTrans(LCARSeffects3.NameOfMonth(DateTime.GetMonth(WorkingDate),True) )'listitem 1
			SeedSettingTrans(Floor(DateTime.GetYear(WorkingDate) / 100))'listitem 2
			SeedSettingTrans(Floor((DateTime.GetYear(WorkingDate) Mod 100) / 10))'listitem 3
			SeedSettingTrans((DateTime.GetYear(WorkingDate) Mod 10))'listitem 4
			SeedSettingTrans(API.GetString("ok"))'listitem 5
		
		Case -35'unit conversion
			SeedSettingTrans("TEMPERATURE")'listitem 0
			SeedSettingTrans("0")'listitem 1
			SeedSettingTrans("")'listitem 2
			SeedSettingTrans("")'listitem 3
			SeedSettingTrans("")'listitem 4
			ConvertUnits(0)
			
		Case -36'APK installer 
			LCAR.SeedButtonBar(BG, Array As String(BoolToBool(API.AutoUpdateAPKS), BoolToBool(API.AutoInstallAPKs)))
			
		Case -37'CARD GAMES
			Games.CARD_HandleOptions(BG, -1,0)			
		
		Case -38'photo widget
			LCAR.SeedButtonBar(BG, Array As String(API.GetString("side_rmnd0")))
			LoadDirs("PhotoWidget", True)		
			
		Case 0'GUI
			SeedSettingTrans(BoolToText(LCAR.AntiAliasing) )'listitem 0
			SeedSettingTrans(LCAR.Zoom )'listitem 1
			SeedSettingTrans(BoolToText(LCAR.LOD)  )'listitem 2
			SeedSettingTrans(BoolToText(False) )'listitem 3
			SeedSettingTrans(GetScalemode(False) )'listitem 4
			SeedSettingTrans(LCAR.Fontfactor & "%" )'listitem 5
			SeedSettingTrans(BoolToText(Games.UT))'listitem 6
			SeedSettingTrans(BoolToText(LCAR.LessRandom))'listitem 7
			SeedSettingTrans(LCARSeffects4.TRI_CameraOrientation)'listitem 8
			SeedSettingTrans(LCAR.OverscanX)'listitem 9
			SeedSettingTrans(LCAR.Overscany)'listitem 10
			SeedSettingTrans(BoolToText(LCAR.SmoothScrolling) )'listitem 11
			SeedSettingTrans(API.IIFIndex(Settings.GetDefault("alertstatus", 0), SettingsArray(0)))'listitem 12
			SeedSettingTrans(BoolToText(API.FullscreenMode))'listitem 13
			SeedSettingTrans(API.RealHeight)'listitem 14
			SeedSettingTrans(API.TransLanguage.ToUpperCase)'15
			
		Case 1'SND
			SeedSettingTrans(LCAR.hVol & "%")'listitem 0
			SeedSettingTrans(BoolToText(MicEnabled) )'listitem 1
			SeedSettingTrans("")'listitem 2
			SeedSettingTrans("")'listitem 3
			SeedSettingTrans(API.IIFIndex(KeyToneIndex, BeepModes)) 'Array As String("DISABLED","RANDOM", "ONLY TONE 1", "ONLY TONE 2", "ONLY TONE 3" ,"ONLY TONE 4")) )'listitem 4
			SeedSettingTrans(API.IIFIndex(HeadsetAction, Array As String("IGNORE", "V.REC.")))'listitem 5
			SeedSettingTrans(BoolToText(AllowVRecOffline))'listitem 6
			SeedSettingTrans(API.BluetoothDelay)'listitem 7
			
		Case 2'BEHAVIOR
			SeedSettingTrans(BoolToText(BackToQuit) )'listitem 0
			SeedSettingTrans(BoolToText(Screenshots) )'listitem 1
			SeedSettingTrans(SettingsList("2.2").Get(SkipIntro))'listitem 2
			SeedSettingTrans(BoolToText(LCAR.HasHardwareKeyboard) )'listitem 3
			SeedSettingTrans(API.IIF(LCAR.RumbleUnit=0, "OFF",LCAR.RumbleUnit)  )'listitem 4
			SeedSettingTrans(BoolToText(WarpCoreRumble)  )'listitem 5
			SeedSettingTrans("")'listitem 6
			SeedSettingTrans(BoolToText(LCAR.UseAnotherFolder) )'listitem 7
			SeedSettingTrans(BoolToText(MenuEnabled) )'listitem 8
			SeedSettingTrans(API.IIFIndex(API.SearchProvider, API.SearchProviders))'listitem 9
			SeedSettingTrans(BoolToText(API.AllowNoti))'listitem 10
			SeedSettingTrans(SettingsList("2.11").Get(btimer.NotificationWidget+1))'Listitem 11
			SeedSettingTrans(BoolToText(API.UsePebble))'listitem 12
			SeedSettingTrans(SettingsList("2.13").Get(ScreenOrientation))'listitem 13
			SeedSettingTrans(API.getstring("datemode_" & API.datemode))'listitem 14		
			
		Case 3'MISC
			SeedSetting(API.getstring("set3.0"), API.GetString("sed3.0") & CRLF & API.Model(0) & " • " & API.Model(1),  "" )'listitem 0
			SeedSettingTrans("")'listitem 1
			SeedSettingTrans("")'listitem 2
			SeedSettingTrans("")'listitem 3
			SeedSettingTrans(BoolToText(AprilFools) )'listitem 4 
			SeedSettingTrans(BoolToText(API.debugMode) )'listitem 5
			
		Case Else Log("Unrecognized section: " & CurrentSettingsSection)
	End Select
End Sub

Sub SettingsList(SettingID As String) As List 
	Dim templist As List 
	templist.Initialize 
	Select Case SettingID
		Case "-7.0": templist.Initialize2(Array As String(API.getstring("disabled"), API.getstring("random"), "1", "2", "3", "4", "5", "6", "7", "LCARS"))'Cardassian keytones
		Case "2.2":  templist.Initialize2(Array As String(API.GetString("okuda_none"), API.GetString("sec_0"), API.GetString("sec_82")))'Intro
		Case "2.11"
			templist.Add(API.GetString("okuda_none"))
			templist.AddAll(LCARSeffects3.WidgetTypes)
		Case "2.13": templist.Initialize2(API.getstrings("orient", -1))'orientation
		Case "29.2": templist.Initialize2(Array As String("RANDOM","FERENGI", "OFFICE SPACE", "STARSHIP TROOPERS", "FREEDOM WARS", "KNIGHT RIDER"))'toasts
	End Select
	Return templist
End Sub

Sub SeedSetting(Name As String, Description As String, CurrentValue As String)
	LCAR.LCAR_AddListItem(3, Name, LCAR.LCAR_Random, -1, Description, False, CurrentValue,0,False,-1)
End Sub
Sub SetElement18Trans()
	If API.Translation.ContainsKey("set" & CurrentSettingsSection) Then SetElement18Text( API.GetString("set" & CurrentSettingsSection) )
	If API.Translation.ContainsKey("seb" & CurrentSettingsSection) Then LCAR.SeedButtonBar(BG, API.GetStrings("seb" & CurrentSettingsSection, 0))
End Sub
Sub SeedSettingTrans(CurrentValue As String)
	Dim CurrentIndex As String = CurrentSettingsSection & "." & LCAR.GetListItemCount(3), Description As String 
	If API.Translation.ContainsKey("sed" & CurrentIndex) Then Description = API.getstring("sed" & CurrentIndex)
	SeedSetting( API.getstring("set" & CurrentIndex), Description, CurrentValue)
End Sub

Sub SeedSetting2(Name As String, Tag As String, SideText As String, Color As Int, Number As Int, WhiteSpace As Int)
	If Color < 0 Then Color = LCAR.LCAR_RandomColor
	LCAR.LCAR_AddListItem(3, Name.ToUpperCase, Color, Number, Tag, False, SideText,WhiteSpace,False,-1)
End Sub
Sub GetFSMmode As String 'SaveLWPsetting
	SaveLWPsetting("SAM", False, True)'forces the system to load the settings file, just in case
	If WallpaperService.Settings.ContainsKey("SAM") Then
		WallpaperService.Settings.Put("FSM", API.IIF(WallpaperService.Settings.Get("SAM"), 1,0))
		WallpaperService.Settings.Remove("SAM")
	End If
	Return API.IIFIndex(WallpaperService.Settings.Getdefault("FSM",  0), Array As String("DISABLED", "PASSIVE", "AGGRESSIVE"))
End Sub
Sub GetScalemode(ReturnArray As Boolean) As Object
	Dim tempstr As List, temp As Int' () As String= Array As String("HALF", "NORMAL", "DOUBLE", "TRIPLE", "QUADRUPLE")
	tempstr.Initialize
	For temp = 0 To 2'HALF to ONE•FIVE
		tempstr.Add( API.GetString("size" & temp) )
	Next
	If Activity.Width >=1080 Or Activity.Height >= 1080 Then 
		For temp = 3 To 9'DOUBLE to QUINTUPLE
			tempstr.Add( API.GetString("size" & temp) )
		Next
	End If
	If ReturnArray Then Return tempstr
	If LCAR.SmallScreen Then Return tempstr.Get(0)
	If LCAR.CrazyRez>0 Then Return tempstr.Get((LCAR.CrazyRez-0.5)*2)
	Return tempstr.Get(1)
End Sub

Sub CheckWidgetID As Int 
	Dim tempstr As String 
	If CurrentSection = 41 And Widgets.CurrentWidget = -1 Then
		tempstr = LCAR.lcar_GetListItem(3,0).side 
		If IsNumber(tempstr) Then
			If tempstr <> -1 Then Widgets.CurrentWidget = tempstr 
		End If
	End If
	Return Widgets.CurrentWidget
End Sub 
Sub WidgetMode(Value As Int) As String 
	Select Case Value
		Case -1
			If Widgets.OnlyWhenLWPisVisible Then Return WidgetMode(2)
			If Widgets.OnlyWhenScreenIsOn Then Return WidgetMode(1)
			Return WidgetMode(0)
		Case 0: Return API.getstring("widgmode0")
		Case 1: Return API.getstring("widgmode1")
		Case 2: Return API.getstring("widgmode2")
		Case 3'warning
			CheckWidgetID
			If Widgets.CurrentWidget <> -1 Then 
				If LCARSeffects3.IsAnimatedWidget(LCARSeffects3.GetWidgetSetting( Widgets.CurrentWidget, "Type", -1)) Then
					LCAR.ToastMessage(BG, API.GetString("widgtoast"), 4)
				End If
			End If
	End Select
	Return ""
End Sub
Sub SetWidgetMode(Value As Int) 
	Widgets.OnlyWhenLWPisVisible=False
	Widgets.OnlyWhenScreenIsOn=False
	Select Case Value
		Case 1:Widgets.OnlyWhenScreenIsOn=True'screen
		Case 2'LWP
			Widgets.OnlyWhenScreenIsOn=True
			Widgets.OnlyWhenLWPisVisible=True
	End Select
End Sub




Sub StartFPScounter(State As Boolean )
	Settings.Put("FPScounter", State)
	LCAR.FPSCounter=State
	If State Then
		LCAR.FramesDrawn = 0 
		LCAR.FPS=0
		API.newtimer("FPS",1, STimer.Infinite)
	Else
		LCAR.LCAR_SetElementText( 6,"", "")
		API.StopTimer(1)
	End If
End Sub 

Sub IsAprilFools As Boolean 
	Return DateTime.GetMonth(DateTime.Now)=4 And DateTime.GetDayOfMonth(DateTime.Now)=1
End Sub 

Sub GotoSleep
	Dim P As PhoneWakeState
	P.ReleaseKeepAlive 
	P.ReleasePartialLock
End Sub

Sub TimerIncrement(tTimer As LCARtimer)
	LCAR.PushEvent(LCAR.LCAR_TimerIncrement , tTimer.id, tTimer.Duration ,tTimer.Index ,0,0,0,0)
	If Not(LCAR.ScreenIsOn ) Then HandleEvents(-1)
End Sub

Sub Timermain_Tick
	'webview resizing
	Dim CurrSecond As Long 
	If SensorEnabled Or LCARSeffects4.CameraIsOn Then API.CurrentOrientation = API.GetOrientation
	If GameMode Then 
		If ButtonsChanged Then
			SendText("g " & GetKeyState)
		End If
	Else 'If LCAR.LCARelements.Size>0 Then
		If LCAR.WebviewOffset <>0 And webview1.Visible Then'LCARSpeed	
			If LCAR.WebviewOffset<0 Then
				If LCAR.WebviewOffset<= -LCARSpeed Then
					LCAR.WebviewOffset=LCAR.WebviewOffset+LCARSpeed
					webview1.Height=webview1.Height-LCARSpeed
				Else
					webview1.Height=Activity.Height- webview1.Top -LCAR.KeyboardHeight -4' webview1.Height-lcar.WebviewOffset
					LCAR.WebviewOffset=0
				End If
			Else
				If LCAR.WebviewOffset>= LCARSpeed Then
					LCAR.WebviewOffset=LCAR.WebviewOffset-LCARSpeed
					webview1.Height=webview1.Height+LCARSpeed
				Else
					webview1.Height=Activity.Height - webview1.Top 'webview1.Height+lcar.WebviewOffset
					LCAR.WebviewOffset=0
				End If
			End If
		'Else If webview1.Visible AND LCAR.KBisVisible Then
		'	Activity.RequestFocus 
		End If

		'TimerBlink=TimerBlink+TimerMain.Interval 
		CurrSecond = Floor(DateTime.Now / LCAR.VolInc ) 'DateTime.GetSecond(DateTime.Now)
		If TimerBlink <> CurrSecond Then
			
		'If TimerBlink>60 Then'=100 Then
			LCAR.DirtyElement(LCAR.KBCancelID+5)
			
			Select Case CurrentSection
				Case -3'stardate
					LCAR.ClearScreen(BG)
					LCAR.LCAR_SetElementText( 19,  LCAR.Stardate(LCAR.StardateMode, DateTime.Now,False,4),  "")
					LCAR.LCAR_SetElementText( 18, DateTime.Time(DateTime.Now) & " - " &  API.getDate(DateTime.Now) ,  "")
			End Select
		
			If micrunning Then ChangeSensor(0,SensorList.Get(0)  ,  A.AudioMaxAmplitude, 0,0)
			If Not (LCAR.ElementMoving ) Then TurnWifiOn
			If SocketConnected Then
				If Not(Socket1.Connected ) Then Socket1_Connected(False)
			End If
			
			If BorgMode>0 Then 
				BorgSwap
				BorgMode=BorgMode-1
				If BorgMode =0 Then BorgDone
			End If
			
			LCAR.LCAR_BlinkLCARs 
			TimerBlink=CurrSecond
		End If
		
		LCAR.LCAR_HandleLightpack 
		If WallpaperService.PreviewMode Or CurrentSection=-1 Or WebMode=-1 Then needsreloading = False 
		If needsreloading Then
			ShowBrowser
			webview1.LoadUrl ( API.ScrollTo(-1))
			needsreloading=False	
		End If
		
'		Select Case CurrentSection
'			Case 48'tricorder	 ,CameraIsOn As Boolean ,LastFrame As Long, FrameDelay As Int
'				'Log(CameraIsOn & " " & (DateTime.Now >= (LastFrame + FrameDelay)))
'				CameraUpdate
'		End Select
		HandleEvents(5)'TimerMain.Interval)
		'CheckGPS
	End If
End Sub

Sub INITBG
	'API.Trace("INITBG", True)
	If BG = Null Then LCAR.BGisInit = False 
	If Not(LCAR.BGisInit) Then
		Try
			BG.Initialize(Activity)
			LCAR.BGisInit=True
		Catch
			LCAR.BGisInit=False
		End Try
		If LCAR.VolText.Length = 0 And LCAR.VolTextList.Size>0 Then
			LCAR.VolSeconds=0 
			LCAR.VolOpacity=0 
			LCAR.PullNextToast(BG)
		End If
	End If
End Sub

Sub DrawScreen (Interval As Int)
	INITBG	
	Try
		If LCAR.NeedsClearing Then LCAR.ClearScreen(BG)
		If NeedsShowFrame Then
			ShowFrame(False,LCARSeffects.NeedsLeftBar)
			NeedsShowFrame=False
			LCAR.IsKeyboardVisible(BG,10,False )
		End If
		
		If Interval> 0 Then LCAR.IncrementLCARs(LCARSpeed , 1,Interval )
		If LCAR.DrawLCARs(BG, 0) Then Activity.Invalidate 
	Catch
		LogColor("DrawScreen Error: " & LastException.Message, Colors.red)
		LCAR.BGisInit = False 
	End Try
End Sub

Sub UrlDone(Url As String)
	'Log(Url & " done")
End Sub









 
Sub Socket1_Connected (Successful As Boolean)
	Lightpackmode=False
	If Successful Then
		AStreams.Initialize(Socket1.InputStream, Socket1.OutputStream, "AStreams")
		LCAR.hidenumboard(BG)
		SetElement18Text(API.GetString("connection_pass"))
		NewShip
		SocketConnected =True
		Select Case CurrentSection
			Case 7'UMR
				ShowSection(7,False)
				'LCAR.LCAR_HideElement(BG,12,True,True,False)
			Case 8'tactical
				ShowTactical
				If DOS > -1 Then  SendText("DOS " & (DOS+1) )
		End Select
		LCAR.SRV_State = Games.PT_Remote
	Else
		ShowModeSelect(39)
		PlayError
		LCAR.ToastMessage(BG, API.GetString("connection_fail"), 3)
		SocketConnected=False
		LCAR.SRV_State = Games.PT_Local
	End If
	IsServer=False
End Sub







Sub StartGPS
	GPSenabled=True
	GPS1.stop 
	GPS1.Start(0, 0)
	GPSStarted = DateTime.Now 
	Log("GPS activated")
End Sub
Sub CheckGPS
	If GPSenabled  And GPSStarted>0 Then
		If GPSStarted < DateTime.Now - (DateTime.TicksPerMinute) Then StartGPS
	End If
End Sub
Sub StopGPS(DontRestart As Boolean)
	If DontRestart Then GPSenabled = False
	'Log("GPS deactivated")
	'Try
		GPS1.Stop
	'Catch
	'End Try
End Sub
Sub UpdateGPS
	If CurrentSection=8 Then
		LCARSeffects.FindGPSscale()
		LCAR.DirtyElement(39)
	End If
End Sub
Sub GPS_LocationChanged (Location1 As Location)
	Dim tempstr As String ,tempstr2 As String 
	GPSStarted=0
	If Not(LCAR.IsNumboardVisible ) Then
		tempstr2=LCARSeffects.CoordToString(Location1)
		Settings.Put("LastKnown", tempstr2)
		If CurrentSection=8 Then 
			tempstr=tempstr2 & " " &  Round2(Location1.Speed,2) & "m/s"
			If Server.IsInitialized Then  tempstr = tempstr & CRLF & "IP: " & Server.GetMyIP & ":" & DefaultPort
			SetElement18Text(tempstr)
		End If
	End If
	'If tempstr2.Length>0 Then Log("GPS: " & tempstr2 & " (" & CurrentSection & ")")
	Select Case CurrentSection 
			Case 8'SNSR\Tractical
				If SendText("gps " & tempstr2) Then LCARSeffects.DoKlingon=True
				LCARSeffects.AddGPScoordinate(0, Location1, -1,False,Settings)
				UpdateGPS
			
			Case 48'tricorder
				LCARSeffects4.ProcessGPS(Location1)
	End Select
End Sub









Sub Server_NewConnection (Successful As Boolean, NewSocket As Socket)
    If Successful Then
		Telnet = API.MakeKB("",0,0,False,False)
		'ToastMessageShow("HOST: " & server.  ,True)
        Socket1 = NewSocket
		doCRLF=False
        AStreams.Initialize(Socket1.InputStream, Socket1.OutputStream, "AStreams")
		If CurrentSection <> 9  Then 
			SendText("raw" & API.IIF(DOS>-1, " " & (DOS+1), "") ) 
			ShowModeSelect(40)
			LCAR.ToastMessage(BG, API.GetString("connection_umr"), 3)
			SendMediaProfile("")
			IsServer=True
		Else
			If DOS>-1 Then SendText("DOS " & (DOS+1))
		End If
		LCAR.SRV_State = Games.PT_Server 
    Else
        'ToastMessageShow(LastException.Message, True)
		LCAR.ToastMessage(BG, LastException.Message, 6)
		LCAR.SRV_State = Games.PT_Local
    End If
    Server.Listen
	NewShip
End Sub

Sub SendText(Text As String) As Boolean 
	Dim buffer() As Byte
	If AStreams.IsInitialized Then
		Try 
			Text = Text & CRLF
    		buffer = Text.GetBytes("UTF8")
    		AStreams.Write(buffer)
		Catch
			Return False
		End Try
	End If
	Return True
End Sub

Sub AStreams_NewData (Buffer() As Byte)
	Dim msg As String
    msg = BytesToString(Buffer, 0, Buffer.Length, "UTF8")
	ProcessText(msg)
End Sub

Sub AStreams_Error
    'ToastMessageShow(LastException.Message, True)
End Sub
Sub ProcessText(Text As String )
	Dim tempstr() As String ,temp As Int 
    'ToastMessageShow(Text, False)
	If Text.Contains(CRLF) Then
		tempstr = Regex.Split(CRLF, Text)
		For temp = 0 To tempstr.Length -1
			If tempstr(temp) <> CRLF Then ProcessCommand( tempstr(temp))
		Next
	Else
		ProcessCommand(Text)
	End If
End Sub
Sub NewShip
	LCARSeffects.NewShip
	If Not(Lightpackmode) Then SendText("model 12")
End Sub
Sub SendMediaProfile(Text As String)
	Dim Color As Int = LCAR.GetColor(LCAR.LCAR_Orange, False,255)
	If Text.Length=0 Then
		SendText("profile 'Media Player' " & LCAR.Stardate(-1,DateTime.Now,False,4) & CRLF & _
					"AddButton 'PLAY/PAUSE' " & Color & CRLF & _
					"AddButton 'PREV TRACK' " & Color & CRLF & _
					"AddButton 'NEXT TRACK' " & Color & CRLF & _
					"AddButton 'STOP' " & Color) 	'receiving button (1=name, 2=color)
	Else
		Select Case Text
			Case "PLAY/PAUSE": 	API.SendMediaButton(KeyCodes.KEYCODE_MEDIA_PLAY_PAUSE)
			Case "PREV TRACK": 	API.SendMediaButton(KeyCodes.KEYCODE_MEDIA_PREVIOUS)
			Case "NEXT TRACK": 	API.SendMediaButton(KeyCodes.KEYCODE_MEDIA_NEXT)
			Case "STOP":		API.SendMediaButton(KeyCodes.KEYCODE_MEDIA_STOP)
		End Select
	End If
End Sub
Sub SendFolderContents(Folder As String)
	Dim Drive As String,Files As List,temp As Int,NewFolder As String ,MF As MediaFile ,tempstr As String 
	If Folder.Length=0 Then
		SendText("folder dir 'C:\FLASH' 1")
		SendText("folder dir 'M:\MUSIC' 1")
		SendText("folder dir 'P:\PHOTO' 1")
		SendText("folder dir 'V:\VIDEO' 1")
	Else
		Drive=API.Left(Folder,1).ToUpperCase 
		NewFolder=API.Right(Folder, Folder.Length-8).Replace("\", "/").Replace("//","/")
		Select Case Drive
			Case "C"'
				If File.IsDirectory(File.DirRootExternal, NewFolder) Then
					NewFolder=File.Combine(File.DirRootExternal, NewFolder)
					'Msgbox(NewFolder,"C")
					Files = File.ListFiles(NewFolder)
					Files.Sort(True)
					For temp = 0 To Files.Size-1
						If File.IsDirectory(NewFolder, Files.Get(temp)) Then
							tempstr="folder dir '" & Folder & "\" & Files.Get(temp) & "' 1"
						Else
							tempstr="folder " & File.Size(NewFolder, Files.Get(temp)) &  " '" & Folder & "\" & Files.Get(temp) & "' 1"
						End If
						'Log("MB: " & tempstr)
						SendText(tempstr)
					Next 
				Else
					NewFolder=File.Combine(File.DirRootExternal, NewFolder)
					API.OpenFile(NewFolder)
				End If
			Case Else
				NewFolder=API.Right(NewFolder, NewFolder.Length-1)
				Files = API.ListMedia(Drive,NewFolder)
				For temp = 0 To Files.Size-1
					If API.IsMediaFiles Then
						MF=Files.Get(temp)
						tempstr="folder " & MF.Size & " 'C:\FLASH\" & MF.Filename.Replace("/","\") & "' '" & MF.Title & "'"
					Else
						tempstr="folder dir '" & Drive & ":\12345\" & NewFolder & "\" & Files.Get(temp) & "' 1"
					End If
					tempstr=tempstr.Replace("\\","\")
					'Log("MF: " & tempstr)
					SendText(tempstr)
				Next
		End Select
	End If
End Sub



Sub ProcessCommand(Text As String) 
	Dim Command As List,tempstr As String,sendurl As Boolean, isTelnet As Boolean   ', tempstr As StringBuilder, temp As Int 
	If API.Left(Text,1) = "#" Or Text.trim.Length=0 Or Text=CRLF Then Return 
	
	If Text.Contains(CRLF) Then
		Dim temps() As String ,temp As Int 
		temps=Regex.Split(CRLF, Text)
		For temp = 0 To temps.Length-1
			ProcessCommand(temps(temp))
		Next
	End If
	
	If Text.Length=1 Then
		'Log(Asc(Text) & "=" & Text)
		Select Case Asc(Text)
			Case 13
				Text = Telnet.Text 
				'Log("TELNET: " & Telnet.Text)
				Telnet = API.MakeKB("",0,0,False,False)
				isTelnet=True
			'Case 8,32'delete, enter, space?
			'	HandleTelnet(Text)
			'	Return
			Case Else
				HandleTelnet(Text)
				Return
		End Select
	End If

	'tempstr.Initialize 
	tempstr=CRLF
	If API.Right(Text,tempstr.Length) = CRLF Then Text =API.Left(Text, Text.Length - tempstr.Length)
	Try
		If Lightpackmode Then
			Command.Initialize2( Regex.Split(":", Text) )
		Else
			Command = API.ParseCommand(Text)
		End If
		'For temp = 0 To command.Size-1
		'	tempstr.Append(temp & ": " & command.Get(temp) & CRLF)
		'Next
		'Msgbox(tempstr,text)
		tempstr=Command.Get(0)
		'Msgbox(Text,"TEXT")
		Select Case tempstr.ToLowerCase 
			'both
			Case "disconnect": DisconnectUMR'Socket1.Close 
			
			Case "exe"
				SendMediaProfile(API.Right(Text, Text.Length-4).Trim)
			
			'LCARS UI (Android) only
			Case "gps"'received gps coordinates from another android device
				LCARSeffects.DoKlingon=True
				LCARSeffects.AddGPScoordinate(1, LCARSeffects.StringToCoord(Command.Get(1)), -1,False, Settings)
			
			Case "dos"
				'If DOS=-1 Then 'DOS = Command.Get(1)
				'If isTelnet Then
				'	SendText("Yeah. I decided against unlocking this")
				If IsNumber(Command.Get(1)) Then
					If Command.Get(1)>0 And (Command.Get(1)<DOS Or DOS=-1) Or isTelnet Then 
						DOS = API.IIF(isTelnet, "9999", Command.Get(1))'+1
						LCAR.ToastMessage(BG, "DOS " & DOS,2)
						AddOmega
						LoadSettings(True)
					End If
				End If
				'End If
				
			Case "raw"
				If CurrentSection<>8 Then
					If Command.Size>1 Then ProcessCommand("dos " & Command.Get(1))
					RAWmode=True
					RepeatMode=True
					VRListen
				End If
			
			Case "umr"
				VR_Handle(API.Right( Text, Text.Length - 4))
			
			'Ultra Mobile Remote (Windows) only
			Case "profile"'receiving new profile (1=name, 2=stardate)
				LCAR.LCAR_ClearList(10,0)
				'LCAR.LCAR_AddListItem(10, "BACK", LCAR.LCAR_Orange , -1,  "", False, "" ,0,False,-1)
			Case "task"	'receiving task list (1=hWnd, 2=name)
				If IsVoiceCommand Then
					If TextContainsCommand(Command.Get(2)) Then 
						LCAR.ToastMessage(BG, "SWITCHING TO: " & Command.Get(2), 3)
						SendText("switchto " & Command.Get(1) )
						IsVoiceCommand=False
					'Else 
					'	Log("NOT: " & Command.Get(2))
					End If
				End If
				LCAR.LCAR_AddListItem(11, Command.Get(2), LCAR.LCAR_Random , -1, Command.Get(1), False, "" ,0,False,-1)
				
			Case "addbutton"'receiving button (1=name, 2=color)
				LCAR.LCAR_AddListItem(10, Command.Get(1), LCAR.LCAR_Random, -1,  "", False, "" ,0,False,-1)
		
			Case "folder"
				If Command.Size=1 Then
					SendFolderContents("")
				Else
					tempstr = Command.Get(1)
					If IsServer Then
						If tempstr.EqualsIgnoreCase("dir") Then
							SendFolderContents(Command.Get(2))
						Else
							Log("UNKNOWN ERROR!")
						End If
					Else	
						If tempstr.EqualsIgnoreCase("dir") Then
							tempstr = Command.Get(2)
							If tempstr.length=2 And API.Right( tempstr, 1)= ":"  Then 
								tempstr=tempstr & "\"
							Else
								tempstr= API.getSide(tempstr , "\", False,True)
							End If
							LCAR.LCAR_AddListItem(13,tempstr.ToUpperCase , LCAR.LCAR_Random, -1 , Command.Get(2), False, "",0,False,-1)
						Else
							tempstr= API.IIF(IsNumber(Command.Get(3)) Or API.Len(Command.Get(3))=0,  API.getSide(  API.getSide( Command.Get(2), "\",False,True) , ".", True, False).ToUpperCase, Command.Get(3)).ToUpperCase
							LCAR.LCAR_AddListItem(13, tempstr, LCAR.LCAR_Random, LCAR.ScientificNotation(Command.Get(1)) ,  Command.Get(2), False, API.getSide( Command.Get(2) , ".", False,False).ToUpperCase ,0,False,-1)
						End If
					End If
				End If
				
			Case "crlf"
				doCRLF=True
				tempstr = API.GetString("welcome")
				SendText("#  _   ____________________________   _")
				SendText("# (_| |____________________________| |_)")'38 characters
				SendText("#")
				SendText("#                 ______")
				SendText("#              _-' .   .`-_")
				SendText("#          |/ /  .. . '   .\ \|")
				SendText("#         |/ /            ..\ \|")
				SendText("#       \|/ |: .   ._|_ .. . | \|/")
				SendText("#        \/ |   _|_ .| . .:  | \/")
				SendText("#       \ / |.   |  .  .    .| \ /")
				SendText("#        \||| .  . .  _|_   .|||/")
				SendText("#       \__| \  . :.  .|.  ./ |__/")
				SendText("#         __| \_  .    .. _/ |__")
				SendText("#          __|  `-______-'  |__")
				SendText("#             -,____  ____,-")
				SendText("#               ---'  `---")
				SendText("# " & API.PadtoLength(tempstr, True, (38-tempstr.Length)/2, " "))
				SendText("#  _   ____________________________   _")
				SendText("# (_| |____________________________| |_)")
				
			Case "model"
				'StarshipID As String, StarshipName As String, StarshipCaptain As String
				If Command.Size=2 Then
					SendText("model " & Command.Get(1) & " '" & API.model(Command.Get(1)) & "'")
				Else If  Command.Get(1) = "12" Then
					LCARSeffects.StarshipID= Command.Get(2)
					LCARSeffects.Starshipname= Command.Get(3)
					LCARSeffects.StarshipCaptain= Command.Get(4)
					LCARSeffects.Starshipname = API.Left(LCARSeffects.Starshipname, LCARSeffects.Starshipname.Length-1)
				End If
				
			Case "speak"
				Speak( API.Right(Text, Text.Length - 6) )
			
			Case "game"
				Games.ThD_MultiplayerData(False, Command.Get(1), Command.Get(2), Command.Get(3), Command.Get(4), Command.Get(5) )
		
		
		
		
		
		
		
		
		
			Case "lightpack"
				Lightpackmode = True
				LCAR.LightpackPattern=0
				Log("lightpack mode activated")
				If API.Len(Settings.Get("lightpackpass")) = 0 Then
					SendLightPackCMD("getstatusapi", "")
				Else
					SendLightPackCMD("apikey", Settings.Get("lightpackpass"))
				End If
			Case "statusapi"
				If Command.Get(1) = "idle" Then
					SendLightPackCMD("getcountleds", "")
				Else
					DisconnectUMR
					LCAR.ToastMessage(BG, API.GetString("lp_busy"), 3)
				End If
			Case "countleds"
				LCAR.LightpackLEDs = Command.Get(1)
				SendLightPackCMD("lock", "")
			Case "lock"
				If Command.Get(1) = "success" Then
					SendLightPackCMD("setstatus", "on")
					ShowModeSelect(41)
					LCAR.ToastMessage(BG, API.GetString("lp_online"), 3)
					LCAR.LightpackColor(-1,0, LCAR.LCAR_Orange, False,255)
				Else
					DisconnectUMR
					LCAR.ToastMessage(BG, API.GetString("lp_denied"), 3)
				End If
			Case "fail"
				If LightpackCMD = "apikey" Then
					DisconnectUMR
					LCAR.ToastMessage(BG, API.GetString("lp_wrongpassword"), 3)
				Else
					LCAR.ToastMessage(BG, API.GetStringVars("lp_error", Array As String(LightpackCMD.ToUpperCase)), 3)
				End If
			Case "ok"
				If LightpackCMD = "apikey" Then	SendLightPackCMD("getstatusapi", "")
			
			Case Else
				Log(Text & " unhandled")
				If Not(HandleTelnet(Text)) And Not(Lightpackmode) Then 
					LCAR.ToastMessage(BG, "'" & Text.ToUpperCase  & "' WAS NOT UNDERSTOOD",4)
					sendurl=isTelnet
				End If
		End Select
	
	Catch
		LCAR.ToastMessage(BG, "'" & Text.ToUpperCase  & "' RESULTED IN AN ERROR",4)
		sendurl=isTelnet
	End Try
	If sendurl Then SendText("Please visit http://sites.google.com/site/neotechni/Home/lcars/telnet")
		
	
'send from client To server:
	'folder dir
	'sendtext '[TEXT]' 1
	'folder dir '[Filename]' 1
	'mouse scroll [y]
	'mouse [x] [y]
	'mouse [Button]
End Sub

'LED: -1=all >-1=specific LED, -2=brightness (0 to 100), -3=gamma (0.01 to 10.00), -4=setsmooth (0/off to 255/full), -5=ticks between updates, -6=Pattern, -7=Index
'for gamma, red = whole number, green = fraction *100 (so a max of 2 decimal places)
Sub LightpackEvent(LED As Int, LED2 As Int, Red As Int, Green As Int, Blue As Int)'Event As ElementClicked)
	Select Case LED'setgamma,setsmooth
		Case -2: SendLightPackCMD("setbrightness", Red)
		Case -3: SendLightPackCMD("setgamma", Red + Green*0.01)
		Case -4: SendLightPackCMD("setsmooth", Red)
		Case -5: LCAR.LightpackUpdateFreq = Red 
		Case -6: LCAR.LightpackPattern = Red
		Case -7: LCAR.LightpackIndex = Red
		
		Case Else: SendLightPackCMD("setcolor", SetLEDColor(LED, LED2, Red,Green,Blue))
	End Select
End Sub
Sub SetLEDColor(LED As Int, LED2 As Int, Red As Int, Green As Int, Blue As Int) As String 
	Dim temp As Int, tempstr As StringBuilder
	If LED=-1 Or LED2>0 Then
		tempstr.Initialize 
		If LED = -1 Then
			LED=0
			LED2=LCAR.LightpackLEDs -1
		End If
		For temp = LED To LED2
			If temp < LCAR.LightpackLEDs Then 
				tempstr.Append(API.IIF(tempstr.Length=0,"",";") & SetLEDColor(temp,0, Red,Green,Blue))
			End If
		Next
		Return tempstr.ToString 
	Else
		Return LED & "-" & Red & "," & Green & "," & Blue
	End If
End Sub

Sub SendLightPackCMD(Command As String, Argument As String) 
	Dim tempstr As String = Command & API.IIF(Argument.Length=0, "", ":" & Argument)
	LightpackCMD = Command
	'Log("Lightpack: " & tempstr)
	Select Case Command
		Case "setcolor":  If Argument.Length  = 0 Then tempstr= ""
	End Select
	If tempstr.Length >0 Then SendText(tempstr)
End Sub
Sub HandleTelnet(Text As String)As Boolean
	Dim tempstr As String 
	If Text = " " Then Text = "SPACE"
	tempstr=API.GetKeyCode(Text, False,False)
	If tempstr.Length>0 Then
		If Not(Telnet.IsInitialized ) Then Telnet = API.MakeKB("",0,0,False,False)
		Telnet= API.HandleKeyboard(Telnet, tempstr)
		Return True
	End If
	Return False
End Sub

Sub DeleteSMSQuickReply(ListID As Int, Index As Int, Text As String)As Boolean 
	Dim temp As Int, Count As Int
	Count = Settings.GetDefault("SMSQR", 0)
	If Count>Index Then
		If Text.Length=0 Then
			For temp = Index To Count-2
				Settings.Put("SMSQR" & temp,   Settings.Get("SMSQR" & (temp+1)) )
			Next
			Settings.Remove("SMSQR" & (Count-1))
			Settings.Put("SMSQR", Count-1)
			LCAR.LCAR_RemoveListitem(ListID,Index)
		Else
			Settings.Put("SMSQR" & Index, Text)
		End If
	End If
	Return False
End Sub
Sub SMSQuickReply(ListID As Int, Text As String, Index As Int) As Int 
	Dim temp As Int, Count As Int
	Count = Settings.GetDefault("SMSQR", 0)
	If Index=-1 Or Index >= Count Then
		If Text.Length=0 Then'enumerate
			If ListID>-1 Then
				LCAR.LCAR_ClearList(ListID,0)
				For temp = 0 To Count-1
					LCAR.LCAR_AddListItem(ListID, Settings.Get("SMSQR" & temp), LCAR.LCAR_Random, -1, "", False, "", 0,False,-1)
				Next
			End If
		Else'add
			Settings.Put("SMSQR" & Count,Text)
			Settings.Put("SMSQR", Count+1)
			Return Count+1
		End If
	Else
		Settings.Put("SMSQR" & Index, Text)
	End If
	Return Count
End Sub
















Sub InitTTS(State As Boolean)
	If Not(TTS1.IsInitialized) Then
		Log("INIT T2S: " & State)
		If State Then
			'TTS1.InitializeTTs("TextToSpeech","en")' TTS1.Initialize("TTS1")'ICOS
			TTS1.Initialize("TextToSpeech")'REGULAR
		Else
			StopSpeaking(0)
			'TTS1.ShutDown 'ICOS
			TTS1.Release'REGULAR
		End If
		TTSisReady=State
	End If
	If Not(State) Then TTSIsSpeaking = False 
End Sub
Sub IsSpeaking As Boolean 
	'Return TTS1.IsSpeaking 'ICOS
	Return TTSIsSpeaking'REGULAR
End Sub
Sub ReadPage
	Dim Filename As String 'file://
	If Not(TTSisReady) Then InitTTS(True)
	If IsSpeaking Then
		StopSpeaking(0)
		SpeakText=""
	Else
		Filename = API.ScrollTo(-1)
		If Filename.Length=0 Then
			Speak("No page was loaded")
		Else If Filename.ToLowerCase.StartsWith("file://") Then
			Filename = API.Right(Filename, Filename.Length - 7)
			'Msgbox(API.GetDir(Filename) & CRLF & API.GetFile(Filename), Filename)
			If File.Exists(API.GetDir(Filename), API.GetFile(Filename)) Then
				Filename = File.ReadString( API.GetDir(Filename), API.GetFile(Filename))
				'Msgbox(Filename, "HTML")
				Filename = API.StripHTML(Filename).ToLowerCase
				Filename = Filename.replace(CRLF, ". ").replace("hellip;", "").Replace("&", " & ").Replace("<br>", ". ")
				Do Until Filename.IndexOf("  ")=-1
					Filename = Filename.Replace("  ", " ")
				Loop
				
				Speak(Filename)
			End If
		End If
	End If
End Sub
Sub Speak(Text As String)
	Dim SplitAt As Int 
	SpeakText=""
	If API.IsOuya Then
		LCAR.toastmessage(BG, API.GetString("no_tts"), 3)
	Else
		Try
			LCAR.Stop ("SPEAK")
			Text= API.trim(Text.Replace("lcars", "elle cars")).ToLowerCase 
			Text = Text.Replace("tricorder", "try corder")
			Text = Text.Replace("uss ", "you ess ess ")
			Text = Text.Replace("fnct\", "function, ")
			Text = Text.Replace("snsr\", "sensors, ")
			Text = Text.Replace("game\", "games, ")
			Text = Text.Replace("sys\", "system, ")
			Text = Text.Replace("gndn\", "goes nowhere does nothing, ")
			
			SplitAt = API.FindAtInstance(Text, " ", 100, 400)'it's a safe assumption words are at least 3 characters average
			If SplitAt = 0 Then 
				LogColor("ERROR: " & Text, Colors.Magenta)
				SplitAt= Text.length 
			End If
			If SplitAt < Text.Length Then
				'Log("Length: " & Text.Length & " " & SplitAt)
			
				SpeakText = API.right(Text, Text.Length-SplitAt)
				Text = API.trim(API.left(Text, SplitAt))
				
				'Log("SpeakText: " & SpeakText)
				'Log("Text: " & Text)
				If Text.Length =0 Then Speak(SpeakText)
			End If
			
			If Not(TTSisReady) Then InitTTS(True)
			If Text.Length > 0 Then 
				Try 
					TTSIsSpeaking=True
					'TTS1.AddSpeaking(Text)'ICOS
					TTS1.Speak(Text, False)'REGULAR
				Catch
					Log("FAILED TRY")
					SpeakText=Text
					InitTTS(True)
				End Try
			End If
		Catch
			SpeakText=Text
		End Try
	End If
End Sub
Sub SpeakKlingon(ListID As Int, ItemID As Int)
	Dim Item As LCARlistitem = LCAR.LCAR_GetListItem(ListID,ItemID),tempstr As String 
	If Item.ColorID = LCAR.LCAR_Red Then
		'tempstr = "Your text to speech engine does not support Klingon" 
		tempstr = Translator.PronounceKlingon( API.GetSide(Item.Text, ":", False,False))
	Else
		tempstr = Item.Text 
	End If
	Log("Speak: " & tempstr)
	Speak( tempstr )
End Sub
Sub StopSpeaking(Delay As Int)
	If TTS1.IsInitialized Then
		If Delay=0 Then
			'TTS1.StopToSpeak'ICOS
			TTS1.Stop 'REGULAR
		Else
			'TTS1.PlaySilence(Delay)'ICOS
			'NOT APPLICABLE FOR REGULAR
		End If
	End If
	TTSIsSpeaking=False
End Sub
Sub TextToSpeech_Ready (Success As Boolean)
	TTS1.SetLanguage("en", "")'REGULAR
	TTSisReady=Success
	TTSIsSpeaking=False
	If Success And SpeakText.Length>0 Then Speak(SpeakText)
    Log("TTS " & API.IIF(Success, "IS", "IS NOT") & " READY (" & SpeakText & ")")
	SpeakText=""
End Sub
















Sub NeedsMenu As Boolean 
	Return (API.APIlevel >= 11 Or MenuEnabled Or API.IsRIM) 'AND Not(WallpaperService.AllowPreview)
End Sub
Sub HandleButtonMenuClicked(Index As Int)
	Dim temp As Boolean 
	Select Case Index
		Case 0: ShowSettings(True,False) 'settings
		Case 1
			temp = Screenshots
			Screenshots=True
			TakeScreenshot
			Screenshots=temp
		Case 2: 
			VRQuestionID=0
			VRListen
		Case 3: Activity_KeyPress(84)'search
		Case 4
			Log("BTN MENU BACK")
			Activity_KeyPress(4)'back
		Case 5: ShowSection(CurrentSection, True)
	End Select
	If LCAR.IsListVisible(ButtonMenu) Then MakeMenu(True)
End Sub
Sub HideMenu
	If ButtonMenu>0 Then
		If LCAR.IsListVisible(ButtonMenu) Then MakeMenu(True)
	End If
End Sub
Sub MakeMenu(Show As Boolean)
	Dim COLS As Int ,Style As Int=LCAR.LCAR_List, Random As Int =LCAR.LCAR_Random, WebViewNeedsMoving As Boolean,IsKlingon As Boolean, IsRim As Boolean = API.IsRim  
	If CurrentSection=999 Then Return'alarm is going off
	If Show Then
		Select Case LCAR.CurrentStyle 'Dim LCAR_TNG As Int=0, LCAR_TOS As Int =1, LCAR_ENT As Int =2 ,LCAR_TMP As Int=3, Klingon As Int =4
			Case LCAR.LCAR_ENT 
				Style=LCAR.ENT_Button
				COLS=50*LCAR.ScaleFactor+LCAR.ChartSpace
			Case LCAR.LCAR_TMP
				Style=LCAR.Legacy_Button				
				Random=LCAR.Classic_Blue
				If CurrentSection=10 Then Random = LCAR.GetElement(51).ColorID 
			Case LCAR.Klingon 
				Style = LCAR.Klingon_Button
			Case LCAR.LCAR_TOS , LCAR.StarWars
				Style= LCAR.TOS_Button
				Random=LCAR.LCAR_Yellow 
			Case LCAR.ChronowerX 
				Style = LCAR.CHX_Iconbar 
				If LCARSeffects3.CHX_Width2=0 Then Return
			Case LCAR.EVENT_Horizon 
				Style = LCAR.EVENT_Horizon 
			Case LCAR.BattleStar 
				Style = LCAR.DRD_Timer
			Case LCAR.LCAR_ClassicTNG
				Random = LCAR.Classic_Green
		End Select	
		If COLS=0 Then COLS=LCAR.ItemHeight+LCAR.ChartSpace
		If webview1.Visible And LCAR.WebviewOffset=0 And Not(LCAR.IsKeyboardVisible(BG,-1,False)) Then WebViewNeedsMoving=True

		If LCAR.IsListVisible(ButtonMenu) Then
			LCAR.MoveList(ButtonMenu,0,-1)
			LCAR.LCAR_HideElement(BG,ButtonMenu,True,False,False)
			If WebViewNeedsMoving Then  LCAR.WebviewOffset=COLS
			LCARSeffects2.HelpMode = False
		Else
			MakeMenu(False)
			LCAR.LCAR_SetListStyle(BG, ButtonMenu, Style, False)
			LCAR.DeRandomizeColors(ButtonMenu,Random)
			If IsRim Then
				LCAR.ResizeList(ButtonMenu,-1, COLS, -1, 0,0,True)
				LCAR.LCAR_HideElement(BG,ButtonMenu,True,True,False)
			Else
				If webview1.Visible  And LCAR.WebviewOffset=0  Then LCAR.WebviewOffset=-COLS			
				LCAR.ResizeList(ButtonMenu,-1, COLS, -1, 0,-1,True)
				LCAR.MoveList(ButtonMenu,0,-1)
				LCAR.LCAR_HideElement(BG,ButtonMenu,True,True,False)
				LCAR.ResizeList(ButtonMenu,-1, COLS, -1, 0,-COLS,True)
			End If
			LCARSeffects2.HelpMode = True
		End If
	Else 
		If ButtonMenu<0 Then
			COLS = 5
			ButtonMenu = LCAR.LCAR_AddList("SUBBTN", 0, COLS,COLS, 0,-1,-1,LCAR.ItemHeight, False,  3,LCAR.leftside,  0, False,False,False ,0)'list 1
		Else
			LCAR.LCAR_ClearList(ButtonMenu,0)
		End If
		IsKlingon= LCAR.CurrentStyle = LCAR.Klingon And Not(Games.UT)
		LCAR.LCAR_AddListItem(ButtonMenu, API.IIF(IsKlingon,"wIv" ,API.GetString("btn_menu")), LCAR.LCAR_Random, -1, 0, False,"",0,False,-1)'1
		LCAR.LCAR_AddListItem(ButtonMenu, API.IIF(IsKlingon,"QaH", API.GetString("help")), LCAR.LCAR_Random, -1, 5, False,"",0,False,-1)'2
		
		If Not(API.isSmallScreenDevice) Then LCAR.LCAR_AddListItem(ButtonMenu, API.IIF(IsKlingon,"qon", API.GetString("printscreen")), LCAR.LCAR_Random, -1, 1, False,"",0,False,-1)'3
		If IsRim Then 
			LCAR.LCAR_AddListItem(ButtonMenu, API.IIF(IsKlingon,"DoH",API.GetString("web_side1")), LCAR.LCAR_Random, -1, 4, False,"",0,False,-1)'4
		Else
			LCAR.LCAR_AddListItem(ButtonMenu, API.IIF(IsKlingon,"QIch", API.GetString("vrec")), LCAR.LCAR_Random, -1, 2, False,"",0,False,-1)'4
		End If
		LCAR.LCAR_AddListItem(ButtonMenu, API.IIF(IsKlingon,"nej", API.GetString("web_search")), LCAR.LCAR_Random, -1, 3, False,"",0,False,-1)'5
	End If
End Sub



Sub BING_Error(Message As String)
	LCAR.HideToast' ("BING_Error")
	LCAR.ToastMessage(BG, "ERROR: " & Message,3)
End Sub
Sub BING_Done(Source As String, Translated As String )
	LCAR.HideToast' ("BING_Done")
	LCAR.ToastMessage(BG, Source.ToUpperCase & " = " & Translated.ToUpperCase,3)
	If Translator.IsNew Then Translator.SeedHistory(3, Translator.History.Size-1)
End Sub


Sub ShowNumberEntry(Animated As Boolean, DefaultValue As Double) As Boolean 
	LCAR.LCAR_HideAll(BG, False)
	ShowFrame(Animated,True)
	LCAR.LCAR_HideElement(BG, 24,True, True, True)
	LCAR.SelectText(DefaultValue)
	AcceptOnlyNumbers=True
End Sub




'-2=lock current orientation, -1 unspecified, 0=landscape, 1=portrait
Sub RequestScreenOrientation(Mode As Int)
	'screenorientation 0=android, 1=lcars ui, 2=LANDSCAPE, 3=PORTRAIT
	If API.IsOuya Then Return'leave as landscape
	Select Case ScreenOrientation
		Case -2: RequestScreenOrientation(API.IIF(LCAR.Landscape, 0,1))
		Case 0: If CurrentScreenOrientation <> -1 Then SetOrientation(-1)
		Case 1: SetOrientation(Mode)
		Case 2,3: SetOrientation(Mode-2)
	End Select
End Sub


'-1 unspecified, 0=landscape, 1=portrait
Sub SetOrientation(Mode As Int)
	Dim Ph As Phone 
	If Not(API.IsScreenLocked) Then
		CurrentScreenOrientation = Mode
		Ph.SetScreenOrientation(Mode)
	End If
End Sub


















Sub Ask2(tMessage As String, Default As String) As String 
	Dim lines As Int = 1
	If SpeakText.StartsWith("[MULTI]") Then 
		lines = 5
		SpeakText = API.right(SpeakText, SpeakText.Length - 7)
	End If
	Return Ask(SpeakText, tMessage,Default, lines)
End Sub
Sub Ask(Title As String, tMessage As String, Default As String, Lines As Int) As String 
	Return betterMSGBOX(tMessage, Title, -Max(1,Lines), Default, API.GetString("kb_ok"), API.GetString("cancel"), "")
End Sub
Sub qMSG(items() As String) As Int 
	Return MSGBOX3(items(0), items(1), items(2), items(3), items(4))
End Sub

Sub MSGBOX1(tMessage As String, Title As String)
	betterMSGBOX(tMessage,Title, 0, "", API.GetString("kb_ok"), "","")
End Sub
Sub MSGBOX3(tMessage As String, Title As String, Positive As String, Cancel As String, Negative As String) As Int 
	Return betterMSGBOX(tMessage,Title, 0, "", Positive, Cancel, Negative)
End Sub
Sub FILELIST(tMessage As String, Title As String, StartingDIR As String, Positive As String, Cancel As String, Negative As String, DirsOnly As Boolean) As String 
	Return betterMSGBOX(tMessage, Title, API.IIF(DirsOnly,2,3), StartingDIR, Positive, Cancel, Negative)
End Sub
'Options is a comma delimited list of the options
Sub OPTIONLIST(tMessage As String, Title As String, Options As String, Positive As String, Cancel As String, Negative As String) As String 
	Return betterMSGBOX(tMessage, Title, 4, Options, Positive, Cancel, Negative)
End Sub

'InputType: <-1=Multiline text, <0=Text, 1=Unknown, 2=Dirs,3=Dirs+Files,4=split NegativeText by commas
Sub betterMSGBOX(tMessage As String, tTitle As String, InputType As Int, Default As String, PositiveText As String, CancelText As String, NegativeText As String) As String 
	Dim IP As BD_InputBoxParams, Title As Panel, Body As Panel, BG2 As Canvas,ColorID As Int = LCAR.LCAR_RandomColor , Color As Int = LCAR.GetColor2(ColorID,False), temp As Int , ret As Int 
	Dim Barwidth As Int = API.IIF(LCAR.SmallScreen, 50,100), Width As Int = Activity.Width * 0.9, ButtonWidth As Int, ButtonCount As Int, Whitespace As Int=3, TestPanel As Panel
	Dim IsTextInput As Boolean = (InputType < 0),  IsFileList As Boolean, TextBoxHeight As Int, Params As BD_CustomDlgParams
	If PositiveText.Length>0 Then ButtonCount = 1
	If CancelText.Length>0 Then ButtonCount = ButtonCount + 1
	If NegativeText.Length>0 Then ButtonCount = ButtonCount + 1
	ButtonWidth = ((Width-Whitespace - ((Barwidth+LCAR.LCARCornerElbow2.Width+Whitespace)*2)) / ButtonCount) 
	tMessage = API.TextWrap(BG, LCAR.LCARfont, LCAR.Fontsize, tMessage.ToUpperCase, Width - (Barwidth+Whitespace)*2)
	ret=LCAR.ItemHeight +LCAR.LCARCornerElbow2.Height
	BDmode = InputType

	Select Case InputType
		Case 2,3,4: IsFileList = True
	End Select

	Dim Lines As Int = Regex.Split(CRLF, tMessage).Length, LineHeight As Int = LCAR.LCARfontheight+2, Height As Int = (ret*2) + (Lines * LineHeight), X As Int
	Params.Initialize 
	'Dim Positive As Object = CreateBetterButton(PositiveText, ColorID, ButtonWidth,ButtonHeight, True, CancelText.Length=0 AND NegativeText.Length=0, barwidth)
	'Dim Cancel   As Object = CreateBetterButton(CancelText, ColorID, ButtonWidth,ButtonHeight, Positivetext.Length=0, NegativeText.Length=0, barwidth)
	'Dim Negative As Object = CreateBetterButton(NegativeText, ColorID, ButtonWidth,ButtonHeight, Positivetext.Length=0 AND CancelText.Length, True, barwidth)

	If IsTextInput Or IsFileList Then 
		If IsFileList Then TextBoxHeight = Activity.Height *0.5
		If IsTextInput Then TextBoxHeight = LCAR.LCARfontheight * (Abs(InputType) + 1)
		Height = Height + TextBoxHeight
	End If
		
	IP.Initialize

	Title.Initialize("")
	Activity.AddView(Title, 0,0,Width, Height)
	Body.Initialize("")
	Activity.AddView(Body, 0,0,Width, 2)
	
	TestPanel.Initialize("")
	Title.AddView(TestPanel, 0,0, Width,Height)
	'Title.Width = Activity.Width * 0.75
	'Title.Height = LCAR.ItemHeight + LCAR.LCARCornerElbow2.height
	BG2.Initialize(TestPanel)

	LCAR.DrawLCARelbow(BG2,  0,0, Barwidth+LCAR.LCARCornerElbow2.Width, Title.Height-ret+2, Barwidth, LCAR.ItemHeight, 0, ColorID, False, "", 0,  255,False)'top left
	temp = Barwidth+LCAR.LCARCornerElbow2.Width
	LCAR.CheckNumbersize(BG2)
	LCAR.DrawText(BG2, Barwidth+Whitespace, ret, tMessage, ColorID, 1, False,255,0)
	tTitle = API.LimitTextWidth(BG2,tTitle.ToUpperCase, LCAR.LCARfont, LCAR.NumberTextSize, Title.Width - (temp*2), "...")
	temp = LCAR.DrawText2(BG2, temp+2, 0, LCAR.NumberTextSize, tTitle, Color,  0) + temp + 4

	X=Barwidth+LCAR.LCARCornerElbow2.Width+Whitespace
	If IsTextInput Then
		Dim Textbox As EditText 
		Params.OpenKeyboard = True
		Textbox.Initialize("")
		Textbox.Text=Default
		Textbox.Color=Colors.Black 
		Log(InputType)
		Textbox.Typeface=LCAR.LCARfont
		Textbox.TextColor=Color 
		Textbox.TextSize=LCAR.Fontsize 
		API.SetMargin(Textbox,0)
		Title.AddView(Textbox, X, Title.Height-LCAR.ItemHeight - TextBoxHeight - Whitespace, Width-X*2, TextBoxHeight)
		Textbox.BringToFront
		Textbox.Enabled = True
		Textbox.InputType = Textbox.INPUT_TYPE_TEXT 
		If InputType < -1 Then 
			Textbox.SingleLine = False 
			Textbox.Gravity = Gravity.TOP
			Textbox.Wrap = True
			Log("MULTILINE")
		Else 
			Textbox.SelectAll
		End If
		LCAR.DrawRect(BG2, Textbox.Left, Textbox.Top, Textbox.Width, Textbox.Height, Color, Whitespace)
	End If

	If IsFileList Then'2,3 (files), 4=text
		Dim CurrentPanel As ScrollView
		CurrentPanel.Initialize(TextBoxHeight)
		FileScroller = CurrentPanel
		Title.AddView(CurrentPanel, X, Title.Height-LCAR.ItemHeight - TextBoxHeight - Whitespace, Width-X*2, TextBoxHeight)
		If InputType = 4 Then 
			LoadOptions(FileScroller, Default)
		Else 
			LoadDir(FileScroller, Default, InputType=2)
		End If 
	End If

	If PositiveText.Length>0 Then 
		Title.AddView(CreateBetterButton(DialogResponse.POSITIVE,PositiveText,ColorID, ButtonWidth, LCAR.ItemHeight-1), X,Title.Height-LCAR.ItemHeight, ButtonWidth, LCAR.ItemHeight-1)
		X=X+ButtonWidth+Whitespace
	End If

	If CancelText.Length>0 Then 
		Title.AddView(CreateBetterButton(DialogResponse.CANCEL,CancelText,ColorID, ButtonWidth, LCAR.ItemHeight-1), X,Title.Height-LCAR.ItemHeight, ButtonWidth, LCAR.ItemHeight-1)
		X=X+ButtonWidth+Whitespace
	End If

	If NegativeText.Length>0 Then Title.AddView(CreateBetterButton(DialogResponse.NEGATIVE, NegativeText,ColorID, ButtonWidth, LCAR.ItemHeight), X,Title.Height-LCAR.ItemHeight, ButtonWidth, LCAR.ItemHeight)
	
	LCAR.DrawLCARelbow(BG2, 0, Title.Height-ret, Barwidth+LCAR.LCARCornerElbow2.Width, ret, Barwidth,LCAR.ItemHeight, 2, ColorID, False, "", 0, 255,False)'bottom left
	LCAR.DrawLCARelbow(BG2, temp,0, Title.Width-temp, Title.Height-ret+2, Barwidth, LCAR.ItemHeight, 1, ColorID, False, "", 0, 255,False)'top right
	LCAR.DrawLCARelbow(BG2, Title.Width-Barwidth-LCAR.LCARCornerElbow2.Width, Title.Height-ret, Barwidth+LCAR.LCARCornerElbow2.Width, ret, Barwidth,LCAR.ItemHeight, 3, ColorID, False, "", 0, 255,False)'bottom left
	
	'LCAR.DrawRect(BG2, temp, 0, Title.Width-temp  ,  LCAR.ItemHeight , Color,0)
	
	'Activity.RemoveAllViews
	'Activity.RemoveViewAt(Activity.NumberOfViews -1)
	Activity.RemoveViewAt(Activity.NumberOfViews -1)
	Activity.RemoveViewAt(Activity.NumberOfViews -1)

	Params.Background = Colors.Black	
	Params.TitleWidth =  Title.Width
	Params.TitleHeight = 1
	'Params.Title = Body
	
	Params.BodyHeight = Title.Height 
	Params.BodyWidth = Title.Width
	Params.DialogBody = Title
	
	'BackPressed = False
	ret = BD.CustomDialog(Params, "msgbox")
	ForceImmersiveMode
	'If BackPressed Then Return 0
	
	'DialogResponse.Positive: -1, DialogResponse.NEGATIVE: -2, DialogResponse.CANCEL: -3
	'ret =  BD.CustomDialog("", 0,0 , Title, Title.Width, Title.Height, 30, Colors.ARGB(192,0,0,0), "", "", "", IsTextInput, "")
	If IsTextInput Then
		If ret = DialogResponse.Positive Then Return Textbox.Text 
		Return ""' IP.CompactAnswer 
	End If
	If IsFileList Then
		If ret = DialogResponse.Positive Then Return SpeakText
		Return ""
	End If
	Return ret
End Sub
Sub msgbox_BackKeyPressed
	'BackPressed = True 
	BD.CloseDialog(0)
	ForceImmersiveMode
End Sub
Sub BetterButton_Click
	Dim Btn As Button = Sender
	BD.CloseDialog(Btn.Tag)
	ForceImmersiveMode
End Sub
Sub CreateBetterButton(ID As Int, Text As String, ColorID As Int, Width As Int, Height As Int) As Button ', LeftSide As Boolean, RightSide As Boolean, BarWidth As Int) As Object 
	Dim BGs As StateListDrawable, gd1 As ColorDrawable , gd2 As ColorDrawable, btn As Button 
	
	btn.Initialize("BetterButton") 
	btn.Tag=ID
	btn.TextColor=Colors.Black 
	btn.Text= Text.ToUpperCase
	btn.Typeface = LCAR.LCARfont 
	btn.TextSize = LCAR.Fontsize 
	btn.Gravity = Gravity.CENTER
	Activity.AddView(btn,  0,0, Width,Height)
	
	'BGs.Initialize
	'BGs.AddState(BGs.State_Pressed, DrawMSGButton(Text,ColorID,Width,Height, LeftSide,RightSide, BarWidth, True))
	'BGs.AddCatchAllState(DrawMSGButton(Text,ColorID,Width,Height, LeftSide,RightSide,BarWidth, False))
	
	BGs.Initialize
	gd1.Initialize( LCAR.GetColor(ColorID, True, 255), 0)
	BGs.AddState(BGs.State_Pressed, gd1)
	gd2.Initialize( LCAR.GetColor(ColorID, False, 255), 0)
	BGs.AddCatchAllState(gd2)
	API.SetMargin(btn,0)
	btn.Background  = BGs
	Activity.RemoveViewAt(Activity.NumberOfViews -1)
	Return btn 
End Sub
Sub LoadDir(thePanel As ScrollView, Directory As String, DirsOnly As Boolean) As Panel 
	Dim Files As List = File.ListFiles(Directory), temp As Int, Y As Int, DOIT As Boolean   
	thePanel.Panel.RemoveAllViews
	If(Directory.Length > File.DirRootExternal.Length) Then
		Y = AddFileButton(thePanel.Panel, Y, thePanel.Width, LCAR.ItemHeight, "[Go to root]", ".") + LCAR.ListitemWhiteSpace
		If API.Right(Directory, Directory.Length - File.DirRootExternal.Length).Contains("/") Then
			Y = AddFileButton(thePanel.Panel, Y, thePanel.Width, LCAR.ItemHeight, "[Go up 1 directory]", "..") + LCAR.ListitemWhiteSpace
		End If
	End If
	For temp = 0 To Files.Size -1 
		If DirsOnly Then DOIT = File.IsDirectory(Directory, Files.Get(temp)) Else DOIT = True
		If DOIT Then
			Y = AddFileButton(thePanel.Panel, Y, thePanel.Width, LCAR.ItemHeight, Files.Get(temp), File.Combine(Directory, Files.Get(temp))) + LCAR.ListitemWhiteSpace
		End If
	Next
	thePanel.Panel.Height = Y
	Return thePanel
End Sub
Sub LoadOptions(thePanel As ScrollView, Text As String) As Panel
	Dim tempstr() As String = Regex.Split(",", Text), temp As Int, Y As Int
	For temp = 0 To tempstr.Length - 1 
		tempstr(temp) = tempstr(temp).Trim
		Y = AddFileButton(thePanel.Panel, Y, thePanel.Width, LCAR.ItemHeight, tempstr(temp), tempstr(temp)) + LCAR.ListitemWhiteSpace
	Next
	thePanel.Panel.Height = Y
	Return thePanel
End Sub
Sub MakeState(ColorID As Int, Width As Int, Height As Int, State As Boolean, Text As String) As BitmapDrawable
	Dim BMPDRAW As BitmapDrawable, BMP As Bitmap, BG2 As Canvas 
	BMP.InitializeMutable(Width,Height)
	BG2.Initialize2(BMP)
	LCAR.DrawLCARbutton(BG2,0,0,Width,Height,ColorID, State, Text, "", LCAR.leftside, 0, False, 0, 4, -1, 255, False)
	BMPDRAW.Initialize(BMP)
	Return BMPDRAW
End Sub
Sub AddFileButton(thePanel As Panel, Y As Int, Width As Int, Height As Int, Text As String, Tag As String) As Int 
	Dim BTN As Button, stdBitmap As StateListDrawable, Color As Int = LCAR.LCAR_RandomColor
	Dim bdwEnabled As BitmapDrawable = MakeState(Color, Width, Height, False, API.uCase(Text))
	Dim bdwPressed As BitmapDrawable = MakeState(Color, Width, Height, True, API.uCase(Text))
	BTN.Initialize("FileButton")
	stdBitmap.Initialize
	stdBitmap.AddState(stdBitmap.State_Pressed, bdwPressed)
	stdBitmap.AddCatchAllState(bdwEnabled)			
	BTN.Background = stdBitmap
	BTN.Tag = Tag
	thePanel.AddView(BTN, 0, Y, Width, LCAR.ItemHeight)
	Y = Y + Height
	Return Y
End Sub

Sub FileButton_Click()
	Dim Btn As Button = Sender, Filename As String = Btn.Tag
	SpeakText = Btn.Tag
	If BDmode < 4 Then 
		If Filename = "." Then
			Filename = File.DirRootExternal
		Else If Filename = ".." Then
			Filename = API.GetDir(Filename)
		End If
		If File.IsDirectory(API.GetDir(Filename), API.GetFile(Filename)) Then
			LoadDir(FileScroller, Filename, BDmode=2)
		End If
	End If 
End Sub
Sub LoadDirs(Keyname As String, RemoveRoot As Boolean)
	Dim Files As List = API.LoadFiles(Keyname), temp As Int, DIR As String 
	For temp = 0 To Files.Size - 1 
		DIR = API.uCase(Files.Get(temp))
		If RemoveRoot Then DIR = API.Right(DIR, DIR.Length - File.DirRootExternal.Length - 1)
		SeedSetting(DIR, Files.Get(temp), "")
	Next
End Sub

Sub ForceImmersiveMode As Boolean 
	If API.FullscreenMode And API.APIlevel >= 19 And API.RealHeight > 0 Then 
		'If Not(LCAR.Landscape) Then 
			Dim r As Reflector
			Try 
				r.Target = r.GetActivity
			    r.Target = r.RunMethod("getWindow")
			    r.Target = r.RunMethod("getDecorView")
			    r.RunMethod2("setSystemUiVisibility", 5894, "java.lang.int")
				'Activity.Width = -1
				'Activity.Height = -1 
				'LCAR.ScaleWidth = Activity.Width
				'LCAR.ScaleHeight = Activity.Height
				'Log("ImmersiveMode: " & Activity.Width & " x " & Activity.Height)
				LCAR.SetupLCARcolors(Activity)
				Log("ImmersiveMode: " & Activity.Width & " x " & Activity.Height & " - " & LCAR.ScaleWidth & " x " & LCAR.ScaleHeight)
			Catch 
				Return True
	 		End Try 
		'End If
	else if API.RealHeight = 0 And API.FullscreenMode Then 
		LCAR.ToastMessage(BG, API.GetString("immersive_height"), 3)
	End If
End Sub
'Sub VisibilityChanged_Event(MethodName As String, Args() As Object) As Object
'    ForceImmersiveMode
'End Sub
'Sub Activity_WindowFocusChanged(HasFocus As Boolean)
'    If HasFocus Then ForceImmersiveMode
'End Sub


'Sub GetFrame(Frame As Int) As Bitmap 
'	If LCARSeffects2.GIFloaded Then Return gif.Frame(Frame)
'End Sub
'Sub LoadGIF(Dir As String, Filename As String) As Boolean 
'	LCARSeffects2.GIFloaded=False
'	If File.Exists(Dir, Filename) Then
'		gif.DisposeFrames
'		gif.Load(Dir, Filename)
'		LCARSeffects2.GIFFrames = gif.FrameCount
'		LCARSeffects2.GIFwidth = gif.FrameWidth
'		LCARSeffects2.GIFheight = gif.FrameHeight 	
'		LCARSeffects2.GIFloaded=True
'		LCARSeffects2.GIFdrawn=False
'	End If
'End Sub
''FRAME STARTS AT 1, ends at FRAMECOUNT
'Sub DrawGIF(BG2 As Canvas, Frame As Int, DestXY As Rect) As Boolean
'	If LCARSeffects2.GIFloaded Then 
'		BG2.DrawBitmap(gif.Frame(Frame mod gif.FrameCount), Null, DestXY)
'		LCARSeffects2.GIFdrawn=True
'		Return True 
'	End If
'End Sub
'Sub DrawGIF2(BG2 As Canvas, Frame As Int, X As Int, Y As Int, Width As Int, Height As Int) As Boolean
'	Return DrawGIF(BG2, gif.Frame(Frame mod gif.FrameCount), LCARSeffects4.SetRect(X,Y,Width,Height))
'End Sub
'
''array: 0=BG as canvas, 1=Frame as int (FRAME STARTS AT 1, ends at FRAMECOUNT), 2=DEST as rect
'Sub DrawGIF3(Params() As Object) As Boolean 
'	Return DrawGIF( Params(0), Params(1), Params(2) )
'End Sub

Sub ShowDIR(Dir As String) As Boolean
	Dim Files As List, tempstr As String = Dir 		
	If Dir.Length = 0 Then Dir = File.DirRootExternal
	LCAR.LCAR_ClearList(3, 0)
	If Dir = "BOOKMARKS" Then 
		CurrentDir=Dir
		Files = GetBookmarks
		Dir = ""
	Else if API.StartsWith(Dir, "SEARCH FOR: ") Then 
		Dir = API.Right(Dir, Dir.Length - 12)
		Files = SearchForFiles(CurrentDir, Dir, True)'change to true
		Dir = ""
	Else 
		CurrentDir=Dir
		If Not(Dir = File.DirRootExternal) Then SeedSetting2("[GO BACK]", API.GetDir(Dir), "DIRECTORY", LCAR.LCAR_Red, -1, 0)
		If Dir = LCAR.DirDefaultExternal And Not(API.debugMode) Then LCAR.ToastMessage(BG, "FILES IN THIS DIRECTORY CAN ONLY BE MANIPULATED IN DEBUG MODE", 3)
		Files = File.ListFiles(Dir)
		tempstr = Dir 
		If API.left(tempstr, File.DirRootExternal.Length) = File.DirRootExternal Then tempstr = API.Right(tempstr, tempstr.Length - File.DirRootExternal.Length - 1)
	End If
	SetElement18Text(tempstr)
	Files.SortCaseInsensitive(True)
	ShowDIRfiles(Dir, Files, True)
	tempstr = Settings.GetDefault("SORTING", "FILENAME")
	Files = SortFiles(Files, tempstr, False, Settings.GetDefault("SORTDIR", "ASCENDING") = "ASCENDING")
	ShowDIRfiles(Dir, Files, False)
	HandleDIRmenu(-4,0)
End Sub

Sub EnumSubDirs(Dir As String) As List 
	Dim temp As Int, Dirs As List, Files As List, temp2 As Int, Filename As String 
	Dirs.Initialize
	Dirs.Add(Dir)
	Do Until temp >= Dirs.Size 
		Dir = Dirs.Get(temp)
		Files = File.ListFiles(Dir)
		For temp2 = 0 To Files.Size - 1
			Filename = Files.Get(temp2)
			If File.IsDirectory(Dir, Filename) Then 
				Dirs.Add( File.Combine(Dir,Filename) )
			End If 
		Next
		temp = temp + 1
	Loop
	Return Dirs 
End Sub
Sub SearchForFiles(Dir As String, Pattern As String, Recursive As Boolean) As List 
	Dim Dirs As List, Files As List, FileName As String, Ret As List, temp As Int, temp2 As Int, tempEquation As String, Equation As String, IsEqu As Boolean = True, IsPat As Boolean = True, LastModified As Long  
	If Pattern.Contains("[") And Pattern.Contains("]") Then 
		Equation = API.GetBetween(Pattern, "[", "]")
		If Eval.IsAnEquation(Equation) Then 
			Pattern = API.RemoveBrackets(Pattern, 2)
		Else 
			Equation = ""
		End If 
	End If
	If Recursive Then 
		Dirs = EnumSubDirs(Dir)
	Else 
		Dirs.Initialize
		Dirs.Add(Dir)
	End If
	Ret.Initialize
	Log(Eval.SetTimeVariables)
	
	For temp = 0 To Dirs.Size - 1
		Dir = Dirs.get(temp)
		'Log("CHECKING DIR: " & Dir)
		Files = File.ListFiles(Dir)
		For temp2 = 0 To Files.Size - 1
			FileName = Files.Get(temp2)
			'Log("CHECKING FILE: " & FileName)
			If Pattern.Length > 0 Then IsPat = API.isLike(FileName, Pattern)
			If Equation.Length > 0 Then 
				If Equation.EqualsIgnoreCase("ERROR") Then 
					IsEqu = False 
				Else 'if Not(File.IsDirectory(Dir,FileName)) Then 
					LastModified = File.LastModified(Dir, FileName)
					Eval.Val("set dir = '" & Dir & "'")
					Eval.Val("set name = '" & FileName & "'")
					Eval.Val("set title = '" & API.GetTitle(FileName) & "'")
					Eval.Val("set ext = '" & API.GetExtension(FileName) & "'")
					Eval.Val("set size = " & File.size(Dir,FileName))
					Eval.Val("set ftime = " & LastModified)
					Eval.Val("set fdate = " & API.OnlyDate(LastModified))
					'Eval.Val("name", 0, False, 0,		FileName, False)
					'Eval.OptionExplicit = False
					'Log(Eval.Val("'dir: ' & dir & ' name: ' & name & ' size: ' & size & ' ext: ' & ext & ' time: ' & ftime & ' date: ' & fdate"))
					'Eval.OptionExplicit = False
					tempEquation = Eval.Val(Equation.ToLowerCase)', 0, True, 0
					'Log("Result: " & tempEquation & " Equation: " & Equation)
					If Eval.EvalError.Length = 0 Then 
						IsEqu = tempEquation.EqualsIgnoreCase("true")
					Else 
						Equation = "ERROR"
						IsEqu = False 
						LCAR.ToastMessage(BG, "ERROR: " & Eval.EvalError, 2)
					End If 
				End If 
			End If
			FileName = File.combine(Dir, FileName)
			'Log("File: " & FileName & " " & IsPat & " " & IsEqu)
			If IsPat And IsEqu Then Ret.Add(FileName )
		Next
	Next
	If Equation.EqualsIgnoreCase("ERROR") Then LCAR.ToastMessage(BG, "ERROR: " & Eval.EvalError, 3)
	Return Ret 
End Sub 
	
Sub SortFiles(Files As List, ByWhat As String, IsDir As Boolean, Ascending As Boolean) As List 
	Dim tempList As List, temp As Int, Dir As String, Filename As String 
	If ByWhat = "FILENAME" And Ascending Then Return Files'it's already sorted that way
	tempList.Initialize
	For temp = 0 To Files.Size - 1
		Dim tempValue As HTMLvalue
		tempValue.Initialize
		tempValue.Key = Files.Get(temp)
		Dir = API.GetDir(tempValue.Key)
		Filename = API.GetFile(tempValue.Key)
		If File.IsDirectory(Dir, Filename) = IsDir Then 
			Select Case ByWhat.ToUpperCase
				Case "FILENAME":	tempValue.Value = API.GetFile(Filename)
				Case "EXTENSION": 	tempValue.Value = API.GetExtension(Filename) & " " & API.GetTitle(Filename)
				Case "SIZE": 		tempValue.Value = File.Size(Dir,Filename)
				Case "DATE": 		tempValue.Value = File.LastModified(Dir,Filename)
			End Select
			tempList.Add(tempValue)
		End If
	Next
	tempList.SortType("Value", Ascending)
	For temp = 0 To tempList.Size - 1
		Dim tempValue As HTMLvalue = tempList.Get(temp)
		tempList.Set(temp, tempValue.Key)
	Next
	Return tempList
End Sub
Sub ShowDIRfiles(Dir As String, Files As List, IsDir As Boolean)
	Dim temp As Int, Size As Int = -1, Filename As String, TheDir As String, TheFile As String, Extension As String = "DIRECTORY"
	For temp = 0 To Files.Size - 1
		Filename = Files.Get(temp)
		If Dir.Length > 0 Then 
			Filename = File.Combine(Dir, Filename)
			TheDir = Dir 
		Else 
			TheDir = API.GetDir(Filename)
		End If
		TheFile=API.GetFile(Filename)
		If IsDir = File.IsDirectory(TheDir, TheFile) Then 
			If Not(IsDir) Then  
				If Not(LCAR.SmallScreen) Then Size = LCAR.ScientificNotation(File.Size(TheDir, TheFile))
				If TheFile.LastIndexOf(".") > 0 Then 
					Extension = API.GetExtension(TheFile).ToUpperCase
					If Extension.Length > 0 Then TheFile = API.Left(TheFile, TheFile.Length - Extension.Length - 1)			
				End If 
			End If 
			TheFile = TheFile.Replace("_", " ")
			SeedSetting2(TheFile, Filename, Extension, API.IIF(IsDir, LCAR.LCAR_Red, LCAR.LCAR_Orange), Size, 0)
		End If 
	Next
End Sub
Sub HandleDIRmenu(ListID As Int, Index As Int) As Boolean'return true to show sub-menu
	Dim tempstr As String, tempitem As LCARlistitem, MultiSelect As Boolean = LCAR.GetList(3).MultiSelect, Dir As String, Filename As String, FileSize As Long, Items As List 
	'FTP: https://www.b4x.com/android/forum/threads/android-ftp-tutorial.10407/
	LCAR.HideToast
	If ListID > -1 Then 
		tempitem = LCAR.LCAR_GetListItem(ListID, Index)
		Dir 	 = API.GetDir(tempitem.tag)
		Filename = API.GetFile(tempitem.tag)
		tempstr  = tempitem.Text
		Log("FILE EX: " & ListID & " - " & tempstr)
	End If
	Select Case ListID
		Case 3'main
			If tempstr = "[GO BACK]" Then 
				Return ShowDIR(tempitem.Tag)'hide menu
			Else If Not(MultiSelect) Then 
				If Dir = "CMD" Then 
					Select Case Filename.ToLowerCase
						Case "kb:ip"
							LCAR.ForceHideAll(BG)
							LCAR.ShowNumBoard(BG, ServerIP)
							Return False
						Case "kb:text", "kb:number"
							Return HandleAskQuestion(tempitem.Text, "PLEASE ENTER THE " & tempitem.Text, tempitem.Side, False)
						Case "kb:multiline"
							Return HandleAskQuestion(tempitem.Text, "PLEASE ENTER THE " & tempitem.Text, tempitem.Side, True)
						
						Case "lcars"
							ShowDIR(LCAR.DirDefaultExternal)
						Case "sort"
							LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("FILENAME", "EXTENSION", "SIZE", "DATE"))
							Return True 
						Case "sortdir"
							LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Array As String("ASCENDING", "DESCENDING"))
							Return True 
						
						Case "ftpbyip", "ftpbyurl"	
							HandleDIRmenu(-6,0)
							If Filename = "ftpbyurl" Then 
								SeedSetting2("ADDRESS (DON'T TYPE FTP://)", "CMD/kb:text" , "", -1, -1,0)	
								SeedSetting2("PORT", "CMD/kb:number" , "", -1, -1,0)
							Else 
								SeedSetting2("ADDRESS", "CMD/kb:ip" , "", -1, -1,0)	
							End If
							SeedSetting2("USERNAME", "CMD/kb:text" , "", -1, -1,0)	
							SeedSetting2("PASSWORD", "CMD/kb:text" , "", -1, -1,0)	
							
						Case Else: Log("'" & Filename & "' IS NOT A SUPPORTED COMMAND")					
					End Select
					Return False
				Else
					Items.Initialize
					tempstr = API.GetExtension(Filename)
					SetElement18Text(Filename)
					If File.IsDirectory(Dir, Filename) Then 
						Items.Add("OPEN [INT]")
					Else 
						Select Case tempstr 
							Case "jpg", "jpeg", "gif", "png", "bmp", "html", "htm", "txt", "json", "nfo", "ini", "pdf", "ogg", "wav", "m4a", "mp3", "apk": Items.Add("OPEN [INT]")
							Case "mp4", "webm": If API.APIlevel >= 11 Then Items.Add("OPEN [INT]")
						End Select
					End If
					Items.Add("OPEN [EXT]")
					If Not(Dir.EqualsIgnoreCase(LCAR.DirDefaultExternal)) Or API.debugMode Then  Items.AddAll(Array As String("COPY", "CUT", "RENAME", "DELETE"))'only allow editing of my files if debug mode is on 
					Items.Add("PROPERTIES")
					LCAR.LCAR_AddListItems(4, LCAR.LCAR_Random,0, Items)
				End If 
			End If
		Case 4'sub-menu, use SettingIndex to get index from 3
			tempitem = LCAR.LCAR_GetListItem(3, SettingIndex)
			Dir = API.GetDir(tempitem.tag)
			Filename = API.GetFile(tempitem.tag)
			HideSubSettings
			If Dir = "CMD" Then 
				tempitem.Side = tempstr
				Select Case Filename
					Case "sort": Settings.put("SORTING", tempstr)
					Case "sortdir": Settings.put("SORTDIR", tempstr)
				End Select
			Else 
				tempitem.Side = API.GetExtension(Filename).ToUpperCase'put it back
				Select Case tempstr 
					Case "OPEN [INT]"'open internally
						If File.IsDirectory(Dir,Filename) Then 
							ShowDIR(tempitem.tag)
						Else 
							tempstr = API.GetExtension(Filename)
							Select Case tempstr'don't forget that 'OPEN [INT]' needs every extension it can use, added above
								Case "jpg", "jpeg", "gif", "png", "bmp"'Images
									BrowseWeb(API.MakeHTML("<IMG SRC='file:///" & tempitem.tag & "'>"),4)
								Case "html", "htm"'web pages
									BrowseWeb(API.MakeHTML(File.ReadString(Dir,Filename)),4)
								Case "txt", "ini", "nfo", "json" 'text
									BrowseWeb(API.MakeHTML( File.ReadString(Dir,Filename).Replace(CRLF, "<BR>") ),4)
								Case "pdf"'PDF
									BrowseWeb(API.MakeHTML(cPDF2Text.ProcessPDFFile(Dir, Filename)), 4)
								Case "ogg", "wav", "m4a", "mp3"'audio
									LCAR.PlaySoundFile(Dir, Filename, False)
								Case "apk"'EXECUTABLE
									API.InstallAPK(Dir,Filename)
								Case "mp4", "webm"'video
									BrowseWeb(API.MakeHTML("<video width='100%' controls><source src='" & tempitem.tag & "' type='video/" & tempstr & "'></video>"),4)
								'Case Else:LCAR.ToastMessage(BG, tempstr & " FILES ARE NOT SUPPORTED. USE 'OPEN [EXT]' INSTEAD", 2)'can no longer be reached
							End Select
						End If
					Case "OPEN [EXT]"'open externally
						API.OpenFile(tempitem.tag)
					Case "COPY", "CUT", "RENAME", "DELETE"
						FileOp(tempstr, tempitem.tag)
					Case "PROPERTIES"
						FileSize = File.Size(Dir,Filename) 
						SetElement18Text("PROPERTIES")
						HandleDIRmenu(-6,0)
						Log("Dir: " & Dir)
						SeedSetting2("[GO BACK]", Dir, "", LCAR.LCAR_Red, -1, 0)
						SeedSetting(Filename, 																			"", "FILENAME")
						SeedSetting(Dir, 																				"", "PATH")
						If File.IsDirectory(Dir, Filename) Then  
							SeedSetting("DIRECTORY",					 												"", "TYPE")
						Else 
							SeedSetting(API.GetExtension(Filename), 													"", "EXTENSION")
							SeedSetting(API.GetFileType(Filename, True), 												"", "MIME TYPE")
						End If
						SeedSetting(API.CompressSize(FileSize,2) & " (" & NumberFormat(FileSize,1,0) & " BYTES)", 		"", "SIZE")
						SeedSetting(API.GetDateVerbose(File.LastModified(Dir,Filename), False, False), 					"", "LAST MODIFIED")
						Return False 'to hide the menu 
				End Select 
			End If 
		Case LCAR.ButtonList'button menu
			Select Case tempstr 
				Case "FAVE"
					FileOp(tempstr, CurrentDir)
				Case "NEW"
					tempstr = Ask2("WHAT WOULD YOU LIKE TO NAME THE DIRECTORY?", "NEW DIRECTORY")
					If tempstr.Length > 0 Then 
						If File.Exists(CurrentDir, tempstr) Then
							PlayError
							LCAR.ToastMessage(BG, "'" & tempstr & "' EXISTS ALREADY", 2)
						Else 
							File.MakeDir(CurrentDir, tempstr)
							ShowDIR(CurrentDir)
						End If 
					End If
				Case "CLIP"
					If Not(CurrentDir.EqualsIgnoreCase(LCAR.DirDefaultExternal)) Or API.debugMode Then 
						tempstr = OPTIONLIST("SELECT AN OPERATION:", "CLIPBOARD", "COPY,CUT,DELETE" & API.IIF(API.Clipboard(3,"").EqualsIgnoreCase("true"),",PASTE",""), "OK", "CANCEL", "")
						If tempstr.Length > 0 Then FileOp(tempstr, "")
					Else 
						PlayError
						LCAR.ToastMessage(BG, "ACCESS TO THIS DIRECTORY IS RESTRICTED", 2)
					End If 
			End Select 
		Case 19'sidebar
			Select Case Index 
				Case 0: ShowDIR("")'root
				Case 1: ShowDIR("BOOKMARKS")
				Case 2'toggle multi-select
					LCAR.GetList(3).MultiSelect = Not(MultiSelect) 
					HideSubSettings
				Case 3'more
					HandleDIRmenu(-6,0)
					SeedSetting2("SORT BY", "CMD/sort", Settings.GetDefault("SORTING", "FILENAME"), -1, -1, 0)
					SeedSetting2("SORT DIRECTION", "CMD/sortdir", Settings.GetDefault("SORTDIR", "ASCENDING"), -1, -1, 0)
					SeedSetting2("BROWSE LCARS DIRECTORY", "CMD/lcars", "", -1, -1, 0)
					'SeedSetting2("CONNECT TO FTP BY IP ADDRESS", "CMD/ftpbyip", "", -1, -1,0)
					'SeedSetting2("CONNECT TO FTP BY URL", "CMD/ftpbyurl", "", -1, -1,0)
			End Select
		Case -1'keyboard
			Select Case Index 
				Case 0'Leyboard
					tempstr = LCAR.GetSelectedText.Trim
				Case 1'IP address
					tempstr = API.GetIP(ServerIP, True)
					LCAR.lcar_getlistitem(3, SettingIndex).Side = tempstr 
					LCAR.ForceHideAll(BG)
					ShowSettingsNoClear(False)
			End Select 
			Log("Returned: " & tempstr)
		Case -2'seed sidebar and button menu
			SeedSideBar(Array As String("ROOT","FAVE", "MLTI", "MORE"),  False,True)
			tempstr = API.IIF(LCAR.SmallScreen, "SRCH", "SEARCH")
			LCAR.LCAR_SetElementText(LCARSeffects.FrameElement, tempstr, "")
			LCAR.LCAR_SetElementText(LCARSeffects.FrameElement+11, "", "")'bottom button			
			HandleDIRmenu(-4,0)
		Case -3'keypress
			Select Case Index
				Case 84'search
					If CurrentDir = "BOOKMARKS" Or CurrentDir = File.DirRootExternal Then 
						PlayError
						LCAR.ToastMessage(BG, "CAN'T SEARCH BOOKMARKS OR ROOT", 2)
					Else 
						tempstr = Ask("SEARCH", "WHAT WOULD YOU LIKE TO SEARCH THE FILE NAMES FOR?", "", 1)
						If tempstr.Length > 0 Then ShowDIR("SEARCH FOR: " & tempstr)
					End If
			End Select
		Case -4'seed button menu
			LCAR.SeedButtonBar(BG, Array As String("FAVE", "CLIP", "NEW"))
		Case -5'hide webview
			webview1.Visible=False 
			ShowSettingsNoClear(False)
			CurrentSection=83
			SetElement18Text("")
			HandleDIRmenu(-2,0)
		Case -6'clear list and hide sub-menu
			LCAR.LCAR_ClearList(3, 0)
			HideSubSettings
	End Select
	Return Not(MultiSelect)
End Sub

Sub PlayYoutube(ID As String, Mode As Int)
	BrowseWeb(API.MakeHTML("<iframe width='100%' class='youtube-player' Type='text/html' src='http://www.youtube.com/embed/" & ID & "' frameborder='0' allowfullscreen>"), Mode)
End Sub

Sub FileOp(Operation As String, Filename As String)
	Dim Files As List, temp As Int, tempstr As StringBuilder, Extension As String, NewFilename As String, NewExtension As String'Use CurrentDir
	tempstr.Initialize
	Select Case Operation
		Case "COPY", "CUT"
			Files = LCAR.LCAR_GetSelectedItems(3, 2)
			tempstr.Append(Operation)
			For temp = 0 To Files.Size - 1
				tempstr.Append(CRLF & Files.Get(temp))	
			Next
			API.Clipboard(4, tempstr.ToString)
			LCAR.ToastMessage(BG, Files.Size & " FILE" & API.plural(Files.Size, "", "S") & " HAVE BEEN ADDED TO THE CLIPBOARD", 2)
			
		Case "DELETE"
			Files = LCAR.LCAR_GetSelectedItems(3, 2)
			If Files.Size = 1 Then 
				Filename = "'" & API.GetFile(Files.Get(0)) & "'"
			Else 
				Filename = Files.Size & " FILES"
			End If
			If MSGBOX3("ARE YOU SURE YOU WANT TO DELETE " & Filename & "?", "DELETE FILES/DIRECTORY", "YES", "NO", "") = -1 Then 
				For temp = 0 To Files.Size - 1
					API.DeleteFileOrDir(Files.Get(temp))					
				Next
				ShowDIR(CurrentDir)
			End If 
			
		Case "PASTE"
			Files.Initialize2(Regex.Split(CRLF, API.Clipboard(1, "")))
			Filename = Files.Get(1)
			For temp = 2 To Files.Size - 1
				If Not(File.IsDirectory(API.GetDir(Files.Get(temp)), API.GetFile(Files.Get(temp)))) Then 
					FileOp(Filename & "PASTE", Files.Get(temp))
				End If 
			Next
			ShowDIR(CurrentDir)
		
		Case "CUTPASTE"
			API.RenameFile(API.GetDir(Filename), API.GetFile(Filename), CurrentDir, API.GetFile(Filename))
		Case "COPYPASTE"
			API.CopyFile(API.GetDir(Filename), API.GetFile(Filename), CurrentDir, API.GetFile(Filename), True)
			
		Case "FAVE"
			If CurrentDir.EqualsIgnoreCase("BOOKMARKS") Then 
				PlayError
				LCAR.ToastMessage(BG, "YOU CANNOT FAVORITE THE FAVORITES LIST", 2)
				If AprilFools Then LCAR.ToastMessage(BG, "BECAUSE YOU'D CAUSE A PARODOX IF YOU UNFAVORITED THE FAVORITES LIST", 2)
			Else 
				Files = GetBookmarks
				temp = Files.IndexOf(Filename)
				If temp = -1 Then 'not found, add it
					Files.Add(Filename)
					LCAR.ToastMessage(BG, "'" & Filename & "' HAS BEEN ADDED TO THE FAVORITES LIST", 2)
				Else'found, delete it
					Files.RemoveAt(temp)
					LCAR.ToastMessage(BG, "'" & Filename & "' HAS BEEN REMOVED FROM THE FAVORITES LIST", 2)
				End If
				Settings.Put("BOOKMARKS", Files.Size)
				For temp = 0 To Files.Size - 1
					Settings.Put("BOOKMARK" & temp, Files.Get(temp))
				Next 
			End If 
			
		Case "RENAME"
			temp = LCAR.LCAR_GetSelectedItem(3)
			If temp > -1 Then 
				tempstr.Append( Ask("RENAME", "WHAT WOULD YOU LIKE THE NAME OF '" & API.GetFile(Filename) & "' TO BE CHANGED TO?", API.GetFile(Filename), 0) )
				If NewFilename.Length > 0 Then
					Extension=API.GetExtension(NewFilename)
					NewExtension=API.GetExtension(Filename)
					If Not(Extension.EqualsIgnoreCase(NewExtension)) Then
						If MSGBOX3("IF YOU CHANGE THE EXTENSION, THE FILE MIGHT BECOME UNUSABLE. ARE YOU SURE YOU WANT TO CHANGE '" & Extension & "' TO '" & NewExtension & "'?", "RENAME", "YES", "NO", "") = -1 Then
							NewFilename = ""
						End If
					End If
				End If
				If Not(NewFilename = API.GetFile(Filename)) And NewFilename.Length> 0 Then
					API.RenameFile(API.GetDir(Filename), API.GetFile(Filename), API.GetDir(Filename), NewFilename)
					Log("RENAME: " & Filename & " to " & NewFilename)
					Filename = File.Combine(API.GetDir(Filename), NewFilename)
					LCAR.LCAR_SetListitemText(3, temp, API.GetTitle(Filename.Replace("_", " ")), API.GetExtension(NewFilename)).Tag = Filename
				End If
			End If
	End Select
End Sub

Sub GetBookmarks As List 
	Dim Count As Int = Settings.GetDefault("BOOKMARKS", 0), Files As List 
	Files.Initialize
	For temp = 0 To Count - 1
		If Settings.ContainsKey("BOOKMARK" & temp) Then Files.Add(Settings.Get("BOOKMARK" & temp))
	Next
	Return Files
End Sub
